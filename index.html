<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud IX Concierge</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@200;300;400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&display=swap" rel="stylesheet">
<style>
/* ══════════════════════════════════════════════════════════════
   MUSIC TRACKER — Ivory & Forest Ink Edition
   Cormorant Garamond + Outfit  |  Luxury Editorial
══════════════════════════════════════════════════════════════ */
:root {
  /* Canvas */
  --canvas:    #f9f6f0;
  --parchment: #f3ede3;
  --cream:     #ede6d8;
  --warm-white:#fdfbf7;

  /* Ink hierarchy */
  --ink:       #1a1a20;
  --ink2:      #2e2e38;
  --ink3:      #4a4a58;
  --ink4:      #7a7a8a;
  --ink5:      #b0adb8;

  /* Gold — restrained, antique */
  --gold:      #9a7b3c;
  --gold-lt:   #c4a05a;
  --gold-pale: #e8d5a8;
  --gold-wash: rgba(154,123,60,.07);
  --gold-line: rgba(154,123,60,.2);

  /* Forest accent */
  --forest:    #2d4a3e;
  --forest-lt: #4a7a68;
  --forest-dim: rgba(45,74,62,.08);

  /* Divider / border */
  --rule:      rgba(26,26,32,.08);
  --rule2:     rgba(26,26,32,.14);

  /* Spacing rhythm */
  --r-xs: 4px;
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 18px;
  --r-xl: 26px;
  --r-2xl:38px;
}

/* ── Reset & base ── */
* { box-sizing:border-box; margin:0; padding:0; }

::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:var(--cream); }
::-webkit-scrollbar-thumb { background:var(--gold-pale); border-radius:10px; }

html { scroll-behavior:smooth; }

body {
  font-family:'Outfit', sans-serif;
  background:var(--canvas);
  min-height:100vh;
  color:var(--ink);
  font-size:14px;
  line-height:1.6;
  letter-spacing:.005em;
  -webkit-font-smoothing:antialiased;
}

/* Subtle warm texture */
body::before {
  content:'';
  position:fixed; inset:0;
  background:
    radial-gradient(ellipse 80% 50% at 20% -10%, rgba(154,123,60,.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%, rgba(45,74,62,.04) 0%, transparent 60%);
  pointer-events:none; z-index:0;
}

.app {
  position:relative; z-index:1;
  max-width:1400px; margin:0 auto;
  padding:0 3rem 8rem;
}

/* ══ HEADER ═══════════════════════════════════════════════ */
header {
  text-align:center;
  padding:5rem 2rem 4.5rem;
  position:relative;
}

.subtitle {
  font-family:'Outfit', sans-serif;
  font-size:.62rem; font-weight:300;
  color:var(--gold); letter-spacing:.55rem;
  text-transform:uppercase;
  margin-bottom:1.8rem;
}

h1 {
  font-family:'Cormorant Garamond', serif;
  font-size:clamp(3rem, 6vw, 5rem);
  font-weight:400;
  color:var(--ink);
  line-height:1;
  letter-spacing:-.03em;
  margin-bottom:1.2rem;
}

h1 em {
  font-style:italic;
  color:var(--gold);
}

.header-rule {
  display:flex; align-items:center; justify-content:center;
  gap:1.5rem; margin-bottom:1.2rem;
}
.header-rule::before,
.header-rule::after {
  content:'';
  width:120px; height:1px;
  background:linear-gradient(90deg, transparent, var(--gold-line));
}
.header-rule::after {
  background:linear-gradient(90deg, var(--gold-line), transparent);
}
.header-rule-dot {
  width:5px; height:5px;
  background:var(--gold);
  border-radius:50%;
}

.tagline {
  font-size:.72rem; font-weight:300;
  color:var(--ink4); letter-spacing:.18rem;
  text-transform:uppercase;
}

/* ══ LAYOUT ════════════════════════════════════════════════ */
.layout {
  display:grid;
  grid-template-columns:300px 1fr;
  gap:3rem;
  align-items:start;
}
@media(max-width:900px){ .layout{ grid-template-columns:1fr; gap:2rem; } }

/* ══ SIDEBAR ═══════════════════════════════════════════════ */
.sidebar {
  position:sticky; top:2rem;
  max-height:calc(100vh - 4rem);
  overflow-y:auto; overflow-x:hidden;
}

/* ══ PANELS ════════════════════════════════════════════════ */
.panel {
  background:var(--warm-white);
  border:1px solid var(--rule);
  border-radius:var(--r-xl);
  padding:2rem 1.8rem;
  margin-bottom:1.4rem;
  box-shadow:
    0 1px 3px rgba(26,26,32,.04),
    0 4px 24px rgba(26,26,32,.06),
    0 20px 60px rgba(26,26,32,.04);
  transition:box-shadow .3s;
}
.panel:hover {
  box-shadow:
    0 2px 6px rgba(26,26,32,.05),
    0 8px 32px rgba(26,26,32,.08),
    0 24px 70px rgba(26,26,32,.05);
}

.panel-title {
  font-family:'Cormorant Garamond', serif;
  font-size:1.05rem; font-weight:600;
  font-style:italic;
  color:var(--ink3);
  margin-bottom:1.25rem;
  display:flex; align-items:center; gap:.7rem;
  letter-spacing:.02em;
}
.panel-title::after {
  content:''; flex:1; height:1px;
  background:linear-gradient(to right, var(--gold-line), transparent);
}

/* ══ FORMS ═════════════════════════════════════════════════ */
.add-form {
  display:flex; flex-direction:column; gap:.55rem;
  padding-bottom:1.2rem; margin-bottom:1.2rem;
  border-bottom:1px solid var(--rule);
}

.date-row { display:flex; gap:.5rem; }
.date-row select { flex:1; }

input[type=text], select {
  width:100%;
  padding:.7rem 1rem;
  border:1px solid var(--rule2);
  border-radius:var(--r-md);
  font-family:'Outfit', sans-serif;
  font-size:.82rem; font-weight:300;
  color:var(--ink);
  background:var(--canvas);
  outline:none;
  transition:all .25s;
  letter-spacing:.015em;
  appearance:none; -webkit-appearance:none;
}

input[type=text]::placeholder { color:var(--ink5); font-weight:300; }

input[type=text]:focus, select:focus {
  border-color:var(--gold);
  background:var(--warm-white);
  box-shadow:0 0 0 3px rgba(154,123,60,.08);
}

select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%239a7b3c'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right .9rem center;
  padding-right:2rem;
}

/* ══ BUTTONS ═══════════════════════════════════════════════ */
.btn {
  padding:.65rem 1.3rem;
  border:1px solid transparent;
  border-radius:var(--r-sm);
  font-family:'Outfit', sans-serif;
  font-size:.75rem; font-weight:500;
  letter-spacing:.08em; text-transform:uppercase;
  cursor:pointer;
  transition:all .25s;
  white-space:nowrap;
  display:inline-flex; align-items:center; justify-content:center;
  gap:.4rem;
}

.btn-red {
  background:var(--ink);
  color:var(--cream);
  border-color:var(--ink);
}
.btn-red:hover {
  background:var(--ink2);
  transform:translateY(-1px);
  box-shadow:0 4px 16px rgba(26,26,32,.2);
}
.btn-red:active { transform:translateY(0); }

.btn-gold {
  background:var(--gold);
  color:var(--warm-white);
  border-color:var(--gold);
  box-shadow:0 2px 8px rgba(154,123,60,.2);
}
.btn-gold:hover {
  background:var(--gold-lt);
  border-color:var(--gold-lt);
  transform:translateY(-1px);
  box-shadow:0 4px 16px rgba(154,123,60,.3);
}

.btn-outline {
  background:transparent;
  border-color:var(--rule2);
  color:var(--ink3);
}
.btn-outline:hover {
  border-color:var(--gold);
  color:var(--gold);
  background:var(--gold-wash);
}

.btn-sm { padding:.35rem .75rem; font-size:.66rem; border-radius:var(--r-xs); }
.btn-full { width:100%; }

/* ══ COUPLE TREE ═══════════════════════════════════════════ */
.year-block { margin-bottom:.7rem; }

.year-row {
  display:flex; align-items:center; gap:.5rem;
  padding:.4rem .5rem;
  border-radius:var(--r-sm);
  cursor:pointer; transition:background .15s; user-select:none;
}
.year-row:hover { background:var(--gold-wash); }

.yr-arrow { font-size:.45rem; color:var(--ink5); transition:transform .2s; flex-shrink:0; }
.yr-arrow.open { transform:rotate(90deg); }

.yr-label {
  font-family:'Cormorant Garamond', serif;
  font-size:.88rem; font-weight:400;
  color:var(--ink2); flex:1;
}
.yr-count { font-size:.6rem; color:var(--ink5); }

.year-body { padding-left:.7rem; }
.month-block { margin-bottom:.45rem; }

.month-row {
  font-size:.58rem; font-weight:500;
  text-transform:uppercase; letter-spacing:.16rem;
  color:var(--ink5);
  padding:.22rem .4rem;
  border-bottom:1px solid var(--rule);
  margin-bottom:.3rem;
}

.couple-row {
  display:flex; align-items:center; gap:.4rem;
  padding:.5rem .65rem;
  border-radius:var(--r-md);
  cursor:pointer;
  border:1px solid transparent;
  margin-bottom:.2rem;
  transition:all .2s;
}
.couple-row:hover {
  background:var(--parchment);
  border-color:var(--rule);
}
.couple-row.active {
  background:var(--ink);
  border-color:var(--ink);
}
.couple-row-name {
  flex:1; font-size:.79rem; font-weight:400;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  color:var(--ink2);
  transition:color .2s;
}
.couple-row.active .couple-row-name { color:var(--cream); }

.couple-del {
  background:none; border:none; cursor:pointer;
  color:var(--ink5); font-size:.68rem; padding:0; flex-shrink:0;
  opacity:.5; transition:all .15s;
}
.couple-del:hover { opacity:1; color:var(--ink); }
.couple-row.active .couple-del { color:var(--gold-pale); }
.couple-row.active .couple-del:hover { color:#fff; }

/* ══ MAIN AREA ═════════════════════════════════════════════ */
.main { min-width:0; }

.placeholder {
  text-align:center; padding:10rem 2rem;
  color:var(--ink5);
}
.placeholder .icon { font-size:2.5rem; margin-bottom:1.2rem; opacity:.35; }
.placeholder p {
  font-size:.78rem; font-weight:300;
  letter-spacing:.1rem; text-transform:uppercase;
}

/* ══ COUPLE BAR ════════════════════════════════════════════ */
.couple-bar {
  padding:2rem 2.5rem;
  margin-bottom:2.5rem;
  display:flex; align-items:flex-end; gap:1.5rem;
  border-bottom:1px solid var(--rule);
  position:relative;
}
.couple-bar::after {
  content:'';
  position:absolute; bottom:-1px; left:0; width:80px; height:2px;
  background:var(--gold);
}

.couple-bar-name {
  font-family:'Cormorant Garamond', serif;
  font-size:clamp(1.8rem, 3vw, 2.8rem);
  font-style:italic; font-weight:400;
  flex:1; color:var(--ink);
  line-height:1.15; letter-spacing:-.02em;
}

.couple-bar-date {
  font-size:.65rem; font-weight:300;
  color:var(--ink4); letter-spacing:.16rem;
  text-transform:uppercase;
  padding-bottom:.2rem;
}

/* ══ EVENT SETUP ═══════════════════════════════════════════ */
.setup-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:1.2rem; margin-top:.8rem; }

.setup-card {
  background:var(--warm-white);
  border:1px solid var(--rule);
  border-radius:var(--r-lg);
  padding:1.4rem 1.3rem;
  transition:all .22s;
}
.setup-card:hover {
  border-color:var(--rule2);
  box-shadow:0 4px 20px rgba(26,26,32,.08);
  transform:translateY(-1px);
}

.setup-card-title {
  font-family:'Cormorant Garamond', serif;
  font-size:.85rem; font-weight:400; font-style:italic;
  color:var(--ink2); margin-bottom:.9rem;
}

.inst-tags { display:flex; flex-wrap:wrap; gap:.35rem; margin-bottom:.65rem; }

.inst-tag {
  display:inline-flex; align-items:center; gap:.3rem;
  padding:.22rem .6rem;
  border-radius:var(--r-xs);
  font-size:.64rem; font-weight:500; letter-spacing:.03em;
  background:var(--forest-dim);
  border:1px solid rgba(45,74,62,.15);
  color:var(--forest);
}
.inst-tag.hc {
  background:var(--gold-wash);
  border-color:var(--gold-line);
  color:var(--gold);
}
.inst-tag button {
  background:none; border:none; cursor:pointer;
  color:inherit; font-size:.58rem; padding:0; opacity:.5;
  transition:opacity .15s;
}
.inst-tag button:hover { opacity:1; }

.chip-list { display:flex; flex-wrap:wrap; gap:.3rem; margin-bottom:.65rem; }

.chip {
  display:inline-flex; align-items:center; gap:.22rem;
  padding:.2rem .6rem;
  border-radius:var(--r-xs);
  font-size:.64rem; font-weight:400; letter-spacing:.02em;
  border:1px dashed var(--rule2);
  background:transparent; color:var(--ink4);
  cursor:pointer; transition:all .18s;
  font-family:'Outfit', sans-serif;
}
.chip:hover {
  border-color:var(--gold);
  color:var(--gold);
  border-style:solid;
  background:var(--gold-wash);
}
.chip-count {
  background:var(--gold); color:white;
  border-radius:50%; width:13px; height:13px;
  display:inline-flex; align-items:center; justify-content:center;
  font-size:.5rem; font-weight:600;
}

.custom-row { display:flex; gap:.35rem; }
.custom-row input { font-size:.74rem; padding:.38rem .65rem; min-width:0; flex:1; }

/* ══ VIEW TOGGLE ═══════════════════════════════════════════ */
.view-toggle {
  display:flex; gap:0;
  background:transparent;
  border:1px solid var(--rule2);
  border-radius:var(--r-sm);
  overflow:hidden;
  width:fit-content;
  margin-bottom:2rem;
}

.vbtn {
  padding:.5rem 1.3rem;
  border-radius:0;
  border:none;
  border-right:1px solid var(--rule2);
  font-family:'Outfit', sans-serif;
  font-size:.68rem; font-weight:500; letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
  background:transparent; color:var(--ink4);
  transition:all .2s;
}
.vbtn:last-child { border-right:none; }
.vbtn.active {
  background:var(--ink);
  color:var(--cream);
  border-color:var(--ink);
}

/* ══ CATEGORY GROUPS ═══════════════════════════════════════ */
.cat-group { margin-bottom:3rem; }
.inst-list { display:flex; flex-direction:column; gap:1rem; }

.cat-head { display:flex; align-items:center; gap:1.2rem; margin-bottom:1.2rem; }

.cat-lbl {
  font-family:'Outfit', sans-serif;
  font-size:.55rem; font-weight:700; letter-spacing:.22rem;
  text-transform:uppercase; color:var(--gold);
  white-space:nowrap;
}
.cat-line { flex:1; height:1px; background:linear-gradient(to right, var(--gold-line), var(--rule)); }
.cat-cnt { font-size:.6rem; color:var(--ink5); }

/* ══ EVENT SECTIONS ════════════════════════════════════════ */
.ev-section {
  background:var(--warm-white);
  border:1px solid var(--gold-line);
  border-radius:var(--r-lg);
  overflow:hidden;
  box-shadow:0 1px 4px rgba(26,26,32,.03), 0 4px 24px rgba(154,123,60,.06);
  transition:all .25s;
}
.ev-section:hover {
  border-color:rgba(154,123,60,.3);
  box-shadow:0 2px 10px rgba(154,123,60,.08), 0 8px 32px rgba(26,26,32,.06);
}
.ev-section.drag-over-top { border-top:2px solid var(--gold); }
.ev-section.drag-over-bot { border-bottom:2px solid var(--gold); }
.ev-section.is-dragging { opacity:.3; }

.ev-head { background:linear-gradient(to bottom, rgba(154,123,60,.025), transparent); 
  padding:.85rem 1.4rem .65rem;
  display:flex; flex-direction:column; gap:.55rem;
  border-bottom:1px solid transparent;
  transition:border-color .2s, background .2s;
}
.ev-head-top {
  display:flex; align-items:center; gap:.75rem;
}
.ev-head.open { border-bottom-color:var(--rule); }
.ev-head:hover { background:rgba(26,26,32,.015); }

.ev-drag-handle {
  width:22px; height:36px;
  display:flex; align-items:center; justify-content:center;
  cursor:grab; color:var(--ink5); font-size:.9rem;
  flex-shrink:0; opacity:.4; user-select:none;
  transition:all .15s;
}
.ev-drag-handle:hover { opacity:1; color:var(--gold); }
.ev-drag-handle:active { cursor:grabbing; }

.ev-name-wrap { flex:1; min-width:0; cursor:pointer; }

.ev-name { font-family:'Cormorant Garamond',serif !important; font-size:1.15rem !important; font-weight:600 !important; letter-spacing:.01em !important; 
  font-family:'Cormorant Garamond', serif;
  font-size:1.05rem; font-weight:600; font-style:italic;
  color:var(--ink); letter-spacing:.01em;
}

.ev-client { font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink4); letter-spacing:.03em; 
  font-size:.62rem; color:var(--gold); font-weight:400;
  margin-top:.06rem; min-height:.9em;
  letter-spacing:.06em; text-transform:uppercase;
}

.ev-meta { display:flex; align-items:center; gap:.45rem; }

.pill {
  padding:.15rem .55rem;
  border-radius:var(--r-xs);
  font-size:.6rem; font-weight:500; letter-spacing:.04em;
  text-transform:uppercase;
}
.pill-a { background:var(--forest-dim); color:var(--forest); border:1px solid rgba(45,74,62,.15); }
.pill-u { background:rgba(154,123,60,.08); color:var(--gold); border:1px solid var(--gold-line); }

.chev { color:var(--ink5); font-size:.5rem; transition:transform .22s; cursor:pointer; }
.chev.open { transform:rotate(180deg); }

.rm-inst { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600; letter-spacing:.06em; text-transform:uppercase; 
  background:transparent;
  border:1px solid var(--rule2);
  color:var(--ink4);
  border-radius:var(--r-xs);
  font-size:.6rem; padding:.15rem .5rem;
  cursor:pointer;
  font-family:'Outfit', sans-serif;
  letter-spacing:.04em; text-transform:uppercase;
  transition:all .18s;
}
.rm-inst:hover { border-color:var(--ink3); color:var(--ink); background:var(--parchment); }

/* ── Client row ── */
.cl-row {
  display:flex; align-items:center; gap:.55rem;
  padding:.6rem 1.4rem .5rem;
  background:var(--parchment);
  border-bottom:1px solid var(--rule);
  flex-wrap:wrap;
}
.cl-lbl {
  font-size:.6rem; color:var(--gold);
  font-weight:500; white-space:nowrap;
  letter-spacing:.1em; text-transform:uppercase;
}
.cl-input {
  flex:1; min-width:140px;
  padding:.42rem .75rem!important;
  font-size:.78rem!important;
  border-color:var(--gold-line)!important;
  background:rgba(255,255,255,.8)!important;
  border-radius:var(--r-sm)!important;
  outline:none!important;
}
.cl-input:focus { border-color:var(--gold)!important; box-shadow:0 0 0 3px rgba(154,123,60,.08)!important; }

/* ── Add song row ── */
.song-add {
  padding:.6rem 1.4rem;
  display:flex; gap:.45rem; flex-wrap:wrap;
  border-bottom:1px solid var(--rule);
  background:var(--parchment);
}
.song-add input { min-width:80px; padding:.4rem .7rem; font-size:.76rem; flex:1; }
.song-add .btn { padding:.4rem .85rem; font-size:.68rem; }

/* ── Suggestions ── */
.suggest-wrap { position:relative; flex:1; min-width:80px; }

.suggest-list {
  position:absolute; top:100%; left:0; right:0;
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-top:none;
  border-radius:0 0 var(--r-md) var(--r-md);
  z-index:200; max-height:220px; overflow-y:auto;
  box-shadow:0 12px 32px rgba(26,26,32,.12);
}

.suggest-item {
  padding:.5rem .8rem;
  font-size:.76rem; cursor:pointer;
  border-bottom:1px solid var(--rule);
  color:var(--ink3);
  transition:background .12s;
}
.suggest-item:last-child { border-bottom:none; }
.suggest-item:hover, .suggest-item.active {
  background:var(--parchment);
  color:var(--ink);
}
.sug-title { font-weight:500; color:var(--ink); }
.sug-artist { font-size:.67rem; color:var(--ink5); margin-top:.08rem; }

mark {
  background:rgba(154,123,60,.18);
  color:var(--gold);
  border-radius:2px; font-style:normal; padding:0 1px;
}

/* ── Song list ── */
.song-list { padding:.2rem 0; }

.song-item {
  display:flex; align-items:center; gap:.6rem;
  padding:.6rem 1.4rem .6rem .8rem;
  border-bottom:1px solid var(--rule);
  transition:background .15s;
}
.song-item:last-child { border-bottom:none; }
.song-item:hover { background:rgba(26,26,32,.018); }
.song-item.used { opacity:.35; }
.song-item.drag-over-top { border-top:2px solid var(--gold); }
.song-item.drag-over-bot { border-bottom:2px solid var(--gold); }
.song-item.is-dragging { opacity:.25; }

.song-drag-handle {
  width:18px; height:30px;
  display:flex; align-items:center; justify-content:center;
  cursor:grab; color:var(--ink5); font-size:.8rem;
  flex-shrink:0; opacity:.3; user-select:none;
  transition:opacity .15s;
}
.song-drag-handle:hover { opacity:.7; }
.song-drag-handle:active { cursor:grabbing; }

.ck-btn {
  width:22px; height:22px; border-radius:50%;
  border:1.5px solid var(--rule2);
  background:transparent; cursor:pointer;
  font-size:.68rem;
  display:flex; align-items:center; justify-content:center;
  transition:all .22s; flex-shrink:0; color:var(--ink);
}
.ck-btn:hover { border-color:var(--forest); background:var(--forest-dim); color:var(--forest); }
.ck-btn.on { background:var(--forest); border-color:var(--forest); color:white; }

.s-info { flex:1; min-width:0; }

.s-title {
  font-size:.82rem; font-weight:400;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  color:var(--ink);
}
.s-title.strike { text-decoration:line-through; color:var(--ink5); }
.s-artist { font-size:.68rem; color:var(--ink5); font-weight:300; }
.s-used { font-size:.62rem; color:var(--ink5); font-style:italic; white-space:nowrap; }

.rm-song {
  width:20px; height:20px; border-radius:50%;
  border:1px solid var(--rule2);
  background:transparent; cursor:pointer;
  font-size:.6rem; color:var(--ink5);
  display:flex; align-items:center; justify-content:center;
  transition:all .18s; flex-shrink:0;
}
.rm-song:hover { border-color:var(--ink3); color:var(--ink); background:var(--parchment); }

.empty-ev {
  text-align:center; padding:1.2rem;
  color:var(--ink5); font-size:.72rem;
  font-style:italic; font-weight:300;
  letter-spacing:.06em;
}

/* ══ FLAT / TABLE VIEW ══════════════════════════════════════ */
.flat-wrap {
  background:var(--warm-white);
  border:1px solid var(--rule);
  border-radius:var(--r-xl);
  overflow:hidden;
  box-shadow:0 2px 12px rgba(26,26,32,.06), 0 8px 40px rgba(26,26,32,.06);
}

.flat-head {
  background:var(--parchment);
  border-bottom:1px solid var(--rule);
  padding:1.2rem 1.6rem;
  display:flex; align-items:center; justify-content:space-between;
  gap:.5rem; flex-wrap:wrap;
}
.flat-head h2 {
  font-family:'Cormorant Garamond', serif;
  font-size:1rem; font-weight:400; font-style:italic;
  color:var(--ink);
}

.badge {
  background:var(--cream);
  border:1px solid var(--rule2);
  border-radius:var(--r-xs);
  padding:.2rem .65rem;
  font-size:.65rem; color:var(--ink3); font-weight:400;
  letter-spacing:.04em;
}

table { width:100%; border-collapse:collapse; }

thead th {
  background:var(--parchment);
  padding:.75rem 1rem;
  text-align:left;
  font-size:.58rem; text-transform:uppercase; letter-spacing:.12rem;
  color:var(--ink4); font-weight:500;
  cursor:pointer; user-select:none; white-space:nowrap;
  border-bottom:2px solid var(--rule2);
  transition:color .15s;
}
thead th:hover { color:var(--gold); }
.sort-arrow { font-size:.5rem; margin-left:.3rem; color:var(--gold); }

tbody tr { border-bottom:1px solid var(--rule); transition:background .12s; }
tbody tr:last-child { border-bottom:none; }
tbody tr:hover { background:var(--parchment); }
tbody tr.ur { opacity:.38; }
tbody td { padding:.75rem 1rem; font-size:.8rem; vertical-align:middle; color:var(--ink); font-weight:300; }

.ev-chip {
  display:inline-block; padding:.14rem .5rem;
  border-radius:var(--r-xs); font-size:.62rem; font-weight:500;
  background:var(--gold-wash); color:var(--gold);
  border:1px solid var(--gold-line);
  letter-spacing:.02em;
}

.filter-bar { display:flex; gap:.35rem; flex-wrap:wrap; align-items:center; margin-bottom:1.2rem; }

.fbtn {
  padding:.3rem .8rem; border-radius:var(--r-xs);
  border:1px solid var(--rule2);
  background:transparent;
  font-family:'Outfit', sans-serif; font-size:.65rem;
  cursor:pointer; transition:all .18s;
  color:var(--ink3); font-weight:400; letter-spacing:.05em; text-transform:uppercase;
}
.fbtn.on { background:var(--ink); color:var(--cream); border-color:var(--ink); }
.fbtn:hover:not(.on) { border-color:var(--gold); color:var(--gold); background:var(--gold-wash); }

.search {
  margin-left:auto; padding:.3rem .85rem;
  border:1px solid var(--rule2); border-radius:var(--r-xs);
  font-family:'Outfit', sans-serif; font-size:.68rem;
  outline:none; background:var(--canvas); width:140px;
  transition:all .22s; color:var(--ink); font-weight:300;
}
.search:focus { border-color:var(--gold); width:185px; box-shadow:0 0 0 3px rgba(154,123,60,.07); }

.empty-s { text-align:center; padding:3.5rem; color:var(--ink5); }
.empty-s .ico { font-size:1.8rem; margin-bottom:.6rem; opacity:.3; }

/* ══ MODALS ════════════════════════════════════════════════ */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(26,26,32,.5);
  backdrop-filter:blur(12px) saturate(.9);
  -webkit-backdrop-filter:blur(12px) saturate(.9);
  z-index:500; align-items:center; justify-content:center;
}
.modal-overlay.open { display:flex; }

.modal {
  background:var(--warm-white);
  border:1px solid var(--rule);
  border-radius:var(--r-2xl);
  padding:2.5rem;
  width:min(540px,92vw);
  box-shadow:
    0 2px 8px rgba(26,26,32,.08),
    0 20px 80px rgba(26,26,32,.2),
    0 0 0 1px rgba(255,255,255,.8);
}

.modal h3 {
  font-family:'Cormorant Garamond', serif;
  font-size:1.75rem; font-weight:300; font-style:italic;
  color:var(--ink); margin-bottom:1.4rem;
  letter-spacing:.01em;
}
.modal-actions { display:flex; gap:.65rem; margin-top:1.6rem; justify-content:flex-end; flex-wrap:wrap; }

.modal label {
  font-size:.62rem; color:var(--ink4);
  display:block; margin-bottom:.4rem;
  letter-spacing:.1em; text-transform:uppercase;
  font-weight:500;
}
.modal input[type=text] { margin-bottom:.9rem; }

/* ── Library modal ── */
.lib-modal-inner { width:min(900px,95vw); max-height:88vh; overflow-y:auto; padding:2.5rem; }

/* ── Language tabs ── */
.lang-tabs { display:flex; gap:0; margin-bottom:1.6rem; flex-wrap:wrap; border:1px solid var(--rule2); border-radius:var(--r-sm); overflow:hidden; width:fit-content; }

.lang-tab {
  padding:.45rem 1.2rem;
  border-radius:0;
  border:none;
  border-right:1px solid var(--rule2);
  background:transparent;
  font-family:'Outfit', sans-serif; font-size:.68rem; font-weight:500;
  cursor:pointer; color:var(--ink4); transition:all .2s;
  letter-spacing:.06em; text-transform:uppercase;
}
.lang-tab:last-child { border-right:none; }
.lang-tab.on { background:var(--ink); color:var(--cream); }
.lang-tab:hover:not(.on) { background:var(--parchment); color:var(--ink); }

/* ── Library accordion ── */
.lib-ev-block {
  border:1px solid var(--rule);
  border-radius:var(--r-md);
  margin-bottom:.7rem;
  overflow:hidden;
  transition:border-color .2s;
}
.lib-ev-block:hover { border-color:var(--rule2); }

.lib-ev-head {
  display:flex; align-items:center; gap:.65rem;
  padding:.8rem 1.1rem;
  background:var(--parchment);
  cursor:pointer; user-select:none;
  transition:background .15s;
}
.lib-ev-head:hover { background:var(--cream); }

.lib-ev-title { flex:1; font-size:.82rem; font-weight:400; color:var(--ink2); letter-spacing:.01em; }
.lib-ev-count { font-size:.62rem; color:var(--ink4); }
.lib-ev-chev { font-size:.5rem; color:var(--ink4); transition:transform .2s; }
.lib-ev-chev.open { transform:rotate(180deg); }

.lib-ev-body { padding:.8rem 1.1rem; border-top:1px solid var(--rule); display:none; background:var(--warm-white); }
.lib-ev-body.open { display:block; }

.lib-song-row { display:grid; grid-template-columns:18px 1fr 1fr; gap:.4rem; align-items:center; margin-bottom:.4rem; }
.lib-num { font-size:.62rem; color:var(--ink5); text-align:right; }
.lib-song-row input { font-size:.74rem; padding:.36rem .6rem; }
.lib-song-row input::placeholder { color:var(--ink5); opacity:.7; }

/* ── Lang picker (add row) ── */
.lang-pick { display:flex; gap:0; flex-shrink:0; border:1px solid var(--rule2); border-radius:var(--r-xs); overflow:hidden; }

.lpbtn {
  padding:.3rem .55rem;
  border-radius:0;
  border:none;
  border-right:1px solid var(--rule2);
  background:transparent;
  font-family:'Outfit', sans-serif; font-size:.65rem; font-weight:600;
  cursor:pointer; color:var(--ink4); transition:all .16s; line-height:1;
  letter-spacing:.04em;
}
.lpbtn:last-child { border-right:none; }
.lpbtn.on[data-lang=en] { background:rgba(59,130,246,.12); color:#2563eb; }
.lpbtn.on[data-lang=hi] { background:rgba(234,88,12,.1); color:#c2410c; }
.lpbtn.on[data-lang=pa] { background:rgba(161,98,7,.1); color:#92400e; }
.lpbtn:not(.on):hover { background:var(--parchment); color:var(--ink); }

/* ── Inline song lang picker ── */
.song-lang-pick { display:flex; gap:0; flex-shrink:0; align-items:center; border:1px solid var(--rule); border-radius:var(--r-xs); overflow:hidden; }

.slpbtn {
  padding:.2rem .38rem;
  border-radius:0;
  border:none;
  border-right:1px solid var(--rule);
  background:transparent;
  font-family:'Outfit', sans-serif; font-size:.58rem; font-weight:600;
  cursor:pointer; color:var(--ink5); transition:all .14s; line-height:1;
  letter-spacing:.02em;
}
.slpbtn:last-child { border-right:none; }
.slpbtn.on[data-lang=en] { background:rgba(59,130,246,.1); color:#2563eb; }
.slpbtn.on[data-lang=hi] { background:rgba(234,88,12,.08); color:#c2410c; }
.slpbtn.on[data-lang=pa] { background:rgba(161,98,7,.08); color:#92400e; }
.slpbtn.on[data-lang=inst] { background:rgba(120,80,200,.1); color:#6d28d9; }
.slpbtn:not(.on):hover { background:var(--parchment); color:var(--ink); }
.lang-badge.inst { background:rgba(120,80,200,.08); color:#6d28d9; border:1px solid rgba(120,80,200,.18); }
.lpbtn.on[data-lang=inst] { background:rgba(120,80,200,.12); color:#6d28d9; }

/* ── History rows ── */
.hist-song-row {
  display:flex; align-items:flex-start; gap:.6rem;
  padding:.65rem .6rem;
  border-bottom:1px solid var(--rule);
  transition:background .12s;
}
.hist-song-row:last-child { border-bottom:none; }
.hist-song-row:hover { background:var(--parchment); }

.hist-song-body { flex:1; min-width:0; }
.hist-song-main { display:flex; align-items:baseline; gap:.6rem; margin-bottom:.25rem; }
.hist-song-title { font-size:.8rem; color:var(--ink); font-weight:400; }
.hist-song-artist { font-size:.68rem; color:var(--ink5); font-weight:300; }

.hist-song-meta {
  display:flex; flex-wrap:wrap; align-items:center;
  gap:.45rem; font-size:.64rem;
}
.hist-meta-couple { color:var(--gold); font-weight:500; }
.hist-meta-ev { color:var(--ink3); }
.hist-meta-client { color:var(--gold-lt); font-weight:400; }
.hist-meta-date { color:var(--ink5); font-style:italic; font-weight:300; }

.rm-hist-btn {
  flex-shrink:0; width:18px; height:18px; border-radius:50%;
  border:1px solid var(--rule2);
  background:transparent; cursor:pointer;
  font-size:.55rem; color:var(--ink5);
  display:flex; align-items:center; justify-content:center;
  transition:all .18s; margin-top:.2rem;
}
.rm-hist-btn:hover { border-color:var(--ink3); color:var(--ink); background:var(--cream); }

.hist-empty {
  font-size:.74rem; color:var(--ink5);
  font-style:italic; font-weight:300;
  padding:1rem 0; letter-spacing:.04em;
}

/* ── Language badges ── */
.lang-badge {
  display:inline-block; font-size:.54rem; font-weight:600;
  padding:.06rem .35rem; border-radius:var(--r-xs);
  margin-left:.3rem; vertical-align:middle;
  letter-spacing:.05em; line-height:1.4; text-transform:uppercase;
}
.lang-badge.en { background:rgba(59,130,246,.1); color:#2563eb; border:1px solid rgba(59,130,246,.2); }
.lang-badge.hi { background:rgba(234,88,12,.08); color:#c2410c; border:1px solid rgba(234,88,12,.18); }
.lang-badge.pa { background:rgba(161,98,7,.08); color:#92400e; border:1px solid rgba(161,98,7,.18); }

/* ── Duplicate warning ── */
.dup-banner {
  display:flex; align-items:flex-start; gap:.8rem;
  padding:1rem 1.2rem;
  background:rgba(154,123,60,.06);
  border:1px solid var(--gold-line);
  border-left:3px solid var(--gold);
  border-radius:var(--r-md);
  margin-bottom:1.5rem;
  font-size:.76rem; color:var(--gold);
}
.dup-banner .dup-icon { font-size:1rem; flex-shrink:0; margin-top:.06rem; }
.dup-banner ul { list-style:none; padding:0; margin:.3rem 0 0; }
.dup-banner ul li { padding:.1rem 0; font-size:.72rem; color:var(--ink3); }
.dup-banner ul li strong { color:var(--gold); }

.dup-badge {
  display:inline-block;
  background:var(--gold-wash); color:var(--gold);
  border:1px solid var(--gold-line);
  border-radius:var(--r-xs); font-size:.56rem; font-weight:600;
  padding:.05rem .3rem; margin-left:.35rem;
  vertical-align:middle; letter-spacing:.04em; text-transform:uppercase;
}

/* ══ DASHBOARD ═════════════════════════════════════════════ */
.dash-toolbar {
  display:flex; align-items:center; justify-content:space-between;
  gap:1rem; flex-wrap:wrap;
  margin-bottom:2.5rem;
  padding-bottom:1.5rem;
  border-bottom:1px solid var(--rule);
}
.dash-filters {
  display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;
}
.dash-filters select {
  width:auto !important;
  padding:.5rem .9rem .5rem .8rem;
  font-size:.72rem; font-weight:400;
  color:var(--ink3);
  border-radius:var(--r-sm);
  min-width:120px;
}
.dash-actions { display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; }

.dash-empty {
  text-align:center; padding:8rem 2rem;
  color:var(--ink5);
}
.dash-empty .icon { font-size:3rem; margin-bottom:1.5rem; opacity:.25; }
.dash-empty h2 {
  font-family:'Cormorant Garamond', serif;
  font-size:1.8rem; font-weight:400; font-style:italic;
  color:var(--ink3); margin-bottom:.8rem;
}
.dash-empty p { font-size:.8rem; font-weight:300; color:var(--ink4); line-height:1.8; }

/* Year groups in dashboard */
.dash-year-group { margin-bottom:3.5rem; }
.dash-year-head {
  display:flex; align-items:center; gap:1.2rem;
  margin-bottom:1.6rem;
}
.dash-year-label {
  font-family:'Cormorant Garamond', serif;
  font-size:2rem; font-weight:300; font-style:italic;
  color:var(--ink2); letter-spacing:.03em;
}
.dash-year-line { flex:1; height:1px; background:linear-gradient(to right, var(--gold-line), transparent); }
.dash-year-count {
  font-family:'Cormorant Garamond',serif; font-size:.9rem; font-style:italic;
  color:var(--gold); letter-spacing:.03em;
}

/* Month sub-groups */
.dash-month-group { margin-bottom:2rem; }
.dash-month-label {
  font-family:'Cormorant Garamond',serif; font-size:1rem; font-weight:300;
  font-style:italic; letter-spacing:.08em;
  color:var(--ink4); margin-bottom:1rem;
  display:flex; align-items:center; gap:.6rem;
}
.dash-month-label::after {
  content:''; flex:1; height:1px;
  background:linear-gradient(to right, var(--rule), transparent);
}

/* Couple card grid */
.couple-cards {
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  gap:1.2rem;
}

/* The couple card */
.couple-card {
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-radius:var(--r-xl);
  padding:1.6rem 1.8rem 1.4rem;
  cursor:pointer;
  transition:all .28s;
  position:relative;
  overflow:hidden;
  box-shadow:0 2px 10px rgba(26,26,32,.04), 0 1px 0 rgba(154,123,60,.06);
}
.couple-card::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold-line) 30%, var(--gold) 50%, var(--gold-line) 70%, transparent);
  opacity:0; transition:opacity .3s;
}
.couple-card:hover {
  border-color:var(--gold-line);
  box-shadow:0 6px 24px rgba(154,123,60,.1), 0 2px 8px rgba(26,26,32,.06);
  transform:translateY(-2px);
}
.couple-card:hover::before { opacity:.8; }

.cc-top {
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:.5rem; margin-bottom:1rem;
}
.cc-name {
  font-family:'Cormorant Garamond', serif;
  font-size:1.35rem; font-style:italic; font-weight:600;
  color:var(--ink); line-height:1.2;
  flex:1; letter-spacing:.01em;
}
.cc-del {
  width:24px; height:24px; border-radius:50%;
  border:1px solid var(--rule2); background:transparent;
  cursor:pointer; font-size:.58rem; color:var(--ink5);
  display:flex; align-items:center; justify-content:center;
  transition:all .18s; flex-shrink:0;
  opacity:0;
  transition:opacity .2s, border-color .18s, color .18s;
}
.couple-card:hover .cc-del { opacity:1; }
.cc-del:hover { border-color:var(--ink3); color:var(--ink); background:var(--parchment); }

.cc-date {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  color:var(--ink5); letter-spacing:.14rem;
  text-transform:uppercase; margin-bottom:.85rem;
}

.cc-types {
  display:flex; flex-wrap:wrap; gap:.35rem;
  margin-bottom:1rem;
}
.cc-type-tag {
  font-size:.6rem; font-weight:500;
  padding:.2rem .55rem; border-radius:var(--r-xs);
  letter-spacing:.04em; text-transform:uppercase;
}

.cc-stats {
  display:flex; gap:1.2rem;
  padding-top:.85rem;
  border-top:1px solid var(--rule);
}
.cc-stat { text-align:center; }
.cc-stat-n {
  font-family:'Cormorant Garamond', serif;
  font-size:1.3rem; font-weight:600;
  color:var(--ink2); display:block; line-height:1;
  margin-bottom:.18rem;
}
.cc-stat-l {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:400;
  color:var(--ink5); letter-spacing:.1em;
  text-transform:uppercase;
}

.cc-edit-hint {
  position:absolute; bottom:1.1rem; right:1.4rem;
  font-family:'Cormorant Garamond',serif; font-size:.75rem;
  font-style:italic; font-weight:400; letter-spacing:.03em;
  color:var(--gold);
  opacity:0; transition:opacity .25s;
}
.couple-card:hover .cc-edit-hint { opacity:.85; }

/* ══ EDITOR VIEW ═══════════════════════════════════════════ */
.editor-topbar {
  display:flex; align-items:center; justify-content:space-between;
  gap:1rem; margin-bottom:2.5rem;
  padding-bottom:1.5rem;
  border-bottom:1px solid var(--rule);
  flex-wrap:wrap;
}
.back-btn {
  font-family:'Outfit', sans-serif;
  font-size:.72rem; font-weight:400;
  color:var(--ink4); letter-spacing:.06em;
  background:none; border:none; cursor:pointer;
  padding:.4rem .6rem .4rem 0;
  transition:color .2s;
}
.back-btn:hover { color:var(--gold); }
.editor-tools { display:flex; gap:.6rem; }

.editor-layout {
  display:grid;
  grid-template-columns:280px 1fr 260px;
  gap:2rem;
  align-items:start;
}
@media(max-width:1100px){ .editor-layout{ grid-template-columns:280px 1fr; } }
@media(max-width:900px){ .editor-layout{ grid-template-columns:1fr; } }

.editor-sidebar { position:sticky; top:1.5rem; }

/* Couple card in editor (smaller/info card) */
.couple-info-card {
  background:var(--warm-white);
  border:1px solid var(--rule);
  border-radius:var(--r-xl);
  padding:1.6rem;
  margin-bottom:1.2rem;
  box-shadow:0 2px 12px rgba(26,26,32,.05);
}
.cic-name {
  font-family:'Cormorant Garamond', serif;
  font-size:1.35rem; font-style:italic; font-weight:600;
  color:var(--ink); margin-bottom:.35rem; line-height:1.2; letter-spacing:.01em;
}
.cic-date {
  font-size:.62rem; color:var(--gold); letter-spacing:.12rem;
  text-transform:uppercase; margin-bottom:1rem;
  font-weight:400;
}
.cic-types { display:flex; flex-wrap:wrap; gap:.3rem; margin-bottom:1.2rem; }
.cic-rule { height:1px; background:var(--rule); margin-bottom:1rem; }
.cic-stats { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.2rem; }
.cic-stat { }
.cic-stat-n {
  font-family:'Cormorant Garamond', serif;
  font-size:1.5rem; font-weight:600; color:var(--ink);
  display:block; line-height:1; margin-bottom:.18rem;
}
.cic-stat-l { font-size:.6rem; color:var(--ink5); letter-spacing:.06em; text-transform:uppercase; }

/* ══ WEDDING TYPES ════════════════════════════════════════ */
.wedding-type-grid {
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:.5rem;
  margin-bottom:1rem;
}
.wt-btn {
  padding:.6rem .5rem;
  border:1px solid var(--rule2);
  border-radius:var(--r-md);
  background:var(--canvas);
  cursor:pointer;
  text-align:center;
  transition:all .2s;
  font-family:'Outfit', sans-serif;
}
.wt-btn:hover {
  border-color:var(--rule2);
  background:var(--parchment);
}
.wt-btn.selected {
  border-color:var(--gold);
  background:var(--gold-wash);
}
.wt-icon { font-size:1.3rem; display:block; margin-bottom:.3rem; }
.wt-label {
  font-size:.62rem; font-weight:500;
  letter-spacing:.04em; text-transform:uppercase;
  color:var(--ink3); line-height:1.2;
}
.wt-btn.selected .wt-label { color:var(--gold); }

/* ══ THEMES ════════════════════════════════════════════════ */

[data-theme="dark"] {
  --canvas:    #0e0e12; --parchment: #141418; --cream: #1a1a20; --warm-white:#121216;
  --ink: #ede8e0; --ink2: #ccc6bc; --ink3: #9a968e; --ink4: #6a6660; --ink5: #3e3c38;
  --gold: #c4a05a; --gold-lt: #e8c880; --gold-pale: #6a5230;
  --gold-wash: rgba(196,160,90,.1); --gold-line: rgba(196,160,90,.2);
  --forest: #7aab8a; --forest-lt: #a8ceb8; --forest-dim: rgba(122,171,138,.12);
  --rule: rgba(255,255,255,.07); --rule2: rgba(255,255,255,.12);
}
[data-theme="dark"] .co-dash-hero { background:#0e0e12; }
[data-theme="dark"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(196,160,90,.08) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(122,171,138,.05) 0%, transparent 60%); }
[data-theme="dark"] ::-webkit-scrollbar-track { background:var(--parchment); }
[data-theme="dark"] ::-webkit-scrollbar-thumb { background:var(--gold-pale); }
[data-theme="dark"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23c4a05a'/%3E%3C/svg%3E"); }

[data-theme="rose"] {
  --canvas: #1c0d12; --parchment: #251018; --cream: #2e1420; --warm-white:#18090e;
  --ink: #f5e8ec; --ink2: #dcc4cc; --ink3: #a8848e; --ink4: #7a5860; --ink5: #4a3038;
  --gold: #d4847a; --gold-lt: #e8a89e; --gold-pale: #7a3838;
  --gold-wash: rgba(212,132,122,.1); --gold-line: rgba(212,132,122,.22);
  --forest: #c4849a; --forest-lt: #e0a8b8; --forest-dim: rgba(196,132,154,.12);
  --rule: rgba(245,232,236,.07); --rule2: rgba(245,232,236,.13);
}
[data-theme="rose"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(212,100,100,.1) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(180,80,110,.07) 0%, transparent 60%); }
[data-theme="rose"] ::-webkit-scrollbar-track { background:var(--parchment); }
[data-theme="rose"] ::-webkit-scrollbar-thumb { background:var(--gold-pale); }
[data-theme="rose"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23d4847a'/%3E%3C/svg%3E"); }

[data-theme="sage"] {
  --canvas: #f4f1eb; --parchment: #ece8e0; --cream: #e4dfd4; --warm-white:#f8f6f2;
  --ink: #1e2818; --ink2: #2e3828; --ink3: #4a5840; --ink4: #7a8870; --ink5: #aab8a0;
  --gold: #4a7a55; --gold-lt: #6a9a70; --gold-pale: #c8dac0;
  --gold-wash: rgba(74,122,85,.07); --gold-line: rgba(74,122,85,.18);
  --forest: #3a5e48; --forest-lt: #5a8868; --forest-dim: rgba(58,94,72,.08);
  --rule: rgba(30,40,24,.08); --rule2: rgba(30,40,24,.14);
}
[data-theme="sage"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(74,122,85,.06) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(58,94,72,.04) 0%, transparent 60%); }
[data-theme="sage"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%234a7a55'/%3E%3C/svg%3E"); }

[data-theme="slate"] {
  --canvas: #f0f2f6; --parchment: #e6eaf2; --cream: #dae0ec; --warm-white:#f5f7fb;
  --ink: #0e1828; --ink2: #1e2e48; --ink3: #3a4e6a; --ink4: #6a7e98; --ink5: #a8b8cc;
  --gold: #3a6898; --gold-lt: #5a88b8; --gold-pale: #c0d0e8;
  --gold-wash: rgba(58,104,152,.07); --gold-line: rgba(58,104,152,.18);
  --forest: #2a5870; --forest-lt: #4a7890; --forest-dim: rgba(42,88,112,.08);
  --rule: rgba(14,24,40,.08); --rule2: rgba(14,24,40,.14);
}
[data-theme="slate"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(58,104,152,.07) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(42,88,112,.05) 0%, transparent 60%); }
[data-theme="slate"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233a6898'/%3E%3C/svg%3E"); }

[data-theme="amber"] {
  --canvas: #141210; --parchment: #1c1814; --cream: #241e18; --warm-white:#100e0c;
  --ink: #f5ede0; --ink2: #d8c8b0; --ink3: #a09078; --ink4: #706050; --ink5: #403830;
  --gold: #d4902a; --gold-lt: #e8b058; --gold-pale: #7a5018;
  --gold-wash: rgba(212,144,42,.1); --gold-line: rgba(212,144,42,.22);
  --forest: #c89050; --forest-lt: #e0b070; --forest-dim: rgba(200,144,80,.12);
  --rule: rgba(245,237,224,.07); --rule2: rgba(245,237,224,.12);
}
[data-theme="amber"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(212,144,42,.1) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(200,120,40,.06) 0%, transparent 60%); }
[data-theme="amber"] ::-webkit-scrollbar-track { background:var(--parchment); }
[data-theme="amber"] ::-webkit-scrollbar-thumb { background:var(--gold-pale); }
[data-theme="amber"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23d4902a'/%3E%3C/svg%3E"); }

[data-theme="blush"] {
  --canvas: #faf4f2; --parchment: #f2ebe8; --cream: #e8deda; --warm-white:#fdf8f7;
  --ink: #281618; --ink2: #3e2428; --ink3: #604048; --ink4: #906878; --ink5: #c0a8b0;
  --gold: #a85870; --gold-lt: #c87890; --gold-pale: #e8c0cc;
  --gold-wash: rgba(168,88,112,.07); --gold-line: rgba(168,88,112,.18);
  --forest: #906878; --forest-lt: #b08898; --forest-dim: rgba(144,104,120,.08);
  --rule: rgba(40,22,24,.08); --rule2: rgba(40,22,24,.14);
}
[data-theme="blush"] body::before { background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(168,88,112,.06) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 110%, rgba(144,104,120,.04) 0%, transparent 60%); }
[data-theme="blush"] select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23a85870'/%3E%3C/svg%3E"); }

/* ══ THEME SWITCHER WIDGET ══════════════════════════════════ */
#darkToggleBtn {
  position: fixed;
  bottom: 1.2rem;
  right: 1.2rem;
  width: 2.4rem;
  height: 2.4rem;
  border-radius: 50%;
  background: var(--warm-white);
  border: 1px solid var(--rule);
  box-shadow: 0 2px 8px rgba(0,0,0,.12);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  cursor: pointer;
  z-index: 1000;
  transition: transform .15s;
}
#darkToggleBtn:hover { transform: scale(1.12); }

/* separator line in panel */
.theme-sep { width:20px; height:1px; background:var(--rule2); flex-shrink:0; margin:.1rem 0; }

/* ══ DASHBOARD VIEW MODES ══════════════════════════════════ */
.view-mode-btns {
  display:flex; gap:0;
  border:1px solid var(--rule2);
  border-radius:var(--r-sm);
  overflow:hidden;
}
.vm-btn {
  padding:.42rem .65rem;
  border:none; border-right:1px solid var(--rule2);
  background:transparent; cursor:pointer;
  font-size:.8rem; color:var(--ink4);
  transition:all .18s; line-height:1;
}
.vm-btn:last-child { border-right:none; }
.vm-btn.active { background:var(--ink); color:var(--cream); }
.vm-btn:hover:not(.active) { background:var(--parchment); color:var(--ink); }

/* LIST VIEW */
.couple-list { display:flex; flex-direction:column; gap:.5rem; }
.couple-list-row {
  display:flex; align-items:center; gap:1.2rem;
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-radius:var(--r-md);
  padding:.9rem 1.4rem;
  cursor:pointer;
  transition:all .2s;
  position:relative; overflow:hidden;
}
.couple-list-row::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:2px;
  background:var(--gold-line); transition:background .2s;
}
.couple-list-row:hover {
  border-color:var(--gold-line);
  box-shadow:0 3px 14px rgba(154,123,60,.09);
  transform:translateX(3px);
}
.couple-list-row:hover::before { background:var(--gold); }
.clr-name {
  font-family:'Cormorant Garamond',serif;
  font-size:1.1rem; font-style:italic; font-weight:600;
  color:var(--ink); flex:1; letter-spacing:.01em;
}
.clr-date {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  color:var(--ink5); letter-spacing:.12rem; text-transform:uppercase;
  white-space:nowrap;
}
.clr-stat-n { font-family:'Cormorant Garamond',serif; font-size:1rem; font-weight:600; color:var(--ink2); display:block; line-height:1; }
.clr-stat-l { font-family:'Outfit',sans-serif; font-size:.52rem; color:var(--ink5); letter-spacing:.07em; text-transform:uppercase; }
.clr-types { display:flex; gap:.3rem; flex-wrap:wrap; flex-shrink:0; }
.clr-stats {
  display:flex; gap:1rem; flex-shrink:0;
}
.clr-stat { text-align:center; min-width:2.2rem; }
.clr-stat-n { font-size:.88rem; font-weight:400; color:var(--ink2); display:block; line-height:1; }
.clr-stat-l { font-size:.55rem; color:var(--ink5); letter-spacing:.06em; text-transform:uppercase; }
.clr-actions { display:flex; gap:.4rem; opacity:0; transition:opacity .2s; flex-shrink:0; }
.couple-list-row:hover .clr-actions { opacity:1; }

/* COMPACT VIEW */
.couple-compact { display:flex; flex-direction:column; gap:0; border:1px solid var(--rule2); border-radius:var(--r-lg); overflow:hidden; background:var(--warm-white); box-shadow:0 2px 10px rgba(26,26,32,.04); }
.couple-compact-row {
  display:flex; align-items:center; gap:1rem;
  padding:.72rem 1.2rem;
  border-bottom:1px solid var(--rule);
  cursor:pointer;
  transition:background .15s, border-color .15s;
  position:relative;
}
.couple-compact-row:last-child { border-bottom:none; }
.couple-compact-row:hover { background:var(--gold-wash); }
.ccr-dot { width:6px; height:6px; border-radius:50%; background:var(--gold-line); flex-shrink:0; transition:background .15s; }
.couple-compact-row:hover .ccr-dot { background:var(--gold); }
.ccr-name {
  font-family:'Cormorant Garamond',serif; font-size:.92rem; font-style:italic;
  font-weight:600; color:var(--ink); flex:1;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  letter-spacing:.01em;
}
.ccr-date { font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:300; color:var(--ink5); letter-spacing:.1rem; text-transform:uppercase; white-space:nowrap; }
.ccr-ev { font-family:'Outfit',sans-serif; font-size:.58rem; color:var(--ink5); white-space:nowrap; }
.ccr-actions { display:flex; gap:.3rem; opacity:0; transition:opacity .2s; flex-shrink:0; }
.couple-compact-row:hover .ccr-actions { opacity:1; }

/* ══ EVENT APPROVAL ════════════════════════════════════════ */
.ev-approve-btn {
  display:inline-flex; align-items:center; gap:.4rem;
  padding:.28rem .75rem;
  border-radius:var(--r-xs);
  border:1px solid var(--rule2);
  background:transparent;
  font-family:'Outfit',sans-serif;
  font-size:.62rem; font-weight:500; letter-spacing:.05em; text-transform:uppercase;
  cursor:pointer;
  transition:all .22s;
  white-space:nowrap;
  color:var(--ink4);
}
.ev-approve-btn:hover {
  border-color:var(--forest);
  color:var(--forest);
  background:var(--forest-dim);
}
.ev-approve-btn.approved {
  background:var(--forest-dim);
  border-color:var(--forest);
  color:var(--forest);
}
.ev-approve-btn.approved:hover {
  background:rgba(220,38,38,.06);
  border-color:rgba(220,38,38,.3);
  color:#b91c1c;
}
.ev-section.approved { border-color:rgba(45,74,62,.25); }
.ev-section.approved .ev-head { background:linear-gradient(to right, rgba(45,74,62,.06), transparent); }
.ev-approved-stamp {
  font-size:.58rem; font-weight:600; letter-spacing:.08em; text-transform:uppercase;
  color:var(--forest); opacity:.7;
  display:flex; align-items:center; gap:.3rem;
}

/* ══ EDIT COUPLE MODAL ═════════════════════════════════════ */
/* reuses addCoupleModal styles — no new classes needed */

/* ══ INSTRUMENTAL LANG TAB ════════════════════════════════ */
/* reuses .lang-tab styles */

/* ══ COMPLETE PROJECT STATE ═════════════════════════════════ */
.couple-card.is-complete {
  border-color: rgba(45,74,62,.5);
  background: linear-gradient(160deg, rgba(45,74,62,.07) 0%, rgba(45,74,62,.03) 50%, var(--warm-white) 100%);
  box-shadow: 0 4px 20px rgba(45,74,62,.1), inset 0 0 0 1px rgba(45,74,62,.08);
}
.couple-card.is-complete::before {
  opacity: 1 !important;
  background: var(--forest) !important;
  height: 3px !important;
}
.couple-card.is-complete .cc-name {
  color: var(--forest);
}
.couple-card.is-complete .cc-edit-hint {
  color: var(--forest); opacity:.6;
}
.cc-complete-banner {
  display:flex; align-items:center; justify-content:center; gap:.5rem;
  margin: .5rem -.1rem .1rem;
  padding: .5rem .75rem;
  background: linear-gradient(90deg, rgba(45,74,62,.12), rgba(45,74,62,.07));
  border: 1px solid rgba(45,74,62,.25);
  border-radius: var(--r-sm);
  font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600;
  font-style:italic; letter-spacing:.02em;
  color: var(--forest);
}
.cc-complete-banner-icon { font-size:1rem; }
.cc-complete-stamp {
  display:inline-flex; align-items:center; gap:.35rem;
  font-size:.6rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase;
  color: var(--forest);
  background: rgba(45,74,62,.1);
  border: 1px solid rgba(45,74,62,.25);
  border-radius: 20px;
  padding: .22rem .65rem;
}
/* List + compact complete */
.couple-list-row.is-complete {
  border-left: 3px solid var(--forest);
  background: linear-gradient(90deg, rgba(45,74,62,.05), transparent 40%);
}
.couple-list-row.is-complete .clr-name { color: var(--forest); font-weight:600; }
.couple-compact-row.is-complete {
  background: rgba(45,74,62,.04);
  border-left: 2px solid var(--forest);
}
.couple-compact-row.is-complete .ccr-dot { background: var(--forest) !important; box-shadow: 0 0 0 3px rgba(45,74,62,.15); }
.couple-compact-row.is-complete .ccr-name { color: var(--forest); }

/* ══ COUNTDOWN BADGE SYSTEM ════════════════════════════════ */
/* urgency levels: ok(>30d), soon(15-30d), urgent(8-14d), critical(1-7d), overdue(<0d), complete */

.cd-badge {
  display: inline-flex; align-items: center; gap: .35rem;
  padding: .28rem .65rem;
  border-radius: 20px;
  font-size: .6rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase;
  border: 1px solid transparent;
  white-space: nowrap;
  flex-shrink: 0;
}
/* on grid cards: shown below stats */
.cc-countdown { margin-top: .6rem; }

/* ok — calm green-gold */
.cd-ok     { background:rgba(74,122,85,.08);  border-color:rgba(74,122,85,.2);  color:#2d5e40; }
/* soon — soft amber */
.cd-soon   { background:rgba(180,140,40,.1);  border-color:rgba(180,140,40,.3); color:#7a5500; }
/* urgent — warm orange */
.cd-urgent { background:rgba(200,80,20,.1);   border-color:rgba(200,80,20,.3);  color:#a03000; }
/* critical — vivid red */
.cd-critical{ background:rgba(200,30,30,.1);  border-color:rgba(200,30,30,.35); color:#8b0000; animation: cd-pulse 2s ease-in-out infinite; }
/* overdue — dark red/charcoal */
.cd-overdue { background:rgba(80,10,10,.12);  border-color:rgba(120,20,20,.4);  color:#6b0000; }
/* none set */
.cd-none   { background:var(--gold-wash);     border-color:var(--gold-line);    color:var(--ink4); }

@keyframes cd-pulse {
  0%,100% { opacity:1; }
  50% { opacity:.65; }
}

/* Ring progress for grid cards */
.cd-ring-wrap {
  position: relative;
  width: 42px; height: 42px;
  flex-shrink: 0;
}
.cd-ring-svg { transform: rotate(-90deg); }
.cd-ring-track { fill:none; stroke:var(--rule); stroke-width:3; }
.cd-ring-fill  { fill:none; stroke-width:3; stroke-linecap:round; transition:stroke-dashoffset .6s ease, stroke .4s; }
.cd-ring-text {
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  line-height:1;
}
.cd-ring-days { font-size:.65rem; font-weight:700; color:var(--ink2); }
.cd-ring-lbl  { font-size:.42rem; font-weight:500; letter-spacing:.06em; text-transform:uppercase; color:var(--ink5); margin-top:.1rem; }

/* Grid card countdown row */
.cc-cd-row {
  display: flex; align-items: center; gap: .75rem;
  margin-top: .65rem;
  padding-top: .65rem;
  border-top: 1px solid var(--rule);
}
.cc-cd-info { flex:1; min-width:0; }
.cc-cd-label {
  font-size:.58rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase;
  margin-bottom:.12rem;
}
.cc-cd-date { font-size:.62rem; color:var(--ink4); }

/* Sidebar countdown block */
.cic-countdown {
  margin-top:.8rem; padding:.8rem 1rem;
  border-radius:var(--r-md);
  display:flex; align-items:center; gap:.9rem;
}
.cic-countdown.cd-ok     { background:rgba(74,122,85,.08);  border:1px solid rgba(74,122,85,.2); }
.cic-countdown.cd-soon   { background:rgba(180,140,40,.08); border:1px solid rgba(180,140,40,.2); }
.cic-countdown.cd-urgent { background:rgba(200,80,20,.08);  border:1px solid rgba(200,80,20,.25); }
.cic-countdown.cd-critical{ background:rgba(200,30,30,.08); border:1px solid rgba(200,30,30,.3); animation:cd-pulse 2s infinite; }
.cic-countdown.cd-overdue { background:rgba(80,10,10,.1);   border:1px solid rgba(120,20,20,.35); }
.cic-countdown.cd-none   { background:var(--gold-wash);     border:1px solid var(--gold-line); }
.cic-cd-days { font-size:2rem; font-weight:300; font-family:'Cormorant Garamond',serif; font-style:italic; line-height:1; letter-spacing:-.01em; }
.cic-cd-right { flex:1; min-width:0; }
.cic-cd-lbl  { font-size:.58rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; margin-bottom:.15rem; }
.cic-cd-date { font-size:.68rem; color:var(--ink4); }

/* compact/list inline badge */
.ccr-cd { flex-shrink:0; }
.clr-cd { flex-shrink:0; }

/* ══ EDITOR BADGE ON CARDS ════════════════════════════════ */
.cc-editors {
  display:flex; flex-wrap:wrap; gap:.3rem;
  margin-top:.45rem;
}
.cc-editor-chip {
  display:inline-flex;align-items:center;gap:.2rem;
}
.cc-editor-pic {
  width:14px;height:14px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;
  background:var(--gold);color:#fff;font-size:.4rem;font-weight:700;flex-shrink:0;
}
.cc-editor-pic img { width:100%;height:100%;object-fit:cover; }
  display:inline-flex; align-items:center; gap:.25rem;
  font-size:.58rem; font-weight:600; letter-spacing:.04em;
  background:var(--gold-wash); border:1px solid var(--gold-line);
  color:var(--ink3); border-radius:20px; padding:.2rem .55rem;
}
.cc-complete-date {
  font-size:.58rem; color:var(--forest); font-weight:500;
  letter-spacing:.03em; margin-top:.25rem;
  display:flex; align-items:center; gap:.3rem;
}

/* ══ EVENT PRODUCTION INFO ═════════════════════════════════ */
.ev-prod-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:.55rem;
  margin:.8rem 0; padding:.9rem 1.1rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
}
.ev-prod-field { display:flex; flex-direction:column; gap:.28rem; }
.ev-prod-field.full { grid-column:1/-1; }
.ev-prod-label {
  font-size:.57rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase;
  color:var(--ink4);
}
.ev-prod-input {
  font-family:'Outfit',sans-serif; font-size:.8rem; font-weight:300; color:var(--ink);
  background:var(--warm-white); border:1px solid var(--rule2); border-radius:var(--r-xs);
  padding:.4rem .65rem; outline:none; transition:border-color .18s;
  width:100%; box-sizing:border-box;
}
.ev-prod-input:focus { border-color:var(--gold); }
.ev-prod-time { display:flex; align-items:center; gap:.5rem; }
.ev-prod-time span { font-size:.7rem; color:var(--ink4); }

/* ══ NOTES SECTION ══════════════════════════════════════════ */
.ev-notes-section {
  margin:.8rem 0;
  padding:.9rem 1.1rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
}
.ev-notes-label {
  font-size:.58rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase;
  color:var(--ink4); margin-bottom:.55rem; display:flex; align-items:center; gap:.35rem;
}
.ev-notes-textarea {
  font-family:'Outfit',sans-serif; font-size:.8rem; font-weight:300; color:var(--ink);
  line-height:1.6; background:var(--warm-white);
  border:1px solid var(--rule2); border-radius:var(--r-xs);
  padding:.55rem .75rem; outline:none; transition:border-color .18s;
  width:100%; box-sizing:border-box; resize:vertical; min-height:72px;
}
.ev-notes-textarea:focus { border-color:var(--gold); }
.ev-notes-textarea::placeholder { color:var(--ink5); font-style:italic; }

/* ══ SONG CHANGE LOG ═════════════════════════════════════════ */
.ev-changelog-section {
  margin:.8rem 0;
}
.ev-changelog-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:.65rem .9rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
  cursor:pointer; transition:background .18s;
  user-select:none;
}
.ev-changelog-head:hover { background:var(--gold-wash); }
.ev-changelog-title {
  font-size:.6rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase;
  color:var(--ink4); display:flex; align-items:center; gap:.4rem;
}
.ev-changelog-count {
  font-size:.62rem; color:var(--gold); font-weight:600;
}
.ev-changelog-btn {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:600; letter-spacing:.05em;
  padding:.25rem .65rem; border-radius:var(--r-xs);
  border:1px solid var(--gold-line); background:transparent;
  color:var(--ink3); cursor:pointer; transition:all .18s; text-transform:uppercase;
}
.ev-changelog-btn:hover { background:var(--gold-wash); border-color:var(--gold); color:var(--ink); }
.ev-changelog-body {
  display:none; padding:.8rem .9rem;
  border:1px solid var(--rule); border-top:none;
  border-radius:0 0 var(--r-md) var(--r-md);
  background:var(--warm-white);
}
.ev-changelog-body.open { display:block; }
.ev-changelog-entry {
  padding:.7rem 0;
  border-bottom:1px solid var(--rule);
}
.ev-changelog-entry:last-child { border-bottom:none; }
.ev-changelog-entry-head {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:.45rem;
}
.ev-changelog-date {
  font-size:.58rem; font-weight:600; letter-spacing:.06em; text-transform:uppercase;
  color:var(--gold);
}
.ev-changelog-note-text {
  font-size:.68rem; color:var(--ink4); font-style:italic; margin-bottom:.45rem;
}
.ev-changelog-songs {
  display:flex; flex-direction:column; gap:.2rem;
}
.ev-changelog-song {
  display:flex; align-items:baseline; gap:.5rem;
  font-size:.76rem; color:var(--ink3);
}
.ev-changelog-song-num {
  font-size:.55rem; color:var(--ink5); min-width:16px; text-align:right; flex-shrink:0;
}
.ev-changelog-song-title { color:var(--ink2); font-weight:400; }
.ev-changelog-song-artist { color:var(--ink5); font-size:.65rem; }
.ev-changelog-empty {
  font-size:.72rem; color:var(--ink5); font-style:italic; padding:.4rem 0;
}
.ev-cl-snapshot-wrap {
  display:flex; align-items:center; gap:.7rem; padding-top:.5rem;
}
.ev-cl-note-input {
  flex:1; font-family:'Outfit',sans-serif; font-size:.75rem; color:var(--ink);
  background:var(--parchment); border:1px solid var(--rule2); border-radius:var(--r-xs);
  padding:.35rem .6rem; outline:none; transition:border-color .18s;
}
.ev-cl-note-input:focus { border-color:var(--gold); }
.ev-cl-note-input::placeholder { color:var(--ink5); font-style:italic; }

/* ══ RANDOM SONG PICKER ════════════════════════════════════ */
.rand-btn {
  font-family:'Outfit',sans-serif; font-size:.68rem; font-weight:600;
  letter-spacing:.04em; padding:.42rem .8rem; border-radius:var(--r-xs);
  border:1px solid var(--gold-line); background:var(--gold-wash);
  color:var(--ink3); cursor:pointer; transition:all .22s;
  display:inline-flex; align-items:center; gap:.35rem; flex-shrink:0;
  white-space:nowrap;
}
.rand-btn:hover { background:var(--gold-line); color:var(--ink); transform:scale(1.03); }
.rand-btn:active { transform:scale(.97); }

.rand-reveal {
  margin:.55rem 0 .2rem;
  padding:.7rem 1rem;
  background:linear-gradient(135deg, rgba(154,123,60,.08), rgba(45,74,62,.05));
  border:1px solid var(--gold-line); border-radius:var(--r-md);
  display:flex; align-items:center; gap:.8rem;
  animation: randPop .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes randPop {
  from { opacity:0; transform:scale(.94) translateY(4px); }
  to   { opacity:1; transform:scale(1)   translateY(0);   }
}
.rand-dice { font-size:1.3rem; flex-shrink:0; animation: randSpin .35s ease; }
@keyframes randSpin { from{transform:rotate(-40deg);} to{transform:rotate(0deg);} }
.rand-info { flex:1; min-width:0; }
.rand-title {
  font-family:'Cormorant Garamond',serif; font-size:1rem; font-style:italic;
  color:var(--ink); font-weight:600; margin-bottom:.1rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.rand-artist { font-size:.68rem; color:var(--ink4); }
.rand-src { font-size:.55rem; color:var(--ink5); text-transform:uppercase; letter-spacing:.07em; }
.rand-actions { display:flex; gap:.4rem; flex-shrink:0; }
.rand-add-btn {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  letter-spacing:.06em; text-transform:uppercase;
  padding:.32rem .65rem; border-radius:var(--r-xs);
  border:1px solid var(--forest); background:transparent;
  color:var(--forest); cursor:pointer; transition:all .18s;
}
.rand-add-btn:hover { background:var(--forest); color:#fff; }
.rand-skip-btn {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:500;
  padding:.32rem .6rem; border-radius:var(--r-xs);
  border:1px solid var(--rule2); background:transparent;
  color:var(--ink5); cursor:pointer; transition:all .18s;
}
.rand-skip-btn:hover { border-color:var(--gold); color:var(--ink3); }

/* ══ INLINE EVENT NAME EDIT ════════════════════════════════ */
.ev-name-edit-wrap {
  display:flex; align-items:center; gap:.4rem; flex:1; min-width:0;
}
.ev-name-edit-input {
  font-family:'Cormorant Garamond',serif; font-size:.88rem; font-style:italic;
  color:var(--ink); background:transparent;
  border:none; border-bottom:1px solid var(--gold);
  outline:none; padding:.1rem .2rem;
  width:100%; max-width:220px;
}
.ev-name-pencil {
  font-size:.7rem; cursor:pointer; color:var(--ink5); opacity:0;
  transition:opacity .2s; flex-shrink:0; padding:.1rem .3rem;
  border-radius:var(--r-xs);
}
.ev-head:hover .ev-name-pencil { opacity:1; }
.ev-name-pencil:hover { color:var(--gold); background:var(--gold-wash); }

/* ══ EDITOR FILTER / DASHBOARD BANNER ═════════════════════ */
.editor-filter-bar {
  display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;
  padding:.6rem .9rem; margin-bottom:.8rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
  font-size:.7rem;
}
.editor-filter-label { color:var(--ink4); font-weight:600; letter-spacing:.06em; text-transform:uppercase; font-size:.58rem; }
.editor-chip {
  display:inline-flex; align-items:center; gap:.3rem;
  padding:.25rem .6rem; border-radius:20px;
  border:1px solid var(--rule2); background:var(--warm-white);
  cursor:pointer; font-size:.65rem; color:var(--ink3);
  transition:all .18s;
}
.editor-chip.on { background:var(--ink); color:var(--warm-white); border-color:var(--ink); }
.editor-chip:hover:not(.on) { border-color:var(--rule2); background:var(--parchment); }

/* ══ TOAST ── */
.toast {
  position:fixed; bottom:2.5rem; left:50%;
  transform:translateX(-50%) translateY(120px);
  background:var(--ink);
  color:var(--cream);
  padding:.7rem 1.6rem;
  border-radius:var(--r-sm);
  font-size:.72rem; font-weight:400;
  letter-spacing:.06em; text-transform:uppercase;
  transition:transform .32s cubic-bezier(.34,1.56,.64,1);
  z-index:999; white-space:nowrap; pointer-events:none;
  box-shadow:0 8px 40px rgba(26,26,32,.25);
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* ══ COMPANY LOGIN PAGE ═══════════════════════════════════ */
#loginView {
  position:fixed; inset:0; z-index:2000;
  background:var(--canvas);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:2rem;
}
.login-header { text-align:center; margin-bottom:2.8rem; }
.login-title { font-family:'Cormorant Garamond',serif; font-size:2.6rem; font-weight:300; font-style:italic; color:var(--ink); margin:0 0 .3rem; letter-spacing:.02em; }
.login-title em { font-style:italic; color:var(--gold); }
.login-sub { font-family:'Outfit',sans-serif; font-size:.7rem; font-weight:300; letter-spacing:.22em; text-transform:uppercase; color:var(--ink4); }
.login-rule { width:36px; height:1px; background:var(--gold-line); margin:.75rem auto; }
.login-tagline { font-family:'Cormorant Garamond',serif; font-style:italic; font-size:.82rem; color:var(--ink5); }
.login-label { font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:600; letter-spacing:.14em; text-transform:uppercase; color:var(--ink4); margin-bottom:1rem; text-align:center; }
.company-grid { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; max-width:680px; width:100%; }
.company-card {
  background:var(--warm-white); border:1px solid var(--rule2); border-radius:var(--r-lg);
  padding:1.6rem 1.8rem; min-width:175px; flex:1; max-width:215px;
  cursor:pointer; text-align:center; transition:border-color .18s, transform .18s, box-shadow .18s;
  position:relative; overflow:hidden; user-select:none;
}
.company-card:hover { border-color:var(--gold-line); transform:translateY(-3px); box-shadow:0 8px 28px rgba(0,0,0,.08); }
.company-card:active { transform:translateY(-1px); }
.company-card-icon { font-size:1.9rem; display:block; margin-bottom:.65rem; }
.company-card-name { font-family:'Cormorant Garamond',serif; font-size:1.05rem; font-weight:600; font-style:italic; color:var(--ink); line-height:1.3; letter-spacing:.01em; }
.company-card-hint { font-family:'Outfit',sans-serif; font-size:.58rem; letter-spacing:.1em; text-transform:uppercase; color:var(--ink5); margin-top:.3rem; }
.company-card.add-new { border-style:dashed; }
.company-card.add-new:hover { border-color:var(--gold-line); background:var(--gold-wash); }
.company-card.add-new .company-card-icon { font-size:1.5rem; color:var(--ink5); }
.co-delete-btn {
  position:absolute; top:6px; right:6px; width:20px; height:20px; border-radius:50%;
  border:1px solid rgba(220,38,38,.2); background:rgba(220,38,38,.06); color:#dc2626;
  font-size:.55rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
  opacity:0; transition:opacity .15s; z-index:2;
}
.company-card:hover .co-delete-btn { opacity:1; }
.co-delete-btn:hover { background:rgba(220,38,38,.15); border-color:rgba(220,38,38,.4); }
.login-footer { margin-top:2rem; font-family:'Outfit',sans-serif; font-size:.58rem; letter-spacing:.12em; text-transform:uppercase; color:var(--ink5); text-align:center; }

/* Background colour swatches */
.bg-swatch {
  width:28px; height:28px; border-radius:50%; border:2px solid var(--rule2);
  cursor:pointer; transition:transform .15s, border-color .15s, box-shadow .15s;
  position:relative; padding:0; outline:none;
}
.bg-swatch:hover { transform:scale(1.15); border-color:var(--gold); }
.bg-swatch.active { border-color:var(--gold); box-shadow:0 0 0 3px rgba(154,123,60,.25); transform:scale(1.1); }
.bg-swatch-custom {
  display:inline-flex; align-items:center; justify-content:center;
  font-size:.7rem; background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red) !important;
  overflow:hidden;
}

/* Auth login */
#authScreen {
  position:fixed;inset:0;z-index:2100;background:var(--canvas);
  display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;
}
.auth-box { max-width:320px;width:100%;text-align:center; }
.auth-box .login-header { margin-bottom:1.8rem; }
.auth-input {
  width:100%;font:inherit;font-size:.85rem;color:var(--ink);
  background:var(--parchment);border:1px solid var(--rule2);border-radius:var(--r-sm);
  padding:.6rem .9rem;outline:none;box-sizing:border-box;margin-bottom:.6rem;
  transition:border-color .15s;
}
.auth-input:focus { border-color:var(--gold); }
.auth-btn {
  width:100%;padding:.65rem;border:none;border-radius:var(--r-sm);
  background:var(--gold);color:#fff;font:600 .78rem/1.4 'Outfit',sans-serif;
  letter-spacing:.04em;cursor:pointer;margin-top:.3rem;transition:opacity .15s;
}
.auth-btn:hover { opacity:.85; }
.auth-error { font-size:.7rem;color:#dc2626;margin-top:.4rem;min-height:1rem; }
.auth-user-badge {
  position:fixed;top:8px;right:12px;z-index:9999;display:flex;align-items:center;gap:.4rem;
  background:var(--card);border:1px solid var(--rule);border-radius:20px;padding:.2rem .5rem .2rem .3rem;
  font:.55rem/1.4 'Outfit',sans-serif;color:var(--muted);cursor:pointer;transition:box-shadow .15s;
}
.auth-user-badge:hover { box-shadow:0 2px 8px rgba(0,0,0,.1); }
.auth-user-badge .badge-avatar {
  width:20px;height:20px;border-radius:50%;background:var(--gold);color:#fff;
  display:flex;align-items:center;justify-content:center;font-size:.5rem;font-weight:700;
  overflow:hidden; flex-shrink:0;
}
.auth-user-badge .badge-avatar img {
  width:100%;height:100%;object-fit:cover;
}
.auth-user-badge .badge-name { font-weight:600;color:var(--ink); }
.auth-user-badge .badge-role { opacity:.6; }

/* Editor read-only modal */
.ev-modal-box.editor-readonly [data-panel="status"] .ev-panel-body,
.ev-modal-box.editor-readonly [data-panel="info"] .ev-panel-body,
.ev-modal-box.editor-readonly [data-panel="vendor"] .ev-panel-body {
  pointer-events:none; opacity:.7;
}
.ev-modal-box.editor-readonly [data-panel="status"] .ev-panel-body::after,
.ev-modal-box.editor-readonly [data-panel="info"] .ev-panel-body::after,
.ev-modal-box.editor-readonly [data-panel="vendor"] .ev-panel-body::after {
  content:'🔒 Read only'; display:block; text-align:center;
  font:.5rem/2 'Outfit',sans-serif; letter-spacing:.08em; text-transform:uppercase;
  color:var(--ink5); margin-top:.3rem;
}
.ev-modal-box.editor-readonly .ev-svc-prompt,
.ev-modal-box.editor-readonly .ev-svc-bar,
.ev-modal-box.editor-readonly .rm-inst,
.ev-modal-box.editor-readonly .ev-panel-drag-handle,
.ev-modal-box.editor-readonly [data-panel="cl"] .ev-panel-body button { display:none !important; }
.ev-modal-box.editor-readonly [data-panel="status"] input,
.ev-modal-box.editor-readonly [data-panel="status"] select,
.ev-modal-box.editor-readonly [data-panel="status"] button,
.ev-modal-box.editor-readonly [data-panel="info"] input,
.ev-modal-box.editor-readonly [data-panel="info"] select,
.ev-modal-box.editor-readonly [data-panel="info"] textarea,
.ev-modal-box.editor-readonly [data-panel="vendor"] input,
.ev-modal-box.editor-readonly [data-panel="vendor"] select,
.ev-modal-box.editor-readonly [data-panel="vendor"] button {
  pointer-events:none !important; opacity:.6;
}
/* Hide services toggle and header bar for editors */
.ev-modal-box.editor-readonly .ev-svc-btn { pointer-events:none !important; opacity:.7; }
.ev-modal-box.editor-readonly .ev-svc-count { display:none; }

/* User management modal */
.users-overlay {
  position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:3100;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .18s;
}
.users-overlay.open { opacity:1;pointer-events:all; }
.users-box {
  background:var(--warm-white);border-radius:var(--r-xl);padding:1.6rem 1.8rem;
  max-width:460px;width:94%;box-shadow:0 20px 60px rgba(0,0,0,.18);max-height:80vh;overflow-y:auto;
}
.users-title { font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:300;font-style:italic;color:var(--ink);margin:0 0 1rem; }
.users-table { width:100%;border-collapse:collapse;font-size:.72rem; }
.users-table th { text-align:left;padding:.3rem .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.03em;color:var(--muted);border-bottom:1px solid var(--rule); }
.users-table td { padding:.4rem .4rem;border-bottom:1px solid rgba(0,0,0,.04); }
.users-table .u-role { font-size:.6rem;padding:.15rem .4rem;border-radius:10px;font-weight:600; }
.users-table .u-role.admin { background:rgba(220,38,38,.08);color:#b91c1c; }
.users-table .u-role.editor { background:rgba(37,99,235,.08);color:#1d4ed8; }
.users-table .u-role.editorplus { background:rgba(154,123,60,.12);color:#9a7b3c; }
.users-add { display:flex;gap:.4rem;margin-top:.8rem;flex-wrap:wrap; }
.users-add input,.users-add select { font:inherit;font-size:.72rem;padding:.35rem .5rem;border:1px solid var(--rule);border-radius:5px;background:var(--card); }
.users-add input { flex:1;min-width:80px; }
.users-add select { width:auto; }

/* New-company modal */
.new-co-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.48); z-index:3000;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .18s;
}
.new-co-overlay.open { opacity:1; pointer-events:all; }
.new-co-box {
  background:var(--warm-white); border-radius:var(--r-xl);
  padding:1.8rem 2rem; max-width:360px; width:92%;
  box-shadow:0 20px 60px rgba(0,0,0,.18);
  transform:translateY(10px); transition:transform .2s;
}
.new-co-overlay.open .new-co-box { transform:translateY(0); }
.new-co-title { font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:300; font-style:italic; color:var(--ink); margin:0 0 1.1rem; letter-spacing:.02em; }
.new-co-lbl { font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--ink4); display:block; margin-bottom:.35rem; margin-top:.7rem; }
.new-co-lbl:first-of-type { margin-top:0; }
.new-co-inp {
  width:100%; font-family:'Outfit',sans-serif; font-size:.86rem; color:var(--ink);
  background:var(--parchment); border:1px solid var(--rule2); border-radius:var(--r-sm);
  padding:.55rem .8rem; outline:none; transition:border-color .15s; box-sizing:border-box;
}
.new-co-inp:focus { border-color:var(--gold); }
.new-co-btns { display:flex; gap:.5rem; justify-content:flex-end; margin-top:1.1rem; }

/* ══ DASHBOARD INTEL PANELS ══════════════════════════════ */
.dash-panels {
  display:grid; grid-template-columns:1fr 1fr; gap:1rem;
  margin:0 0 1.4rem; padding:0;
}
@media(max-width:720px){ .dash-panels { grid-template-columns:1fr; } }

.intel-panel {
  background:var(--warm-white); border:1px solid var(--rule2);
  border-radius:var(--r-lg); padding:1.1rem 1.2rem; overflow:hidden;
  position:relative;
  box-shadow:0 2px 10px rgba(26,26,32,.04);
}
.intel-panel::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold-line) 40%, var(--gold-line) 60%, transparent);
}
.intel-panel-head {
  display:flex; align-items:baseline; justify-content:space-between;
  margin-bottom:.75rem; padding-bottom:.55rem; border-bottom:1px solid var(--rule);
}
.intel-panel-title {
  font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600;
  font-style:italic; letter-spacing:.02em; color:var(--ink3);
}
.intel-panel-count {
  font-family:'Cormorant Garamond',serif; font-size:.8rem; font-style:italic;
  color:var(--gold);
}
.intel-empty {
  font-family:'Cormorant Garamond',serif; font-style:italic;
  font-size:.75rem; color:var(--ink5); text-align:center; padding:.6rem 0;
}

/* Editor rows */
.editor-row {
  display:flex; align-items:flex-start; gap:.65rem;
  padding:.5rem 0; border-bottom:1px solid var(--rule);
}
.editor-row:last-child { border-bottom:none; }
.editor-avatar {
  width:28px; height:28px; border-radius:50%;
  background:var(--gold-wash); border:1px solid var(--gold-line);
  display:flex; align-items:center; justify-content:center;
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  color:var(--gold); flex-shrink:0; overflow:hidden;
}
.editor-avatar img { width:100%;height:100%;object-fit:cover; }
}
.editor-info { flex:1; min-width:0; }
.editor-name {
  font-family:'Outfit',sans-serif; font-size:.75rem; font-weight:600;
  color:var(--ink2); margin-bottom:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.editor-projects { display:flex; flex-wrap:wrap; gap:.3rem; }
.editor-proj-chip {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:500;
  background:var(--parchment); border:1px solid var(--rule2);
  border-radius:20px; padding:.15rem .5rem; color:var(--ink3);
  cursor:pointer; transition:border-color .15s;
}
.editor-proj-chip:hover { border-color:var(--gold-line); color:var(--ink); }

/* Shoot rows */
.shoot-row {
  display:flex; align-items:flex-start; gap:.65rem;
  padding:.5rem 0; border-bottom:1px solid var(--rule);
}
.shoot-row:last-child { border-bottom:none; }
.shoot-date-badge {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-width:38px; height:38px; border-radius:var(--r-sm);
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.18);
  flex-shrink:0;
}
.shoot-date-badge.overdue { background:rgba(220,38,38,.08); border-color:rgba(220,38,38,.22); }
.shoot-date-badge.soon    { background:rgba(245,158,11,.1);  border-color:rgba(245,158,11,.28); }
.shoot-date-day   { font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600; line-height:1; color:var(--forest); }
.shoot-date-badge.overdue .shoot-date-day { color:#b91c1c; }
.shoot-date-badge.soon    .shoot-date-day { color:#92400e; }
.shoot-date-mon   { font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--forest-lt); }
.shoot-date-badge.overdue .shoot-date-mon { color:#c81e1e; }
.shoot-date-badge.soon    .shoot-date-mon { color:#b45309; }
.shoot-info       { flex:1; min-width:0; }
.shoot-couple     { font-family:'Cormorant Garamond',serif; font-size:.9rem; font-weight:600; font-style:italic; color:var(--ink2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; }
.shoot-couple:hover { color:var(--gold); }
.shoot-event      { font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink4); margin-top:.1rem; }
.shoot-crew       { display:flex; flex-wrap:wrap; gap:.3rem; margin-top:.3rem; }
.shoot-crew-chip  {
  font-family:'Outfit',sans-serif; font-size:.57rem; font-weight:500;
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.18);
  border-radius:20px; padding:.12rem .45rem; color:var(--forest);
}
.shoot-days-away  { font-family:'Outfit',sans-serif; font-size:.56rem; color:var(--ink5); white-space:nowrap; flex-shrink:0; margin-top:.25rem; }

/* ══ EDITOR ASSIGN PANEL ══════════════════════════════════ */
.editor-status-group { margin-top:.5rem; }
.editor-status-group:first-child { margin-top:0; }
.editor-status-label {
  font-family:'Outfit',sans-serif; font-size:.54rem; font-weight:700;
  letter-spacing:.11em; text-transform:uppercase; padding:.12rem .5rem;
  border-radius:20px; display:inline-block; margin-bottom:.35rem;
}
.editor-status-label.new     { background:rgba(45,74,62,.12); color:var(--forest); border:1px solid rgba(45,74,62,.22); }
.editor-status-label.changes { background:rgba(234,88,12,.1);  color:#c2410c;       border:1px solid rgba(234,88,12,.25); }
.editor-proj-chip.new     { border-color:rgba(45,74,62,.25);  background:rgba(45,74,62,.07);  color:var(--forest); }
.editor-proj-chip.changes { border-color:rgba(234,88,12,.28); background:rgba(234,88,12,.07); color:#b45309; }
.editor-proj-chip .chip-status-dot {
  display:inline-block; width:5px; height:5px; border-radius:50%;
  margin-right:.3rem; flex-shrink:0;
}
.chip-status-dot.new     { background:var(--forest); }
.chip-status-dot.changes { background:#c2410c; }

.panel-assign-btn {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  letter-spacing:.06em; text-transform:uppercase;
  background:transparent; border:1px dashed var(--rule2);
  border-radius:20px; padding:.2rem .65rem; color:var(--ink5);
  cursor:pointer; transition:all .15s; margin-top:.45rem; display:inline-block;
}
.panel-assign-btn:hover { border-color:var(--gold-line); color:var(--gold); }

/* Assign modal */
.assign-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.48); z-index:2500;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .18s;
}
.assign-overlay.open { opacity:1; pointer-events:all; }
.assign-box {
  background:var(--warm-white); border-radius:var(--r-xl);
  padding:1.6rem 1.8rem; max-width:440px; width:94%;
  box-shadow:0 20px 60px rgba(0,0,0,.18);
  transform:translateY(10px); transition:transform .2s; max-height:90vh; overflow-y:auto;
}
.assign-overlay.open .assign-box { transform:translateY(0); }
.assign-title { font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:300; font-style:italic; color:var(--ink); margin:0 0 1.1rem; letter-spacing:.02em; }
.assign-lbl {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; color:var(--ink4);
  display:block; margin-bottom:.35rem; margin-top:.8rem;
}
.assign-lbl:first-of-type { margin-top:0; }
.assign-sel, .assign-inp {
  width:100%; font-family:'Outfit',sans-serif; font-size:.84rem; color:var(--ink);
  background:var(--parchment); border:1px solid var(--rule2); border-radius:var(--r-sm);
  padding:.55rem .8rem; outline:none; transition:border-color .15s; box-sizing:border-box;
}
.assign-sel:focus, .assign-inp:focus { border-color:var(--gold); }
.assign-status-row { display:flex; gap:.6rem; margin-top:.1rem; }
.assign-status-btn {
  flex:1; font-family:'Outfit',sans-serif; font-size:.72rem; font-weight:600;
  padding:.55rem .5rem; border-radius:var(--r-sm); border:1px solid var(--rule2);
  background:transparent; color:var(--ink4); cursor:pointer; transition:all .15s; text-align:center;
}
.assign-status-btn.on.new     { background:rgba(45,74,62,.1);  border-color:rgba(45,74,62,.3);  color:var(--forest); }
.assign-status-btn.on.changes { background:rgba(234,88,12,.1); border-color:rgba(234,88,12,.3); color:#c2410c; }
.assign-status-btn:hover:not(.on) { border-color:var(--rule2); background:var(--parchment); color:var(--ink2); }
.assign-btns { display:flex; gap:.5rem; justify-content:flex-end; margin-top:1.2rem; }
.assign-event-list { display:flex; flex-direction:column; gap:.3rem; margin-top:.1rem; max-height:200px; overflow-y:auto; }
.assign-event-row {
  display:flex; align-items:center; gap:.5rem; padding:.45rem .6rem;
  border:1px solid var(--rule2); border-radius:var(--r-sm); cursor:pointer;
  transition:border-color .15s; background:var(--parchment);
}
.assign-event-row:hover { border-color:var(--gold-line); }
.assign-event-row.selected { border-color:var(--gold); background:var(--gold-wash); }
.assign-event-couple { font-family:'Cormorant Garamond',serif; font-size:.92rem; font-weight:600; font-style:italic; color:var(--ink2); }
.assign-event-type   { font-family:'Outfit',sans-serif; font-size:.63rem; color:var(--ink4); margin-top:.08rem; }

/* Assign modal date badges */
.assign-date-badge {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-width:34px; height:34px; border-radius:var(--r-xs);
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.18); flex-shrink:0;
}
.assign-date-badge.soon   { background:rgba(245,158,11,.1);  border-color:rgba(245,158,11,.3); }
.assign-date-badge.urgent { background:rgba(220,38,38,.08);  border-color:rgba(220,38,38,.22); }
.assign-date-badge.no-date { background:var(--cream); border-color:transparent; }
.assign-date-day { font-family:'Cormorant Garamond',serif; font-size:1rem; font-weight:600; line-height:1; color:var(--forest); }
.assign-date-badge.soon   .assign-date-day { color:#92400e; }
.assign-date-badge.urgent .assign-date-day { color:#b91c1c; }
.assign-date-badge.no-date .assign-date-day { font-size:.55rem; color:var(--ink5); font-family:'Outfit',sans-serif; }
.assign-date-mon { font-family:'Outfit',sans-serif; font-size:.48rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; color:var(--forest-lt); }
.assign-date-badge.soon   .assign-date-mon { color:#b45309; }
.assign-date-badge.urgent .assign-date-mon { color:#c81e1e; }

/* ══ OVERVIEW STATS BANNER ══════════════════════════════════ */
.overview-banner {
  display:grid; grid-template-columns:repeat(3,1fr); gap:.75rem;
  margin:0 0 1rem;
}
@media(max-width:900px){ .overview-banner { grid-template-columns:repeat(2,1fr); } }
@media(max-width:520px){ .overview-banner { grid-template-columns:1fr; } }
.ov-card {
  background:var(--warm-white); border:1px solid var(--rule2);
  border-radius:var(--r-lg); padding:1rem 1.15rem;
  display:flex; align-items:center; gap:.85rem;
  position:relative; overflow:hidden;
  box-shadow:0 2px 10px rgba(26,26,32,.04);
  transition:box-shadow .2s, border-color .2s;
}
/* Thin gold top rule on each card */
.ov-card::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold-line) 40%, var(--gold-line) 60%, transparent);
}
.ov-donut { flex-shrink:0; display:block; overflow:visible; }
.ov-info { flex:1; min-width:0; }
.ov-big {
  font-family:'Cormorant Garamond',serif; font-size:1.7rem; font-weight:600;
  color:var(--ink); line-height:1;
}
.ov-big span { font-size:.85rem; color:var(--ink4); font-family:'Outfit',sans-serif; font-weight:300; }
.ov-label {
  font-family:'Outfit',sans-serif; font-size:.55rem; font-weight:600;
  letter-spacing:.14em; text-transform:uppercase; color:var(--ink5); margin-top:.22rem;
}
.ov-sub { font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink4); margin-top:.12rem; font-weight:300; }

/* ══ PROGRESS % ON COUPLE CARDS ══════════════════════════════ */
.cc-progress-row {
  display:flex; align-items:center; gap:.4rem; margin-bottom:.4rem;
}
.cc-progress-bar-wrap {
  flex:1; height:4px; border-radius:2px;
  background:var(--rule); overflow:hidden;
}
.cc-progress-fill {
  height:100%; border-radius:2px; background:rgba(74,122,85,.9); transition:width .4s;
}
.cc-progress-pct {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  color:var(--ink4); white-space:nowrap; min-width:28px; text-align:right;
}

/* ══ OLD PROJECTS DRAWER ════════════════════════════════════ */
.old-projects-btn {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:600;
  letter-spacing:.08em; text-transform:uppercase; color:var(--ink5);
  background:transparent; border:1px solid var(--rule); border-radius:20px;
  padding:.18rem .55rem; cursor:pointer; transition:all .15s; margin-top:.45rem;
  display:inline-flex; align-items:center; gap:.25rem;
}
.old-projects-btn:hover { border-color:var(--gold-line); color:var(--gold); }
.old-projects-btn .op-arrow { transition:transform .18s; font-size:.5rem; }
.old-projects-btn.open .op-arrow { transform:rotate(180deg); }
.old-projects-list {
  display:none; flex-direction:column; gap:.25rem; margin-top:.4rem;
}
.old-projects-list.open { display:flex; }
.old-proj-item {
  display:flex; align-items:flex-start; gap:.4rem;
  background:var(--parchment); border:1px solid var(--rule);
  border-radius:var(--r-sm); padding:.35rem .55rem; font-family:'Outfit',sans-serif;
}
.old-proj-dot { font-size:.55rem; color:var(--ink5); margin-top:.12rem; flex-shrink:0; }
.old-proj-name { font-size:.68rem; font-weight:600; color:var(--ink3); }
.old-proj-meta { font-size:.58rem; color:var(--ink5); margin-top:.05rem; }
.old-proj-badge {
  font-size:.5rem; font-weight:700; letter-spacing:.07em; text-transform:uppercase;
  padding:.1rem .35rem; border-radius:20px; flex-shrink:0; margin-top:.1rem;
}
.old-proj-badge.new     { background:rgba(45,74,62,.1);  color:var(--forest); }
.old-proj-badge.changes { background:rgba(234,88,12,.1); color:#c2410c; }

/* ══ SHOOTER PANEL ROWS ══════════════════════════════════════ */
.shooter-block { border-bottom:1px solid var(--rule); padding:.6rem 0; }
.shooter-block:last-child { border-bottom:none; }
.shooter-block-head {
  display:flex; align-items:center; gap:.55rem; margin-bottom:.4rem;
}
.shooter-avatar {
  width:28px; height:28px; border-radius:50%;
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.18);
  display:flex; align-items:center; justify-content:center;
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  color:var(--forest); flex-shrink:0; overflow:hidden;
}
.shooter-avatar img { width:100%;height:100%;object-fit:cover; }
.shooter-name {
  font-family:'Outfit',sans-serif; font-size:.75rem; font-weight:600; color:var(--ink2); flex:1;
}
.shoot-event-item {
  display:flex; align-items:center; gap:.5rem; margin-bottom:.3rem;
}
.shoot-event-item:last-child { margin-bottom:0; }
.shoot-mini-badge {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-width:30px; height:30px; border-radius:var(--r-xs);
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.18); flex-shrink:0;
}
.shoot-mini-badge.soon   { background:rgba(245,158,11,.1);  border-color:rgba(245,158,11,.3); }
.shoot-mini-badge.urgent { background:rgba(220,38,38,.08);  border-color:rgba(220,38,38,.22); }
.shoot-mini-badge.past   { background:var(--parchment); border-color:var(--rule2); }
.shoot-mini-day { font-family:'Cormorant Garamond',serif; font-size:.92rem; font-weight:600; line-height:1; color:var(--forest); }
.shoot-mini-badge.soon   .shoot-mini-day { color:#92400e; }
.shoot-mini-badge.urgent .shoot-mini-day { color:#b91c1c; }
.shoot-mini-badge.past   .shoot-mini-day { color:var(--ink4); }
.shoot-mini-mon { font-family:'Outfit',sans-serif; font-size:.44rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; color:var(--forest-lt); }
.shoot-mini-badge.past   .shoot-mini-mon { color:var(--ink5); }
.shoot-event-details { flex:1; min-width:0; }
.shoot-event-couple { font-family:'Cormorant Garamond',serif; font-size:.88rem; font-weight:600; font-style:italic; color:var(--ink2); cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.shoot-event-couple:hover { color:var(--gold); }
.shoot-event-info   { font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink4); margin-top:.05rem; }
.shoot-event-hours  { font-family:'Outfit',sans-serif; font-size:.58rem; color:var(--ink5); white-space:nowrap; }

/* ══ OVERVIEW DRILL-DOWN MODAL ═══════════════════════════ */
/* Static info cards — no interaction */
.ov-card { cursor:default; }

/* Clickable cards — strong affordance */
.ov-card--clickable {
  cursor:pointer;
  border-color:var(--gold-line);
  background:linear-gradient(135deg, var(--gold-wash) 0%, var(--warm-white) 100%);
  transition:border-color .18s, transform .18s, box-shadow .18s;
  position:relative;
}
.ov-card--clickable::before {
  background:linear-gradient(90deg, transparent, var(--gold) 40%, var(--gold) 60%, transparent);
  opacity:.5;
}
.ov-card--clickable:hover {
  border-color:var(--gold);
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(154,123,60,.14);
}
.ov-card--clickable .ov-label {
  color:var(--gold);
}
.ov-card--clickable .ov-label::after {
  content:' →';
  font-size:.6rem;
  opacity:.7;
}

.ovdrill-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.52); z-index:2800;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .18s;
}
.ovdrill-overlay.open { opacity:1; pointer-events:all; }
.ovdrill-box {
  background:var(--warm-white); border-radius:var(--r-xl);
  padding:0; max-width:520px; width:95%; max-height:82vh;
  display:flex; flex-direction:column;
  box-shadow:0 24px 70px rgba(0,0,0,.22);
  transform:translateY(12px); transition:transform .2s;
}
.ovdrill-overlay.open .ovdrill-box { transform:translateY(0); }
.ovdrill-head {
  padding:1.2rem 1.5rem .8rem;
  border-bottom:1px solid var(--rule);
  display:flex; align-items:flex-start; justify-content:space-between; gap:.5rem;
  flex-shrink:0;
}
.ovdrill-title { font-family:'Cormorant Garamond',serif; font-size:1.2rem; font-weight:600; font-style:italic; color:var(--ink); letter-spacing:.01em; }
.ovdrill-close {
  background:none; border:none; cursor:pointer; font-size:1rem; color:var(--ink4);
  padding:.1rem .3rem; border-radius:var(--r-xs); line-height:1;
}
.ovdrill-close:hover { color:var(--ink); background:var(--parchment); }
.ovdrill-tabs {
  display:flex; border-bottom:1px solid var(--rule); flex-shrink:0;
}
.ovdrill-tab {
  flex:1; font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; padding:.65rem .5rem;
  border:none; background:none; cursor:pointer; color:var(--ink5);
  border-bottom:2px solid transparent; margin-bottom:-1px; transition:color .15s;
}
.ovdrill-tab.active { color:var(--ink); border-bottom-color:var(--gold); }
.ovdrill-tab:hover:not(.active) { color:var(--ink3); }
.ovdrill-tab .tab-badge {
  display:inline-block; min-width:16px; height:16px; line-height:16px;
  border-radius:8px; background:var(--parchment); font-size:.55rem;
  text-align:center; padding:0 4px; margin-left:.3rem;
}
.ovdrill-tab.active .tab-badge { background:var(--gold-wash); color:var(--gold); }
.ovdrill-body { overflow-y:auto; flex:1; padding:.6rem .8rem .8rem; }
.ovdrill-section-label {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:700;
  letter-spacing:.13em; text-transform:uppercase; color:var(--ink5);
  padding:.5rem .4rem .3rem; position:sticky; top:0;
  background:var(--warm-white); z-index:1;
}
.ovdrill-couple-row {
  border:1px solid var(--rule2); border-radius:var(--r-md);
  margin-bottom:.5rem; overflow:hidden;
}
.ovdrill-couple-head {
  display:flex; align-items:center; gap:.6rem; padding:.6rem .75rem;
  cursor:pointer; background:var(--parchment); transition:background .15s;
}
.ovdrill-couple-head:hover { background:var(--gold-wash); }
.ovdrill-couple-name {
  font-family:'Cormorant Garamond',serif; font-size:.98rem; font-weight:600; font-style:italic; color:var(--ink); flex:1; letter-spacing:.01em;
}
.ovdrill-couple-date { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300; color:var(--ink5); letter-spacing:.06em; text-transform:uppercase; }
.ovdrill-couple-pct {
  font-family:'Cormorant Garamond',serif; font-size:.8rem; font-style:italic; color:var(--gold);
}
.ovdrill-events { padding:.3rem .5rem .5rem 2rem; }
.ovdrill-event-row {
  display:flex; align-items:center; gap:.5rem; padding:.35rem .5rem;
  border-radius:var(--r-sm); cursor:pointer; transition:background .12s;
  margin-bottom:.2rem;
}
.ovdrill-event-row:hover { background:var(--parchment); }
.ovdrill-event-status {
  width:7px; height:7px; border-radius:50%; flex-shrink:0;
}
.ovdrill-event-status.done    { background:var(--forest); }
.ovdrill-event-status.pending { background:var(--gold); }
.ovdrill-event-name {
  font-family:'Cormorant Garamond',serif; font-size:.88rem; font-style:italic; color:var(--ink2); flex:1;
}
.ovdrill-event-meta {
  font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink5);
}
.ovdrill-empty {
  font-family:'Cormorant Garamond',serif; font-style:italic;
  font-size:.78rem; color:var(--ink5); text-align:center; padding:1.5rem 1rem;
}

/* ══ EVENT INFO TABS (Shooting / Editing) ═══════════════════ */
.ev-info-tabs {
  display:flex; border-bottom:2px solid var(--rule);
  margin:.8rem 0 0;
}
.ev-info-tab {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase;
  padding:.55rem 1rem; border:none; background:none; cursor:pointer;
  color:var(--ink5); border-bottom:2px solid transparent; margin-bottom:-2px;
  transition:color .15s;
}
.ev-info-tab.active { color:var(--ink); border-bottom-color:var(--gold); }
.ev-info-tab:hover:not(.active) { color:var(--ink3); }
.ev-info-pane { display:none; }
.ev-info-pane.active { display:block; }

/* ══ CREW ROWS (photographers / videographers) ══════════════ */
.ev-crew-section {
  margin:.8rem 0; padding:.9rem 1.1rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
}
.ev-crew-block { margin-bottom:.85rem; }
.ev-crew-block:last-child { margin-bottom:0; }
.ev-crew-block-head {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:.45rem;
}
.ev-crew-block-label {
  font-size:.57rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--ink4);
}
.ev-crew-add-btn {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:600;
  letter-spacing:.06em; text-transform:uppercase;
  background:transparent; border:1px dashed var(--rule2);
  border-radius:20px; padding:.15rem .5rem; color:var(--ink5);
  cursor:pointer; transition:all .14s;
}
.ev-crew-add-btn:hover { border-color:var(--gold-line); color:var(--gold); }
.ev-crew-rows { display:flex; flex-direction:column; gap:.3rem; }
.ev-crew-row {
  display:flex; align-items:center; gap:.4rem;
}
.ev-crew-row .ev-prod-input { flex:1; margin:0; }
.ev-crew-remove {
  background:none; border:none; cursor:pointer; color:var(--ink5);
  font-size:.72rem; padding:.2rem .3rem; border-radius:var(--r-xs);
  transition:color .14s; flex-shrink:0; line-height:1;
}
.ev-crew-remove:hover { color:#c81e1e; }

/* ══ VENDOR ROWS ═════════════════════════════════════════════ */
.ev-vendor-section {
  margin:.8rem 0; padding:.9rem 1.1rem;
  background:var(--parchment); border-radius:var(--r-md);
  border:1px solid var(--rule);
}
.ev-vendor-head {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:.45rem;
}
.ev-vendor-label {
  font-size:.57rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--ink4);
}
.ev-vendor-rows { display:flex; flex-direction:column; gap:.3rem; }
.ev-vendor-row {
  display:grid; grid-template-columns:1fr 1.4fr auto; gap:.35rem; align-items:center;
}
.ev-vendor-type { font-family:'Outfit',sans-serif; }

/* ══ CREW NAME DROPDOWN ══════════════════════════════════ */
.ev-crew-row { position:relative; }
.crew-suggest-wrap { flex:1; position:relative; min-width:0; }
.crew-suggest-list {
  position:absolute; top:calc(100% + 3px); left:0; right:0; z-index:500;
  background:var(--warm-white); border:1px solid var(--gold-line);
  border-radius:var(--r-sm); box-shadow:0 6px 20px rgba(0,0,0,.1);
  max-height:160px; overflow-y:auto; display:none;
}
.crew-suggest-list.open { display:block; }
.crew-suggest-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:.42rem .65rem; cursor:pointer; gap:.4rem;
  font-family:'Outfit',sans-serif; font-size:.76rem; color:var(--ink2);
  transition:background .1s;
}
.crew-suggest-item:hover { background:var(--gold-wash); }
.crew-suggest-item span.del {
  font-size:.6rem; color:var(--ink5); padding:.1rem .3rem;
  border-radius:var(--r-xs); cursor:pointer; flex-shrink:0;
  transition:color .12s;
}
.crew-suggest-item span.del:hover { color:#c81e1e; }
.crew-suggest-divider {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; color:var(--ink5);
  padding:.35rem .65rem .2rem; border-top:1px solid var(--rule);
}

/* ══ LOCATION ADDRESS AUTOCOMPLETE ════════════════════════ */
.loc-suggest-wrap { position:relative; }
.loc-suggest-list {
  position:absolute; top:calc(100% + 3px); left:0; right:0; z-index:500;
  background:var(--warm-white); border:1px solid var(--gold-line);
  border-radius:var(--r-sm); box-shadow:0 6px 20px rgba(0,0,0,.1);
  max-height:200px; overflow-y:auto; display:none;
}
.loc-suggest-list.open { display:block; }
.loc-suggest-item {
  padding:.45rem .7rem; cursor:pointer;
  font-family:'Outfit',sans-serif; font-size:.74rem; color:var(--ink2);
  border-bottom:1px solid var(--rule); transition:background .1s;
}
.loc-suggest-item:last-child { border-bottom:none; }
.loc-suggest-item:hover { background:var(--gold-wash); }
.loc-suggest-item .loc-main { font-weight:500; }
.loc-suggest-item .loc-sub  { font-size:.62rem; color:var(--ink5); margin-top:.08rem; }
.loc-searching {
  padding:.5rem .7rem; font-family:'Outfit',sans-serif;
  font-size:.68rem; color:var(--ink5); font-style:italic;
}

/* ══ DUAL APPROVAL BUTTONS ════════════════════════════════ */
.ev-approve-rows {
  display:flex; flex-direction:column; gap:.3rem;
}
.ev-approve-row {
  display:flex; gap:.4rem; align-items:center; flex-wrap:wrap;
}
.ev-shoot-row .ev-approve-btn { }
.ev-edit-row {
  padding-top:.15rem;
  border-top:1px solid rgba(0,0,0,.06);
}
.ev-approve-btn.shoot-btn {
  border-color:rgba(37,99,235,.2); color:#3b6fc4;
}
.ev-approve-btn.shoot-btn:hover {
  border-color:rgba(37,99,235,.4); background:rgba(37,99,235,.05); color:#2d5ba8;
}
.ev-approve-btn.shoot-btn.approved {
  background:rgba(37,99,235,.06); border-color:rgba(37,99,235,.3); color:#2d5ba8;
}
.ev-approve-btn.shoot-btn.approved:hover {
  background:rgba(220,38,38,.05); border-color:rgba(220,38,38,.25); color:#b91c1c;
}

/* Dual progress bars on couple card */
.cc-dual-progress { display:flex; flex-direction:column; gap:.22rem; margin-bottom:.45rem; }
.cc-prog-row { display:flex; align-items:center; gap:.4rem; }
.cc-prog-icon { font-size:.58rem; flex-shrink:0; width:14px; text-align:center; }
.cc-prog-bar  { flex:1; height:4px; border-radius:2px; background:var(--rule); overflow:hidden; }
.cc-prog-fill-edit  { height:100%; border-radius:2px; background:rgba(74,122,85,.85); transition:width .4s; }
.cc-prog-fill-shoot { height:100%; border-radius:2px; background:#3b6fc4;        transition:width .4s; }
.cc-prog-pct  { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700; color:var(--ink5); min-width:26px; text-align:right; }

/* ══ SHOOTING CARDS — PER-YEAR BREAKDOWN ══════════════════ */
.ov-card.ov-shoot-card {
  flex-direction:column; align-items:stretch; gap:0;
}
.ov-shoot-card-title {
  font-family:'Cormorant Garamond',serif; font-size:.85rem; font-weight:600;
  font-style:italic; letter-spacing:.02em; color:var(--ink4);
  margin-bottom:.6rem; padding-bottom:.4rem;
  border-bottom:1px solid var(--rule);
}
.ov-year-row {
  display:flex; align-items:center; gap:.55rem;
  padding:.3rem .4rem;
  border-radius:var(--r-sm);
  cursor:pointer;
  transition:background .12s;
  margin:0 -.4rem;
}
.ov-year-row:hover { background:var(--gold-wash); }
.ov-year-row + .ov-year-row { border-top:1px solid var(--rule); margin-top:1px; }
.ov-year-label {
  font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600;
  color:var(--ink3); min-width:34px; line-height:1;
}
.ov-year-label.current-yr { color:var(--gold); }
.ov-year-bar-wrap {
  flex:1; height:5px; border-radius:3px; background:var(--rule); overflow:hidden;
}
.ov-year-bar-fill {
  height:100%; border-radius:3px; transition:width .5s; background:var(--gold);
}
.ov-year-stats {
  font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink4);
  white-space:nowrap; min-width:44px; text-align:right;
}
.ov-year-all-done {
  font-size:.58rem; color:var(--forest); font-weight:700; margin-left:.2rem;
}
.ov-shoot-empty {
  font-family:'Cormorant Garamond',serif; font-style:italic;
  font-size:.72rem; color:var(--ink5); text-align:center; padding:.5rem 0;
}

/* ══ N/A CREW CHIP ═══════════════════════════════════════ */
.crew-na-chip {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.7rem; font-weight:500;
  color:var(--ink5); background:var(--rule); border-radius:20px;
  padding:.22rem .65rem; cursor:pointer; border:1px solid var(--rule2);
  transition:all .14s; flex:1;
}
.crew-na-chip:hover { border-color:var(--gold-line); color:var(--ink3); }
.crew-na-btn {
  font-family:'Outfit',sans-serif; font-size:.55rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  background:transparent; border:1px dashed var(--rule2);
  border-radius:20px; padding:.14rem .45rem; color:var(--ink5);
  cursor:pointer; transition:all .14s; flex-shrink:0; white-space:nowrap;
}
.crew-na-btn:hover { border-color:#b45309; color:#b45309; }
.crew-na-btn.active { background:rgba(180,83,9,.08); border-color:#b45309; color:#b45309; }

/* ══ ASSIGN DRILL-DOWN MODAL ═════════════════════════════ */
.ovdrill-assign-row {
  display:flex; flex-direction:column; align-items:stretch; gap:.4rem;
  padding:.6rem 0; border-bottom:1px solid var(--rule);
}
.ovdrill-assign-row:last-child { border-bottom:none; }
.ovdrill-assign-info { min-width:0; }
.ovdrill-assign-name { font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600; font-style:italic; color:var(--ink); }
.ovdrill-assign-meta { font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink5); margin-top:.1rem; }
.ovdrill-assign-input {
  font-family:'Outfit',sans-serif; font-size:.76rem; font-weight:300; color:var(--ink);
  background:var(--warm-white); border:1px solid var(--rule2); border-radius:var(--r-xs);
  padding:.38rem .65rem; outline:none; transition:border-color .18s; width:100%; box-sizing:border-box;
}
.ovdrill-assign-input:focus { border-color:var(--gold); }

/* ══ UNASSIGNED LINK IN YEAR ROWS ═══════════════════════ */
.ov-unassigned-link {
  color:#b45309; cursor:pointer; text-decoration:underline dotted;
  transition:color .12s;
}
.ov-unassigned-link:hover { color:#92400e; }

/* ══ COMPANY DASHBOARD VIEW ══════════════════════════════ */
#companyDashView {
  min-height:100vh;
  background:var(--bg);
}

/* Hero header */
.co-dash-hero {
  background:#1a1714;
  padding:2.5rem 0 2rem;
  position:relative; overflow:hidden;
}
.co-dash-hero::before {
  content:'';
  position:absolute; inset:0;
  background:
    radial-gradient(ellipse 60% 100% at 80% 50%, rgba(193,154,79,.13) 0%, transparent 70%),
    radial-gradient(ellipse 40% 80% at 10% 80%, rgba(193,154,79,.07) 0%, transparent 60%);
  pointer-events:none;
}
.co-dash-hero-inner {
  position:relative; z-index:1;
  display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap;
}
.co-dash-hero-left { display:flex; align-items:center; gap:1rem; padding-top:.3rem; }
.co-dash-hero-icon {
  width:52px; height:52px; border-radius:14px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
  display:flex; align-items:center; justify-content:center;
  font-size:1.6rem; flex-shrink:0;
}
.co-dash-hero-name {
  font-family:'Cormorant Garamond',serif; font-size:1.7rem;
  font-weight:700; font-style:italic; color:#f5f0e8; letter-spacing:.02em;
}
.co-dash-hero-sub {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:500;
  letter-spacing:.18em; text-transform:uppercase;
  color:rgba(193,154,79,.8); margin-top:.25rem;
}
.co-dash-hero-actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
.co-dash-hero-btn {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:600;
  letter-spacing:.07em; text-transform:uppercase;
  padding:.42rem 1rem; border-radius:var(--r-xs);
  cursor:pointer; transition:all .18s; border:none;
}
.co-dash-hero-btn.secondary {
  background:rgba(255,255,255,.08); color:rgba(245,240,232,.7);
  border:1px solid rgba(255,255,255,.12);
}
.co-dash-hero-btn.secondary:hover { background:rgba(255,255,255,.14); color:#f5f0e8; }
.co-dash-hero-btn.primary {
  background:var(--gold); color:#fff;
}
.co-dash-hero-btn.primary:hover { background:var(--gold-lt); }

/* Section label */
.co-dash-section {
  padding:1.75rem 0 0;
}
.co-dash-section-label {
  font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:300;
  font-style:italic; letter-spacing:.04em;
  color:var(--ink4); margin-bottom:.9rem;
  display:flex; align-items:center; gap:.75rem;
}
.co-dash-section-label::before {
  content:''; width:28px; height:1px;
  background:linear-gradient(90deg, transparent, var(--gold-line));
}
.co-dash-section-label::after {
  content:''; flex:1; height:1px;
  background:linear-gradient(90deg, var(--rule), transparent);
}

/* Stats grid */
#coDashBanner {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:.75rem;
  margin:0;
}
@media(max-width:860px){ #coDashBanner { grid-template-columns:repeat(2,1fr); } }
@media(max-width:480px){ #coDashBanner { grid-template-columns:1fr; } }

/* Teams grid — 3 panels side by side */
#coDashPanels {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:.85rem;
  padding-bottom:3rem;
}
@media(max-width:1100px){ #coDashPanels { grid-template-columns:repeat(2,1fr); } }
@media(max-width:600px){ #coDashPanels { grid-template-columns:1fr; } }

/* Next shoots timeline panel */
.next-shoots-panel { }
.next-shoot-row {
  display:flex; align-items:flex-start; gap:.65rem;
  padding:.55rem 0; border-bottom:1px solid var(--rule);
}
.next-shoot-row:last-child { border-bottom:none; }
.next-shoot-date {
  flex-shrink:0; width:38px; text-align:center;
  background:var(--rule); border-radius:6px; padding:.3rem .2rem;
}
.next-shoot-day {
  font-family:'Outfit',sans-serif; font-size:.95rem; font-weight:800;
  color:var(--ink); line-height:1;
}
.next-shoot-mon {
  font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:600;
  letter-spacing:.08em; text-transform:uppercase; color:var(--ink5);
}
.next-shoot-date.urgent { background:rgba(200,80,20,.1); }
.next-shoot-date.urgent .next-shoot-day { color:#c85014; }
.next-shoot-date.soon { background:rgba(180,140,40,.1); }
.next-shoot-date.soon .next-shoot-day { color:#b48c28; }
.next-shoot-date.past { background:var(--rule); opacity:.5; }
.next-shoot-info { flex:1; min-width:0; }
.next-shoot-couple {
  font-family:'Cormorant Garamond',serif; font-size:.88rem; font-weight:600; font-style:italic;
  color:var(--ink2); cursor:pointer; white-space:nowrap;
  overflow:hidden; text-overflow:ellipsis;
}
.next-shoot-couple:hover { color:var(--gold); }
.next-shoot-event {
  font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink5); margin-top:.08rem;
}
.next-shoot-crew {
  font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink4);
  margin-top:.1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.next-shoot-days {
  flex-shrink:0;
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700;
  letter-spacing:.04em; color:var(--ink5); white-space:nowrap; padding-top:.3rem;
}
.next-shoot-days.urgent { color:#c85014; }
.next-shoot-days.soon { color:#b48c28; }

/* ══ FOOTAGE RECEIVED ════════════════════════════════════ */
.ev-footage-row {
  display:flex; align-items:center; gap:.6rem;
  padding:.6rem .75rem;
  background:var(--warm-white); border:1px solid var(--rule2);
  border-radius:var(--r-sm); margin-top:.5rem;
}
.ev-footage-btn {
  display:inline-flex; align-items:center; gap:.45rem;
  font-family:'Outfit',sans-serif; font-size:.68rem; font-weight:600;
  letter-spacing:.04em;
  padding:.32rem .85rem; border-radius:20px; cursor:pointer;
  border:1.5px solid var(--rule2); background:transparent; color:var(--ink5);
  transition:all .16s;
}
.ev-footage-btn:hover { border-color:#2563eb; color:#2563eb; }
.ev-footage-btn.received {
  background:rgba(37,99,235,.09); border-color:#2563eb; color:#2563eb;
}
.ev-footage-btn.received:hover { background:rgba(200,30,30,.08); border-color:#b91c1c; color:#b91c1c; }
.ev-footage-date {
  font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink5); margin-left:auto;
}

/* ══ BACKUP / RESTORE MODAL ══════════════════════════════ */
.backup-overlay {
  position:fixed; inset:0; z-index:9999;
  background:rgba(20,18,14,.55); backdrop-filter:blur(4px);
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .2s;
}
.backup-overlay.open { opacity:1; pointer-events:all; }
.backup-box {
  background:var(--warm-white); border-radius:var(--r);
  border:1px solid var(--rule2); box-shadow:0 24px 60px rgba(0,0,0,.18);
  width:min(720px,94vw); max-height:90vh; overflow-y:auto; padding:2rem;
}
.backup-title {
  font-family:'Cormorant Garamond',serif; font-size:1.05rem;
  font-weight:700; color:var(--ink); margin-bottom:.35rem;
}
.backup-sub {
  font-family:'Outfit',sans-serif; font-size:.72rem; color:var(--ink5);
  line-height:1.55; margin-bottom:1.4rem;
}
.backup-section {
  padding:1.1rem; border:1px solid var(--rule2); border-radius:var(--r-sm);
  margin-bottom:.85rem;
}
.backup-section-title {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; color:var(--ink5);
  margin-bottom:.6rem;
}
.backup-section p {
  font-family:'Outfit',sans-serif; font-size:.72rem; color:var(--ink3);
  line-height:1.5; margin:0 0 .75rem;
}
.backup-drop {
  border:2px dashed var(--rule2); border-radius:var(--r-sm);
  padding:1.1rem; text-align:center; cursor:pointer;
  font-family:'Outfit',sans-serif; font-size:.72rem; color:var(--ink5);
  transition:all .16s; position:relative;
}
.backup-drop:hover, .backup-drop.over { border-color:var(--gold); color:var(--ink3); background:var(--gold-wash); }
.backup-drop input[type=file] {
  position:absolute; inset:0; opacity:0; cursor:pointer; width:100%;
}
.backup-status {
  font-family:'Outfit',sans-serif; font-size:.7rem; margin-top:.6rem;
  padding:.5rem .75rem; border-radius:var(--r-xs); display:none;
}
.backup-status.ok { background:rgba(22,120,60,.1); color:#16783c; display:block; }
.backup-status.err { background:rgba(180,30,30,.1); color:#b41e1e; display:block; }
.backup-close-row { display:flex; justify-content:flex-end; margin-top:1rem; }

/* ══ IN PRODUCTION PANEL ══════════════════════════════════ */
#coDashEditing { }

/* ── Revisions Panel ── */
.rev-panel {
  background:var(--warm-white);
  border:1px solid rgba(220,140,40,.25);
  border-radius:var(--r-xl);
  overflow:hidden;
  box-shadow:0 4px 32px rgba(26,26,32,.07), 0 1px 0 rgba(220,140,40,.15);
  position:relative;
}
.rev-panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg, transparent 0%, rgba(220,140,40,.3) 20%, rgba(220,140,40,.6) 50%, rgba(220,140,40,.3) 80%, transparent 100%);
}
.rev-panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:1.35rem 2rem 1.2rem;
  border-bottom:1px solid rgba(220,140,40,.15);
  background:linear-gradient(to bottom, rgba(255,243,220,.4), var(--warm-white));
  position:relative;
}
.rev-panel-title {
  font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600;
  letter-spacing:.03em; color:var(--ink);
  font-style:italic;
}
.rev-panel-title::after {
  content:' —';
  color:rgba(220,140,40,.7); font-style:normal; font-weight:300;
}
.rev-panel-sub {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  letter-spacing:.16em; text-transform:uppercase; color:var(--ink5);
}
.rev-grid {
  display:flex;
  flex-wrap:wrap;
  gap:1rem;
  padding:1.5rem 2rem 1.75rem;
  background:radial-gradient(ellipse at 0% 100%, rgba(220,140,40,.04) 0%, transparent 60%);
}
.rev-card {
  background:var(--canvas);
  border:1px solid rgba(220,140,40,.2);
  border-radius:var(--r-lg);
  padding:.85rem 1rem;
  min-width:180px;
  max-width:260px;
  flex:1 1 200px;
  cursor:pointer;
  transition:border-color .15s, box-shadow .15s;
}
.rev-card:hover {
  border-color:rgba(220,140,40,.45);
  box-shadow:0 2px 12px rgba(220,140,40,.1);
}
.rev-card-couple {
  font-family:'Cormorant Garamond',serif; font-size:.92rem; font-weight:600;
  color:var(--ink); line-height:1.2;
}
.rev-card-event {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:300;
  letter-spacing:.12em; text-transform:uppercase; color:var(--ink5);
  margin-top:.15rem;
}
.rev-card-editor {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:400;
  color:var(--ink6); margin-top:.4rem;
}
.rev-card-badges { display:flex; flex-wrap:wrap; gap:.3rem; margin-top:.4rem; }
.rev-badge {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:500;
  letter-spacing:.06em; text-transform:uppercase;
  padding:.15rem .45rem; border-radius:4px;
}
.rev-badge.changes {
  background:rgba(220,38,38,.08); border:1px solid rgba(220,38,38,.2); color:#dc2626;
}
.rev-badge.photo { background:rgba(37,99,235,.07); border:1px solid rgba(37,99,235,.18); color:#2563eb; }
.rev-badge.video { background:rgba(139,92,246,.07); border:1px solid rgba(139,92,246,.18); color:#7c3aed; }
.rev-no-items { padding:1.5rem 2rem; font-size:.72rem; color:var(--ink5); font-style:italic; text-align:center; }

/* ── Overdue Panel ── */
.overdue-panel {
  background:var(--warm-white);
  border:1px solid rgba(220,38,38,.2);
  border-radius:var(--r-xl);
  overflow:hidden;
  box-shadow:0 4px 32px rgba(26,26,32,.07), 0 1px 0 rgba(220,38,38,.12);
  position:relative;
}
.overdue-panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg, transparent 0%, rgba(220,38,38,.25) 20%, rgba(220,38,38,.5) 50%, rgba(220,38,38,.25) 80%, transparent 100%);
}
.overdue-panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:1.35rem 2rem 1.2rem;
  border-bottom:1px solid rgba(220,38,38,.12);
  background:linear-gradient(to bottom, rgba(254,226,226,.3), var(--warm-white));
}
.overdue-panel-title {
  font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600;
  letter-spacing:.03em; color:#991b1b; font-style:italic;
}
.overdue-panel-title::after {
  content:' —'; color:rgba(220,38,38,.4); font-style:normal; font-weight:300;
}
.overdue-panel-sub {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  letter-spacing:.16em; text-transform:uppercase; color:rgba(220,38,38,.6);
}
.overdue-grid {
  display:flex; flex-wrap:wrap; gap:1rem; padding:1.5rem 2rem 1.75rem;
  background:radial-gradient(ellipse at 0% 100%, rgba(220,38,38,.03) 0%, transparent 60%);
}
.overdue-card {
  background:var(--canvas); border:1px solid rgba(220,38,38,.18);
  border-radius:var(--r-lg); padding:.85rem 1rem;
  min-width:180px; max-width:260px; flex:1 1 200px;
  cursor:pointer; transition:border-color .15s, box-shadow .15s;
}
.overdue-card:hover { border-color:rgba(220,38,38,.4); box-shadow:0 2px 12px rgba(220,38,38,.08); }
.overdue-card .due-card-days { color:#dc2626; font-weight:600; }

/* ── Almost Due Panel ── */
.almostdue-panel {
  background:var(--warm-white);
  border:1px solid rgba(234,88,12,.2);
  border-radius:var(--r-xl);
  overflow:hidden;
  box-shadow:0 4px 32px rgba(26,26,32,.07), 0 1px 0 rgba(234,88,12,.12);
  position:relative;
}
.almostdue-panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg, transparent 0%, rgba(234,88,12,.25) 20%, rgba(234,88,12,.5) 50%, rgba(234,88,12,.25) 80%, transparent 100%);
}
.almostdue-panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:1.35rem 2rem 1.2rem;
  border-bottom:1px solid rgba(234,88,12,.12);
  background:linear-gradient(to bottom, rgba(255,237,213,.3), var(--warm-white));
}
.almostdue-panel-title {
  font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600;
  letter-spacing:.03em; color:#9a3412; font-style:italic;
}
.almostdue-panel-title::after {
  content:' —'; color:rgba(234,88,12,.4); font-style:normal; font-weight:300;
}
.almostdue-panel-sub {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  letter-spacing:.16em; text-transform:uppercase; color:rgba(234,88,12,.6);
}
.almostdue-grid {
  display:flex; flex-wrap:wrap; gap:1rem; padding:1.5rem 2rem 1.75rem;
  background:radial-gradient(ellipse at 0% 100%, rgba(234,88,12,.03) 0%, transparent 60%);
}
.almostdue-card {
  background:var(--canvas); border:1px solid rgba(234,88,12,.18);
  border-radius:var(--r-lg); padding:.85rem 1rem;
  min-width:180px; max-width:260px; flex:1 1 200px;
  cursor:pointer; transition:border-color .15s, box-shadow .15s;
}
.almostdue-card:hover { border-color:rgba(234,88,12,.4); box-shadow:0 2px 12px rgba(234,88,12,.08); }
.almostdue-card .due-card-days { color:#ea580c; font-weight:600; }

/* Shared due card inner styles */
.due-card-couple {
  font-family:'Cormorant Garamond',serif; font-size:.92rem; font-weight:600;
  color:var(--ink); line-height:1.2;
}
.due-card-event {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:300;
  letter-spacing:.12em; text-transform:uppercase; color:var(--ink5); margin-top:.15rem;
}
.due-card-editor {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:400;
  color:var(--ink6); margin-top:.35rem;
}
.due-card-days {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:500;
  margin-top:.35rem;
}
.due-card-date {
  font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:300;
  color:var(--ink5); margin-top:.1rem;
}

.prod-panel {
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-radius:var(--r-xl);
  overflow:hidden;
  box-shadow:0 4px 32px rgba(26,26,32,.07), 0 1px 0 rgba(154,123,60,.12);
  position:relative;
}
/* Subtle corner ornament */
.prod-panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg, transparent 0%, var(--gold-line) 20%, var(--gold) 50%, var(--gold-line) 80%, transparent 100%);
  opacity:.7;
}
.prod-panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:1.35rem 2rem 1.2rem;
  border-bottom:1px solid var(--rule);
  background:linear-gradient(to bottom, var(--parchment), var(--warm-white));
  position:relative;
}
.prod-panel-title {
  font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600;
  letter-spacing:.03em; color:var(--ink);
  font-style:italic;
}
.prod-panel-title::after {
  content:' —';
  color:var(--gold); font-style:normal; font-weight:300;
}
.prod-panel-sub {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:300;
  letter-spacing:.16em; text-transform:uppercase; color:var(--ink5);
}
.prod-editor-grid {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:1.25rem;
  padding:1.75rem 2rem 2rem;
  background:
    radial-gradient(ellipse at 0% 100%, rgba(154,123,60,.04) 0%, transparent 60%),
    radial-gradient(ellipse at 100% 0%, rgba(154,123,60,.03) 0%, transparent 60%);
}
.prod-editor-col {
  background:var(--canvas);
  border:1px solid var(--rule2);
  border-radius:var(--r-lg);
  padding:1.3rem 1.4rem 1.5rem;
  min-width:260px;
  flex:0 1 310px;
  transition:border-color .2s, box-shadow .2s;
  position:relative;
  box-shadow:0 2px 12px rgba(26,26,32,.04);
}
.prod-editor-col:hover {
  border-color:var(--gold-line);
  box-shadow:0 4px 20px rgba(154,123,60,.1);
}
/* Small decorative top rule on each column */
.prod-editor-col::before {
  content:'';
  position:absolute; top:0; left:1.4rem; right:1.4rem; height:1px;
  background:linear-gradient(90deg, transparent, var(--gold-line), transparent);
}
.prod-editor-name-row {
  display:flex; align-items:center; gap:.75rem;
  margin-bottom:1rem;
  padding-bottom:.8rem;
  border-bottom:1px solid var(--rule);
}
.prod-editor-avatar {
  width:40px; height:40px; border-radius:50%;
  background:var(--parchment); border:1px solid var(--gold-line);
  display:flex; align-items:center; justify-content:center;
  font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600;
  color:var(--gold); flex-shrink:0;
  box-shadow:0 1px 6px rgba(154,123,60,.12); overflow:hidden;
}
.prod-editor-avatar img { width:100%;height:100%;object-fit:cover; }
.prod-editor-name {
  font-family:'Outfit',sans-serif; font-size:.9rem; font-weight:500;
  color:var(--ink2); flex:1; min-width:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  letter-spacing:.01em;
}
.prod-editor-count {
  font-family:'Cormorant Garamond',serif; font-size:.85rem; font-weight:400;
  font-style:italic; color:var(--gold);
  background:var(--parchment);
  border:1px solid var(--gold-line); border-radius:20px;
  padding:.1rem .6rem; flex-shrink:0;
}
.prod-project-card {
  display:flex; flex-direction:column; gap:.2rem;
  padding:.8rem 1rem;
  border-radius:var(--r-md); margin-bottom:.5rem;
  border:1px solid var(--rule2); cursor:pointer;
  transition:border-color .18s, background .18s, box-shadow .18s;
  background:var(--warm-white);
  position:relative; overflow:hidden;
}
/* Thin left accent line on card */
.prod-project-card::before {
  content:'';
  position:absolute; top:.4rem; bottom:.4rem; left:0; width:2px;
  background:var(--gold-line);
  border-radius:0 2px 2px 0;
  transition:background .18s;
}
.prod-project-card:hover {
  border-color:var(--gold-line);
  background:var(--gold-wash);
  box-shadow:0 2px 10px rgba(154,123,60,.08);
}
.prod-project-card:hover::before { background:var(--gold); }
.prod-project-card:last-child { margin-bottom:0; }
.prod-project-couple {
  font-family:'Cormorant Garamond',serif; font-size:1.08rem; font-weight:600;
  color:var(--ink); line-height:1.3;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.prod-project-event {
  font-family:'Outfit',sans-serif; font-size:.65rem; font-weight:300;
  color:var(--ink5); letter-spacing:.08em; text-transform:uppercase;
}
.prod-project-badges {
  display:flex; gap:.28rem; flex-wrap:wrap; margin-top:.28rem;
}
.prod-badge {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:600;
  letter-spacing:.09em; text-transform:uppercase;
  padding:.1rem .48rem; border-radius:20px;
}
.prod-badge.new     { background:var(--forest-dim); border:1px solid rgba(45,74,62,.2); color:var(--forest); }
.prod-badge.changes { background:rgba(234,88,12,.07); border:1px solid rgba(234,88,12,.22); color:#b45309; }
.prod-badge.hours   { background:var(--parchment); border:1px solid var(--rule2); color:var(--ink5); }
.prod-card-meta {
  display:flex; flex-wrap:wrap; gap:.3rem; align-items:center; margin-top:.2rem;
}
.prod-card-svc {
  font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:500;
  padding:.1rem .38rem; border-radius:3px; letter-spacing:.04em;
}
.prod-card-svc.photo { background:rgba(37,99,235,.07); border:1px solid rgba(37,99,235,.18); color:#2563eb; }
.prod-card-svc.video { background:rgba(139,92,246,.07); border:1px solid rgba(139,92,246,.18); color:#7c3aed; }
.prod-card-due {
  font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:400; color:var(--ink5);
}
.prod-card-due.overdue { color:#dc2626; font-weight:600; }
.prod-card-due.soon { color:#ea580c; font-weight:500; }
.prod-card-clock {
  display:inline-flex;align-items:center;gap:.25rem;font-size:.6rem;color:var(--muted);cursor:pointer;
  padding:.15rem .4rem;border-radius:4px;transition:background .15s;
}
.prod-card-clock:hover { background:rgba(0,0,0,.05); }
.prod-card-clock .clock-icon { font-size:.65rem; }
.prod-card-clock .clock-elapsed { font-weight:600; color:var(--ink); }
.prod-card-clock .clock-start { opacity:.7; }
.prod-clock-edit {
  position:absolute;z-index:9999;background:var(--card);border:1px solid var(--rule);border-radius:8px;
  padding:.6rem;box-shadow:0 4px 16px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:.4rem;
  font-size:.75rem;min-width:180px;
}
.prod-clock-edit label { font-weight:600;color:var(--ink);font-size:.65rem;text-transform:uppercase;letter-spacing:.03em; }
.prod-clock-edit input { padding:.3rem .4rem;border:1px solid var(--rule);border-radius:5px;font:inherit;font-size:.75rem; }
.prod-clock-edit .clock-edit-btns { display:flex;gap:.3rem;margin-top:.2rem; }
.prod-clock-edit .clock-edit-btns button { flex:1;padding:.25rem;border-radius:5px;font-size:.65rem;cursor:pointer;border:1px solid var(--rule); }
.prod-clock-edit .clock-edit-btns .clock-save { background:var(--gold);color:#fff;border-color:var(--gold);font-weight:600; }
.prod-clock-edit .clock-edit-btns .clock-clear { background:transparent;color:var(--muted); }

/* ── Production Analytics ─────────────────────── */
.analytics-panel { background:var(--card);border-radius:10px;border:1px solid var(--rule);overflow:hidden; }
.analytics-panel-head { padding:.7rem 1rem;display:flex;align-items:center;gap:.5rem;border-bottom:1px solid var(--rule); }
.analytics-panel-title { font:600 .8rem/1.3 'Cormorant Garamond',serif;color:var(--ink); }
.analytics-panel-sub { font-size:.65rem;color:var(--muted); }
.analytics-tabs { display:flex;gap:0;border-bottom:1px solid var(--rule); }
.analytics-tab { flex:1;padding:.45rem .5rem;font-size:.65rem;font-weight:600;text-align:center;cursor:pointer;
  border-bottom:2px solid transparent;color:var(--muted);transition:all .15s; }
.analytics-tab.active { color:var(--gold);border-bottom-color:var(--gold); }
.analytics-tab:hover { color:var(--ink); }
.analytics-body { padding:.6rem .8rem; }
.analytics-table { width:100%;border-collapse:collapse;font-size:.7rem; }
.analytics-table th { text-align:left;padding:.35rem .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.03em;
  color:var(--muted);border-bottom:1px solid var(--rule);font-weight:600; }
.analytics-table td { padding:.4rem .4rem;border-bottom:1px solid rgba(0,0,0,.04);color:var(--ink); }
.analytics-table tr:last-child td { border-bottom:none; }
.analytics-table .avg-val { font-weight:700;font-size:.75rem; }
.analytics-table .avg-fast { color:#16a34a; }
.analytics-table .avg-med { color:#d97706; }
.analytics-table .avg-slow { color:#dc2626; }
.analytics-table .sample-count { font-size:.55rem;color:var(--muted);margin-left:.3rem; }
.analytics-empty { text-align:center;padding:1.5rem;color:var(--muted);font-size:.75rem; }
.prod-no-editors {
  padding:3rem 2rem; text-align:center;
  font-family:'Cormorant Garamond',serif; font-style:italic;
  font-size:1rem; color:var(--ink5); letter-spacing:.02em;
}



/* ══ PAUSE BUTTON ════════════════════════════════════════ */
.ev-pause-btn {
  display:inline-flex; align-items:center; gap:.25rem;
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700;
  letter-spacing:.06em; text-transform:uppercase;
  padding:.18rem .55rem; border-radius:20px;
  background:var(--parchment); border:1px solid var(--rule2);
  color:var(--ink4); cursor:pointer; transition:all .14s;
  margin-left:.35rem;
}
.ev-pause-btn:hover { border-color:var(--gold-line); color:var(--ink3); }
.ev-pause-btn.paused {
  background:rgba(88,28,235,.07); border-color:rgba(88,28,235,.25);
  color:#5b21b6;
}
.ev-section.is-paused > .ev-header { opacity:.7; }

/* ══ CHANGES PROMPT ══════════════════════════════════════ */
.changes-prompt-overlay {
  position:fixed; inset:0; z-index:9998;
  background:rgba(20,18,14,.45); backdrop-filter:blur(3px);
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .18s;
}
.changes-prompt-overlay.open { opacity:1; pointer-events:all; }
.changes-prompt-box {
  background:var(--warm-white); border:1px solid var(--rule2);
  border-radius:var(--r-lg); box-shadow:0 20px 50px rgba(0,0,0,.15);
  width:min(360px,90vw); padding:1.75rem 1.75rem 1.5rem;
  text-align:center;
}
.changes-prompt-icon { font-size:1.6rem; margin-bottom:.6rem; }
.changes-prompt-title {
  font-family:'Cormorant Garamond',serif; font-size:1rem; font-weight:700;
  color:var(--ink); margin-bottom:.3rem;
}
.changes-prompt-sub {
  font-family:'Outfit',sans-serif; font-size:.7rem; color:var(--ink5);
  margin-bottom:1.25rem; line-height:1.5;
}
.changes-prompt-name {
  font-family:'Cormorant Garamond',serif; font-style:italic;
  color:var(--ink3); font-size:.85rem; margin-bottom:1.1rem;
}
.changes-prompt-btns {
  display:flex; gap:.65rem; justify-content:center;
}
.changes-prompt-btns .btn-yes {
  flex:1; padding:.6rem; border-radius:var(--r-sm);
  background:rgba(234,88,12,.09); border:1px solid rgba(234,88,12,.28);
  color:#b45309; font-family:'Outfit',sans-serif; font-size:.75rem; font-weight:700;
  cursor:pointer; transition:background .14s;
}
.changes-prompt-btns .btn-yes:hover { background:rgba(234,88,12,.16); }
.changes-prompt-btns .btn-no {
  flex:1; padding:.6rem; border-radius:var(--r-sm);
  background:var(--forest-dim); border:1px solid rgba(45,74,62,.2);
  color:var(--forest); font-family:'Outfit',sans-serif; font-size:.75rem; font-weight:700;
  cursor:pointer; transition:background .14s;
}
.changes-prompt-btns .btn-no:hover { background:rgba(45,74,62,.14); }
/* Changes flag badge on approve row */
.ev-changes-flag {
  display:inline-flex; align-items:center; gap:.25rem;
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700;
  letter-spacing:.06em; text-transform:uppercase;
  padding:.18rem .55rem; border-radius:20px;
  background:rgba(234,88,12,.09); border:1px solid rgba(234,88,12,.28);
  color:#b45309; cursor:pointer; transition:background .14s;
  margin-left:.35rem;
}
.ev-changes-flag:hover { background:rgba(234,88,12,.18); }

/* ══ COUPLE SUMMARY PANEL ════════════════════════════════ */
.couple-summary {
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-radius:var(--r-lg);
  overflow:hidden;
  margin-top:.85rem;
  box-shadow:0 2px 10px rgba(26,26,32,.04);
  position:relative;
}
.couple-summary::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold-line) 40%, var(--gold-line) 60%, transparent);
}
.couple-summary-head {
  padding:.75rem 1rem .6rem;
  border-bottom:1px solid var(--rule);
  background:linear-gradient(to bottom, var(--parchment), var(--warm-white));
  display:flex; align-items:baseline; justify-content:space-between;
}
.couple-summary-title {
  font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600;
  font-style:italic; color:var(--ink3); letter-spacing:.02em;
}
.couple-summary-count {
  font-family:'Cormorant Garamond',serif; font-size:.8rem; font-style:italic;
  color:var(--gold); font-weight:400;
}
.couple-summary-event {
  padding:.7rem 1rem;
  border-bottom:1px solid var(--rule);
  display:flex; flex-direction:column; gap:.3rem;
}
.couple-summary-event:last-child { border-bottom:none; }
.cse-name {
  font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600;
  color:var(--ink); line-height:1.2;
}
.cse-row {
  display:flex; align-items:flex-start; gap:.4rem;
  font-family:'Outfit',sans-serif; font-size:.72rem; color:var(--ink4);
  line-height:1.4;
}
.cse-icon { flex-shrink:0; opacity:.7; width:16px; }
.cse-val { flex:1; min-width:0; }
.cse-address {
  font-size:.65rem; color:var(--ink5); margin-top:.08rem;
}

/* ══ COMPANY ENTRY CHOICE ════════════════════════════════ */
.company-card-choices {
  position:absolute; inset:0;
  background:var(--warm-white);
  border-radius:var(--r-lg);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:.5rem; padding:.8rem;
  opacity:0; pointer-events:none;
  transition:opacity .18s;
  z-index:2;
}
.company-card:hover .company-card-choices,
.company-card.choosing .company-card-choices {
  opacity:1; pointer-events:all;
}
.company-card { position:relative; overflow:visible; }
.co-choice-btn {
  width:100%; padding:.45rem .6rem;
  border-radius:var(--r-sm);
  font-family:'Outfit',sans-serif; font-size:.65rem; font-weight:600;
  letter-spacing:.06em; cursor:pointer;
  transition:background .14s, border-color .14s;
  text-align:center;
}
.co-choice-btn.dashboard {
  background:var(--ink); border:1px solid var(--ink);
  color:var(--warm-white);
}
.co-choice-btn.dashboard:hover { background:var(--ink2); }
.co-choice-btn.clients {
  background:transparent; border:1px solid var(--rule2);
  color:var(--ink3);
}
.co-choice-btn.clients:hover { border-color:var(--gold-line); background:var(--gold-wash); }
.co-choice-name {
  font-family:'Cormorant Garamond',serif; font-size:.78rem;
  font-weight:700; color:var(--ink); margin-bottom:.2rem;
  text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width:100%;
}

/* ══ LOCATION MAP EMBED ══════════════════════════════════ */
.loc-maps-btn {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  letter-spacing:.04em; color:var(--gold); text-decoration:none;
  background:var(--gold-wash); border:1px solid var(--gold-line);
  border-radius:var(--r-xs); padding:.18rem .5rem;
  cursor:pointer; transition:all .15s; white-space:nowrap;
}
.loc-maps-btn:hover { background:var(--gold-line); color:var(--ink); }


.loc-saved-item { background:var(--gold-wash) !important; border-left:2px solid var(--gold-line); }
.loc-saved-item:hover { background:rgba(154,123,60,.12) !important; }
.loc-del-btn {
  background:transparent; border:none; cursor:pointer;
  font-size:.6rem; color:var(--ink5); padding:.15rem .3rem;
  border-radius:var(--r-xs); flex-shrink:0;
  transition:color .12s, background .12s;
}
.loc-del-btn:hover { color:#b91c1c; background:rgba(185,28,28,.08); }
.loc-section-label {
  font-family:'Outfit',sans-serif; font-size:.55rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; color:var(--ink5);
  padding:.35rem .75rem .2rem; border-top:1px solid var(--rule);
  margin-top:.15rem;
}
.cse-role {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  background:var(--parchment); border:1px solid var(--rule2);
  border-radius:3px; padding:.06rem .3rem;
  color:var(--ink5); vertical-align:middle; margin-left:.25rem;
}

/* ══ SHOOT DONE INDICATOR IN SUMMARY ════════════════════ */
.cse-shoot-done {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#2d5ba8; background:rgba(59,111,196,.07);
  border:1px solid rgba(59,111,196,.2);
  border-radius:20px; padding:.22rem .65rem;
  margin-top:.3rem; align-self:flex-start;
  animation: shootDonePop .5s cubic-bezier(.175,.885,.32,1.275) both;
}
@keyframes shootDonePop {
  0%   { transform:scale(0) rotate(-8deg); opacity:0; }
  60%  { transform:scale(1.15) rotate(2deg); opacity:1; }
  100% { transform:scale(1) rotate(0deg); opacity:1; }
}
.cse-shoot-done-flash {
  animation: shootFlash .6s ease both !important;
}
@keyframes shootFlash {
  0%,100% { background:rgba(37,99,235,.08); }
  40%     { background:rgba(37,99,235,.22); box-shadow:0 0 0 4px rgba(37,99,235,.12); }
}
.couple-summary-event.just-shot {
  animation: summaryEventFlash .7s ease both;
}
@keyframes summaryEventFlash {
  0%   { background:transparent; }
  30%  { background:rgba(37,99,235,.07); border-color:rgba(37,99,235,.3); }
  100% { background:transparent; }
}
.cse-edit-done {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#4a7a55; background:rgba(74,122,85,.08);
  border:1px solid rgba(74,122,85,.25);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .5s cubic-bezier(.175,.885,.32,1.275) both;
}
@keyframes editDonePop {
  0%   { transform:scale(0) rotate(8deg); opacity:0; }
  60%  { transform:scale(1.15) rotate(-2deg); opacity:1; }
  100% { transform:scale(1) rotate(0deg); opacity:1; }
}

/* ══ COUPLE INFO CARD PROGRESS BARS ═════════════════════ */
.cic-progress-section {
  display:flex; flex-direction:column; gap:.55rem;
  padding:.65rem 0 .3rem;
}
.cic-progress-row {
  display:grid;
  grid-template-columns: auto 1fr auto;
  align-items:center;
  gap:.5rem;
}
.cic-progress-label {
  display:flex; align-items:center; gap:.3rem; min-width:0;
}
.cic-progress-icon { font-size:.72rem; flex-shrink:0; }
.cic-progress-name {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:700;
  letter-spacing:.06em; text-transform:uppercase; color:var(--ink4);
  white-space:nowrap;
}
.cic-progress-frac {
  font-family:'Cormorant Garamond',serif; font-size:.72rem; font-weight:600;
  color:var(--ink5); margin-left:.2rem; white-space:nowrap;
}
.cic-bar-track {
  height:6px; background:var(--rule); border-radius:99px; overflow:hidden;
  min-width:0;
}
.cic-bar-fill {
  height:100%; border-radius:99px;
  transition:width .6s cubic-bezier(.4,0,.2,1);
}
.cic-bar-edit  { background:linear-gradient(90deg,#4a7a55,#6aad7a); }
.cic-bar-shoot { background:linear-gradient(90deg,#1d6fa4,#3b9de0); }
.cic-progress-pct {
  font-family:'Cormorant Garamond',serif; font-size:.8rem; font-weight:600;
  color:var(--ink4); white-space:nowrap; min-width:2.4rem; text-align:right;
}
.cic-songs-row {
  display:flex; align-items:center; justify-content:space-between;
  padding-top:.3rem; border-top:1px solid var(--rule);
  margin-top:.1rem;
}
.cic-songs-lbl {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase; color:var(--ink5);
}
.cic-songs-val {
  font-family:'Cormorant Garamond',serif; font-size:.78rem; font-weight:600;
  color:var(--ink4);
}

/* ══ EVENT MODAL ═════════════════════════════════════════ */
.ev-modal-overlay {
  position:fixed; inset:0; z-index:9000;
  background:rgba(10,8,6,.7);
  display:flex; align-items:center; justify-content:center;
  padding:2rem 1rem;
  opacity:0; pointer-events:none;
  transition:opacity .2s ease;
  overflow:hidden;
}
.ev-modal-overlay.open {
  opacity:1; pointer-events:all;
}
.ev-modal-box {
  background:var(--warm-white);
  border:1px solid var(--rule2);
  border-radius:var(--r);
  box-shadow:0 24px 80px rgba(0,0,0,.35);
  width:min(780px,96vw);
  max-height:calc(100vh - 4rem);
  display:flex; flex-direction:column;
  transform:translateY(20px) scale(.97);
  transition:transform .25s cubic-bezier(.2,.8,.3,1);
  flex-shrink:0;
}
.ev-modal-overlay.open .ev-modal-box {
  transform:translateY(0) scale(1);
}
.ev-modal-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:.85rem 1.2rem .75rem;
  border-bottom:1px solid var(--rule);
  background:var(--warm-white);
  border-radius:var(--r) var(--r) 0 0;
  flex-shrink:0;
}
.ev-modal-title {
  font-family:'Cormorant Garamond',serif;
  font-size:1.05rem; font-weight:600; font-style:italic;
  color:var(--ink);
}
.ev-modal-close {
  background:none; border:1px solid var(--rule2); cursor:pointer;
  font-size:.8rem; color:var(--ink4); padding:.28rem .55rem;
  border-radius:var(--r-xs); line-height:1;
  transition:background .12s, color .12s;
}
.ev-modal-close:hover { background:var(--rule); color:var(--ink); }
.ev-modal-body {
  padding:1rem 1.2rem 1.4rem;
  overflow-y:auto;
  flex:1;
}

/* ══ COLLAPSIBLE INNER PANELS IN EVENT MODAL ════════════ */
.ev-panel {
  border:1px solid var(--rule); border-radius:var(--r-xs);
  margin-bottom:.75rem; overflow:hidden;
}
.ev-panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:.5rem .85rem;
  background:var(--parchment);
  cursor:pointer; user-select:none;
  transition:background .12s;
}
.ev-panel-head:hover { background:var(--rule); }
.ev-panel-title {
  font-family:'Outfit',sans-serif; font-size:.65rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase; color:var(--ink4);
}
.ev-panel-chev {
  font-size:.6rem; color:var(--ink5);
  transition:transform .2s ease;
}
.ev-panel.open .ev-panel-chev { transform:rotate(180deg); }
.ev-panel-body {
  display:none; padding:.75rem .85rem;
  border-top:1px solid var(--rule);
}
.ev-panel.open .ev-panel-body { display:block; }

/* ══ BACKUP FIELDS ═══════════════════════════════════════ */
.ev-backup-block {
  margin-bottom:.5rem;
}
.ev-backup-fields {
  display:flex; align-items:flex-end; gap:.75rem; flex-wrap:wrap;
  margin-top:.45rem; padding:.55rem .65rem;
  background:rgba(37,99,235,.04); border:1px solid rgba(37,99,235,.12);
  border-radius:var(--r-xs);
}
.ev-backup-check {
  display:flex; align-items:center; gap:.4rem;
  font-family:'Outfit',sans-serif; font-size:.65rem; color:var(--ink4);
  cursor:pointer; white-space:nowrap; padding-bottom:.1rem;
}
.ev-backup-check input[type=checkbox] { accent-color:#2563eb; width:13px; height:13px; cursor:pointer; }
.ev-backup-check span { user-select:none; }

/* ══ BREADCRUMB NAV ══════════════════════════════════════ */
.breadcrumb {
  display:flex; align-items:center; gap:.2rem;
  padding:.55rem var(--page-pad);
  background:var(--warm-white);
  border-bottom:1px solid var(--rule);
  font-family:'Outfit',sans-serif;
  font-size:.62rem; letter-spacing:.04em;
  position:sticky; top:0; z-index:200;
}
.bc-item {
  color:var(--ink5); cursor:pointer; text-decoration:none;
  padding:.18rem .35rem; border-radius:var(--r-xs);
  transition:color .12s, background .12s;
  white-space:nowrap;
}
.bc-item:hover { color:var(--ink); background:var(--rule); }
.bc-item.active {
  color:var(--ink); font-weight:600; cursor:default;
  background:transparent;
}
.bc-sep {
  color:var(--rule2); font-size:.55rem; user-select:none;
}

/* ══ DASHBOARD CONTENT WRAPPER ═══════════════════════════ */
.co-dash-content {
  max-width:1400px;
  margin:0 auto;
  padding:0 3rem 6rem;
}
@media(max-width:700px){ .co-dash-content { padding:0 1rem 4rem; } }

/* Fix hero inner max-width to match */
.co-dash-hero-inner {
  max-width:1400px !important;
  margin:0 auto;
  padding:0 3rem;
}
@media(max-width:700px){ .co-dash-hero-inner { padding:0 1rem; } }

/* Fix breadcrumb on company dash to match width */
#bc_company { max-width:100%; padding-left:calc((100% - 1400px) / 2 + 3rem); }
@media(max-width:1466px){ #bc_company { padding-left:3rem; } }
@media(max-width:700px){ #bc_company { padding-left:1rem; } }

/* ── Hero full-bleed inside .app ── */
.app .co-dash-hero {
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
  width: 100vw;
}

/* ── Hero nav button variants ── */
.co-dash-hero-btn.nav-companies {
  background: #f5f0e8;
  color: #1a1714;
  border: none;
}
.co-dash-hero-btn.nav-companies:hover { background: #ede7d9; }

.co-dash-hero-btn.nav-dashboard {
  background: #2563eb;
  color: #fff;
  border: none;
}
.co-dash-hero-btn.nav-dashboard:hover { background: #1d4ed8; }

/* ── Library genre toggle button ── */
.lib-genre-toggle {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  letter-spacing:.06em; text-transform:uppercase;
  background:none; border:1px solid var(--rule2);
  border-radius:var(--r-xs); padding:.18rem .55rem;
  cursor:pointer; color:var(--ink4);
  transition:background .12s, color .12s;
}
.lib-genre-toggle:hover { background:var(--rule); color:var(--ink); }

/* ── Changes badge in event summary ── */
.cse-badges-row {
  display:flex; flex-wrap:wrap; gap:.25rem;
  margin-bottom:.4rem;
}
.cse-badges-row > div {
  margin-top:0 !important;
}
.cse-changes-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#b45309; background:rgba(180,83,9,.09);
  border:1px solid rgba(180,83,9,.28);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .4s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-photo-edit-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#4a7a55; background:rgba(74,122,85,.08);
  border:1px solid rgba(74,122,85,.25);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .5s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-video-edit-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#2d5ba8; background:rgba(59,111,196,.07);
  border:1px solid rgba(59,111,196,.2);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .5s .06s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-photo-changes-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#b45309; background:rgba(180,83,9,.09);
  border:1px solid rgba(180,83,9,.28);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .4s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-video-changes-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#7c3aed; background:rgba(124,58,237,.07);
  border:1px solid rgba(124,58,237,.22);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .4s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-pause-badge {
  display:inline-flex; align-items:center; gap:.35rem;
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.07em; text-transform:uppercase;
  color:#6b7280; background:rgba(107,114,128,.09);
  border:1px solid rgba(107,114,128,.25);
  border-radius:20px; padding:.22rem .65rem;
  animation: editDonePop .4s cubic-bezier(.175,.885,.32,1.275) both;
}

/* ── Date quick-pick ── */
.ev-date-quick {
  display:flex; flex-wrap:wrap; gap:.3rem; margin-top:.4rem;
}
.ev-date-chip {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  letter-spacing:.04em; padding:.2rem .55rem;
  border:1px solid var(--rule2); border-radius:20px;
  background:var(--parchment); color:var(--ink4);
  cursor:pointer; transition:background .12s, color .12s;
  white-space:nowrap;
}
.ev-date-chip:hover { background:var(--gold); color:var(--ink); border-color:var(--gold); }

.ev-changes-textarea {
  font-family:'Outfit',sans-serif; font-size:.72rem;
  resize:vertical; min-height:2.5rem; line-height:1.5;
}

/* ══ CLIENT TIMELINE ════════════════════════════════════ */
.ctl-mini {
  background:var(--warm-white); border:1px solid var(--rule2);
  border-radius:var(--r-lg); padding:.75rem .9rem .8rem;
  margin-top:.75rem; position:relative; overflow:hidden;
  box-shadow:0 2px 8px rgba(26,26,32,.04);
}
.ctl-mini::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold-line) 40%, var(--gold-line) 60%, transparent);
}
.ctl-mini-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:.55rem; }
.ctl-mini-title {
  font-family:'Cormorant Garamond',serif; font-size:.82rem; font-weight:600;
  font-style:italic; color:var(--ink3); letter-spacing:.02em;
}
.ctl-mini-open {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:600;
  letter-spacing:.08em; text-transform:uppercase; color:var(--gold);
  background:none; border:1px solid var(--gold-line); border-radius:20px;
  padding:.15rem .5rem; cursor:pointer; transition:all .15s;
}
.ctl-mini-open:hover { background:var(--gold-wash); }
.ctl-mini-progress { display:flex; align-items:center; gap:.5rem; margin-bottom:.55rem; }
.ctl-mini-bar-wrap { flex:1; height:5px; border-radius:3px; background:var(--rule); overflow:hidden; }
.ctl-mini-bar-fill { height:100%; border-radius:3px; background:var(--gold); transition:width .5s; }
.ctl-mini-pct { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700; color:var(--ink4); white-space:nowrap; }
.ctl-mini-steps { display:flex; flex-direction:column; gap:.22rem; }
.ctl-mini-step { display:flex; align-items:center; gap:.45rem; font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink3); padding:.2rem 0; }
.ctl-mini-step.done { color:var(--ink5); }
.ctl-mini-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; border:1.5px solid var(--rule2); background:var(--parchment); }
.ctl-mini-step.done .ctl-mini-dot { background:var(--gold); border-color:var(--gold-lt); }
.ctl-mini-step.event-step .ctl-mini-dot { background:var(--gold-wash); border-color:var(--gold-line); }
.ctl-mini-step.done.event-step .ctl-mini-dot { background:var(--gold); border-color:var(--gold-lt); }
.ctl-mini-step-label { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ctl-mini-step.done .ctl-mini-step-label { text-decoration:line-through; opacity:.6; }
.ctl-mini-step-date { font-size:.54rem; color:var(--ink5); white-space:nowrap; }
.ctl-mini-more { font-family:'Outfit',sans-serif; font-size:.56rem; color:var(--ink5); font-style:italic; margin-top:.25rem; text-align:center; }

/* ── Full timeline modal ── */
.ctl-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.52); z-index:2900;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .18s;
}
.ctl-overlay.open { opacity:1; pointer-events:all; }
.ctl-box {
  background:var(--warm-white); border-radius:var(--r-xl);
  width:min(680px,96vw); max-height:88vh; display:flex; flex-direction:column;
  box-shadow:0 24px 70px rgba(0,0,0,.22);
  transform:translateY(12px); transition:transform .2s;
}
.ctl-overlay.open .ctl-box { transform:translateY(0); }
.ctl-head {
  padding:1.2rem 1.5rem .9rem; border-bottom:1px solid var(--rule);
  display:flex; align-items:flex-start; justify-content:space-between; flex-shrink:0;
}
.ctl-head-left { display:flex; flex-direction:column; gap:.2rem; }
.ctl-title { font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:600; font-style:italic; color:var(--ink); }
.ctl-subtitle { font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:300; letter-spacing:.12em; text-transform:uppercase; color:var(--ink5); }
.ctl-close { background:none; border:none; cursor:pointer; font-size:1rem; color:var(--ink4); padding:.1rem .3rem; border-radius:var(--r-xs); }
.ctl-close:hover { color:var(--ink); background:var(--parchment); }
.ctl-body { background: var(--warm-white);  overflow-y:auto; flex:1; padding:1rem 1.5rem 1.5rem; }
.ctl-section-label {
  font-family:'Outfit',sans-serif; font-size:.54rem; font-weight:700;
  letter-spacing:.14em; text-transform:uppercase; color:var(--ink5);
  margin:.9rem 0 .4rem; padding-bottom:.3rem; border-bottom:1px solid var(--rule);
}
.ctl-section-label:first-child { margin-top:0; }
.ctl-step { display:grid; grid-template-columns:24px 1fr; gap:0 .65rem; margin-bottom:.15rem; position:relative; }
.ctl-step:not(:last-child) .ctl-step-line { position:absolute; left:11px; top:24px; bottom:-4px; width:1.5px; background:var(--rule2); }
.ctl-step-dot-col { display:flex; flex-direction:column; align-items:center; padding-top:3px; }
.ctl-step-dot {
  width:18px; height:18px; border-radius:50%; flex-shrink:0;
  border:2px solid var(--rule2); background:var(--parchment);
  display:flex; align-items:center; justify-content:center;
  font-size:.55rem; cursor:pointer; transition:all .15s; position:relative; z-index:1;
}
.ctl-step.done .ctl-step-dot { background:rgba(74,122,85,.85); border-color:rgba(74,122,85,.5); color:#fff; }
.ctl-step.event-type .ctl-step-dot { background:rgba(37,99,235,.1); border-color:rgba(37,99,235,.35); }
.ctl-step.event-type.done .ctl-step-dot { background:rgba(37,99,235,.75); border-color:rgba(37,99,235,.5); color:#fff; }
.ctl-step-dot:hover { transform:scale(1.15); box-shadow:0 2px 8px rgba(0,0,0,.12); }
.ctl-step-content {
  background:var(--canvas); border:1px solid var(--rule2);
  border-radius:var(--r-md); padding:.55rem .75rem .6rem;
  margin-bottom:.4rem; transition:border-color .15s; cursor:pointer;
}
.ctl-step-content:hover { border-color:var(--gold-line); }
.ctl-step.done .ctl-step-content { background:rgba(74,122,85,.04); border-color:rgba(74,122,85,.18); }
.ctl-step.event-type .ctl-step-content { background:rgba(37,99,235,.03); border-color:rgba(37,99,235,.15); }
.ctl-step-name { font-family:'Outfit',sans-serif; font-size:.72rem; font-weight:600; color:var(--ink2); display:flex; align-items:center; gap:.4rem; }
.ctl-step.done .ctl-step-name { color:var(--ink4); }
.ctl-step-meta { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.3rem; }
.ctl-step-chip { font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:500; padding:.12rem .4rem; border-radius:20px; background:var(--parchment); border:1px solid var(--rule2); color:var(--ink4); }
.ctl-step-chip.date { border-color:var(--gold-line); color:var(--gold); }
.ctl-step-chip.person { border-color:rgba(74,122,85,.3); color:#4a7a55; }
.ctl-step-chip.event { border-color:rgba(37,99,235,.25); color:#1d6fa4; }
.ctl-step-notes { font-family:'Outfit',sans-serif; font-size:.6rem; color:var(--ink4); margin-top:.3rem; line-height:1.5; font-style:italic; }
.ctl-step-actions { display:flex; gap:.35rem; margin-top:.35rem; flex-wrap:wrap; }
.ctl-step-btn {
  font-family:'Outfit',sans-serif; font-size:.56rem; font-weight:600;
  letter-spacing:.05em; padding:.18rem .5rem; border-radius:20px;
  border:1px solid var(--rule2); background:var(--parchment);
  color:var(--ink4); cursor:pointer; transition:all .14s;
}
.ctl-step-btn:hover { border-color:var(--gold-line); color:var(--gold); background:var(--gold-wash); }
.ctl-step-btn.primary { border-color:rgba(74,122,85,.35); color:#4a7a55; background:rgba(74,122,85,.07); }
.ctl-step-btn.primary:hover { background:rgba(74,122,85,.14); }
.ctl-step-btn.danger { border-color:rgba(220,38,38,.25); color:#b91c1c; background:rgba(220,38,38,.05); }
.ctl-step-btn.danger:hover { background:rgba(220,38,38,.1); }
.ctl-step-form { margin-top:.4rem; display:flex; flex-direction:column; gap:.35rem; }
.ctl-step-form input, .ctl-step-form textarea, .ctl-step-form select {
  font-family:'Outfit',sans-serif; font-size:.65rem;
  border:1px solid var(--rule2); border-radius:var(--r-sm);
  padding:.3rem .5rem; background:var(--warm-white); color:var(--ink); width:100%;
}
.ctl-step-form input:focus, .ctl-step-form textarea:focus { outline:none; border-color:var(--gold-line); }
.ctl-step-form textarea { resize:vertical; min-height:2.5rem; }
.ctl-step-form-row { display:flex; gap:.4rem; }
.ctl-step-form-row input, .ctl-step-form-row select { flex:1; }
.ctl-add-step {
  display:flex; align-items:center; gap:.5rem; margin-top:.75rem;
  padding:.5rem .75rem; border:1px dashed var(--rule2); border-radius:var(--r-md);
  cursor:pointer; transition:border-color .15s, background .15s;
  font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink5);
}
.ctl-add-step:hover { border-color:var(--gold-line); color:var(--gold); background:var(--gold-wash); }

/* ══ AUDIO CAPTURE ══════════════════════════════════════ */
.ev-audio-req {
  padding:.65rem .85rem .5rem;
  border-bottom:1px solid var(--rule);
}
.ev-audio-req-label {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.1em; text-transform:uppercase; color:var(--ink4);
  margin-bottom:.55rem;
}
.ev-audio-type {
  border:1px solid var(--rule); border-radius:var(--r-sm);
  margin-bottom:.45rem; overflow:hidden;
}
.ev-audio-type.active { border-color:var(--rule2); }
.ev-audio-type-head {
  display:flex; align-items:center; gap:.5rem;
  padding:.38rem .65rem;
  background:var(--parchment);
  font-family:'Outfit',sans-serif; font-size:.68rem; color:var(--ink3);
}
.ev-audio-type-label { flex:1; font-weight:500; }
.ev-audio-count { font-size:.6rem; color:var(--gold); font-weight:600; }
.ev-audio-add-btn {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  letter-spacing:.04em; background:none; border:1px solid var(--rule2);
  border-radius:var(--r-xs); padding:.15rem .45rem;
  cursor:pointer; color:var(--ink4); transition:all .12s;
}
.ev-audio-add-btn:hover { background:var(--gold); color:var(--ink); border-color:var(--gold); }
.ev-audio-rows { padding:.45rem .65rem; display:flex; flex-direction:column; gap:.4rem; }
.ev-audio-row {
  display:grid; grid-template-columns:1fr 1fr auto;
  gap:.4rem; align-items:center;
}
.ev-audio-row-who, .ev-audio-row-what { min-width:0; }
.ev-audio-icon { font-size:.85rem; flex-shrink:0; }

.ev-status-inline {
  padding: .4rem .85rem .5rem;
  border-bottom: 1px solid var(--rule);
  background: rgba(232,213,168,.03);
}
/* ══ EVENT SERVICES PROMPT ══════════════════════════════ */
.ev-svc-prompt {
  display:flex; align-items:center; gap:.45rem; flex-wrap:wrap;
  padding:.45rem .85rem;
  background:rgba(154,123,60,.04);
  border-top:1px solid var(--gold-line);
}
.ev-svc-prompt-label {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.08em; text-transform:uppercase; color:var(--ink4);
  flex-shrink:0;
}
.ev-svc-btn {
  font-family:'Outfit',sans-serif; font-size:.65rem; font-weight:600;
  padding:.28rem .8rem; border-radius:20px;
  border:1px solid var(--rule2); background:var(--parchment);
  color:var(--ink4); cursor:pointer;
  display:inline-flex; align-items:center; gap:.35rem;
  transition: background .18s, border-color .18s, color .18s, transform .13s, box-shadow .18s;
}
.ev-svc-btn:hover {
  background:var(--gold-wash); color:var(--ink3);
  border-color:var(--gold-line);
}
.ev-svc-btn.active {
  background:var(--gold); border-color:var(--gold);
  color:#fff; font-weight:700;
  box-shadow:0 2px 8px rgba(154,123,60,.3);
  transform: scale(1.04);
}
.ev-svc-btn:active { transform: scale(0.97); }
.ev-svc-count {
  font-size:.58rem; font-weight:700;
  background:rgba(0,0,0,.12); border-radius:10px;
  padding:.05rem .35rem; min-width:1.2rem; text-align:center;
  transition: background .18s;
}
.ev-svc-btn.active .ev-svc-count {
  background:rgba(0,0,0,.2);
}

/* ══ SERVICE-GATED SHOW/HIDE TRANSITIONS ════════════════ */
.ev-crew-block, .ev-audio-req, .ev-backup-block,
.ev-prod-field {
  animation: svcFadeIn .22s ease;
}
@keyframes svcFadeIn {
  from { opacity:0; transform:translateY(-6px); }
  to   { opacity:1; transform:translateY(0); }
}

/* ══ MODAL SERVICES BAR ════════════════════════════════ */
.ev-svc-bar { background:linear-gradient(to right, rgba(154,123,60,.05), transparent); border-bottom:1px solid var(--gold-line); 
  display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
  padding:.55rem .9rem;
  background:rgba(193,154,79,.06);
  border-bottom:1px solid var(--rule);
}
.ev-svc-bar-label { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--gold); 
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.08em; text-transform:uppercase; color:var(--ink4);
  flex-shrink:0; margin-right:.2rem;
}
/* ══ SUMMARY ROW LIVE-UPDATE ANIMATIONS ═════════════════ */
@keyframes cseRowPop {
  0%   { transform: scale(1); }
  30%  { transform: scale(1.06) translateX(3px); color: var(--gold); }
  100% { transform: scale(1); color: inherit; }
}
@keyframes cseRowEnter {
  from { opacity:0; transform: translateY(-8px) scale(.96); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}
@keyframes cseRowExit {
  from { opacity:1; transform: translateY(0); max-height: 3rem; }
  to   { opacity:0; transform: translateY(-6px); max-height: 0; overflow:hidden; }
}
.cse-row-pop {
  animation: cseRowPop .3s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-row-enter {
  opacity: 0;
}
.cse-row-entered {
  animation: cseRowEnter .28s cubic-bezier(.175,.885,.32,1.275) both;
}
.cse-row-exit {
  animation: cseRowExit .18s ease forwards;
  pointer-events: none;
}

.cse-video-shoot-badge {
  color:#1d6fa4; background:rgba(37,99,235,.08);
  border-color:rgba(37,99,235,.22);
}
/* ══ SUMMARY SECTION HEADERS ════════════════════════════ */
.cse-section-header {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:800;
  letter-spacing:.1em; text-transform:uppercase;
  color:var(--ink4); opacity:.6;
  margin-top:.5rem; margin-bottom:.1rem;
  padding-left:.1rem;
}
.ev-chg-resolve {
  cursor:pointer; text-decoration:underline; text-underline-offset:2px;
  opacity:.8;
}
.ev-chg-resolve:hover { opacity:1; }
.ev-chg-undo {
  cursor:pointer; margin-left:.25rem; opacity:.5; font-size:.7em;
  font-weight:700; padding:0 .2rem;
  border-radius:3px;
}
.ev-chg-undo:hover { opacity:1; background:rgba(180,83,9,.15); }
.ev-changes-resolved {
  opacity:.5; font-style:italic; font-size:.58rem;
  background:transparent; border-color:transparent;
}
/* ══ EVENT SETUP PANEL COLLAPSE ═════════════════════════ */
.setup-panel-header {
  padding-bottom:.5rem;
}
.setup-panel-body {
  overflow: hidden;
  max-height: 600px;
  transition: max-height .35s cubic-bezier(.4,0,.2,1),
              opacity .25s ease,
              padding .25s ease;
  opacity: 1;
}
.setup-panel-body.setup-panel-collapsed {
  max-height: 0;
  opacity: 0;
  padding-top: 0;
  padding-bottom: 0;
}
.setup-panel-chev {
  font-size: .65rem;
  color: var(--ink4);
  transition: transform .3s cubic-bezier(.4,0,.2,1);
  display: inline-block;
}
.setup-panel-is-collapsed .setup-panel-chev {
  transform: rotate(180deg);
}
.setup-panel-is-collapsed {
  margin-bottom: .75rem !important;
}

/* ── Button drag-reorder ── */
.ev-btn-wrap { display:inline-flex; align-items:center; position:relative; }
.ev-btn-wrap:active { cursor:grabbing; }
.ev-btn-drag-handle {
  display:none; position:absolute; left:-1px; top:50%; transform:translateY(-50%);
  font-size:.6rem; color:var(--ink4,#aaa); opacity:.5; pointer-events:none; line-height:1;
}
.ev-btn-wrap:hover .ev-btn-drag-handle { display:block; }
.ev-btn-wrap.ev-drag-over > .ev-approve-btn,
.ev-btn-wrap.ev-drag-over > .ev-pause-btn { outline:2px dashed #c9a84c; outline-offset:2px; }
.ev-btn-wrap.ev-dragging { opacity:.3; }


/* ── Panel drag-reorder ── */
.ev-panel-drag-handle {
  font-size:.75rem; color:var(--ink4,#bbb); opacity:.4; cursor:grab;
  padding:0 .4rem 0 0; line-height:1; flex-shrink:0;
  transition:opacity .15s;
}
.ev-panel-draggable:hover .ev-panel-drag-handle { opacity:.8; }
.ev-panel-draggable.ep-dragging { opacity:.3; }
.ev-panel-draggable.ep-drag-over { outline:2px dashed #c9a84c; outline-offset:-2px; border-radius:6px; }
.ev-panel-head { display:flex; align-items:center; }
.ev-panel-title { flex:1; }


/* ── Client Journey drag-reorder ── */
.ctl-step-drag-handle {
  font-size:.75rem; color:var(--ink4,#bbb); opacity:0; cursor:grab;
  display:block; line-height:1; margin-bottom:.25rem; transition:opacity .15s;
}
.ctl-step:hover .ctl-step-drag-handle { opacity:.6; }
.ctl-step.ctl-dragging { opacity:.3; }
.ctl-step.ctl-drag-over { outline:2px dashed #c9a84c; outline-offset:2px; border-radius:6px; }


/* ── Journey section groups ── */
.ctl-step-group { margin-bottom:.5rem; }
.ctl-section-label {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:700;
  letter-spacing:.08em; text-transform:uppercase; color:var(--gold);
  padding:.5rem 0 .3rem; margin-top:.4rem;
}


/* ── Journey event blocks ── */
.ctl-event-block {
  margin-bottom: .75rem;
}
.ctl-event-block-label {
  font-family: 'Outfit', sans-serif;
  font-size: .62rem;
  font-weight: 700;
  color: var(--ink3);
  padding: .35rem .5rem .2rem;
  border-left: 2px solid var(--gold-line);
  margin-bottom: .2rem;
  letter-spacing: .04em;
}
.ctl-event-block-label.done {
  color: var(--ink4);
  border-color: rgba(74,122,85,.4);
}


/* ── ev-panels-wrap padding ── */
.ev-panels-wrap { padding: .6rem .6rem .2rem; position:relative; }


/* ══ ILLUSTRATED JOURNEY TIMELINE ══════════════════════════════════════════ */
/* ══ FILM STRIP JOURNEY TIMELINE ════════════════════════════════════════════ */

/* ── Outer wrapper ── */
.ctl-visual-timeline {
  margin-bottom: 1.6rem;
  position: relative;
  border-radius: 12px;
  overflow: visible;
}

/* ── Film strip body ── */
.ctl-film-strip {
  position: relative;
  background: #2a1f0e;
  border-radius: 10px;
  padding: 0;
  overflow: visible;
  box-shadow:
    0 4px 24px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.06);
}

/* ── Header bar above the strip ── */
.ctl-film-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: .6rem 1rem .55rem;
  background: linear-gradient(to right, #1a1206, #2a1f0e, #1a1206);
  border-radius: 10px 10px 0 0;
  border-bottom: 1px solid rgba(154,123,60,.2);
  gap: .5rem;
}
.ctl-film-title {
  font-family: 'Outfit', sans-serif;
  font-size: .58rem; font-weight: 700; letter-spacing: .14em;
  text-transform: uppercase; color: var(--gold-lt);
}
.ctl-film-fraction {
  font-family: 'Cormorant Garamond', serif;
  font-size: .8rem; font-weight: 600; color: rgba(232,213,168,.75);
  font-style: italic;
}

/* ── Sprocket holes row (top) ── */
.ctl-film-sprockets {
  display: flex; align-items: center;
  background: #1a1206;
  padding: .18rem .5rem;
  gap: 0;
  overflow: hidden;
}
.ctl-film-sprocket {
  flex: 1;
  display: flex; justify-content: center;
}
.ctl-film-sprocket-hole {
  width: 10px; height: 14px;
  border-radius: 3px;
  background: #3d2e12;
  border: 1.5px solid #4e3b18;
  box-shadow: inset 0 1px 3px rgba(0,0,0,.5);
}

/* ── Frames row ── */
.ctl-film-frames {
  display: flex; align-items: stretch;
  overflow-x: auto; overflow-y: visible;
  height: 140px;
  scrollbar-width: thin;
  scrollbar-color: rgba(154,123,60,.4) transparent;
  scroll-behavior: smooth;
  background: #231a0b;
  gap: 0;
}
.ctl-film-frames::-webkit-scrollbar { height: 3px; }
.ctl-film-frames::-webkit-scrollbar-thumb { background: rgba(154,123,60,.4); border-radius: 2px; }

/* ── Individual frame ── */
.ctl-film-frame {
  flex: 0 0 auto;
  min-width: 78px;
  max-width: 90px;
  display: flex; flex-direction: column; align-items: center; justify-content: space-between;
  padding: .35rem .3rem .45rem;
  border-right: 1px solid rgba(154,123,60,.12);
  position: relative;
  transition: min-width .2s, background .2s;
  cursor: pointer;
  overflow: visible;
  background: rgba(232,213,168,.13);
}
.ctl-film-frame:last-child { border-right: none; }
.ctl-film-frame:hover {
  min-width: 100px;
  background: rgba(154,123,60,.08);
}
.ctl-film-frame.done { background: rgba(154,123,60,.35); border-right-color: rgba(154,123,60,.25); }
.ctl-film-frame.active { background: #c4a05a; border-right-color: rgba(154,123,60,.4); min-width: 100px; }

/* Frame number top-left */
.ctl-film-frame-top {
  display: flex; flex-direction: column; align-items: center; gap: .1rem;
  width: 100%;
}
.ctl-film-frame-num {
  font-family: 'Outfit', sans-serif;
  font-size: .42rem; font-weight: 700; letter-spacing: .06em;
  color: rgba(232,213,168,.3);
  text-align: center;
}
.ctl-film-frame.active .ctl-film-frame-num { color: rgba(26,18,6,.4); }

/* ── Icon node inside frame ── */
.ctl-film-node {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem;
  border: 2px solid rgba(232,213,168,.5);
  background: rgba(232,213,168,.15);
  position: relative; z-index: 1;
  transition: .22s;
  flex-shrink: 0;
  margin-bottom: .3rem;
}
.ctl-film-frame.done .ctl-film-node {
  border-color: var(--gold);
  background: rgba(154,123,60,.45);
  box-shadow: 0 0 14px rgba(154,123,60,.45), inset 0 1px 0 rgba(255,255,255,.1);
}
.ctl-film-frame.active .ctl-film-node {
  border-color: #1a1206;
  border-width: 2.5px;
  background: rgba(26,18,6,.55);
  animation: film-pulse 2s infinite;
  width: 44px !important; height: 44px !important; font-size: 1.3rem !important;
}
.ctl-film-frame:hover .ctl-film-node {
  width: 44px !important; height: 44px !important;
  font-size: 1.3rem !important;
  border-color: var(--gold-lt);
  box-shadow: 0 0 16px rgba(154,123,60,.35), 0 4px 12px rgba(0,0,0,.4);
  transform: translateY(-8px);
}
@keyframes film-pulse {
  0%,100% { box-shadow: 0 0 0 3px rgba(154,123,60,.15); }
  50%      { box-shadow: 0 0 0 6px rgba(154,123,60,.06); }
}

/* Done check badge */
.ctl-film-check {
  position: absolute; bottom: -3px; right: -3px;
  width: 13px; height: 13px; border-radius: 50%;
  background: var(--gold); color: #1a1206;
  font-size: .42rem; display: flex; align-items: center; justify-content: center;
  font-weight: 900; border: 1.5px solid #231a0b;
}

/* Label */
.ctl-film-label { display: none; }
.ctl-film-frame.done .ctl-film-label { color: #f0d98a; font-weight: 700; }
.ctl-film-frame.done .ctl-film-date { color: rgba(240,217,138,.6); }
.ctl-film-frame.active .ctl-film-date { color: rgba(26,18,6,.65); font-weight: 600; }
.ctl-film-frame.active .ctl-film-label { color: #1a1206; font-weight: 800; font-size: .62rem; }
.ctl-film-frame.active .ctl-film-label { color: var(--gold-lt); font-weight: 700; }
.ctl-film-frame:hover .ctl-film-label {
  font-size: .66rem !important;
  color: #fff !important;
  max-width: 94px !important;
}

/* Date */
.ctl-film-date {
  font-family: 'Outfit', sans-serif;
  font-size: .48rem; font-weight: 500;
  color: rgba(232,213,168,.5);
  text-align: center;
  min-height: .65rem;
}
.ctl-film-frame.done .ctl-film-date { color: rgba(240,217,138,.65); }
.ctl-film-frame.active .ctl-film-date { color: rgba(26,18,6,.6); font-weight: 600; }
.ctl-film-frame:hover .ctl-film-date {
  font-size: .56rem !important;
  color: var(--gold-lt) !important;
}

/* ── Bottom sprockets (mirror of top) ── */

/* ── Progress bar at very bottom ── */
.ctl-film-progress {
  height: 4px; border-radius: 0 0 10px 10px;
  background: rgba(255,255,255,.05);
  overflow: hidden;
}
.ctl-film-progress-fill {
  height: 100%; border-radius: 0 0 10px 10px;
  background: linear-gradient(90deg, #9a7b3c, #c4a05a);
  transition: width .6s ease;
}

/* ── Scroll arrows ── */
.ctl-film-scroll-wrap { position: relative; overflow: visible; }
.ctl-film-arrow {
  position: absolute; top: 50%; transform: translateY(-50%);
  width: 26px; height: 26px; border-radius: 50%;
  background: #1a1206; border: 1px solid rgba(154,123,60,.4);
  box-shadow: 0 2px 8px rgba(0,0,0,.4);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 10; font-size: .65rem; color: var(--gold);
  transition: all .15s; user-select: none;
}
.ctl-film-arrow:hover { background: rgba(154,123,60,.2); border-color: var(--gold); }
.ctl-film-arrow.left  { left: -13px; }
.ctl-film-arrow.right { right: -13px; }
.ctl-film-arrow.hidden { opacity: 0; pointer-events: none; }

/* ── Scroll arrow buttons (old style — keep for compat) ── */
.ctl-vt-scroll-wrap { position: relative; overflow: visible; }
.ctl-vt-arrow {
  position: absolute; top: 50%; transform: translateY(-50%);
  width: 26px; height: 26px; border-radius: 50%;
  background: #1a1206; border: 1px solid rgba(154,123,60,.4);
  box-shadow: 0 2px 8px rgba(0,0,0,.4);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 10; font-size: .65rem; color: var(--gold);
  transition: all .15s; user-select: none;
}
.ctl-vt-arrow:hover { background: rgba(154,123,60,.2); border-color: var(--gold); }
.ctl-vt-arrow.left  { left: -13px; }
.ctl-vt-arrow.right { right: -13px; }
.ctl-vt-arrow.hidden { opacity: 0; pointer-events: none; }

/* Event cards — warm gold border */
.ev-section {
  border-color: rgba(154,123,60,.2) !important;
  box-shadow: 0 1px 4px rgba(26,26,32,.03), 0 4px 24px rgba(154,123,60,.05) !important;
}
.ev-section:hover {
  border-color: rgba(154,123,60,.35) !important;
  box-shadow: 0 2px 10px rgba(154,123,60,.08), 0 8px 32px rgba(26,26,32,.05) !important;
}

/* Event name — serif elegance */
.ev-name {
  font-family: 'Cormorant Garamond', serif !important;
  font-size: 1.18rem !important;
  font-weight: 600 !important;
  letter-spacing: .01em !important;
}

/* Event client name */
.ev-client {
  font-family: 'Outfit', sans-serif !important;
  font-size: .63rem !important;
  color: var(--ink4) !important;
  letter-spacing: .03em !important;
}

/* Services buttons — warm parchment instead of dark */
.ev-svc-btn {
  border: 1px solid var(--rule2) !important;
  background: var(--parchment) !important;
  color: var(--ink3) !important;
}
.ev-svc-btn:hover {
  background: var(--gold-wash) !important;
  border-color: var(--gold-line) !important;
  color: var(--ink) !important;
}
.ev-svc-btn.active {
  background: var(--gold) !important;
  border-color: var(--gold) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px rgba(154,123,60,.3) !important;
}
.ev-svc-count {
  background: rgba(26,26,32,.1) !important;
}
.ev-svc-btn.active .ev-svc-count {
  background: rgba(255,255,255,.25) !important;
}

/* Services bar in modal */
.ev-svc-bar {
  background: linear-gradient(to right, rgba(154,123,60,.04), transparent) !important;
  border-bottom: 1px solid var(--gold-line) !important;
  padding: .75rem 1rem !important;
  gap: .7rem !important;
}
.ev-modal-body .ev-svc-btn {
  padding: .45rem 1rem !important;
  font-size: .72rem !important;
  min-height: 2rem !important;
  cursor: pointer !important;
}
.ev-svc-bar-label {
  font-family: 'Outfit', sans-serif !important;
  font-size: .58rem !important;
  font-weight: 700 !important;
  letter-spacing: .1em !important;
  text-transform: uppercase !important;
  color: var(--gold) !important;
}

/* Services prompt on card */
.ev-svc-prompt {
  background: rgba(154,123,60,.03) !important;
  border-top: 1px solid rgba(154,123,60,.12) !important;
  border-bottom: none !important;
}
.ev-svc-prompt-label {
  color: var(--gold) !important;
}

/* Shoot buttons — soften from hard blue */
.ev-approve-btn.shoot-btn {
  border-color: rgba(59,111,196,.25) !important;
  color: #3b6fc4 !important;
}
.ev-approve-btn.shoot-btn:hover {
  border-color: rgba(59,111,196,.45) !important;
  background: rgba(59,111,196,.06) !important;
  color: #2d5ba8 !important;
}
.ev-approve-btn.shoot-btn.approved {
  background: rgba(59,111,196,.07) !important;
  border-color: rgba(59,111,196,.3) !important;
  color: #2d5ba8 !important;
}

/* Shoot done badge — soften blue */
.cse-shoot-done {
  color: #2d5ba8 !important;
  background: rgba(59,111,196,.07) !important;
  border-color: rgba(59,111,196,.2) !important;
}
.cse-video-shoot-badge {
  color: #2d5ba8 !important;
  background: rgba(59,111,196,.07) !important;
  border-color: rgba(59,111,196,.2) !important;
}

/* Shoot progress bar */
.cc-prog-fill-shoot { background: #3b6fc4 !important; }

/* Footage / Images received inline button */
.ev-approve-btn[id^="ftgBtn_"],
.ev-approve-btn[id^="imgBtn_"] {
  font-size: .6rem !important;
}

/* Remove button — brand aligned */
.rm-inst {
  font-family: 'Outfit', sans-serif !important;
  font-size: .58rem !important;
  font-weight: 600 !important;
  letter-spacing: .06em !important;
  text-transform: uppercase !important;
  color: var(--ink5) !important;
  border-color: var(--rule2) !important;
  background: transparent !important;
}
.rm-inst:hover {
  color: var(--ink2) !important;
  border-color: var(--ink4) !important;
  background: var(--parchment) !important;
}

/* Category headers */
.cat-lbl {
  font-family: 'Outfit', sans-serif !important;
  font-size: .54rem !important;
  font-weight: 700 !important;
  letter-spacing: .22rem !important;
  text-transform: uppercase !important;
  color: var(--gold) !important;
}


/* Journey node hover enlargement — pushes siblings */
.ctl-vt-phase {
  transition: min-width .2s ease, max-width .2s ease;
  height: 140px;
  justify-content: flex-end;
  overflow: visible;
}
.ctl-vt-node {
  transition: all .22s ease;
}
.ctl-vt-label {
  transition: font-size .2s ease, color .2s ease;
}
.ctl-vt-date {
  transition: font-size .2s ease;
}
.ctl-vt-phase:hover {
  min-width: 108px;
  max-width: 124px;
  z-index: 5;
}
.ctl-vt-phase:hover .ctl-vt-node {
  width: 52px !important;
  height: 52px !important;
  font-size: 1.5rem !important;
  border-color: var(--gold);
  box-shadow: 0 4px 14px rgba(154,123,60,.18), 0 0 0 5px rgba(154,123,60,.1);
}
.ctl-vt-phase:hover .ctl-vt-label {
  font-size: .72rem !important;
  color: var(--ink) !important;
  max-width: 112px !important;
  font-weight: 700 !important;
}
.ctl-vt-phase:hover .ctl-vt-date {
  font-size: .62rem !important;
  color: var(--gold) !important;
}


/* Film strip header label — between title and fraction */
.ctl-film-header-label {
  flex: 1;
  text-align: center;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.05rem; font-weight: 600; font-style: italic;
  color: rgba(232,213,168,.95);
  letter-spacing: .02em;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  padding: 0 .8rem;
  transition: opacity .2s;
}


/* ── Client Journey Sidebar Panel ─────────────────────────────── */
.cj-sidebar-panel {
  background: var(--warm-white);
  border: 1px solid var(--rule);
  border-radius: var(--r-xl);
  padding: 1.2rem 1.4rem 1rem;
  margin-bottom: 1.4rem;
  box-shadow: 0 1px 3px rgba(26,26,32,.04), 0 4px 24px rgba(26,26,32,.06);
  position: relative;
}
.cj-sidebar-panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:3px;
  background: linear-gradient(90deg, var(--gold), var(--gold-pale));
  border-radius: var(--r-xl) var(--r-xl) 0 0;
}
.cj-sb-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:.6rem;
}
.cj-sb-title {
  font-family:'Outfit',sans-serif;
  font-size:.58rem; font-weight:700; letter-spacing:.1em;
  text-transform:uppercase; color:var(--gold);
}
.cj-sb-fraction {
  font-family:'Cormorant Garamond',serif;
  font-size:.8rem; font-weight:600; font-style:italic; color:var(--ink3);
}
.cj-sb-open-btn {
  font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:700;
  letter-spacing:.06em; padding:.15rem .5rem; border-radius:20px;
  border:1px solid var(--gold-line); background:var(--gold-wash);
  color:var(--gold); cursor:pointer; text-transform:uppercase;
  transition:background .15s;
}
.cj-sb-open-btn:hover { background:var(--parchment); }
.cj-sb-progress-bar {
  height:3px; border-radius:2px; background:var(--rule);
  margin-bottom:.8rem; overflow:hidden;
}
.cj-sb-progress-fill {
  height:100%; border-radius:2px;
  background: linear-gradient(90deg, var(--gold-lt), var(--gold-pale));
  transition:width .5s;
}
.cj-sb-steps { display:flex; flex-direction:column; gap:0; }
.cj-sb-step {
  display:flex; align-items:center; gap:.5rem;
  padding:.3rem .2rem; cursor:pointer;
  border-bottom:1px solid var(--rule);
  transition:background .12s; border-radius:4px;
}
.cj-sb-step:last-child { border-bottom:none; }
.cj-sb-step:hover { background:var(--gold-wash); }
.cj-sb-dot {
  width:16px; height:16px; border-radius:50%; flex-shrink:0;
  border:1.5px solid var(--rule2); background:var(--parchment);
  display:flex; align-items:center; justify-content:center;
  font-size:.45rem; font-weight:900; color:var(--warm-white);
}
.cj-sb-step.done .cj-sb-dot {
  background:var(--gold); border-color:var(--gold-lt); color:#fff;
}
.cj-sb-step.active .cj-sb-dot {
  background:var(--gold-lt); border-color:var(--gold); color:#1a1206;
  box-shadow:0 0 0 3px rgba(154,123,60,.15);
}
.cj-sb-info { display:flex; align-items:center; gap:.3rem; flex:1; min-width:0; }
.cj-sb-icon { font-size:.78rem; flex-shrink:0; }
.cj-sb-label {
  font-family:'Outfit',sans-serif; font-size:.6rem; font-weight:600;
  color:var(--ink3); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.cj-sb-step.done .cj-sb-label { text-decoration:line-through; color:var(--ink5); }
.cj-sb-step.active .cj-sb-label { color:var(--gold); font-weight:700; }
.cj-sb-step.event-step .cj-sb-label { color:var(--ink2); }
.cj-sb-date {
  font-family:'Outfit',sans-serif; font-size:.5rem; color:var(--ink5);
  white-space:nowrap; flex-shrink:0;
}
.cj-sb-step.done .cj-sb-date { color:var(--gold-lt); }


/* ── Journey Right Panel ──────────────────────────────────── */
.journey-right-panel {
  position: sticky;
  top: 1.5rem;
}
.cj-sidebar-panel {
  background: var(--warm-white);
  border: 1px solid var(--rule);
  border-radius: var(--r-xl);
  padding: 1.2rem 1.2rem 1rem;
  box-shadow: 0 1px 3px rgba(26,26,32,.04), 0 4px 24px rgba(26,26,32,.06);
  position: relative;
  overflow: hidden;
}
.cj-sidebar-panel::before {
  content:''; position:absolute; top:0; left:0; right:0; height:3px;
  background: linear-gradient(90deg, var(--gold), var(--gold-pale));
  border-radius: var(--r-xl) var(--r-xl) 0 0;
}
.cj-sb-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:.55rem;
}
.cj-sb-title {
  font-family:'Outfit',sans-serif;
  font-size:.58rem; font-weight:700; letter-spacing:.1em;
  text-transform:uppercase; color:var(--gold);
}
.cj-sb-fraction {
  font-family:'Cormorant Garamond',serif;
  font-size:.78rem; font-weight:600; font-style:italic; color:var(--ink3);
}
.cj-sb-open-btn {
  font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:700;
  letter-spacing:.06em; padding:.14rem .45rem; border-radius:20px;
  border:1px solid var(--gold-line); background:var(--gold-wash);
  color:var(--gold); cursor:pointer; text-transform:uppercase;
  transition:background .15s;
}
.cj-sb-open-btn:hover { background:var(--parchment); }
.cj-sb-progress-bar {
  height:3px; border-radius:2px; background:var(--rule);
  margin-bottom:.7rem; overflow:hidden;
}
.cj-sb-progress-fill {
  height:100%; border-radius:2px;
  background: linear-gradient(90deg, var(--gold-lt), var(--gold-pale));
  transition:width .5s;
}
.cj-sb-steps { display:flex; flex-direction:column; }
.cj-sb-step {
  display:flex; align-items:center; gap:.45rem;
  padding:.28rem .1rem; cursor:pointer;
  border-bottom:1px solid var(--rule);
  transition:background .12s; border-radius:4px;
}
.cj-sb-step:last-child { border-bottom:none; }
.cj-sb-step:hover { background:var(--gold-wash); padding-left:.35rem; }
.cj-sb-dot {
  width:15px; height:15px; border-radius:50%; flex-shrink:0;
  border:1.5px solid var(--rule2); background:var(--parchment);
  display:flex; align-items:center; justify-content:center;
  font-size:.42rem; font-weight:900; color:transparent;
  transition: all .15s;
}
.cj-sb-step.done .cj-sb-dot { background:var(--gold); border-color:var(--gold-lt); color:#fff; }
.cj-sb-step.active .cj-sb-dot { background:transparent; border-color:var(--gold); color:var(--gold); font-size:.55rem; box-shadow:0 0 0 3px rgba(154,123,60,.12); }
.cj-sb-info { display:flex; align-items:center; gap:.28rem; flex:1; min-width:0; }
.cj-sb-icon { font-size:.72rem; flex-shrink:0; line-height:1; }
.cj-sb-label {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600;
  color:var(--ink3); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.cj-sb-step.done .cj-sb-label { text-decoration:line-through; color:var(--ink5); font-weight:400; }
.cj-sb-step.active .cj-sb-label { color:var(--gold); font-weight:700; }
.cj-sb-date {
  font-family:'Outfit',sans-serif; font-size:.48rem; color:var(--ink5);
  white-space:nowrap; flex-shrink:0;
}
.cj-sb-step.done .cj-sb-date { color:var(--gold-lt); }


.cj-sb-date-wrap { flex-shrink:0; }
.cj-sb-date {
  font-family:'Outfit',sans-serif; font-size:.48rem; color:var(--ink5);
  white-space:nowrap; cursor:pointer; border-radius:4px; padding:.1rem .25rem;
  transition:background .12s, color .12s;
}
.cj-sb-date:hover { background:var(--gold-wash); color:var(--gold); }
.cj-sb-date-add { color:rgba(154,123,60,.4); font-style:italic; }
.cj-sb-date-add:hover { color:var(--gold); }
.cj-sb-step.done .cj-sb-date { color:var(--gold-lt); }


/* ── Device Picker ──────────────────────────────────────── */
.device-picker {
  display: flex; gap: 1rem; justify-content: center;
  flex-wrap: wrap; margin-bottom: 1.5rem;
}
.device-btn {
  display: flex; flex-direction: column; align-items: center;
  gap: .3rem; padding: 1.2rem 1.6rem;
  background: var(--warm-white); border: 1.5px solid var(--rule);
  border-radius: var(--r-xl); cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: border-color .15s, box-shadow .15s, transform .1s;
  min-width: 110px;
}
.device-btn:hover {
  border-color: var(--gold-lt);
  box-shadow: 0 4px 16px rgba(154,123,60,.12);
  transform: translateY(-2px);
}
.device-btn:active { transform: translateY(0); }
.device-icon { font-size: 1.8rem; line-height: 1; }
.device-name { font-size: .72rem; font-weight: 700; color: var(--ink); letter-spacing: .02em; }
.device-hint { font-size: .57rem; color: var(--ink5); font-weight: 400; }
.login-device-badge {
  text-align: center; margin-bottom: .8rem;
  font-family: 'Outfit', sans-serif; font-size: .6rem;
  font-weight: 600; color: var(--gold); letter-spacing: .1em;
  text-transform: uppercase;
}

/* ── Mobile layout (data-layout=mobile or tablet) ─────── */
[data-layout="mobile"] .editor-layout,
[data-layout="tablet"] .editor-layout {
  grid-template-columns: 1fr !important;
  gap: 1rem;
}
/* Tablet: sidebar + main side by side, journey list full width below */
[data-layout="tablet"] .editor-layout {
  grid-template-columns: 240px 1fr !important;
  grid-template-rows: auto auto;
}
[data-layout="tablet"] .editor-sidebar {
  grid-column: 1;
  grid-row: 1;
  display: block !important;
}
[data-layout="tablet"] .main {
  grid-column: 2;
  grid-row: 1;
}
[data-layout="tablet"] .journey-right-panel {
  grid-column: 1 / -1 !important;
  grid-row: 2;
}
[data-layout="mobile"] .journey-right-panel,
[data-layout="tablet"] .journey-right-panel {
  grid-column: 1 / -1; /* span full width below main */
  position: static;
}
[data-layout="mobile"] .cj-sidebar-panel,
[data-layout="tablet"] .cj-sidebar-panel {
  margin-top: .5rem;
}
[data-layout="mobile"] .cj-sb-steps,
[data-layout="tablet"] .cj-sb-steps {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
}
[data-layout="mobile"] .cj-sb-steps {
  grid-template-columns: 1fr;
}
[data-layout="mobile"] .editor-sidebar,
[data-layout="tablet"] .editor-sidebar {
  position: static;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .8rem;
  align-items: start;
}
[data-layout="mobile"] .editor-sidebar {
  grid-template-columns: 1fr;
}
[data-layout="mobile"] .app-nav,
[data-layout="tablet"] .app-nav {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
[data-layout="mobile"] .co-dash-hero-inner,
[data-layout="tablet"] .co-dash-hero-inner {
  flex-direction: column;
  gap: 1rem;
}
[data-layout="mobile"] .co-dash-stats,
[data-layout="tablet"] .co-dash-stats {
  flex-wrap: wrap;
}
[data-layout="mobile"] .ev-approve-row,
[data-layout="tablet"] .ev-approve-row {
  flex-wrap: wrap;
}
[data-layout="mobile"] .ev-approve-btn,
[data-layout="tablet"] .ev-approve-btn {
  font-size: .65rem !important;
  padding: .45rem .7rem;
}
[data-layout="mobile"] .ctl-film-strip,
[data-layout="tablet"] .ctl-film-strip {
  font-size: 90%;
}
[data-layout="mobile"] .couple-grid,
[data-layout="tablet"] .couple-grid {
  grid-template-columns: 1fr !important;
}
[data-layout="mobile"] {
  font-size: 14px;
}
[data-layout="tablet"] {
  font-size: 13px;
}


/* ── Global Header ─────────────────────────────── */
#globalHeader {
  position:fixed; top:0; left:0; right:0; z-index:2000;
  background:var(--warm-white); border-bottom:1px solid var(--gold-line);
  text-align:center; padding:.5rem 1rem .4rem;
  box-shadow:0 2px 12px rgba(0,0,0,.06);
}
.gh-brand { font-family:'Cormorant Garamond',serif; font-size:1.05rem; font-weight:400; letter-spacing:.03em; line-height:1.1; margin-bottom:.06rem; }
.gh-cloud,.gh-concierge { color:var(--ink); font-style:normal; }
.gh-ix { color:var(--gold); font-style:italic; }
.gh-company { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600; letter-spacing:.14em; text-transform:uppercase; color:var(--gold); min-height:.75rem; }
.gh-page { font-family:'Outfit',sans-serif; font-size:.48rem; font-weight:400; letter-spacing:.12em; text-transform:uppercase; color:var(--ink5); min-height:.65rem; }
body { padding-top:56px; }


/* ── Sitemap pills ─────────────────────────────── */
.co-dash-hero-right { display:flex; flex-direction:column; align-items:flex-end; gap:.15rem; }
.hero-sitemap { display:flex; align-items:center; gap:.18rem; margin-bottom:.3rem; overflow:visible; }
.hero-sitemap-pill {
  font-family:'Outfit',sans-serif; font-size:.46rem; font-weight:600;
  letter-spacing:.08em; text-transform:uppercase;
  padding:.15rem .48rem; border-radius:20px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05); color:rgba(245,240,232,.35);
  white-space:nowrap; transition:all .15s;
}
.hero-sitemap-pill.active {
  background:rgba(255,255,255,.2); border-color:rgba(255,255,255,.55);
  color:#fff; font-weight:800; box-shadow:0 0 0 2px rgba(255,255,255,.1);
}
.hero-sitemap-pill.active-blue {
  background:rgba(255,255,255,.95); border-color:#fff;
  color:#2563eb; font-weight:800; box-shadow:0 0 0 2px rgba(255,255,255,.2);
}
.hero-sitemap-pill.active-gold {
  background:rgba(255,255,255,.95); border-color:#fff;
  color:#9a7b3c; font-weight:800; box-shadow:0 0 0 2px rgba(255,255,255,.2);
}
.hero-sitemap-pill.active-green {
  background:rgba(255,255,255,.95); border-color:#fff;
  color:#2d6b4a; font-weight:800; box-shadow:0 0 0 2px rgba(255,255,255,.2);
}
.hero-sitemap-pill.active-purple {
  background:rgba(255,255,255,.95); border-color:#fff;
  color:#533483; font-weight:800; box-shadow:0 0 0 2px rgba(255,255,255,.2);
}
.hero-sitemap-pill.clickable { cursor: default; }
.hero-sitemap-sep { font-size:.46rem; color:rgba(255,255,255,.18); }
/* Green Editing Room button */
.co-dash-hero-btn.er-btn { background:var(--forest); color:#fff; border:1.5px solid var(--forest); }
.co-dash-hero-btn.er-btn:hover { background:#1e5c3a; border-color:#1e5c3a; }
/* Purple Theatre Room button */
.co-dash-hero-btn.tr-btn { background:#533483; color:#fff; border:1.5px solid #533483; }
.co-dash-hero-btn.tr-btn:hover { background:#6b44a0; }

/* ── Theatre Room ─────────────────────────────────── */
.tr-couple-select { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.5rem; }
.tr-couple-pill {
  font-family:'Outfit',sans-serif; font-size:.62rem; font-weight:600;
  padding:.3rem .7rem; border-radius:20px; cursor:pointer;
  border:1px solid var(--rule2); background:var(--card); color:var(--ink3); transition:all .15s;
}
.tr-couple-pill:hover { border-color:var(--gold-line); }
.tr-couple-pill.on { background:#533483; color:#fff; border-color:#533483; }

.tr-video-list { display:flex; flex-direction:column; gap:.6rem; margin-bottom:1rem; }
.tr-video-card {
  background:var(--card); border:1px solid var(--rule); border-radius:10px;
  padding:.6rem .8rem; cursor:pointer; transition:all .15s; display:flex; align-items:center; gap:.6rem;
}
.tr-video-card:hover { border-color:var(--gold-line); box-shadow:0 2px 12px rgba(0,0,0,.06); }
.tr-video-card.active { border-color:#533483; box-shadow:0 0 0 2px rgba(83,52,131,.2); }
.tr-video-title { font-family:'Cormorant Garamond',serif; font-size:.9rem; font-weight:600; color:var(--ink); }
.tr-video-meta { font-family:'Outfit',sans-serif; font-size:.5rem; color:var(--ink5); margin-top:.1rem; }
.tr-video-badge { display:inline-block; font-size:.45rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; padding:.08rem .3rem; border-radius:10px; }
.tr-video-badge.vimeo { background:rgba(26,183,234,.1); color:#1ab7ea; }
.tr-video-badge.youtube { background:rgba(255,0,0,.08); color:#c00; }
.tr-video-comments-count { font-family:'Outfit',sans-serif; font-size:.5rem; color:var(--ink5); }

.tr-player-wrap {
  background:#000; border-radius:10px; overflow:hidden; margin-bottom:.8rem;
  position:relative; aspect-ratio:16/9; max-height:480px;
}
.tr-player-wrap iframe { width:100%; height:100%; border:none; }

.tr-add-form { display:flex; gap:.4rem; align-items:center; flex-wrap:wrap; margin-bottom:1.2rem; }
.tr-add-form input {
  font-family:'Outfit',sans-serif; font-size:.62rem; padding:.35rem .5rem;
  border:1px solid var(--rule2); border-radius:6px; background:var(--card); color:var(--ink2);
}

.tr-comment-bar { display:flex; gap:.4rem; align-items:center; margin-bottom:.6rem; }
.tr-comment-bar input {
  flex:1; font-family:'Outfit',sans-serif; font-size:.62rem; padding:.35rem .5rem;
  border:1px solid var(--rule2); border-radius:6px; background:var(--card); color:var(--ink2);
}
.tr-timestamp-btn {
  font-family:'Outfit',sans-serif; font-size:.55rem; font-weight:700;
  padding:.3rem .55rem; border-radius:6px; border:1px solid #533483;
  background:rgba(83,52,131,.08); color:#533483; cursor:pointer; white-space:nowrap;
}
.tr-timestamp-btn:hover { background:rgba(83,52,131,.18); }

.tr-comments-list { display:flex; flex-direction:column; gap:.35rem; }
.tr-comment-item {
  display:flex; gap:.5rem; align-items:flex-start;
  padding:.45rem .6rem; border-radius:8px; background:var(--card); border:1px solid var(--rule);
}
.tr-comment-time {
  font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:700;
  color:#533483; cursor:pointer; white-space:nowrap; min-width:45px;
  padding:.1rem .3rem; border-radius:4px; background:rgba(83,52,131,.06);
}
.tr-comment-time:hover { background:rgba(83,52,131,.15); }
.tr-comment-body { font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink2); flex:1; line-height:1.5; }
.tr-comment-author { font-size:.48rem; color:var(--ink5); margin-top:.1rem; }
.tr-comment-delete {
  font-size:.5rem; opacity:.3; cursor:pointer; padding:.1rem .2rem; border:none; background:none; color:var(--ink);
}
.tr-comment-delete:hover { opacity:.8; color:#dc2626; }
.tr-empty { font-family:'Outfit',sans-serif; font-size:.7rem; color:var(--ink5); text-align:center; padding:2rem; font-style:italic; }


/* ══ EDITING ROOM ═══════════════════════════════════════════════════════════ */
.er-layout { display:grid; grid-template-columns:1fr 1fr; gap:1.4rem; margin-bottom:1.4rem; }
.er-layout-full { grid-template-columns:1fr; }
@media(max-width:900px){ .er-layout { grid-template-columns:1fr; } }
.er-section { background:var(--warm-white); border:1px solid var(--rule); border-radius:var(--r-xl); overflow:hidden; }
.er-section-head { display:flex; align-items:center; justify-content:space-between; padding:.9rem 1.1rem .7rem; border-bottom:1px solid var(--rule); background:var(--parchment); }
.er-section-title { font-family:'Outfit',sans-serif; font-size:.65rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--ink3); }
.er-section-count { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600; color:var(--ink5); background:var(--rule2); border-radius:20px; padding:.1rem .45rem; }
.er-empty { padding:1.5rem 1.1rem; font-family:'Outfit',sans-serif; font-size:.65rem; color:var(--ink5); font-style:italic; text-align:center; }
.er-card { display:grid; grid-template-columns:1fr auto; gap:.3rem .6rem; align-items:start; padding:.75rem 1.1rem; border-bottom:1px solid var(--rule2); cursor:pointer; transition:background .12s; }
.er-card:last-child { border-bottom:none; }
.er-card:hover { background:var(--gold-wash); }
.er-card-name { font-family:'Cormorant Garamond',serif; font-size:.95rem; font-weight:600; color:var(--ink); grid-column:1; }
.er-card-meta { font-family:'Outfit',sans-serif; font-size:.58rem; color:var(--ink5); grid-column:1; display:flex; flex-wrap:wrap; gap:.25rem .6rem; margin-top:.1rem; }
.er-card-actions { grid-column:2; grid-row:1/3; display:flex; flex-direction:column; align-items:flex-end; gap:.3rem; }
.er-badge { font-family:'Outfit',sans-serif; font-size:.5rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; border-radius:20px; padding:.15rem .45rem; white-space:nowrap; border:1px solid transparent; }
.er-badge.bq  { background:rgba(154,123,60,.1);  color:var(--gold);    border-color:var(--gold-line); }
.er-badge.bp  { background:rgba(37,99,235,.08);  color:#2563eb;        border-color:rgba(37,99,235,.2); }
.er-badge.brv { background:rgba(234,88,12,.08);  color:#ea580c;        border-color:rgba(234,88,12,.2); }
.er-badge.brs { background:rgba(220,38,38,.08);  color:#dc2626;        border-color:rgba(220,38,38,.2); }
.er-badge.brd { background:rgba(45,74,62,.08);   color:var(--forest);  border-color:rgba(45,74,62,.2); }
.er-badge.bdn { background:var(--rule2);         color:var(--ink4); }
.er-badge.bps { background:rgba(88,28,235,.07);  color:#5b21b6;        border-color:rgba(88,28,235,.2); }
.er-badge.bph { background:rgba(59,111,196,.07); color:#3b6fc4;        border-color:rgba(59,111,196,.2); }
.er-badge.bvd { background:rgba(139,92,246,.07); color:#7c3aed;        border-color:rgba(139,92,246,.2); }
.er-pbar { height:4px; background:var(--rule2); border-radius:2px; overflow:hidden; width:100%; }
.er-pbar-fill { height:100%; border-radius:2px; background:#2563eb; }
.er-isel { font-family:'Outfit',sans-serif; font-size:.55rem; color:var(--ink4); background:transparent; border:none; outline:none; cursor:pointer; }
.er-delivery-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; padding:.55rem 1.1rem; border-bottom:1px solid var(--rule2); }
.er-delivery-row:last-child { border-bottom:none; }
.er-chk { display:inline-flex; align-items:center; gap:.3rem; font-family:'Outfit',sans-serif; font-size:.57rem; color:var(--ink4); cursor:pointer; padding:.2rem .4rem; border-radius:6px; transition:background .12s; }
.er-chk:hover { background:var(--gold-wash); }
.er-chk input { margin:0; accent-color:var(--gold); cursor:pointer; }
.er-chk.on { color:var(--forest); font-weight:600; }
.er-stat-row { display:flex; gap:1.5rem; flex-wrap:wrap; padding:1rem 1.1rem; background:var(--parchment); border-bottom:1px solid var(--rule); margin-bottom:1.4rem; border-radius:var(--r-xl); border:1px solid var(--rule); }
.er-stat { text-align:center; }
.er-stat-n { font-family:'Cormorant Garamond',serif; font-size:1.8rem; font-weight:600; color:var(--ink); }
.er-stat-l { font-family:'Outfit',sans-serif; font-size:.52rem; letter-spacing:.1em; text-transform:uppercase; color:var(--ink5); }
.er-arch-row { display:flex; align-items:center; justify-content:space-between; padding:.6rem 1.1rem; border-bottom:1px solid var(--rule2); }
.er-arch-row:last-child { border-bottom:none; }


.conflict-row { background:var(--parchment); border:1px solid var(--rule2); border-radius:10px; padding:.75rem 1rem; }
.conflict-name { font-family:'Cormorant Garamond',serif; font-size:1rem; font-weight:600; color:var(--ink); margin-bottom:.5rem; }
.conflict-cols { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-bottom:.5rem; }
.conflict-col { background:var(--cream); border-radius:6px; padding:.4rem .6rem; }
.conflict-col-title { font-family:'Outfit',sans-serif; font-size:.52rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--ink4); margin-bottom:.2rem; }
.conflict-detail { font-family:'Outfit',sans-serif; font-size:.62rem; color:var(--ink3); }
.conflict-btns { display:flex; gap:.4rem; flex-wrap:wrap; }
.conflict-btn { font-family:'Outfit',sans-serif; font-size:.58rem; font-weight:600; padding:.28rem .7rem; border-radius:20px; border:1.5px solid var(--rule2); background:transparent; color:var(--ink3); cursor:pointer; transition:all .15s; }
.conflict-btn:hover { border-color:var(--gold); color:var(--ink); }
.conflict-btn.keep.selected    { background:rgba(37,99,235,.12); border-color:#2563eb; color:#2563eb; }
.conflict-btn.replace.selected { background:rgba(220,38,38,.1); border-color:#dc2626; color:#dc2626; }
.conflict-btn.both.selected    { background:rgba(45,74,62,.12); border-color:var(--forest); color:var(--forest); }
.conflict-chosen { font-family:'Outfit',sans-serif; font-size:.56rem; color:var(--ink4); margin-top:.35rem; min-height:.8rem; font-style:italic; }

.scl-item { display:flex; align-items:center; gap:.5rem; padding:.42rem .75rem; cursor:pointer; border-bottom:1px solid var(--rule2); transition:background .1s; }
.scl-item:hover { background:var(--gold-wash); }


/* ── Button drag-reorder ── */
.ev-btn-wrap { display:inline-flex; align-items:center; cursor:grab; position:relative; }
.ev-btn-wrap:active { cursor:grabbing; }
.ev-btn-drag-handle {
  display:none; position:absolute; left:-1px; top:50%; transform:translateY(-50%);
  font-size:.6rem; color:var(--ink4,#aaa); opacity:.5; pointer-events:none; line-height:1;
}
.ev-btn-wrap:hover .ev-btn-drag-handle { display:block; }
.ev-btn-wrap.ev-drag-over > .ev-approve-btn,
.ev-btn-wrap.ev-drag-over > .ev-pause-btn { outline:2px dashed #c9a84c; outline-offset:2px; }
.ev-btn-wrap.ev-dragging { opacity:.3; }

</style>
<!-- Cloud sync uses direct REST API calls (no SDK needed) -->
</head>
<body>

<div id="globalHeader" style="display:none">
  <div class="gh-brand"><span class="gh-cloud">Cloud</span> <span class="gh-ix">IX</span> <span class="gh-concierge">Concierge</span></div>
  <div class="gh-company" id="ghCompanyLabel"></div>
  <div class="gh-page" id="ghPageLabel"></div>
</div>

<div id="authScreen">
  <div class="auth-box">
    <div class="login-header">
      <div class="login-sub">Handle Weddings Like a Pro</div>
      <h1 class="login-title"><span style="color:var(--ink);font-style:normal;">Cloud</span> <em>IX</em> <span style="color:var(--ink);font-style:normal;">Concierge</span></h1>
      <div class="login-rule"></div>
      <div class="login-tagline">Elevated workflow for luxury wedding professionals</div>
    </div>
    <div class="login-label">Sign In</div>
    <input type="text" class="auth-input" id="authUser" placeholder="Username" autocomplete="username" onkeydown="if(event.key==='Enter')document.getElementById('authPass').focus()">
    <div style="position:relative;">
      <input type="password" class="auth-input" id="authPass" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()" style="padding-right:2rem;">
      <button type="button" onclick="togglePassVis('authPass',this)" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:.7rem;opacity:.5;padding:2px;">👁</button>
    </div>
    <button class="auth-btn" onclick="doLogin()">Sign In</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<div class="auth-user-badge" id="authBadge" style="display:none" onclick="openUserMenu()">
  <div class="badge-avatar" id="badgeAvatar"></div>
  <span class="badge-name" id="badgeName"></span>
  <span class="badge-role" id="badgeRole"></span>
</div>

<div class="users-overlay" id="usersOverlay" onclick="if(event.target===this)closeUserMgmt()">
  <div class="users-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;">
      <div class="users-title" id="userMgmtTitle">Settings</div>
      <button class="btn btn-outline btn-sm" style="font-size:.6rem;" onclick="closeUserMgmt()">✕ Close</button>
    </div>
    <div id="usersListWrap"></div>
    <div id="usersAddWrap"></div>
    <div style="margin-top:1rem;">
      <div style="font-family:'Outfit',sans-serif;font-size:.58rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);margin-bottom:.5rem;">Profile Picture</div>
      <div style="display:flex;align-items:center;gap:.75rem;">
        <div id="profilePicPreview" style="width:48px;height:48px;border-radius:50%;background:var(--gold);color:#fff;display:flex;align-items:center;justify-content:center;font:700 1rem/1 'Outfit',sans-serif;overflow:hidden;border:2px solid var(--rule2);flex-shrink:0;"></div>
        <div style="display:flex;flex-direction:column;gap:.3rem;">
          <label class="btn btn-outline btn-sm" style="font-size:.55rem;cursor:pointer;display:inline-block;text-align:center;">
            📷 Choose Photo
            <input type="file" accept="image/*" onchange="handleProfilePic(this)" style="display:none;">
          </label>
          <button class="btn btn-outline btn-sm" style="font-size:.5rem;opacity:.6;" onclick="removeProfilePic()">Remove</button>
        </div>
      </div>
    </div>
    <div style="margin-top:1rem;">
      <div style="font-family:'Outfit',sans-serif;font-size:.58rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);margin-bottom:.5rem;">Change Password</div>
      <div style="display:flex;align-items:flex-end;gap:.5rem;">
        <div style="flex:1;position:relative;">
          <input id="selfNewPass" type="password" placeholder="New password" style="font-family:'Outfit',sans-serif;font-size:.62rem;width:100%;padding:.3rem 2rem .3rem .4rem;border:1px solid var(--rule2);border-radius:4px;background:var(--card);color:var(--ink2);box-sizing:border-box;">
          <button type="button" onclick="togglePassVis('selfNewPass',this)" style="position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:.6rem;opacity:.5;padding:2px;">👁</button>
        </div>
        <button class="btn btn-outline btn-sm" style="font-size:.55rem;white-space:nowrap;" onclick="selfChangePassword()">Update</button>
      </div>
    </div>
    <div style="margin-top:1rem;">
      <div style="font-family:'Outfit',sans-serif;font-size:.58rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);margin-bottom:.5rem;">Background Colour</div>
      <div id="modalBgPicker" style="display:flex;gap:.4rem;flex-wrap:wrap;"></div>
    </div>
    <div style="margin-top:1rem;text-align:center;">
      <button class="btn btn-outline btn-sm" style="font-size:.6rem;" onclick="doLogout()">🚪 Sign Out</button>
    </div>
  </div>
</div>

<div id="loginView" style="display:none">
  <div class="login-header">
    <div class="login-sub">Handle Weddings Like a Pro</div>
    <h1 class="login-title"><span style="color:var(--ink);font-style:normal;">Cloud</span> <em>IX</em> <span style="color:var(--ink);font-style:normal;">Concierge</span></h1>
    <div class="login-rule"></div>
    <div class="login-tagline">Elevated workflow for luxury wedding professionals</div>
  </div>

  <!-- Signed-in indicator -->
  <div id="loginUserBanner" style="display:none;text-align:center;margin-bottom:1.5rem;">
    <div style="display:inline-flex;align-items:center;gap:.5rem;background:var(--warm-white);border:1px solid var(--rule2);border-radius:20px;padding:.35rem .8rem .35rem .4rem;cursor:pointer;" onclick="openUserMenu()">
      <div id="loginBannerAvatar" style="width:26px;height:26px;border-radius:50%;background:var(--gold);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;overflow:hidden;"></div>
      <div style="text-align:left;">
        <div style="font-family:'Outfit',sans-serif;font-size:.72rem;font-weight:600;color:var(--ink);line-height:1.2;" id="loginBannerName"></div>
        <div style="font-family:'Outfit',sans-serif;font-size:.52rem;color:var(--ink5);letter-spacing:.04em;" id="loginBannerRole"></div>
      </div>
    </div>
  </div>

  <!-- Step 1: Device picker -->
  <div id="loginDeviceStep">
    <div class="login-label">Choose your device</div>
    <div class="device-picker">
      <button class="device-btn" onclick="selectDevice('desktop')">
        <span class="device-icon">🖥</span>
        <span class="device-name">Desktop</span>
        <span class="device-hint">Full layout</span>
      </button>
      <button class="device-btn" onclick="selectDevice('tablet')">
        <span class="device-icon">📱</span>
        <span class="device-name">iPad / Tablet</span>
        <span class="device-hint">Touch optimised</span>
      </button>
      <button class="device-btn" onclick="selectDevice('mobile')">
        <span class="device-icon">📲</span>
        <span class="device-name">Mobile</span>
        <span class="device-hint">Compact view</span>
      </button>
    </div>
  </div>

  <!-- Step 2: Company grid (shown after device chosen) -->
  <div id="loginCompanyStep" style="display:none;">
    <div class="login-device-badge" id="loginDeviceBadge"></div>
    <div class="login-label">Select your company to continue</div>
    <div class="company-grid" id="companyGrid"></div>
    <div class="login-footer">Each company has its own separate workspace</div>
    <div style="text-align:center;margin-top:.75rem;" class="admin-only"><button class="btn btn-outline btn-sm" style="font-size:.62rem;" onclick="openBackup()">💾 Backup &amp; Restore</button></div>
    <div style="text-align:center;margin-top:.5rem;"><button class="btn btn-outline btn-sm" style="font-size:.58rem;opacity:.6;" onclick="showDevicePicker()">⬅ Change device</button></div>
  </div>
</div>

<div class="new-co-overlay" id="newCoOverlay" onclick="if(event.target===this)closeNewCo()">
  <div class="new-co-box">
    <div class="new-co-title">Add New Company</div>
    <label class="new-co-lbl">Company Name</label>
    <input class="new-co-inp" id="newCoName" placeholder="e.g. Golden Hour Films" onkeydown="if(event.key==='Enter')document.getElementById('newCoIcon').focus()">
    <label class="new-co-lbl">Icon (emoji)</label>
    <input class="new-co-inp" id="newCoIcon" placeholder="🎬" style="font-size:1.1rem;" maxlength="4" onkeydown="if(event.key==='Enter')saveNewCo()">
    <div class="new-co-btns">
      <button class="btn btn-outline btn-sm" onclick="closeNewCo()">Cancel</button>
      <button class="btn btn-red" onclick="saveNewCo()">Create</button>
    </div>
  </div>
</div>

<div id="companyDashView" style="display:none">
  <div class="co-dash-hero" style="background:linear-gradient(135deg,#142244 0%,#1b3268 50%,#2563eb 100%);">
    <div class="co-dash-hero-inner">
      <div class="co-dash-hero-left">
        <div class="co-dash-hero-icon" id="coDashIcon">🏢</div>
        <div>
          <div class="co-dash-hero-name" id="coDashName" style="color:#b8ccf5;">Company</div>
          
        </div>
      </div>
      <div class="co-dash-hero-right">
        <div class="hero-sitemap"><span class="hero-sitemap-pill">Home</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill active-blue">Boardroom</span><span class="hero-sitemap-sep">›</span><span style="position:relative;display:inline-flex;align-items:center;"><span style="position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:.15rem;white-space:nowrap;"><span class="hero-sitemap-pill">Production Office</span></span><span class="hero-sitemap-pill">Client Lounge</span></span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Editing Room</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Theatre Room</span></div>
        <div class="co-dash-hero-actions">
          <button class="co-dash-hero-btn nav-companies" onclick="backToLogin()">⌂ Home</button>
          <button class="co-dash-hero-btn primary" onclick="goToAllCouples()">👥 Client Lounge →</button>
          <button class="co-dash-hero-btn er-btn" onclick="goToEditingRoom()">✂️ Editing Room →→</button>
          <button class="co-dash-hero-btn tr-btn" onclick="goToTheatreRoom()">🎬 Theatre →→→</button>
        </div>
      </div>
    </div>
  </div>
  <div class="co-dash-content">
    <div class="co-dash-section">
      <div class="co-dash-section-label">In Production</div>
      <div id="coDashEditing"></div>
    </div>
    <div class="co-dash-section" id="coDashRevisionsWrap" style="display:none;">
      <div class="co-dash-section-label">Revisions</div>
      <div id="coDashRevisions"></div>
    </div>
    <div class="co-dash-section" id="coDashOverdueWrap" style="display:none;">
      <div class="co-dash-section-label">Overdue</div>
      <div id="coDashOverdue"></div>
    </div>
    <div class="co-dash-section" id="coDashAlmostDueWrap" style="display:none;">
      <div class="co-dash-section-label">Almost Due</div>
      <div id="coDashAlmostDue"></div>
    </div>
    <div class="co-dash-section" id="coDashAnalyticsWrap" style="display:none;">
      <div class="co-dash-section-label">Production Analytics</div>
      <div id="coDashAnalytics"></div>
    </div>
    <div class="co-dash-section">
      <div class="co-dash-section-label">Overview</div>
      <div id="coDashBanner"></div>
    </div>
    <div class="co-dash-section">
      <div class="co-dash-section-label">Teams &amp; Schedule</div>
      <div id="coDashPanels"></div>
    </div>
  </div>
</div>

<div class="app" id="mainApp" style="display:none">
  <!-- ── DASHBOARD VIEW ── -->
  <div id="dashView">
    <div class="co-dash-hero" style="background:linear-gradient(135deg,#2e2310 0%,#4a3820 50%,#9a7b3c 100%);">
      <div class="co-dash-hero-inner">
        <div class="co-dash-hero-left">
          <div class="co-dash-hero-icon" id="allClientsIcon">👥</div>
          <div>
            <div class="co-dash-hero-name" id="allClientsHeroName" style="color:#e8d5a8;">Client Lounge</div>
          </div>
        </div>
        <div class="co-dash-hero-right">
          <div class="hero-sitemap"><span class="hero-sitemap-pill">Home</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Boardroom</span><span class="hero-sitemap-sep">›</span><span style="position:relative;display:inline-flex;align-items:center;"><span style="position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:.15rem;white-space:nowrap;"><span class="hero-sitemap-pill">Production Office</span></span><span class="hero-sitemap-pill active-gold">Client Lounge</span></span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Editing Room</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Theatre Room</span></div>
          <div class="co-dash-hero-actions">
            <button class="co-dash-hero-btn nav-companies" onclick="backToLogin()">⌂ Home</button>
            <button class="co-dash-hero-btn secondary admin-only" onclick="openBackup()" title="Backup &amp; Restore">💾 Backup</button>
            <button class="co-dash-hero-btn primary admin-only" onclick="openAddCouple()">+ Add Client</button>
            <button class="co-dash-hero-btn nav-dashboard" onclick="goToDashboard()">← Boardroom 🏢</button>
            <button class="co-dash-hero-btn er-btn" onclick="goToEditingRoom()">✂️ Editing Room →</button>
            <button class="co-dash-hero-btn tr-btn" onclick="goToTheatreRoom()">🎬 Theatre →→</button>
          </div>
        </div>
      </div>
    </div>
    <div class="co-dash-content">
      <div class="dash-toolbar" style="padding:1.2rem 0 .5rem;border-bottom:1px solid var(--rule);margin-bottom:1.2rem;">
        <div class="dash-filters">
          <input type="text" id="clientSearch" placeholder="Search clients…" oninput="renderDashboard()" style="width:180px;padding:.35rem .6rem;border:1px solid var(--rule);border-radius:6px;font:inherit;font-size:.82rem;background:var(--card);color:var(--ink);">
          <select id="filterYear" onchange="renderDashboard()" style="width:auto;">
            <option value="">All Years</option>
          </select>
          <select id="filterMonth" onchange="renderDashboard()" style="width:auto;">
            <option value="">All Months</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
          <select id="filterType" onchange="renderDashboard()" style="width:auto;">
            <option value="">All Types</option>
          </select>
          <div class="view-mode-btns">
            <button class="vm-btn active" id="vmGrid" onclick="setDashView('grid')" title="Grid view">⊞</button>
            <button class="vm-btn" id="vmList" onclick="setDashView('list')" title="List view">☰</button>
            <button class="vm-btn" id="vmCompact" onclick="setDashView('compact')" title="Compact view">▤</button>
          </div>
        </div>
      </div>
      <div id="editorFilterBar" style="display:none" class="editor-filter-bar"></div>
      <div id="shooterFilterBar" style="display:none" class="editor-filter-bar"></div>
      <div id="dashGrid"></div>
    </div>
  </div>

  <!-- ── EDITOR VIEW ── -->
  <div id="editorView" style="display:none">
    <div class="co-dash-hero" style="background:linear-gradient(135deg,#2e2310 0%,#4a3820 50%,#9a7b3c 100%);">
      <div class="co-dash-hero-inner">
        <div class="co-dash-hero-left">
          <div class="co-dash-hero-icon" id="coupleHeroIcon">💍</div>
          <div>
            <div class="co-dash-hero-name" id="coupleHeroName" style="color:#e8d5a8;">Couple</div>
            <div style="font-family:'Outfit',sans-serif;font-size:.55rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(232,213,168,.5);margin-top:.15rem;">Production Office</div>
          </div>
        </div>
        <div class="co-dash-hero-right">
          <div class="hero-sitemap"><span class="hero-sitemap-pill">Home</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Boardroom</span><span class="hero-sitemap-sep">›</span><span style="position:relative;display:inline-flex;align-items:center;"><span style="position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:.15rem;white-space:nowrap;"><span class="hero-sitemap-pill active-gold">Production Office</span></span><span class="hero-sitemap-pill">Client Lounge</span></span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Editing Room</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Theatre Room</span></div>
          <div class="co-dash-hero-actions">
            <button class="co-dash-hero-btn nav-companies" onclick="backToLogin()">⌂ Home</button>
            <button class="co-dash-hero-btn secondary admin-only" onclick="openBackup()" title="Backup &amp; Restore">💾 Backup</button>
            <button class="co-dash-hero-btn secondary" onclick="openLibrary()">Song Library</button>
            <button class="co-dash-hero-btn secondary" onclick="openHistory()">Song History</button>
            <button class="co-dash-hero-btn nav-dashboard" onclick="goToDashboard()">↓ Boardroom 🏢</button>
            <button class="co-dash-hero-btn primary" onclick="goToAllCouples()">↓ Client Lounge 👥</button>
            <button class="co-dash-hero-btn er-btn" onclick="goToEditingRoom()">↓ Editing Room ✂️</button>
          </div>
        </div>
      </div>
    </div>
    <div class="co-dash-content" style="padding-top:2rem;">
    <div class="editor-layout">
      <div class="editor-sidebar">
        <div id="coupleCard"></div>
        <div id="coupleSummary"></div>
        <div id="coupleTimeline"></div>
      </div>
      <div class="main" id="main">
        <div class="placeholder"><div class="icon">🎵</div><p>Select or add a couple to get started</p></div>
      </div>
      <div class="journey-right-panel" id="journeyRightPanel">
        <div id="journeyOverviewPanel"></div>
      </div>
    </div>
    </div><!-- /.co-dash-content -->
  </div>
</div>


<!-- ══ EDITING ROOM VIEW ══════════════════════════════════════════════════ -->
<div id="editingRoomView" style="display:none">
  <div class="co-dash-hero" style="background:linear-gradient(135deg,#132e20 0%,#1e4a35 50%,#2d6b4a 100%);">
    <div class="co-dash-hero-inner">
      <div class="co-dash-hero-left">
        <div class="co-dash-hero-icon">✂️</div>
        <div><div class="co-dash-hero-name" style="color:#b8e0cc;">Editing Room</div></div>
      </div>
      <div class="co-dash-hero-right">
        <div class="hero-sitemap"><span class="hero-sitemap-pill">Home</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Boardroom</span><span class="hero-sitemap-sep">›</span><span style="position:relative;display:inline-flex;align-items:center;"><span style="position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:.15rem;white-space:nowrap;"><span class="hero-sitemap-pill">Production Office</span></span><span class="hero-sitemap-pill">Client Lounge</span></span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill active-green">Editing Room</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Theatre Room</span></div>
        <div class="co-dash-hero-actions">
          <button class="co-dash-hero-btn nav-companies" onclick="backToLogin()">⌂ Home</button>
          <button class="co-dash-hero-btn secondary" onclick="openLibrary()">Song Library</button>
          <button class="co-dash-hero-btn secondary" onclick="openHistory()">Song History</button>
          <button class="co-dash-hero-btn nav-dashboard" onclick="goToDashboard()">←← Boardroom 🏢</button>
          <button class="co-dash-hero-btn primary" onclick="goToAllCouples()">← Client Lounge 👥</button>
          <button class="co-dash-hero-btn tr-btn" onclick="goToTheatreRoom()">🎬 Theatre →</button>
        </div>
      </div>
    </div>
  </div>
  <div class="co-dash-content" style="padding-top:2rem;">
    <div id="erBody"></div>
  </div>
</div>

<!-- ══ THEATRE ROOM VIEW ══════════════════════════════════════════════════ -->
<div id="theatreRoomView" style="display:none">
  <div class="co-dash-hero" style="background:linear-gradient(135deg,#2d1b4e 0%,#3d2463 50%,#533483 100%);">
    <div class="co-dash-hero-inner">
      <div class="co-dash-hero-left">
        <div class="co-dash-hero-icon">🎬</div>
        <div><div class="co-dash-hero-name" style="color:#e2d4f5;">Theatre Room</div></div>
      </div>
      <div class="co-dash-hero-right">
        <div class="hero-sitemap"><span class="hero-sitemap-pill">Home</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Boardroom</span><span class="hero-sitemap-sep">›</span><span style="position:relative;display:inline-flex;align-items:center;"><span style="position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:.15rem;white-space:nowrap;"><span class="hero-sitemap-pill">Production Office</span></span><span class="hero-sitemap-pill">Client Lounge</span></span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill">Editing Room</span><span class="hero-sitemap-sep">›</span><span class="hero-sitemap-pill active-purple">Theatre Room</span></div>
        <div class="co-dash-hero-actions">
          <button class="co-dash-hero-btn nav-companies" onclick="backToLogin()">⌂ Home</button>
          <button class="co-dash-hero-btn nav-dashboard" onclick="goToDashboard()">←← Boardroom 🏢</button>
          <button class="co-dash-hero-btn primary" onclick="goToAllCouples()">← Client Lounge 👥</button>
          <button class="co-dash-hero-btn er-btn" onclick="goToEditingRoom()">← Editing Room ✂️</button>
        </div>
      </div>
    </div>
  </div>
  <div class="co-dash-content" style="padding-top:1.5rem;">
    <div id="theatreBody"></div>
  </div>
</div>

<!-- Add Couple Modal -->
<div class="modal-overlay" id="addCoupleModal" onclick="if(event.target===this)closeAddCouple()">
  <div class="modal">
    <h3>Add New Couple</h3>
    <label>Couple Name</label>
    <input type="text" id="cName" placeholder="e.g. Patel &amp; Sharma" onkeydown="if(event.key==='Enter')addCouple()">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.7rem;">
      <div>
        <label>Year</label>
        <select id="cYear" style="margin-bottom:.9rem;"></select>
      </div>
      <div>
        <label>Month</label>
        <select id="cMonth" style="margin-bottom:.9rem;">
          <option value="1">January</option><option value="2">February</option><option value="3">March</option>
          <option value="4">April</option><option value="5">May</option><option value="6">June</option>
          <option value="7">July</option><option value="8">August</option><option value="9">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>
    </div>
    <label>Wedding Style(s)</label>
    <p style="font-size:.72rem;color:var(--ink4);margin-bottom:.7rem;line-height:1.5;">Select all that apply — helps with music recommendations</p>
    <div class="wedding-type-grid" id="weddingTypeGrid"></div>
    <label style="margin-top:.4rem;">Event Date <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(for countdown timer)</span></label>
    <input type="date" id="cEventDate" style="margin-bottom:.9rem;" onchange="autoFillCoupleDueDate('c')">
    <label style="margin-top:.2rem;">Project Due Date <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(when the full edit is due)</span></label>
    <div style="display:flex;gap:.4rem;align-items:center;margin-bottom:.9rem;">
      <input type="text" id="cEditDueDuration" placeholder="e.g. 90d, 3m" style="width:5rem;flex:none;text-align:center;"
        onkeydown="if(event.key==='Enter'){calcCoupleDueDate('c');}" onblur="calcCoupleDueDate('c')">
      <input type="date" id="cEditDueDate" style="flex:1;"
        onchange="document.getElementById('cEditDueDuration').value='';">
    </div>
    <label style="margin-top:.2rem;">Editors Assigned <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(comma separated)</span></label>
    <input type="text" id="cEditors" placeholder="e.g. Ravi, Priya" style="margin-bottom:.9rem;">
    <label style="margin-top:.2rem;">🎬 Theatre Room Access Code <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(client login password)</span></label>
    <input type="text" id="cTheatrePass" placeholder="e.g. review2025" style="margin-bottom:.3rem;">
    <div style="font-size:.52rem;color:var(--ink5);margin-bottom:.9rem;">Client logs in at <b>theatre.html</b> with their couple name + this code</div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeAddCouple()">Cancel</button>
      <button class="btn btn-red" onclick="addCouple()">Add Couple</button>
    </div>
  </div>
</div>

<!-- Edit Couple Modal -->
<div class="modal-overlay" id="editCoupleModal" onclick="if(event.target===this)closeEditCouple()">
  <div class="modal">
    <h3>Edit Couple</h3>
    <label>Couple Name</label>
    <input type="text" id="eName" placeholder="e.g. Patel &amp; Sharma" onkeydown="if(event.key==='Enter')saveEditCouple()">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.7rem;">
      <div>
        <label>Year</label>
        <select id="eYear" style="margin-bottom:.9rem;"></select>
      </div>
      <div>
        <label>Month</label>
        <select id="eMonth" style="margin-bottom:.9rem;">
          <option value="1">January</option><option value="2">February</option><option value="3">March</option>
          <option value="4">April</option><option value="5">May</option><option value="6">June</option>
          <option value="7">July</option><option value="8">August</option><option value="9">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>
    </div>
    <label>Wedding Style(s)</label>
    <p style="font-size:.72rem;color:var(--ink4);margin-bottom:.7rem;line-height:1.5;">Select all that apply — helps with music recommendations</p>
    <div class="wedding-type-grid" id="editWeddingTypeGrid"></div>
    <label style="margin-top:.4rem;">Event Date <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(for countdown timer)</span></label>
    <input type="date" id="eEventDate" style="margin-bottom:.9rem;" onchange="autoFillCoupleDueDate('e')">
    <label style="margin-top:.2rem;">Project Due Date <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(when the full edit is due)</span></label>
    <div style="display:flex;gap:.4rem;align-items:center;margin-bottom:.9rem;">
      <input type="text" id="eEditDueDuration" placeholder="e.g. 90d, 3m" style="width:5rem;flex:none;text-align:center;"
        onkeydown="if(event.key==='Enter'){calcCoupleDueDate('e');}" onblur="calcCoupleDueDate('e')">
      <input type="date" id="eEditDueDate" style="flex:1;"
        onchange="document.getElementById('eEditDueDuration').value='';">
    </div>
    <label style="margin-top:.2rem;">Editors Assigned <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(comma separated)</span></label>
    <input type="text" id="eEditors" placeholder="e.g. Ravi, Priya" style="margin-bottom:.9rem;">
    <label style="margin-top:.2rem;">🎬 Theatre Room Access Code <span style="font-size:.68rem;color:var(--ink5);font-weight:300;">(client login password)</span></label>
    <input type="text" id="eTheatrePass" placeholder="e.g. review2025" style="margin-bottom:.3rem;">
    <div style="font-size:.52rem;color:var(--ink5);margin-bottom:.9rem;">Client logs in at <b>theatre.html</b> with their couple name + this code</div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeEditCouple()">Cancel</button>
      <button class="btn btn-red" onclick="saveEditCouple()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModal">
  <div class="modal">
    <h3>📄 Export Event &amp; Song Breakdown</h3>
    <label>Document Title</label>
    <input type="text" id="exportTitle" placeholder="e.g. Smith & Johnson — Music Plan">
    <label>Notes (optional)</label>
    <input type="text" id="exportNotes" placeholder="e.g. Prepared by DJ Sharma">
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeExport()">Cancel</button>
      <button class="btn btn-gold" onclick="doExport()">📧 Send to Email</button>
    </div>
  </div>
</div>

<!-- Song Library Modal -->
<div class="modal-overlay" id="libModal" onclick="if(event.target===this)closeLibrary()">
  <div class="modal lib-modal-inner">
    <h3>🎵 Song Library</h3>
    <p style="font-size:.8rem;color:var(--ink3);margin-bottom:1rem;line-height:1.5;">
      Set default songs per event type. Choose language tab, then fill in up to 10 songs (Title + Artist) for each event.
      These pre-load automatically when you add that event to a couple.
    </p>
    <!-- Language tabs -->
    <div class="lang-tabs">
      <button class="lang-tab on" onclick="setLibLang('en',this)">🇬🇧 English</button>
      <button class="lang-tab" onclick="setLibLang('hi',this)">🇮🇳 Hindi</button>
      <button class="lang-tab" onclick="setLibLang('pa',this)">🟡 Punjabi</button>
      <button class="lang-tab" onclick="setLibLang('inst',this)">🎻 Instrumental</button>
    </div>
    <div id="libContent"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="closeLibrary()">✓ Done</button>
    </div>
  </div>
</div>

<!-- Song History Modal -->
<div class="modal-overlay" id="histModal" onclick="if(event.target===this)closeHistory()">
  <div class="modal lib-modal-inner">
    <h3>📖 Song History</h3>
    <p style="font-size:.8rem;color:var(--ink3);margin-bottom:1rem;line-height:1.5;">
      Every song you've manually added across all events, organised by event type and language. Read-only reference.
    </p>
    <div class="lang-tabs" id="histLangTabs">
      <button class="lang-tab on" onclick="setHistLang('en',this)">🇬🇧 English</button>
      <button class="lang-tab" onclick="setHistLang('hi',this)">🇮🇳 Hindi</button>
      <button class="lang-tab" onclick="setHistLang('pa',this)">🟡 Punjabi</button>
      <button class="lang-tab" onclick="setHistLang('inst',this)">🎻 Instrumental</button>
    </div>
    <div id="histContent"></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="closeHistory()">✓ Close</button>
    </div>
  </div>
</div>

<!-- Theme Switcher -->
<div id="darkToggleBtn" onclick="toggleDark()" title="Toggle night mode">🌙</div>

<div class="toast" id="toast"></div>

<script>
// Global error catcher — shows any JS errors visibly
window.onerror = function(msg, src, line, col, err) {
  var d = document.createElement('div');
  d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#b91c1c;color:#fff;padding:.75rem 1rem;font:600 .75rem/1.4 monospace;z-index:99999;white-space:pre-wrap;';
  d.textContent = '⚠ JS Error: ' + msg + ' (line ' + line + ')';
  document.body ? document.body.appendChild(d) : document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(d); });
  return false;
};

// ════════════════════════════════════════════════════════
// SUPABASE CLOUD SYNC (Direct REST API — no SDK needed)
// ════════════════════════════════════════════════════════
const SUPABASE_URL = 'https://lbnbceaexamjnghbayns.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibmJjZWFleGFtam5naGJheW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODIyNDUsImV4cCI6MjA4NzY1ODI0NX0.Yerr57763y4qj5x8C0HHYE0vWbA23l_nDZDVheYAFcQ';
const _REST = SUPABASE_URL + '/rest/v1/app_data';
const _hdrs = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json' };
let _cloudReady = false; // will be set true after connectivity test
let _suppressRealtimeRefresh = false;
let _pollTimer = null;
let _lastPollTs = null;

// ── Direct REST helpers (XHR — works in most contexts) ──
function _xhr(method, url, body) {
  return new Promise(function(resolve, reject) {
    var x = new XMLHttpRequest();
    x.open(method, url, true);
    x.timeout = 10000; // 10s timeout
    Object.keys(_hdrs).forEach(function(k) { x.setRequestHeader(k, _hdrs[k]); });
    if (method === 'POST') x.setRequestHeader('Prefer', 'resolution=merge-duplicates');
    x.onload = function() {
      if (x.status >= 200 && x.status < 300) {
        try { resolve(JSON.parse(x.responseText || '[]')); }
        catch(e) { resolve([]); }
      } else {
        reject(new Error('HTTP ' + x.status));
      }
    };
    x.onerror = function() { reject(new Error('Network error')); };
    x.ontimeout = function() { reject(new Error('Timeout')); };
    x.send(body ? JSON.stringify(body) : null);
  });
}

function _dbSelect(params) {
  var qs = Object.keys(params).map(function(k) {
    return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
  }).join('&');
  if (!params.select) qs += '&select=key%2Cvalue';
  return _xhr('GET', _REST + '?' + qs, null);
}

function _dbUpsert(rows) {
  return _xhr('POST', _REST, rows);
}

// ── Connectivity test — enable cloud only if Supabase is reachable ──
(async function _cloudConnTest() {
  try {
    await _dbSelect({ select: 'key', limit: '1' });
    _cloudReady = true;
    console.log('☁️ Cloud sync connected');
    _cloudFlash('☁️ Connected', '#22c55e');
    cloudStartPolling();
    // Now run auto-migrate
    _cloudAutoMigrate();
  } catch (e) {
    _cloudReady = false;
    console.log('☁️ Cloud sync unavailable (sandboxed?) — using localStorage only. Open the HTML file directly in Chrome for cloud sync.');
  }
})();

// ── Cloud status indicator ──────────────────────────────
function _cloudStatusEl() {
  let el = document.getElementById('cloudSyncStatus');
  if (!el) {
    el = document.createElement('div');
    el.id = 'cloudSyncStatus';
    el.style.cssText = 'position:fixed;bottom:10px;right:10px;z-index:99998;font:600 .7rem/1.4 system-ui;padding:4px 10px;border-radius:12px;pointer-events:none;transition:opacity .3s;opacity:0;';
    document.body ? document.body.appendChild(el) : document.addEventListener('DOMContentLoaded', () => document.body.appendChild(el));
  }
  return el;
}
function _cloudFlash(msg, color) {
  const el = _cloudStatusEl();
  el.textContent = msg;
  el.style.background = color || '#22c55e';
  el.style.color = '#fff';
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.opacity = '0'; }, 2000);
}

// ── Cloud save (fire-and-forget, batched) ───────────────
let _cloudSaveQueue = {};
let _cloudSaveTimer = null;
let _cloudFlushing = false;
let _cloudFailCount = 0;

function cloudSave(key, value) {
  if (!_cloudReady) return;
  _cloudSaveQueue[key] = value;
  if (_cloudSaveTimer) clearTimeout(_cloudSaveTimer);
  // Reset fail count so sync can resume after pause
  _cloudFailCount = 0;
  _cloudSaveTimer = setTimeout(_cloudFlush, 600);
}

async function _cloudFlush() {
  if (_cloudFlushing || !Object.keys(_cloudSaveQueue).length) return;
  _cloudFlushing = true;
  const batch = { ..._cloudSaveQueue };
  _cloudSaveQueue = {};
  _cloudSaveTimer = null;
  _suppressRealtimeRefresh = true;
  try {
    const rows = Object.entries(batch).map(([k, v]) => {
      var val = v;
      if (typeof v === 'string') { try { val = JSON.parse(v); } catch(e) { val = v; } }
      return { key: k, value: val };
    });
    await _dbUpsert(rows);
    _cloudFlash('☁️ Synced', '#22c55e');
    _cloudFailCount = 0;
  } catch (e) {
    console.warn('Cloud save error:', e.message);
    _cloudFailCount++;
    // Put failed items back
    Object.entries(batch).forEach(([k, v]) => {
      if (!_cloudSaveQueue[k]) _cloudSaveQueue[k] = v;
    });
    if (_cloudFailCount <= 3) {
      _cloudFlash('☁️ Retrying...', '#f59e0b');
      setTimeout(_cloudFlush, 2000 * _cloudFailCount);
    } else {
      _cloudFlash('☁️ Sync paused', '#ef4444');
    }
  }
  _cloudFlushing = false;
  setTimeout(() => { _suppressRealtimeRefresh = false; }, 2000);
}

// ── Cloud pull (fetch all data for a company) ───────────
async function cloudPull(companyId) {
  if (!_cloudReady) return false;
  _cloudFlash('☁️ Loading...', '#3b82f6');
  try {
    // Fetch company list
    const coRows = await _dbSelect({ key: 'eq.mt6_companies', select: 'value' });
    if (coRows.length && coRows[0].value) {
      localStorage.setItem('mt6_companies', JSON.stringify(coRows[0].value));
    }

    // Fetch all keys for this company (using LIKE: mt6_%_companyId)
    const suffix = '_' + companyId;
    const rows = await _dbSelect({ key: 'like.mt6_%' + suffix, select: 'key,value' });
    if (rows && rows.length) {
      rows.forEach(r => {
        localStorage.setItem(r.key, JSON.stringify(r.value));
      });
    }
    _cloudFlash('☁️ Loaded', '#22c55e');
    return true;
  } catch (e) {
    console.warn('Cloud pull error:', e);
    _cloudFlash('☁️ Load failed — using local', '#f59e0b');
    return false;
  }
}

// ── Polling for changes (replaces WebSocket realtime) ───
function cloudStartPolling() {
  if (_pollTimer) return;
  _lastPollTs = new Date().toISOString();
  _pollTimer = setInterval(_cloudPoll, 5000); // check every 5s
}
function cloudStopPolling() {
  if (_pollTimer) { clearInterval(_pollTimer); _pollTimer = null; }
}
async function _cloudPoll() {
  if (!_cloudReady || _suppressRealtimeRefresh || !_lastPollTs) return;
  try {
    const rows = await _dbSelect({
      select: 'key,value',
      updated_at: 'gt.' + _lastPollTs,
      order: 'updated_at.desc',
      limit: '50'
    });
    if (!rows.length) return;

    _lastPollTs = new Date().toISOString();
    let needRefresh = false;
    rows.forEach(r => {
      localStorage.setItem(r.key, JSON.stringify(r.value));
      if (activeCompany && r.key.endsWith('_' + activeCompany)) needRefresh = true;
      if (r.key === 'mt6_companies') {
        companies = r.value || [];
        localStorage.setItem('mt6_companies', JSON.stringify(companies));
        needRefresh = true;
      }
    });
    if (needRefresh) {
      _cloudFlash('☁️ Updated by teammate', '#8b5cf6');
      _reloadActiveData();
    }
  } catch (e) {
    // On poll failure, reset timestamp to avoid getting stuck
    // Next successful poll will catch up
    console.warn('Poll error:', e.message);
  }
}

// ── Reload active data from localStorage (after cloud push) ─
function _reloadActiveData() {
  if (!activeCompany) return;
  try {
    couples  = ld(coKey('mt6_c'),    []);
    songs    = ld(coKey('mt6_s'),    []);
    insts    = ld(coKey('mt6_i'),    []);
    openSec  = ld(coKey('mt6_os'),   {});
    openYr   = ld(coKey('mt6_oy'),   {});
    songLib  = ld(coKey('mt6_lib'),  {});
    songHist = ld(coKey('mt6_hist'), {});
    normaliseInsts();
    // Update hashes so next sv() doesn't re-push unchanged data
    var dm = { [coKey('mt6_c')]: couples, [coKey('mt6_s')]: songs, [coKey('mt6_i')]: insts, [coKey('mt6_lib')]: songLib, [coKey('mt6_hist')]: songHist };
    Object.entries(dm).forEach(function(e){ _lastSavedHashes[e[0]] = JSON.stringify(e[1]).length + '_' + (Array.isArray(e[1]) ? e[1].length : Object.keys(e[1]).length); });
    if (document.getElementById('companyDashView')?.style.display !== 'none') {
      renderDashPanels('coDashPanels','coDashBanner');
    } else if (document.getElementById('mainApp')?.style.display !== 'none') {
      if (cur) { renderCoupleCard(); renderSections(); renderCoupleSummary(); renderCoupleTimeline(); }
      else { renderDashboard(); }
    }
  } catch (e) { console.warn('Reload error:', e); }
}

// ── Push ALL localStorage data to cloud (for initial migration) ─
async function cloudPushAll() {
  if (!_cloudReady) return;
  _cloudFlash('☁️ Uploading all data...', '#3b82f6');
  try {
    const rows = [];
    const coStr = localStorage.getItem('mt6_companies');
    if (coStr) rows.push({ key: 'mt6_companies', value: JSON.parse(coStr) });
    // Push users (global, not per-company)
    const usersStr = localStorage.getItem('mt6_users');
    if (usersStr) rows.push({ key: 'mt6_users', value: JSON.parse(usersStr) });

    const dataKeys = ['mt6_c','mt6_s','mt6_i','mt6_os','mt6_oy','mt6_lib','mt6_hist','mt6_dashview','mt6_crew_photographers','mt6_crew_videographers','mt6_locations'];
    const allCos = JSON.parse(coStr || '[]');
    allCos.forEach(co => {
      dataKeys.forEach(k => {
        const fullKey = k + '_' + co.id;
        const val = localStorage.getItem(fullKey);
        if (val !== null) {
          try { rows.push({ key: fullKey, value: JSON.parse(val) }); }
          catch(e2) { rows.push({ key: fullKey, value: val }); }
        }
      });
    });

    if (rows.length) {
      for (let i = 0; i < rows.length; i += 50) {
        const chunk = rows.slice(i, i + 50);
        await _dbUpsert(chunk);
      }
    }
    _cloudFlash('☁️ All data uploaded!', '#22c55e');
    return true;
  } catch (e) {
    console.warn('Cloud push all error:', e);
    _cloudFlash('☁️ Upload failed', '#ef4444');
    return false;
  }
}

// Polling starts automatically after successful connectivity test above

// ════════════════════════════════════════════════════════
// AUTH & USER MANAGEMENT
// ════════════════════════════════════════════════════════
let _appUsers = []; // [{username, password, displayName, role:'admin'|'editor'|'editor+', companies:[]}]
let _currentUser = null; // set after login

function _isGlobalAdmin() { return _currentUser && _currentUser.role === 'admin'; }
function _isEditorPlus() { return _currentUser && _currentUser.role === 'editor+'; }
// Editor+ acts as admin only for companies they own
function _isEditorPlusOwner() {
  if (!_currentUser || _currentUser.role !== 'editor+') return false;
  return activeCompany && (_currentUser.companies || []).indexOf(activeCompany) !== -1;
}
// _isAdmin() returns true for global admin OR editor+ in their own company
function _isAdmin() { return _currentUser && (_currentUser.role === 'admin' || _isEditorPlusOwner()); }
// _isEditor() returns true for regular editors OR editor+ in someone else's company
function _isEditor() { return _currentUser && (_currentUser.role === 'editor' || (_currentUser.role === 'editor+' && !_isEditorPlusOwner())); }
function _editorName() { return _currentUser ? _currentUser.displayName : ''; }

// Load users from localStorage (synced from cloud)
function _loadUsers() {
  try { _appUsers = JSON.parse(localStorage.getItem('mt6_users') || '[]'); } catch(e) { _appUsers = []; }
  // Seed default admin if no users exist
  if (!_appUsers.length) {
    _appUsers = [{ username:'admin', password:'admin', displayName:'Admin', role:'admin' }];
    localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
    cloudSave('mt6_users', _appUsers);
  }
}

// Check for existing session — disabled, require login each time
function _checkSession() {
  try {
    var sess = JSON.parse(localStorage.getItem('mt6_session') || 'null');
    if (!sess || !sess.username) return false;
    var user = _appUsers.find(function(u) { return u.username === sess.username; });
    if (!user) return false;
    _currentUser = user;
    return sess; // returns { username, companyId, view }
  } catch(e) { return false; }
}

function _saveSession() {
  if (!_currentUser) return;
  var view = 'companies';
  if (activeCompany) {
    var cdv = document.getElementById('companyDashView');
    var ma = document.getElementById('mainApp');
    var erv = document.getElementById('editingRoomView');
    var trv = document.getElementById('theatreRoomView');
    if (trv && trv.style.display !== 'none') view = 'theatreRoom';
    else if (erv && erv.style.display !== 'none') view = 'editingRoom';
    else if (cdv && cdv.style.display !== 'none') view = 'boardroom';
    else if (ma && ma.style.display !== 'none') {
      var ev = document.getElementById('editorView');
      var dv = document.getElementById('dashView');
      if (ev && ev.style.display !== 'none' && cur) view = 'productionOffice';
      else if (dv && dv.style.display !== 'none') view = 'clientLounge';
    }
  }
  var state = {
    username: _currentUser.username,
    companyId: activeCompany || null,
    coupleId: cur || null,
    view: view
  };
  localStorage.setItem('mt6_session', JSON.stringify(state));
  // Push browser history so back/forward buttons work
  _pushHistory(state);
}

var _historyNav = false; // flag to prevent pushing state during popstate
function _pushHistory(state) {
  if (_historyNav) return; // don't push when navigating via back/forward
  try {
    var current = history.state;
    // Only push if view actually changed
    if (!current || current.view !== state.view || current.companyId !== state.companyId || current.coupleId !== state.coupleId) {
      history.pushState(state, '', '');
    }
  } catch(e) {}
}

// Handle browser back/forward
window.addEventListener('popstate', function(e) {
  if (!e.state || !_currentUser) return;
  var s = e.state;
  _historyNav = true; // prevent _saveSession from pushing state back
  
  // Navigate to the right view
  if (!s.companyId) {
    // Back to company picker
    if (activeCompany) {
      activeCompany = null; cur = null;
      var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('companyDashView').style.display = 'none';
      document.getElementById('editorView').style.display = 'none';
      document.getElementById('loginView').style.display='';
      var _gh=document.getElementById('globalHeader');if(_gh)_gh.style.display='none';
      setPageLabel('');
      renderCompanyGrid();
      _applyRoleVisibility();
    }
  } else if (s.view === 'boardroom') {
    if (activeCompany === s.companyId) {
      // Same company, just switch view
      cur = null;
      var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
      document.getElementById('editorView').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('companyDashView').style.display='';
      var _gh2=document.getElementById('globalHeader');if(_gh2)_gh2.style.display='';
      setPageLabel('Boardroom');
      renderDashPanels('coDashPanels','coDashBanner');
      _applyRoleVisibility();
    } else {
      selectCompanyDash(s.companyId);
    }
  } else if (s.view === 'clientLounge') {
    if (activeCompany === s.companyId) {
      cur = null;
      var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
      document.getElementById('editorView').style.display = 'none';
      document.getElementById('companyDashView').style.display = 'none';
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('mainApp').style.display='';
      var _gh3=document.getElementById('globalHeader');if(_gh3)_gh3.style.display='';
      document.getElementById('dashView').style.display='';
      setPageLabel('Client Lounge');
      renderDashboard();
      _applyRoleVisibility();
    } else {
      selectCompanyClients(s.companyId);
    }
  } else if (s.view === 'productionOffice' && s.coupleId) {
    if (activeCompany === s.companyId) {
      cur = s.coupleId;
      var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
      document.getElementById('companyDashView').style.display = 'none';
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('mainApp').style.display='';
      var _gh4=document.getElementById('globalHeader');if(_gh4)_gh4.style.display='';
      document.getElementById('dashView').style.display = 'none';
      document.getElementById('editorView').style.display='';
      setPageLabel('Production Office');
      renderCoupleCard(); renderMain(); renderCoupleSummary(); renderCoupleTimeline();
      _applyRoleVisibility();
    } else {
      selectCompanyClients(s.companyId).then(function(){ selectCouple(s.coupleId); });
    }
  } else if (s.view === 'editingRoom') {
    if (activeCompany === s.companyId) {
      goToEditingRoom();
    } else {
      selectCompanyDash(s.companyId).then(function(){ goToEditingRoom(); });
    }
  } else if (s.view === 'theatreRoom') {
    if (activeCompany === s.companyId) {
      goToTheatreRoom();
    } else {
      selectCompanyDash(s.companyId).then(function(){ goToTheatreRoom(); });
    }
  }
  
  // Update localStorage session to match
  localStorage.setItem('mt6_session', JSON.stringify(s));
  _historyNav = false;
});

function _clearSession() {
  localStorage.removeItem('mt6_session');
}

let _usersLoaded = false; // true once cloud users have been pulled

function doLogin() {
  var uEl = document.getElementById('authUser');
  var pEl = document.getElementById('authPass');
  var errEl = document.getElementById('authError');
  var username = (uEl.value||'').trim().toLowerCase();
  var password = (pEl.value||'').trim();
  errEl.textContent = '';
  if (!username || !password) { errEl.textContent = 'Enter username and password'; return; }
  var user = _appUsers.find(function(u){return u.username.toLowerCase() === username && u.password === password;});
  if (user) { _currentUser = user; _saveSession(); _showApp(); return; }
  // Not found locally — try cloud pull if we haven't loaded yet
  if (!_usersLoaded) {
    errEl.textContent = 'Checking credentials...';
    _pullUsersAndRetry(username, password);
    return;
  }
  errEl.textContent = 'Invalid credentials'; pEl.value = ''; pEl.focus();
}

async function _pullUsersAndRetry(username, password) {
  var errEl = document.getElementById('authError');
  var pEl = document.getElementById('authPass');
  try {
    // Try cloud pull (works even if _cloudReady not set — direct XHR)
    var rows = await _dbSelect({ key: 'eq.mt6_users', select: 'value' });
    if (rows.length && rows[0].value && Array.isArray(rows[0].value) && rows[0].value.length) {
      _appUsers = rows[0].value;
      localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
    }
    _usersLoaded = true;
    var user = _appUsers.find(function(u){return u.username.toLowerCase() === username && u.password === password;});
    if (user) { _currentUser = user; _saveSession(); _showApp(); return; }
  } catch(e) {
    console.warn('Cloud user pull failed:', e);
    // Fallback: try direct fetch in case XHR wrapper isn't working
    try {
      var resp = await fetch('https://lbnbceaexamjnghbayns.supabase.co/rest/v1/app_data?key=eq.mt6_users&select=value', {
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibmJjZWFleGFtam5naGJheW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODIyNDUsImV4cCI6MjA4NzY1ODI0NX0.Yerr57763y4qj5x8C0HHYE0vWbA23l_nDZDVheYAFcQ',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibmJjZWFleGFtam5naGJheW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODIyNDUsImV4cCI6MjA4NzY1ODI0NX0.Yerr57763y4qj5x8C0HHYE0vWbA23l_nDZDVheYAFcQ'
        }
      });
      var data = await resp.json();
      if (data.length && data[0].value && Array.isArray(data[0].value) && data[0].value.length) {
        _appUsers = data[0].value;
        localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
        _usersLoaded = true;
        var user2 = _appUsers.find(function(u){return u.username.toLowerCase() === username && u.password === password;});
        if (user2) { _currentUser = user2; _saveSession(); _showApp(); return; }
      }
    } catch(e2) { console.warn('Fetch fallback also failed:', e2); }
  }
  _usersLoaded = true;
  if (errEl) { errEl.textContent = 'Invalid credentials'; }
  if (pEl) { pEl.value = ''; pEl.focus(); }
}

function doLogout() {
  _clearSession();
  _currentUser = null;
  closeUserMgmt();
  document.getElementById('authBadge').style.display = 'none';
  var _lb = document.getElementById('loginUserBanner'); if (_lb) _lb.style.display = 'none';
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('companyDashView').style.display = 'none';
  document.getElementById('mainApp').style.display = 'none';
  var gh = document.getElementById('globalHeader'); if (gh) gh.style.display = 'none';
  document.getElementById('authScreen').style.display = '';
  document.getElementById('authUser').value = '';
  document.getElementById('authPass').value = '';
  document.getElementById('authError').textContent = '';
}

function _showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('loginView').style.display = '';
  // Auto-restore device layout if previously selected
  if (_deviceLayout) {
    applyDeviceLayout(_deviceLayout);
    document.getElementById('loginDeviceStep').style.display = 'none';
    document.getElementById('loginCompanyStep').style.display = '';
    var icons = { desktop:'🖥 Desktop', tablet:'📱 iPad / Tablet', mobile:'📲 Mobile' };
    var dbadge = document.getElementById('loginDeviceBadge');
    if (dbadge) dbadge.textContent = (icons[_deviceLayout] || _deviceLayout) + ' mode';
    renderCompanyGrid();
  }
  // Update badge
  var badge = document.getElementById('authBadge');
  var initials = _currentUser.displayName.split(' ').map(function(w){return (w[0]||'').toUpperCase();}).join('').slice(0,2);
  document.getElementById('badgeAvatar').textContent = initials;
  _applyProfilePic();
  document.getElementById('badgeName').textContent = _currentUser.displayName;
  document.getElementById('badgeRole').textContent = _currentUser.role === 'admin' ? '(Admin)' : _currentUser.role === 'editor+' ? '(Editor+)' : '(Editor)';
  badge.style.display = '';
  // Update login page banner
  var banner = document.getElementById('loginUserBanner');
  if (banner) {
    banner.style.display = '';
    document.getElementById('loginBannerAvatar').innerHTML = _currentUser.profilePic
      ? '<img src="' + _currentUser.profilePic + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">'
      : initials;
    document.getElementById('loginBannerName').textContent = _currentUser.displayName;
    document.getElementById('loginBannerRole').textContent = _currentUser.role === 'admin' ? 'Administrator' : _currentUser.role === 'editor+' ? 'Editor+' : 'Editor';
  }
  // Hide admin-only elements for editors
  _applyRoleVisibility();
}

function _applyRoleVisibility() {
  // Elements to hide for editors
  document.querySelectorAll('.admin-only').forEach(function(el) {
    el.style.display = _isAdmin() ? '' : 'none';
  });
}

function openUserMenu() {
  openUserMgmt();
}

function openUserMgmt() {
  var titleEl = document.getElementById('userMgmtTitle');
  if (_isGlobalAdmin()) {
    if (titleEl) titleEl.textContent = 'User Management';
    renderUsersList();
  } else {
    if (titleEl) titleEl.textContent = 'Settings';
    document.getElementById('usersListWrap').innerHTML = '';
    document.getElementById('usersAddWrap').innerHTML = '';
  }
  _renderModalBgPicker();
  _applyProfilePic();
  document.getElementById('usersOverlay').classList.add('open');
}
function closeUserMgmt() {
  document.getElementById('usersOverlay').classList.remove('open');
}

function renderUsersList() {
  var listEl = document.getElementById('usersListWrap');
  var addEl = document.getElementById('usersAddWrap');
  var rows = _appUsers.map(function(u, idx) {
    var isSelf = _currentUser && _currentUser.username === u.username;
    var roleOpts = ['editor','editor+','admin'].map(function(r) {
      var label = r === 'editor+' ? 'Editor+' : r.charAt(0).toUpperCase() + r.slice(1);
      return '<option value="' + r + '"' + (u.role === r ? ' selected' : '') + '>' + label + '</option>';
    }).join('');
    return '<tr>' +
      '<td style="font-weight:600;">' + esc(u.displayName) + (isSelf ? ' <span style="font-size:.55rem;color:var(--gold);">(you)</span>' : '') + '</td>' +
      '<td>' + esc(u.username) + '</td>' +
      '<td><input class="um-pass-input" value="' + esc(u.password) + '" onchange="changeUserPass(' + idx + ',this.value)" style="font-family:\'Outfit\',sans-serif;font-size:.62rem;width:80px;padding:.15rem .3rem;border:1px solid var(--rule2);border-radius:4px;background:var(--card);color:var(--ink2);"></td>' +
      '<td><select class="um-role-sel" onchange="changeUserRole(' + idx + ',this.value)" style="font-family:\'Outfit\',sans-serif;font-size:.58rem;padding:.15rem .25rem;border:1px solid var(--rule2);border-radius:4px;background:var(--card);color:var(--ink2);">' + roleOpts + '</select></td>' +
      '<td>' + (isSelf ? '' : '<button class="btn btn-outline btn-sm" style="font-size:.55rem;padding:.1rem .3rem;" onclick="removeUser('+idx+')">✕</button>') + '</td>' +
    '</tr>';
  }).join('');
  listEl.innerHTML = '<table class="users-table"><thead><tr><th>Name</th><th>Username</th><th>Password</th><th>Role</th><th></th></tr></thead><tbody>' + rows + '</tbody></table>';
  addEl.innerHTML = '<div class="users-add">' +
    '<input id="nuName" placeholder="Display Name">' +
    '<input id="nuUser" placeholder="Username">' +
    '<input id="nuPass" placeholder="Password">' +
    '<select id="nuRole"><option value="editor">Editor</option><option value="editor+">Editor+</option><option value="admin">Admin</option></select>' +
    '<button class="btn btn-red" style="font-size:.65rem;padding:.3rem .6rem;white-space:nowrap;" onclick="addUser()">+ Add</button>' +
  '</div>';
}

function addUser() {
  var name = document.getElementById('nuName').value.trim();
  var user = document.getElementById('nuUser').value.trim().toLowerCase();
  var pass = document.getElementById('nuPass').value.trim();
  var role = document.getElementById('nuRole').value;
  if (!name || !user || !pass) { toast('Fill in all fields'); return; }
  if (_appUsers.some(function(u){return u.username.toLowerCase()===user;})) { toast('Username already exists'); return; }
  var newUser = { username:user, password:pass, displayName:name, role:role };
  if (role === 'editor+') newUser.companies = [];
  _appUsers.push(newUser);
  _saveUsers();
  renderUsersList();
  toast('User added: ' + name);
}

function removeUser(idx) {
  var u = _appUsers[idx]; if (!u) return;
  if (!confirm('Remove user "' + u.displayName + '"?')) return;
  _appUsers.splice(idx, 1);
  _saveUsers();
  renderUsersList();
  toast('User removed');
}

function changeUserRole(idx, newRole) {
  var u = _appUsers[idx]; if (!u) return;
  u.role = newRole;
  if (newRole === 'editor+' && !u.companies) u.companies = [];
  // Update current user if changing self
  if (_currentUser && _currentUser.username === u.username) {
    _currentUser.role = newRole;
    if (newRole === 'editor+' && !_currentUser.companies) _currentUser.companies = [];
    document.getElementById('badgeRole').textContent = newRole === 'admin' ? '(Admin)' : newRole === 'editor+' ? '(Editor+)' : '(Editor)';
  }
  _saveUsers();
  toast(u.displayName + ' → ' + (newRole === 'editor+' ? 'Editor+' : newRole));
}

function changeUserPass(idx, newPass) {
  var u = _appUsers[idx]; if (!u) return;
  newPass = newPass.trim();
  if (!newPass) { toast('Password cannot be empty'); renderUsersList(); return; }
  u.password = newPass;
  if (_currentUser && _currentUser.username === u.username) {
    _currentUser.password = newPass;
  }
  _saveUsers();
  toast('Password updated for ' + u.displayName);
}

function selfChangePassword() {
  var inp = document.getElementById('selfNewPass');
  var newPass = (inp.value || '').trim();
  if (!newPass) { toast('Enter a new password'); inp.focus(); return; }
  if (!_currentUser) return;
  _currentUser.password = newPass;
  var u = _appUsers.find(function(x){ return x.username === _currentUser.username; });
  if (u) u.password = newPass;
  _saveUsers();
  inp.value = '';
  inp.type = 'password'; // reset visibility
  toast('Password updated');
}

function togglePassVis(inputId, btn) {
  var inp = document.getElementById(inputId);
  if (!inp) return;
  if (inp.type === 'password') {
    inp.type = 'text';
    btn.textContent = '🙈';
    btn.style.opacity = '.8';
  } else {
    inp.type = 'password';
    btn.textContent = '👁';
    btn.style.opacity = '.5';
  }
  inp.focus();
}

function _saveUsers() {
  localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
  cloudSave('mt6_users', _appUsers);
}

// ── Editor filtering helpers ────────────────────────────
function _editorCoupleIds() {
  // Returns Set of couple IDs where current editor is assigned (editing or shooting)
  if (_isAdmin()) return null; // null means no filter
  var name = _editorName();
  var ids = new Set();
  insts.forEach(function(i) {
    if ((i.editor||'').trim() === name) ids.add(i.coupleId);
    if ((i.photoEditor||'').trim() === name) ids.add(i.coupleId);
    if ((i.videoEditor||'').trim() === name) ids.add(i.coupleId);
    if ((i.shooter||'').trim() === name) ids.add(i.coupleId);
    (i.photographers||[]).forEach(function(p){ if ((p||'').trim() === name) ids.add(i.coupleId); });
    (i.videographers||[]).forEach(function(v){ if ((v||'').trim() === name) ids.add(i.coupleId); });
  });
  couples.forEach(function(c) {
    if ((c.editors||[]).some(function(e){ return e.trim() === name; })) ids.add(c.id);
  });
  return ids;
}

function _editorInstIds() {
  // Returns Set of inst IDs where current editor is assigned
  if (_isAdmin()) return null;
  var name = _editorName();
  var ids = new Set();
  insts.forEach(function(i) {
    if ((i.editor||'').trim() === name) ids.add(i.id);
    if ((i.photoEditor||'').trim() === name) ids.add(i.id);
    if ((i.videoEditor||'').trim() === name) ids.add(i.id);
    if ((i.shooter||'').trim() === name) ids.add(i.id);
    (i.photographers||[]).forEach(function(p){ if ((p||'').trim() === name) ids.add(i.id); });
    (i.videographers||[]).forEach(function(v){ if ((v||'').trim() === name) ids.add(i.id); });
  });
  return ids;
}

// ── Init auth on page load ──────────────────────────────
_loadUsers();
// Try to load users from cloud (async)
(async function _pullUsers() {
  try {
    var rows;
    if (_cloudReady) {
      rows = await _dbSelect({ key: 'eq.mt6_users', select: 'value' });
    } else {
      // Fallback: direct fetch (works on Safari/mobile where XHR conn test may not have run yet)
      var resp = await fetch('https://lbnbceaexamjnghbayns.supabase.co/rest/v1/app_data?key=eq.mt6_users&select=value', {
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibmJjZWFleGFtam5naGJheW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODIyNDUsImV4cCI6MjA4NzY1ODI0NX0.Yerr57763y4qj5x8C0HHYE0vWbA23l_nDZDVheYAFcQ',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibmJjZWFleGFtam5naGJheW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODIyNDUsImV4cCI6MjA4NzY1ODI0NX0.Yerr57763y4qj5x8C0HHYE0vWbA23l_nDZDVheYAFcQ'
        }
      });
      rows = await resp.json();
    }
    if (rows && rows.length && rows[0].value && Array.isArray(rows[0].value) && rows[0].value.length) {
      _appUsers = rows[0].value;
      localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
    }
    _usersLoaded = true;
  } catch(e) { console.warn('User pull failed:', e); }
})();

// ════════════════════════════════════════════════════════
// DATA MODEL
// couples[]      { id, name, year, month, weddingTypes[], eventDate, editors[], completedAt }
// insts[]        { id, coupleId, catId, eventType, client, order, approved, approvedAt,
//                  editor, shooter, shootDay, timeFrom, timeTo,
//                  photographers[], videographers[], locationName, locationAddress, parkingLocation, vendors[] }
// songs[]        { id, coupleId, instanceId, title, artist, used, usedAt, order, lang, libLang }
// insts[]        { id, coupleId, catId, eventType, client, order, approved, approvedAt }
// openSec{}      instId → bool
// openYr{}       year   → bool
// songLib{}      "evType|lang" → [{title,artist}, ...]  lang = 'en'|'hi'|'pa'|'inst'
// songHist{}     "evType|lang" → [{title,artist,...}]
// ════════════════════════════════════════════════════════

const WEDDING_TYPES = [
  { id:'sikh',    label:'Sikh',       icon:'🪯', color:'rgba(255,165,0,.12)',  border:'rgba(255,165,0,.3)',  text:'#b45309' },
  { id:'hindu',   label:'Hindu',      icon:'🪔', color:'rgba(220,38,38,.08)',  border:'rgba(220,38,38,.25)', text:'#b91c1c' },
  { id:'punjabi', label:'Punjabi',    icon:'🌾', color:'rgba(34,197,94,.08)',  border:'rgba(34,197,94,.25)', text:'#15803d' },
  { id:'muslim',  label:'Muslim',     icon:'☪️',  color:'rgba(16,185,129,.08)', border:'rgba(16,185,129,.3)', text:'#065f46' },
  { id:'civil',   label:'Civil',      icon:'📜', color:'rgba(59,130,246,.08)', border:'rgba(59,130,246,.25)',text:'#1d4ed8' },
  { id:'mixed',   label:'Mixed',      icon:'🌐', color:'rgba(139,92,246,.08)', border:'rgba(139,92,246,.25)',text:'#6d28d9' },
  { id:'western', label:'Western',    icon:'💐', color:'rgba(236,72,153,.08)', border:'rgba(236,72,153,.25)',text:'#be185d' },
  { id:'namdhari',label:'Namdhari',   icon:'🕊️', color:'rgba(245,158,11,.08)', border:'rgba(245,158,11,.25)',text:'#92400e' },
  { id:'inter',   label:'Interfaith', icon:'✨', color:'rgba(154,123,60,.1)',  border:'rgba(154,123,60,.3)', text:'#92400e' },
];

const CATS = [
  { id:'pre', label:'Pre-Events', icon:'🌸',
    events:['Rokha','Engagement','Kurmayee','Mehndi','Goat Meat Party','Maiyan','Jaggo','Sangeet Night','Choora Ceremony'] },
  { id:'wed', label:'Wedding', icon:'💍',
    events:['Bride Prep','Groom Prep','Baraat','Milni','Ceremony','Park Shoot','Doli','Paani Varna'] },
  { id:'rec', label:'Reception', icon:'🥂',
    events:['Cocktail Hour','Program','Dancing'] }
];
const LANGS = [{id:'en',label:'🇬🇧 English'},{id:'hi',label:'🇮🇳 Hindi'},{id:'pa',label:'🟡 Punjabi'}];
const MO = ['','January','February','March','April','May','June','July','August','September','October','November','December'];

const ld = (k,d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } };

let couples  = ld('mt6_c',  []);
let songs    = ld('mt6_s',  []);
let insts    = ld('mt6_i',  []);
let openSec  = ld('mt6_os', {});
let openYr   = ld('mt6_oy', {});
let songLib  = ld('mt6_lib',{});  // key: "EventType|lang"  val: [{title,artist},...]
let songHist = ld('mt6_hist',{}); // key: "EventType|lang"  val: [{title,artist},...] — auto-saved from manual adds

let cur = null, view = 'sections', ff = 'all', fs = '', sortCol = '', sortDir = 1;
let curLibLang = 'en';
let dashViewMode = 'grid'; // loaded per-company on selectCompany
let editingCoupleId = null;

let activeCompany = null;
const coKey = k => k + '_' + (activeCompany || 'default');

let _lastSavedHashes = {};

const sv = () => {
  if (!activeCompany) return;
  localStorage.setItem(coKey('mt6_c'),    JSON.stringify(couples));
  localStorage.setItem(coKey('mt6_s'),    JSON.stringify(songs));
  localStorage.setItem(coKey('mt6_i'),    JSON.stringify(insts));
  localStorage.setItem(coKey('mt6_os'),   JSON.stringify(openSec));
  localStorage.setItem(coKey('mt6_oy'),   JSON.stringify(openYr));
  localStorage.setItem(coKey('mt6_lib'),  JSON.stringify(songLib));
  localStorage.setItem(coKey('mt6_hist'), JSON.stringify(songHist));
  // Cloud sync — only push keys that changed
  const dataMap = {
    [coKey('mt6_c')]: couples,
    [coKey('mt6_s')]: songs,
    [coKey('mt6_i')]: insts,
    [coKey('mt6_lib')]: songLib,
    [coKey('mt6_hist')]: songHist
  };
  Object.entries(dataMap).forEach(([k, v]) => {
    const hash = JSON.stringify(v).length + '_' + (Array.isArray(v) ? v.length : Object.keys(v).length);
    if (_lastSavedHashes[k] !== hash) {
      _lastSavedHashes[k] = hash;
      cloudSave(k, v);
    }
  });
};

// Local-only save — no cloud push (used after cloud pull to persist normalisation)
const _svLocal = () => {
  if (!activeCompany) return;
  localStorage.setItem(coKey('mt6_c'),    JSON.stringify(couples));
  localStorage.setItem(coKey('mt6_s'),    JSON.stringify(songs));
  localStorage.setItem(coKey('mt6_i'),    JSON.stringify(insts));
  localStorage.setItem(coKey('mt6_os'),   JSON.stringify(openSec));
  localStorage.setItem(coKey('mt6_oy'),   JSON.stringify(openYr));
  localStorage.setItem(coKey('mt6_lib'),  JSON.stringify(songLib));
  localStorage.setItem(coKey('mt6_hist'), JSON.stringify(songHist));
  // Update hashes so next sv() doesn't re-push the same data
  const dataMap = {
    [coKey('mt6_c')]: couples, [coKey('mt6_s')]: songs, [coKey('mt6_i')]: insts,
    [coKey('mt6_lib')]: songLib, [coKey('mt6_hist')]: songHist
  };
  Object.entries(dataMap).forEach(([k, v]) => {
    _lastSavedHashes[k] = JSON.stringify(v).length + '_' + (Array.isArray(v) ? v.length : Object.keys(v).length);
  });
};

const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,5);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
const uesc = s => String(s||'').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'");

// ── Page/Company label helpers ───────────────────────────────────
function setPageLabel(l){var e=document.getElementById('ghPageLabel');if(e)e.textContent=l;}
function setCompanyLabel(n){var e=document.getElementById('ghCompanyLabel');if(e)e.textContent=n||'';}

// ── Editing Room navigation ──────────────────────────────────────
function goToEditingRoom(){
  ['companyDashView','mainApp','loginView','theatreRoomView'].forEach(function(id){var e=document.getElementById(id);if(e)e.style.display='none';});
  document.getElementById('editingRoomView').style.display='';
  document.getElementById('globalHeader').style.display='';
  setPageLabel('Editing Room');
  renderEditingRoom();
  _applyRoleVisibility();
  _saveSession();
}

// ── THEATRE ROOM ─────────────────────────────────────────────────────
var _trCouple = null;    // selected couple id
var _trVideo = null;     // selected video index
var _trPlayer = null;    // player reference (Vimeo/YouTube)
var _trPlayerType = null; // 'vimeo' | 'youtube'
var _trPlayerReady = false;

function goToTheatreRoom(){
  ['companyDashView','mainApp','loginView','editingRoomView'].forEach(function(id){var e=document.getElementById(id);if(e)e.style.display='none';});
  document.getElementById('theatreRoomView').style.display='';
  document.getElementById('globalHeader').style.display='';
  setPageLabel('Theatre Room');
  _trPlayerReady = false;
  _trPlayer = null;
  renderTheatreRoom();
  _applyRoleVisibility();
  _saveSession();
}

function _trGetVideos(coupleId) {
  var co = couples.find(function(c){ return c.id === coupleId; });
  return co && co.theatreVideos ? co.theatreVideos : [];
}

function _trSaveVideos(coupleId, videos) {
  var co = couples.find(function(c){ return c.id === coupleId; });
  if (!co) return;
  co.theatreVideos = videos;
  sv();
}

function _trParseUrl(url) {
  url = (url||'').trim();
  // Vimeo — handles vimeo.com/ID, vimeo.com/video/ID, vimeo.com/ID/HASH, vimeo.com/manage/videos/ID
  var vm = url.match(/vimeo\.com\/(?:manage\/videos\/|video\/)?(\d+)(?:\/([a-zA-Z0-9]+))?/);
  if (vm) return { type:'vimeo', id:vm[1], hash:vm[2]||null };
  // YouTube — handles watch?v=, youtu.be/, embed/, shorts/
  var yt = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  if (yt) return { type:'youtube', id:yt[1], hash:null };
  return null;
}

function _trFmtTime(secs) {
  secs = Math.floor(secs || 0);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function renderTheatreRoom() {
  var body = document.getElementById('theatreBody');
  if (!body) return;

  // Couple selector
  var pillsHtml = couples.map(function(c) {
    var on = _trCouple === c.id ? ' on' : '';
    return '<span class="tr-couple-pill' + on + '" onclick="trSelectCouple(\'' + c.id + '\')">' + esc(c.name) + '</span>';
  }).join('');

  if (!_trCouple && couples.length) _trCouple = couples[0].id;
  if (!_trCouple) { body.innerHTML = '<div class="tr-empty">No couples yet</div>'; return; }

  var videos = _trGetVideos(_trCouple);
  if (_trVideo === null && videos.length) _trVideo = 0;
  if (_trVideo !== null && _trVideo >= videos.length) _trVideo = videos.length ? 0 : null;

  var videoListHtml = videos.map(function(v, i) {
    var active = _trVideo === i ? ' active' : '';
    var badge = v.type === 'vimeo' ? '<span class="tr-video-badge vimeo">Vimeo</span>' : '<span class="tr-video-badge youtube">YouTube</span>';
    var commentCount = (v.comments || []).length;
    return '<div class="tr-video-card' + active + '" onclick="trSelectVideo(' + i + ')">' +
      '<div style="flex:1;min-width:0;">' +
        '<div class="tr-video-title">' + esc(v.title || 'Untitled') + ' ' + badge + '</div>' +
        '<div class="tr-video-meta">' + esc(v.event || '') + (commentCount ? ' · ' + commentCount + ' note' + (commentCount>1?'s':'') : '') + '</div>' +
      '</div>' +
      ((_isAdmin() || _isEditorPlusOwner()) ? '<button class="tr-comment-delete" onclick="event.stopPropagation();trRemoveVideo(' + i + ')" title="Remove">✕</button>' : '') +
    '</div>';
  }).join('');

  // Add video form (admin or editor+ in own company)
  var canManageVideos = _isAdmin() || _isEditorPlusOwner();
  var addFormHtml = canManageVideos ? '<div class="tr-add-form">' +
    '<input id="trAddUrl" placeholder="Paste Vimeo or YouTube URL" style="flex:1;min-width:200px;" onkeydown="if(event.key===\'Enter\')trAddVideo()">' +
    '<input id="trAddTitle" placeholder="Title (optional)" style="width:120px;" onkeydown="if(event.key===\'Enter\')trAddVideo()">' +
    '<input id="trAddEvent" placeholder="Event (optional)" style="width:100px;" onkeydown="if(event.key===\'Enter\')trAddVideo()">' +
    '<button class="btn btn-red" style="font-size:.6rem;padding:.3rem .5rem;white-space:nowrap;" onclick="trAddVideo()">+ Add Video</button>' +
  '</div>' : '';

  // Player + comments for selected video
  var playerHtml = '';
  var commentsHtml = '';
  if (_trVideo !== null && videos[_trVideo]) {
    var vid = videos[_trVideo];
    var embedUrl = vid.type === 'vimeo'
      ? 'https://player.vimeo.com/video/' + vid.videoId + '?badge=0&autopause=0' + (vid.hash ? '&h=' + vid.hash : '')
      : 'https://www.youtube.com/embed/' + vid.videoId + '?enablejsapi=1&origin=' + encodeURIComponent(location.origin);

    playerHtml = '<div class="tr-player-wrap"><iframe id="trPlayerFrame" src="' + embedUrl + '" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>';

    // Comments sorted by timestamp
    var sortedComments = (vid.comments || []).slice().sort(function(a,b){ return (a.time||0) - (b.time||0); });
    var commentsListHtml = sortedComments.map(function(c, ci) {
      var origIdx = (vid.comments || []).indexOf(c);
      return '<div class="tr-comment-item">' +
        '<span class="tr-comment-time" onclick="trSeekTo(' + (c.time||0) + ')" title="Jump to ' + _trFmtTime(c.time) + '">' + _trFmtTime(c.time) + '</span>' +
        '<div style="flex:1;min-width:0;">' +
          '<div class="tr-comment-body">' + esc(c.text) + '</div>' +
          '<div class="tr-comment-author">' + esc(c.author || '') + '</div>' +
        '</div>' +
        '<button class="tr-comment-delete" onclick="trDeleteComment(' + origIdx + ')" title="Delete">✕</button>' +
      '</div>';
    }).join('');

    commentsHtml = '<div class="tr-comment-section">' +
      '<div class="tr-comment-bar">' +
        '<button class="tr-timestamp-btn" onclick="trStampComment()" title="Pause video & capture timestamp">⏸ Stamp</button>' +
        '<input id="trCommentInput" placeholder="Leave a note at this moment..." onkeydown="if(event.key===\'Enter\')trPostComment()">' +
        '<button class="btn btn-red" style="font-size:.58rem;padding:.25rem .5rem;" onclick="trPostComment()">Post</button>' +
      '</div>' +
      '<div id="trCurrentTime" style="font-family:\'Outfit\',sans-serif;font-size:.52rem;color:#533483;font-weight:700;margin-bottom:.5rem;">⏱ 0:00</div>' +
      (commentsListHtml || '<div class="tr-empty" style="padding:.8rem;">No notes yet — pause the video and leave your first note</div>') +
    '</div>';
  }

  body.innerHTML =
    '<div class="tr-couple-select">' + pillsHtml + '</div>' +
    addFormHtml +
    '<div style="display:grid;grid-template-columns:' + (videos.length ? '260px 1fr' : '1fr') + ';gap:1.2rem;align-items:start;">' +
      (videos.length ? '<div><div style="font-family:\'Outfit\',sans-serif;font-size:.55rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);margin-bottom:.4rem;">Videos</div><div class="tr-video-list">' + videoListHtml + '</div></div>' : '') +
      '<div>' + (playerHtml ? playerHtml + commentsHtml : '<div class="tr-empty">Add a Vimeo or YouTube link to get started</div>') + '</div>' +
    '</div>';

  // Init player API after DOM renders
  if (_trVideo !== null && videos[_trVideo]) {
    setTimeout(function(){ _trInitPlayer(videos[_trVideo]); }, 300);
  }
}

function _trInitPlayer(vid) {
  _trPlayerReady = false;
  _trPlayer = null;
  _trPlayerType = vid.type;
  var frame = document.getElementById('trPlayerFrame');
  if (!frame) return;

  if (vid.type === 'vimeo') {
    // Load Vimeo Player API if needed
    if (!window.Vimeo) {
      var s = document.createElement('script');
      s.src = 'https://player.vimeo.com/api/player.js';
      s.onload = function() { _trInitVimeo(frame); };
      document.head.appendChild(s);
    } else {
      _trInitVimeo(frame);
    }
  } else if (vid.type === 'youtube') {
    // Load YouTube IFrame API if needed
    if (!window.YT || !window.YT.Player) {
      if (!window._ytApiLoading) {
        window._ytApiLoading = true;
        var s = document.createElement('script');
        s.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(s);
      }
      window.onYouTubeIframeAPIReady = function() { _trInitYouTube(frame); };
    } else {
      _trInitYouTube(frame);
    }
  }
  // Start time display updater
  _trStartTimeUpdater();
}

function _trInitVimeo(frame) {
  try {
    _trPlayer = new Vimeo.Player(frame);
    _trPlayerReady = true;
  } catch(e) { console.warn('Vimeo init error:', e); }
}

function _trInitYouTube(frame) {
  try {
    _trPlayer = new YT.Player('trPlayerFrame', { events:{
      onReady: function(){ _trPlayerReady = true; }
    }});
  } catch(e) { console.warn('YouTube init error:', e); }
}

var _trTimeInterval = null;
function _trStartTimeUpdater() {
  if (_trTimeInterval) clearInterval(_trTimeInterval);
  _trTimeInterval = setInterval(function() {
    _trGetCurrentTime(function(t) {
      var el = document.getElementById('trCurrentTime');
      if (el) el.textContent = '⏱ ' + _trFmtTime(t);
    });
  }, 500);
}

function _trGetCurrentTime(cb) {
  if (!_trPlayerReady || !_trPlayer) { cb(0); return; }
  if (_trPlayerType === 'vimeo') {
    _trPlayer.getCurrentTime().then(function(t){ cb(t); }).catch(function(){ cb(0); });
  } else if (_trPlayerType === 'youtube') {
    try { cb(_trPlayer.getCurrentTime ? _trPlayer.getCurrentTime() : 0); } catch(e) { cb(0); }
  } else { cb(0); }
}

function _trPause() {
  if (!_trPlayerReady || !_trPlayer) return;
  if (_trPlayerType === 'vimeo') {
    _trPlayer.pause().catch(function(){});
  } else if (_trPlayerType === 'youtube') {
    try { _trPlayer.pauseVideo(); } catch(e) {}
  }
}

function trSeekTo(secs) {
  if (!_trPlayerReady || !_trPlayer) return;
  if (_trPlayerType === 'vimeo') {
    _trPlayer.setCurrentTime(secs).catch(function(){});
  } else if (_trPlayerType === 'youtube') {
    try { _trPlayer.seekTo(secs, true); } catch(e) {}
  }
}

function trSelectCouple(id) {
  _trCouple = id; _trVideo = null; _trPlayer = null; _trPlayerReady = false;
  renderTheatreRoom();
}

function trSelectVideo(idx) {
  _trVideo = idx; _trPlayer = null; _trPlayerReady = false;
  renderTheatreRoom();
}

function trAddVideo() {
  try {
    var urlEl = document.getElementById('trAddUrl');
    var titleEl = document.getElementById('trAddTitle');
    var eventEl = document.getElementById('trAddEvent');
    if (!urlEl) { toast('Form not found — try refreshing'); return; }
    var url = urlEl.value;
    if (!url || !url.trim()) { toast('Paste a video URL first'); urlEl.focus(); return; }
    var parsed = _trParseUrl(url);
    if (!parsed) { toast('Paste a valid Vimeo or YouTube URL'); urlEl.focus(); return; }
    if (!_trCouple) { toast('Select a couple first'); return; }
    var videos = _trGetVideos(_trCouple);
    videos.push({
      videoId: parsed.id,
      type: parsed.type,
      hash: parsed.hash || null,
      title: (titleEl && titleEl.value||'').trim() || (parsed.type === 'vimeo' ? 'Vimeo Video' : 'YouTube Video'),
      event: (eventEl && eventEl.value||'').trim(),
      comments: [],
      addedAt: new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
    });
    _trSaveVideos(_trCouple, videos);
    _trVideo = videos.length - 1;
    renderTheatreRoom();
    toast('Video added');
  } catch(e) {
    console.error('trAddVideo error:', e);
    toast('Error adding video: ' + e.message);
  }
}

function trRemoveVideo(idx) {
  var videos = _trGetVideos(_trCouple);
  if (!videos[idx]) return;
  if (!confirm('Remove "' + (videos[idx].title||'this video') + '"?')) return;
  videos.splice(idx, 1);
  _trSaveVideos(_trCouple, videos);
  if (_trVideo >= videos.length) _trVideo = videos.length ? 0 : null;
  _trPlayer = null; _trPlayerReady = false;
  renderTheatreRoom();
  toast('Video removed');
}

function trStampComment() {
  _trPause();
  _trGetCurrentTime(function(t) {
    var el = document.getElementById('trCurrentTime');
    if (el) el.textContent = '⏸ Paused at ' + _trFmtTime(t);
    var inp = document.getElementById('trCommentInput');
    if (inp) { inp.dataset.stamp = t; inp.focus(); }
  });
}

function trPostComment() {
  if (_trVideo === null || !_trCouple) return;
  var inp = document.getElementById('trCommentInput');
  var text = (inp.value||'').trim();
  if (!text) { toast('Type a note first'); inp.focus(); return; }
  var stamp = parseFloat(inp.dataset.stamp || '0');
  // If no stamp yet, grab current time
  if (!inp.dataset.stamp) {
    _trPause();
  }
  _trGetCurrentTime(function(t) {
    var time = inp.dataset.stamp ? stamp : t;
    var videos = _trGetVideos(_trCouple);
    if (!videos[_trVideo]) return;
    if (!videos[_trVideo].comments) videos[_trVideo].comments = [];
    videos[_trVideo].comments.push({
      time: time,
      text: text,
      author: _currentUser ? _currentUser.displayName : 'Unknown',
      at: new Date().toISOString()
    });
    _trSaveVideos(_trCouple, videos);
    inp.value = ''; inp.dataset.stamp = '';
    renderTheatreRoom();
    // Re-select same video to keep player
    toast('Note added at ' + _trFmtTime(time));
  });
}

function trDeleteComment(idx) {
  if (_trVideo === null || !_trCouple) return;
  var videos = _trGetVideos(_trCouple);
  if (!videos[_trVideo] || !videos[_trVideo].comments[idx]) return;
  videos[_trVideo].comments.splice(idx, 1);
  _trSaveVideos(_trCouple, videos);
  renderTheatreRoom();
}

// ── Editing Room save helper ─────────────────────────────────────
function erSave(instId,field,value){
  var inst=insts.find(function(i){return i.id===instId;});
  if(!inst)return;
  inst[field]=value;
  if(field==='erDelivered'&&value===true)
    inst.erDeliveredAt=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  sv();
  renderEditingRoom();
}

// ── Pipeline status from existing site data ──────────────────────
function erStatus(inst){
  var hp=!!(inst.servicePhoto||inst.services==='photo'||inst.services==='both');
  var hv=!!(inst.serviceVideo||inst.services==='video'||inst.services==='both');
  if(inst.erDelivered) return 'delivered';
  var pd=!hp||!!inst.photoEditApproved, vd=!hv||!!inst.videoEditApproved;
  var editDone=(hp||hv)?(pd&&vd):!!inst.approved;
  if(editDone) return 'ready';
  if(inst.changesNeeded||inst.photoChangesNeeded||inst.videoChangesNeeded||inst.editorStatus==='changes'||inst.erDeliveryStatus||inst.erFirstDraft) return 'review';
  if(!_isInstShootDone(inst)||inst.editPaused||inst.editUpcoming) return 'queue';
  var hasEd=!!(inst.editor||inst.photoEditor||inst.videoEditor);
  return hasEd?'progress':'queue';
}

// ── Render ───────────────────────────────────────────────────────
function renderEditingRoom(){
  var el=document.getElementById('erBody');if(!el)return;

  function cn(i){var c=couples.find(function(x){return x.id===i.coupleId;});return c?c.name:'—';}
  function cy(i){var c=couples.find(function(x){return x.id===i.coupleId;});return c?(c.year||''):'';}
  function gt(i){return 'goToAllCouples();setTimeout(function(){selectCoupleAndOpen(\''+i.coupleId+'\',\''+i.id+'\')},150)';}
  function eds(i){var s=[];['editor','photoEditor','videoEditor'].forEach(function(f){if(i[f]&&s.indexOf(i[f].trim())<0)s.push(i[f].trim());});return s.filter(Boolean);}
  function hp(i){return!!(i.servicePhoto||i.services==='photo'||i.services==='both');}
  function hv(i){return!!(i.serviceVideo||i.services==='video'||i.services==='both');}

  function svc(i){var p=hp(i),v=hv(i);
    if(p&&v)return'<span class="er-badge bph">📷</span><span class="er-badge bvd">🎥</span>';
    if(p)return'<span class="er-badge bph">📷</span>';
    if(v)return'<span class="er-badge bvd">🎥</span>';return'';}

  function ebadge(i){var p=hp(i),v=hv(i),pa=i.photoEditApproved,va=i.videoEditApproved,pc=i.photoChangesNeeded,vc=i.videoChangesNeeded;
    if(p&&v){if(pa&&va)return'<span class="er-badge brd">✓ Both Done</span>';
      if(pc||vc)return'<span class="er-badge brs">⚑ Changes</span>';
      if(pa)return'<span class="er-badge bp">Photo ✓</span>';if(va)return'<span class="er-badge bp">Video ✓</span>';}
    if(p&&pa)return'<span class="er-badge brd">✓ Photo</span>';
    if(v&&va)return'<span class="er-badge brd">✓ Video</span>';
    if(i.approved)return'<span class="er-badge brd">✓ Approved</span>';
    if(i.changesNeeded||pc||vc||i.editorStatus==='changes')return'<span class="er-badge brs">⚑ Changes</span>';
    return'';}

  function ftg(i){if(i.footageReceived&&i.imagesReceived)return'<span class="er-badge brd">📁 All In</span>';
    if(i.footageReceived)return'<span class="er-badge bp">🎬 Footage</span>';
    if(i.imagesReceived)return'<span class="er-badge bp">🖼 Images</span>';
    return'<span class="er-badge bq" style="opacity:.55">Awaiting</span>';}

  function pbadge(i){if(i.editPaused)return'<span class="er-badge bps">⏸ Paused</span>';
    if(i.editUpcoming)return'<span class="er-badge bps">🔜 Soon</span>';return'';}

  function shotbadge(i){return _isInstShootDone(i)?'<span class="er-badge brd" style="opacity:.7">✓ Shot</span>':'<span class="er-badge bq">📸 Unshot</span>';}

  function chgbadge(i){var n=(i.changesCount||0)+(i.photoChangesCount||0)+(i.videoChangesCount||0);return n?'<span class="er-badge brs">⚑ '+n+'</span>':'';}

  function etsel(i){var v=i.erEditType||'';
    return '<select class="er-isel" onchange="erSave(\''+i.id+'\',\'erEditType\',this.value)" onclick="event.stopPropagation()"><option value=""'+(v?'':' selected')+'>Type…</option><option value="Documentary"'+(v==='Documentary'?' selected':'')+'>Documentary</option><option value="Highlights"'+(v==='Highlights'?' selected':'')+'>Highlights</option><option value="Feature Film"'+(v==='Feature Film'?' selected':'')+'>Feature Film</option><option value="Same Day Edit"'+(v==='Same Day Edit'?' selected':'')+'>Same Day Edit</option></select>';}

  function pbar(i){var p=hp(i),v=hv(i),pct=i.erProgress;
    if(!pct){var d=0,t=0;if(p){t++;if(i.photoEditApproved)d++;else if(i.photoChangesNeeded)d+=.5;}if(v){t++;if(i.videoEditApproved)d++;else if(i.videoChangesNeeded)d+=.5;}if(!p&&!v&&i.approved){d=1;t=1;}pct=t?Math.round(d/t*100):0;}
    return '<div style="display:flex;align-items:center;gap:.4rem;margin-top:.3rem;grid-column:1/-1"><div class="er-pbar" style="flex:1"><div class="er-pbar-fill" style="width:'+pct+'%"></div></div><input type="number" min="0" max="100" value="'+pct+'" style="width:2.4rem;font-size:.5rem;border:1px solid var(--rule);border-radius:4px;padding:.1rem .2rem;text-align:right" onclick="event.stopPropagation()" onchange="erSave(\''+i.id+'\',\'erProgress\',Math.min(100,Math.max(0,+this.value)))"><span style="font-size:.48rem;color:var(--ink5)">%</span></div>';}

  function dueip(i){var v=i.erDueDate||'',urg='';
    if(v){var today=new Date();today.setHours(0,0,0,0);var d=new Date(v+'T00:00:00'),days=Math.round((d-today)/86400000);if(days<0)urg='color:#dc2626;font-weight:700';else if(days<=7)urg='color:#ea580c;font-weight:600';}
    return '<div onclick="event.stopPropagation()" style="display:flex;align-items:center;gap:.3rem"><span style="font-size:.5rem;color:var(--ink5)">Due:</span><input type="date" value="'+v+'" style="font-size:.5rem;border:none;border-bottom:1px solid var(--rule);background:transparent;outline:none;'+urg+'" onchange="erSave(\''+i.id+'\',\'erDueDate\',this.value)"></div>';}

  function sdmeta(i){if(!i.shootDay)return'';
    var today=new Date();today.setHours(0,0,0,0);var d=new Date(i.shootDay+'T00:00:00'),days=Math.round((d-today)/86400000);
    var rel=days<0?(Math.abs(days)+'d ago'):days===0?'Today':('in '+days+'d');
    return'<span>📅 '+i.shootDay+' ('+rel+')</span>';}

  function nameSpan(i){var y=cy(i);return esc(cn(i))+(y?' <span style="font-size:.62rem;color:var(--ink5);font-style:italic">'+y+'</span>':'');}

  function card(i,extra){
    var e=eds(i);
    var edStr=e.length?('<span>✂️ '+esc(e.join(', '))+'</span>'):'<span style="color:var(--gold)">⚠ Unassigned</span>';
    return '<div class="er-card" onclick="'+gt(i)+'"><div class="er-card-name">'+nameSpan(i)+'</div>'
      +'<div class="er-card-meta"><span>'+esc(i.eventType||'Event')+'</span>'+sdmeta(i)+edStr+etsel(i)+'</div>'
      +'<div class="er-card-actions">'+svc(i)+extra+'</div></div>';
  }

  var queue=[],progress=[],review=[],ready=[],delivered=[];
  var _erInsts = insts;
  // Editor role: only show events they're assigned to
  if (_isEditor()) {
    var _myInstIds = _editorInstIds();
    if (_myInstIds) _erInsts = insts.filter(function(i){ return _myInstIds.has(i.id); });
  }
  _erInsts.forEach(function(i){
    var s=erStatus(i);
    if(s==='delivered')delivered.push(i);
    else if(s==='ready')ready.push(i);
    else if(s==='review')review.push(i);
    else if(s==='progress')progress.push(i);
    else queue.push(i);
  });
  queue.sort(function(a,b){return(a.shootDay||'9999').localeCompare(b.shootDay||'9999');});
  progress.sort(function(a,b){return(a.erDueDate||'9999').localeCompare(b.erDueDate||'9999');});

  var qH=queue.length?queue.map(function(i){return card(i,shotbadge(i)+ftg(i)+pbadge(i)+dueip(i));}).join(''):'<div class="er-empty">No projects in queue</div>';

  var prH=progress.length?progress.map(function(i){
    var e=eds(i);var edStr=e.length?('<span>✂️ '+esc(e.join(', '))+'</span>'):'';
    return '<div class="er-card" onclick="'+gt(i)+'">'
      +'<div class="er-card-name">'+nameSpan(i)+'</div>'
      +'<div class="er-card-meta"><span>'+esc(i.eventType||'Event')+'</span>'+edStr+ftg(i)+etsel(i)+'</div>'
      +'<div class="er-card-actions">'+svc(i)+ebadge(i)+dueip(i)+'</div>'
      +pbar(i)+'</div>';
  }).join(''):'<div class="er-empty">No projects in progress</div>';

  function rvst(i){
    if(i.erDeliveryStatus==='final_approval')return['Final Approval Pending','brv'];
    if(i.erDeliveryStatus==='revision_progress')return['Revision In Progress','brs'];
    if(i.changesNeeded||i.photoChangesNeeded||i.videoChangesNeeded||i.editorStatus==='changes')return['Revision Requested','brs'];
    if(i.erDeliveryStatus==='sent_client')return['Sent to Client','bp'];
    if(i.erFirstDraft||i.erDeliveryStatus==='first_draft')return['First Draft Ready','bq'];
    return['In Review','brv'];
  }
  var rvH=review.length?review.map(function(i){
    var rs=rvst(i),sl=rs[0],sc=rs[1];var e=eds(i);var edStr=e.length?('<span>✂️ '+esc(e.join(', '))+'</span>'):'';
    return '<div class="er-card" onclick="'+gt(i)+'">'
      +'<div class="er-card-name">'+nameSpan(i)+'</div>'
      +'<div class="er-card-meta"><span>'+esc(i.eventType||'Event')+'</span>'+edStr+chgbadge(i)+'</div>'
      +'<div class="er-card-actions">'+svc(i)+'<span class="er-badge '+sc+'">'+sl+'</span>'+ebadge(i)
      +'<select class="er-isel" onchange="erSave(\''+i.id+'\',\'erDeliveryStatus\',this.value)" onclick="event.stopPropagation()">'
      +'<option value="">Update…</option>'
      +'<option value="first_draft"'+(i.erDeliveryStatus==='first_draft'?' selected':'')+'>First Draft</option>'
      +'<option value="sent_client"'+(i.erDeliveryStatus==='sent_client'?' selected':'')+'>Sent to Client</option>'
      +'<option value="revision_progress"'+(i.erDeliveryStatus==='revision_progress'?' selected':'')+'>Revision WIP</option>'
      +'<option value="final_approval"'+(i.erDeliveryStatus==='final_approval'?' selected':'')+'>Final Approval</option>'
      +'</select></div></div>';
  }).join(''):'<div class="er-empty">No projects in review</div>';

  function chk(i,field,label,icon){var ch=!!i[field];
    return '<label class="er-chk'+(ch?' on':'')+'" onclick="event.stopPropagation()">'
      +'<input type="checkbox"'+(ch?' checked':'')+' onchange="erSave(\''+i.id+'\',\''+field+'\',this.checked)">'+icon+' '+label+'</label>';}

  var rdH=ready.length?ready.map(function(i){
    var e=eds(i);var meta=esc(i.eventType||'')+(cy(i)?' · '+cy(i):'')+(e.length?' · ✂️ '+esc(e[0]):'')+( e.length>1?' +':'');
    return '<div class="er-delivery-row">'
      +'<div onclick="'+gt(i)+'" style="min-width:120px;cursor:pointer">'
      +'<div style="font-family:\'Cormorant Garamond\',serif;font-size:.9rem;font-weight:600">'+esc(cn(i))+'</div>'
      +'<div style="font-family:\'Outfit\',sans-serif;font-size:.54rem;color:var(--ink5)">'+meta+'</div></div>'
      +chk(i,'erExportComplete','Export','📁')
      +chk(i,'erUsbNeeded','USB','💾')
      +chk(i,'erGalleryUploaded','Gallery','🖼')
      +chk(i,'erClientNotified','Notified','✉️')
      +'<button class="er-badge brd" style="cursor:pointer;border:none;padding:.25rem .6rem" onclick="event.stopPropagation();erSave(\''+i.id+'\',\'erDelivered\',true)">Delivered ✓</button>'
      +'</div>';
  }).join(''):'<div class="er-empty">No projects ready</div>';

  var dlH=delivered.length?delivered.slice().sort(function(a,b){return(b.erDeliveredAt||'').localeCompare(a.erDeliveredAt||'');}).map(function(i){
    var e=eds(i);
    return '<div class="er-arch-row" onclick="'+gt(i)+'" style="cursor:pointer">'
      +'<div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">'
      +'<span style="font-family:\'Cormorant Garamond\',serif;font-size:.9rem;font-weight:600">'+esc(cn(i))+'</span>'
      +(cy(i)?'<span style="font-size:.52rem;color:var(--ink5)">'+cy(i)+'</span>':'')
      +'<span style="font-size:.54rem;color:var(--ink5)">'+esc(i.eventType||'')+'</span>'
      +(e.length?'<span style="font-size:.52rem;color:var(--ink5)">✂️ '+esc(e.join(', '))+'</span>':'')
      +(i.erDeliveredAt?'<span style="font-size:.5rem;color:var(--ink5)">'+i.erDeliveredAt+'</span>':'')
      +'</div><div style="display:flex;gap:.4rem;align-items:center">'
      +'<span class="er-badge bdn">✓ Done</span>'
      +'<button class="er-badge" style="cursor:pointer;border:1px solid var(--rule);background:transparent;font-size:.46rem" onclick="event.stopPropagation();erSave(\''+i.id+'\',\'erDelivered\',false)">Undo</button>'
      +'</div></div>';
  }).join(''):'<div class="er-empty">No delivered projects yet</div>';

  var unass=[].concat(queue,progress).filter(function(i){return!eds(i).length;}).length;
  var totchg=insts.reduce(function(s,i){return s+(i.changesCount||0)+(i.photoChangesCount||0)+(i.videoChangesCount||0);},0);

  var statH='<div class="er-stat-row">'
    +'<div class="er-stat"><div class="er-stat-n">'+queue.length+'</div><div class="er-stat-l">Queue</div></div>'
    +'<div class="er-stat"><div class="er-stat-n">'+progress.length+'</div><div class="er-stat-l">In Progress</div></div>'
    +'<div class="er-stat"><div class="er-stat-n">'+review.length+'</div><div class="er-stat-l">Review</div></div>'
    +'<div class="er-stat"><div class="er-stat-n">'+ready.length+'</div><div class="er-stat-l">Ready</div></div>'
    +'<div class="er-stat"><div class="er-stat-n">'+delivered.length+'</div><div class="er-stat-l">Delivered</div></div>'
    +(unass?'<div class="er-stat"><div class="er-stat-n" style="color:var(--gold)">'+unass+'</div><div class="er-stat-l">Unassigned</div></div>':'')
    +(totchg?'<div class="er-stat"><div class="er-stat-n" style="color:#dc2626">'+totchg+'</div><div class="er-stat-l">Changes</div></div>':'')
    +'<div class="er-stat"><div class="er-stat-n">'+insts.length+'</div><div class="er-stat-l">Total</div></div>'
    +'</div>';

  el.innerHTML=statH
    +'<div class="er-layout">'
    +'<div class="er-section"><div class="er-section-head"><span class="er-section-title">🧭 Editor Queue</span><span class="er-section-count">'+queue.length+'</span></div>'+qH+'</div>'
    +'<div class="er-section"><div class="er-section-head"><span class="er-section-title">✂️ In Progress</span><span class="er-section-count">'+progress.length+'</span></div>'+prH+'</div>'
    +'</div>'
    +'<div class="er-layout">'
    +'<div class="er-section"><div class="er-section-head"><span class="er-section-title">🧠 Review &amp; Revisions</span><span class="er-section-count">'+review.length+'</span></div>'+rvH+'</div>'
    +'<div class="er-section"><div class="er-section-head"><span class="er-section-title">📦 Ready for Delivery</span><span class="er-section-count">'+ready.length+'</span></div>'+rdH+'</div>'
    +'</div>'
    +'<div class="er-layout er-layout-full">'
    +'<div class="er-section"><div class="er-section-head"><span class="er-section-title">🏁 Delivered</span><span class="er-section-count">'+delivered.length+'</span></div>'+dlH+'</div>'
    +'</div>';
}

function toast(m) {
  const el = document.getElementById('toast');
  el.textContent = m; el.classList.add('show');
  clearTimeout(el._t); el._t = setTimeout(() => el.classList.remove('show'), 2500);
}

// ── YEAR INIT ────────────────────────────────────────
function initYears() {
  const now = new Date().getFullYear();
  // Populate both add and edit year selects
  ['cYear','eYear'].forEach(id => {
    const s = document.getElementById(id); if (!s) return;
    s.innerHTML = '';
    for (let y = now+3; y >= 2009; y--) {
      const o = document.createElement('option');
      o.value = y; o.textContent = y; if (y===now) o.selected = true;
      s.appendChild(o);
    }
  });
  document.getElementById('cMonth').value = new Date().getMonth()+1;
  // Render wedding type buttons for Add modal
  document.getElementById('weddingTypeGrid').innerHTML = WEDDING_TYPES.map(w =>
    `<button class="wt-btn" data-wt="${w.id}" onclick="toggleWT(this)" type="button">
      <span class="wt-icon">${w.icon}</span>
      <span class="wt-label">${w.label}</span>
    </button>`
  ).join('');
  // Render wedding type buttons for Edit modal
  document.getElementById('editWeddingTypeGrid').innerHTML = WEDDING_TYPES.map(w =>
    `<button class="wt-btn" data-wt="${w.id}" onclick="toggleWT(this)" type="button">
      <span class="wt-icon">${w.icon}</span>
      <span class="wt-label">${w.label}</span>
    </button>`
  ).join('');
  populateFilterYears();
  populateFilterTypes();
  // Restore dash view mode
  setDashView(dashViewMode, true);
}

function toggleWT(btn) {
  btn.classList.toggle('selected');
}

function getSelectedWTs() {
  return [...document.querySelectorAll('#weddingTypeGrid .wt-btn.selected')].map(b => b.dataset.wt);
}

function populateFilterYears() {
  const sel = document.getElementById('filterYear'); if (!sel) return;
  const years = [...new Set(couples.map(c=>c.year))].sort((a,b)=>b-a);
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Years</option>' + years.map(y=>`<option value="${y}"${cur==y?' selected':''}>${y}</option>`).join('');
}

function populateFilterTypes() {
  const sel = document.getElementById('filterType'); if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Types</option>' + WEDDING_TYPES.map(w=>`<option value="${w.id}"${cur===w.id?' selected':''}>${w.icon} ${w.label}</option>`).join('');
}

// ── ADD COUPLE MODAL ─────────────────────────────────
function openAddCouple() {
  document.getElementById('cName').value = '';
  document.querySelectorAll('#weddingTypeGrid .wt-btn').forEach(b=>b.classList.remove('selected'));
  const now = new Date();
  document.getElementById('cYear').value = now.getFullYear();
  document.getElementById('cMonth').value = now.getMonth()+1;
  document.getElementById('cEventDate').value = '';
  document.getElementById('cEditDueDate').value = '';
  document.getElementById('cEditDueDuration').value = '90d';
  document.getElementById('addCoupleModal').classList.add('open');
  setTimeout(()=>document.getElementById('cName').focus(), 80);
}
function closeAddCouple() { document.getElementById('addCoupleModal').classList.remove('open'); }

// ── COUPLES ──────────────────────────────────────────
function addCouple() {
  const name = document.getElementById('cName').value.trim();
  const year = +document.getElementById('cYear').value;
  const month = +document.getElementById('cMonth').value;
  if (!name) return toast('Please enter a couple name.');
  const weddingTypes = getSelectedWTs();
  const eventDate = document.getElementById('cEventDate').value || '';
  const editDueDate = document.getElementById('cEditDueDate').value || '';
  const editDueDuration = document.getElementById('cEditDueDuration').value.trim() || '';
  const editors = (document.getElementById('cEditors').value || '').split(',').map(e=>e.trim()).filter(Boolean);
  const theatrePass = (document.getElementById('cTheatrePass').value || '').trim();
  const c = { id:uid(), name, year, month, weddingTypes, eventDate, editors, completedAt:null, editDueDate, editDueDuration, theatrePass };
  couples.push(c); sv();
  closeAddCouple();
  populateFilterYears(); populateFilterTypes();
  renderDashboard(); renderEditorFilter();
  toast(`Added: ${name} — ${MO[month]} ${year}`);
}

function delCouple(id, e) {
  if (e) e.stopPropagation();
  const c = couples.find(x=>x.id===id);
  if (!confirm(`Remove "${c?.name}" and all their data?`)) return;
  couples = couples.filter(x=>x.id!==id);
  songs   = songs.filter(s=>s.coupleId!==id);
  insts   = insts.filter(i=>i.coupleId!==id);
  if (cur===id) { cur = null; goToDashboard(); }
  sv(); populateFilterYears(); populateFilterTypes(); renderDashboard();
}

function filterDashYear(year) {
  const sel = document.getElementById('filterYear');
  if (sel) { sel.value = year; renderDashboard(); }
}

function selectCoupleFromDash(id) {
  if (_isEditor()) {
    // Editor: open first assigned event modal directly
    _editorPrevView = 'boardroom';
    cur = id;
    document.getElementById('companyDashView').style.display = 'none';
    document.getElementById('mainApp').style.display=''; var _ghx=document.getElementById('globalHeader');if(_ghx)_ghx.style.display='';
    _setupCoupleDOM(id);
    const myIds = _editorInstIds();
    const firstInst = insts.find(i => i.coupleId === id && (!myIds || myIds.has(i.id)));
    if (firstInst) setTimeout(() => { openEvModal(firstInst.id); }, 120);
    return;
  }
  // Go directly from company dashboard to couple editor, no All Clients stop
  cur = id;
  document.getElementById('companyDashView').style.display = 'none';
  document.getElementById('mainApp').style.display=''; var _gh3=document.getElementById('globalHeader');if(_gh3)_gh3.style.display='';
  document.getElementById('dashView').style.display = 'none';
  document.getElementById('editorView').style.display=''; setPageLabel('Production Office');
  initYears();
  renderCoupleCard();
  renderMain();
  renderCoupleSummary(); renderCoupleTimeline();
}

let _editorPrevView = null; // tracks where editor was before modal opened

function selectCouple(id) {
  cur = id;
  if (_isEditor()) {
    // Editor: find first assigned event and open modal directly
    _editorPrevView = _getCurrentView();
    _setupCoupleDOM(id);
    const myIds = _editorInstIds();
    const firstInst = insts.find(i => i.coupleId === id && (!myIds || myIds.has(i.id)));
    if (firstInst) {
      setTimeout(() => { openEvModal(firstInst.id); }, 120);
    }
    return;
  }
  document.getElementById('dashView').style.display = 'none';
  document.getElementById('editorView').style.display=''; setPageLabel('Production Office');
  renderCoupleCard();
  renderMain();
  renderCoupleSummary(); renderCoupleTimeline();
  _applyRoleVisibility();
  _saveSession();
}

function selectCoupleAndOpen(coupleId, instId) {
  cur = coupleId;
  sv();
  if (_isEditor()) {
    // Default to boardroom — most clicks come from there via goToAllCouples()
    if (!_editorPrevView) _editorPrevView = 'boardroom';
    _setupCoupleDOM(coupleId);
    setTimeout(() => { openEvModal(instId); }, 120);
    return;
  }
  document.getElementById('dashView').style.display = 'none';
  document.getElementById('editorView').style.display=''; setPageLabel('Production Office');
  renderCoupleCard();
  renderMain();
  renderCoupleSummary(); renderCoupleTimeline();
  _applyRoleVisibility();
  // Open the event modal after DOM has rendered
  setTimeout(() => { openEvModal(instId); }, 100);
}

// Helper: set up couple page DOM (hidden behind modal) so event modal can grab content
function _setupCoupleDOM(coupleId) {
  cur = coupleId;
  // Pre-show overlay immediately to prevent couple page flash for editors
  if (_isEditor()) {
    var ov = document.getElementById('evModalOverlay');
    if (ov) ov.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
  document.getElementById('dashView').style.display = 'none';
  document.getElementById('editorView').style.display = ''; setPageLabel('Production Office');
  renderCoupleCard();
  renderMain();
  renderCoupleSummary(); renderCoupleTimeline();
  _applyRoleVisibility();
}

// Helper: detect which view is currently active
function _getCurrentView() {
  var cdv = document.getElementById('companyDashView');
  if (cdv && cdv.style.display !== 'none') return 'boardroom';
  var er = document.getElementById('editingRoomView');
  if (er && er.style.display !== 'none' && er.style.display !== '') return 'editingRoom';
  var dv = document.getElementById('dashView');
  if (dv && dv.style.display !== 'none') return 'clientLounge';
  return 'boardroom';
}

function goToDashboard() {
  var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
  cur = null;
  document.getElementById('editorView').style.display = 'none';
  if (activeCompany) {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('companyDashView').style.display=''; var _gh2=document.getElementById('globalHeader');if(_gh2)_gh2.style.display=''; setPageLabel('Boardroom');
    renderDashPanels('coDashPanels','coDashBanner');
    _applyRoleVisibility();
  } else {
    document.getElementById('dashView').style.display=''; setPageLabel('Client Lounge');
    renderDashboard();
    _applyRoleVisibility();
  }
  _saveSession();
}

// ── COUNTDOWN HELPERS ────────────────────────────────
function getDaysLeft(c) {
  if (!c.eventDate) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const event = new Date(c.eventDate + 'T00:00:00');
  return Math.round((event - today) / 86400000);
}
function countdownUrgency(days) {
  if (days === null) return 'none';
  if (days < 0)   return 'overdue';
  if (days <= 7)  return 'critical';
  if (days <= 14) return 'urgent';
  if (days <= 30) return 'soon';
  return 'ok';
}
function countdownLabel(days, isComplete) {
  if (isComplete) return '✓ Complete';
  if (days === null) return 'No date set';
  if (days < 0)  return `${Math.abs(days)}d overdue`;
  if (days === 0) return 'Today!';
  if (days === 1) return 'Tomorrow!';
  return `${days} days left`;
}
function fmtEventDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
}
// SVG ring: r=17, C≈106.8. pct = how much of 90d window has elapsed (0=just added, 1=day of event)
function buildRing(days, urgency, isComplete) {
  const C = 106.8;
  const strokeMap = { ok:'#4a7a55', soon:'#b48c28', urgent:'#c85014', critical:'#c81e1e', overdue:'#8b0000', none:'var(--gold-lt)', complete:'#4a7a55' };
  const stroke = strokeMap[isComplete ? 'complete' : urgency] || 'var(--gold-lt)';
  let pct = 0;
  if (isComplete) { pct = 1; }
  else if (days !== null && days <= 90) { pct = Math.max(0, Math.min(1, (90 - days) / 90)); }
  else if (days !== null && days > 90) { pct = 0; }
  const offset = (C - pct * C).toFixed(1);
  const dText  = isComplete ? '✓' : (days === null ? '—' : days < 0 ? '!' : days > 999 ? '99+' : String(days));
  const lText  = isComplete ? 'done' : (days === null ? 'set' : 'days');
  const fsize  = dText.length > 2 ? '.52rem' : '.65rem';
  return `<div class="cd-ring-wrap">
    <svg class="cd-ring-svg" width="42" height="42" viewBox="0 0 42 42">
      <circle class="cd-ring-track" cx="21" cy="21" r="17"/>
      <circle class="cd-ring-fill" cx="21" cy="21" r="17" stroke="${stroke}" stroke-dasharray="${C}" stroke-dashoffset="${offset}"/>
    </svg>
    <div class="cd-ring-text">
      <span class="cd-ring-days" style="font-size:${fsize};color:${stroke};">${dText}</span>
      <span class="cd-ring-lbl">${lText}</span>
    </div>
  </div>`;
}

// ── DASHBOARD ────────────────────────────────────────
function renderDashboard() {
  const el = document.getElementById('dashGrid'); if (!el) return;
  // Panels and overview are on the company dashboard — not repeated here
  const fyVal = document.getElementById('filterYear')?.value || '';
  const fmVal = document.getElementById('filterMonth')?.value || '';
  const ftVal = document.getElementById('filterType')?.value || '';
  const csVal = (document.getElementById('clientSearch')?.value || '').trim().toLowerCase();

  let filtered = [...couples];
  // Editor role: only show couples they're assigned to
  if (_isEditor()) {
    const myCoupleIds = _editorCoupleIds();
    if (myCoupleIds) filtered = filtered.filter(c => myCoupleIds.has(c.id));
  }
  if (csVal) filtered = filtered.filter(c => {
    const name = (c.name||'').toLowerCase();
    const client = insts.filter(i=>i.coupleId===c.id).map(i=>(i.client||'').toLowerCase()).join(' ');
    return name.includes(csVal) || client.includes(csVal);
  });
  if (fyVal) filtered = filtered.filter(c => c.year == fyVal);
  if (fmVal) filtered = filtered.filter(c => c.month == fmVal);
  if (ftVal) filtered = filtered.filter(c => (c.weddingTypes||[]).includes(ftVal));
  // Editor filter: show couple if any inst or couple.editors includes the filter
  if (editorFilter) {
    filtered = filtered.filter(c => {
      const coupleEdMatch = (c.editors||[]).some(e=>e.trim()===editorFilter);
      const instEdMatch   = insts.filter(i=>i.coupleId===c.id).some(i=>(i.editor||'').trim()===editorFilter);
      const hasNoEditor   = insts.filter(i=>i.coupleId===c.id).every(i=>!(i.editor||'').trim());
      return coupleEdMatch || instEdMatch || hasNoEditor;
    });
  }
  // Shooter filter
  if (shooterFilter) {
    filtered = filtered.filter(c =>
      insts.filter(i=>i.coupleId===c.id).some(i=>(i.shooter||'').trim()===shooterFilter)
    );
  }

  if (!filtered.length) {
    el.innerHTML = `<div class="dash-empty">
      <div class="icon">♪</div>
      <h2>${couples.length ? 'No couples match your filters' : 'No couples yet'}</h2>
      <p>${couples.length ? 'Try adjusting the year, month or type filters above.' : 'Add your first couple to get started building their music plan.'}</p>
    </div>`;
    return;
  }
  const byY = {};
  filtered.forEach(c => {
    if (!byY[c.year]) byY[c.year] = {};
    if (!byY[c.year][c.month]) byY[c.year][c.month] = [];
    byY[c.year][c.month].push(c);
  });
  const years = Object.keys(byY).map(Number).sort((a,b)=>b-a);

  if (dashViewMode === 'compact') {
    const allSorted = filtered.sort((a,b)=> a.year!==b.year ? b.year-a.year : a.month!==b.month ? a.month-b.month : a.name.localeCompare(b.name));
    el.innerHTML = years.map(y => {
      const mc = allSorted.filter(c=>c.year===y);
      return `<div class="dash-year-group">
        <div class="dash-year-head">
          <span class="dash-year-label">${y}</span>
          <span class="dash-year-line"></span>
          <span class="dash-year-count">${mc.length} couple${mc.length!==1?'s':''}</span>
        </div>
        <div class="couple-compact">${mc.map(c=>renderCoupleCompactHTML(c)).join('')}</div>
      </div>`;
    }).join('');
    return;
  }
  el.innerHTML = years.map(y => {
    const allInYear = Object.values(byY[y]).flat();
    const months = Object.keys(byY[y]).map(Number).sort((a,b)=>a-b);
    const monthsHtml = months.map(m => {
      const mc = byY[y][m].sort((a,b)=>a.name.localeCompare(b.name));
      if (dashViewMode === 'list') {
        return `<div class="dash-month-group">
          <div class="dash-month-label">${MO[m]}</div>
          <div class="couple-list">${mc.map(c=>renderCoupleListHTML(c)).join('')}</div>
        </div>`;
      }
      return `<div class="dash-month-group">
        <div class="dash-month-label">${MO[m]}</div>
        <div class="couple-cards">${mc.map(c=>renderCoupleCardHTML(c)).join('')}</div>
      </div>`;
    }).join('');
    return `<div class="dash-year-group">
      <div class="dash-year-head">
        <span class="dash-year-label">${y}</span>
        <span class="dash-year-line"></span>
        <span class="dash-year-count">${allInYear.length} couple${allInYear.length!==1?'s':''}</span>
      </div>
      ${monthsHtml}
    </div>`;
  }).join('');
}

function _isInstShootDone(i) {
  const hasPhoto = !!(i.servicePhoto || i.services==='photo' || i.services==='both');
  const hasVideo = !!(i.serviceVideo || i.services==='video' || i.services==='both');
  if (hasPhoto && hasVideo) return !!(i.photoShootApproved && i.videoShootApproved);
  if (hasPhoto) return !!i.photoShootApproved;
  if (hasVideo) return !!i.videoShootApproved;
  return !!i.shootApproved; // fallback for events with no service selected
}

function _coupleStats(c) {
  let ci = insts.filter(i=>i.coupleId===c.id);
  // Editor role: only count events they're assigned to
  if (_isEditor()) {
    var _myIds = _editorInstIds();
    if (_myIds) ci = ci.filter(function(i){ return _myIds.has(i.id); });
  }
  const totalSongs      = songs.filter(s=>s.coupleId===c.id).length;
  const usedSongs       = songs.filter(s=>s.coupleId===c.id&&s.used).length;
  const evCount         = ci.length;
  const approvedCount   = ci.filter(i=>i.approved).length;
  const shootDoneCount  = ci.filter(i=>_isInstShootDone(i)).length;
  const isEditComplete  = evCount > 0 && approvedCount === evCount;
  const isShootComplete = evCount > 0 && shootDoneCount === evCount;
  const isComplete      = isEditComplete && isShootComplete;
  return { totalSongs, usedSongs, evCount, approvedCount, shootDoneCount, isEditComplete, isShootComplete, isComplete };
}
function _typeTags(c, cls) {
  return (c.weddingTypes||[]).map(wt=>{
    const w=WEDDING_TYPES.find(x=>x.id===wt); if(!w) return '';
    return `<span class="${cls||'cc-type-tag'}" style="background:${w.color};border:1px solid ${w.border};color:${w.text};">${w.icon} ${w.label}</span>`;
  }).join('');
}

function renderCoupleCardHTML(c) {
  const {totalSongs, evCount, approvedCount, shootDoneCount, isEditComplete, isShootComplete, isComplete} = _coupleStats(c);
  const typeTags = _typeTags(c, 'cc-type-tag');
  const days    = getDaysLeft(c);
  const urgency = isComplete ? 'complete' : countdownUrgency(days);
  const cdClass = isComplete ? 'cd-ok' : `cd-${urgency}`;
  const ring    = buildRing(days, urgency, isComplete);
  const cdLabel = countdownLabel(days, isComplete);
  const editPct  = evCount > 0 ? Math.round(approvedCount/evCount*100)  : 0;
  const shootPct = evCount > 0 ? Math.round(shootDoneCount/evCount*100) : 0;
  const approvedBar = evCount > 0
    ? `<div class="cc-dual-progress">
        <div class="cc-prog-row">
          <span class="cc-prog-icon">✂️</span>
          <div class="cc-prog-bar"><div class="cc-prog-fill-edit"  style="width:${editPct}%"></div></div>
          <span class="cc-prog-pct">${editPct}%</span>
        </div>
        <div class="cc-prog-row">
          <span class="cc-prog-icon">📷</span>
          <div class="cc-prog-bar"><div class="cc-prog-fill-shoot" style="width:${shootPct}%"></div></div>
          <span class="cc-prog-pct">${shootPct}%</span>
        </div>
      </div>`
    : '';
  const editorsHtml = (c.editors||[]).length
    ? `<div class="cc-editors">${(c.editors||[]).map(e=>`<span class="cc-editor-chip"><span class="cc-editor-pic">${_userAvatar(e)}</span> ${esc(e)}</span>`).join('')}</div>`
    : '';
  const completedLine = `${isEditComplete && c.editCompletedAt ? `<div class="cc-complete-date" style="color:var(--forest);">✂️ Edits done ${esc(c.editCompletedAt)}</div>` : ''}${isShootComplete && c.shootCompletedAt ? `<div class="cc-complete-date" style="color:#2563eb;">📷 Shoots done ${esc(c.shootCompletedAt)}</div>` : ''}${isComplete && c.completedAt ? `<div class="cc-complete-date">🎉 Fully complete ${esc(c.completedAt)}</div>` : ''}`;
  const completeBanner = isComplete
    ? `<div class="cc-complete-banner"><span class="cc-complete-banner-icon">✓</span>Project Complete</div>`
    : '';
  return `<div class="couple-card${isComplete?' is-complete':''}" onclick="selectCouple('${c.id}')">
    <div class="cc-top">
      <div style="flex:1;min-width:0;">
        <div class="cc-name">${esc(c.name)}</div>
        ${!isComplete ? (isEditComplete ? '<span class="cc-complete-stamp" style="background:rgba(74,122,85,.08);border-color:rgba(74,122,85,.25);color:#4a7a55;">✂️ Edits Done</span>' : (isShootComplete ? '<span class="cc-complete-stamp" style="background:rgba(37,99,235,.07);border-color:rgba(37,99,235,.2);color:#2563eb;">📷 Shoots Done</span>' : '')) : ''}
        ${completedLine}
      </div>
      <div style="display:flex;gap:.3rem;flex-shrink:0;align-items:flex-start;">
        ${_isAdmin() ? `<button class="cc-del" onclick="event.stopPropagation();openEditCouple('${c.id}')" title="Edit" style="opacity:0;">✏️</button>
        <button class="cc-del" onclick="delCouple('${c.id}',event)" title="Remove">✕</button>` : ''}
      </div>
    </div>
    <div class="cc-date">${MO[c.month]} ${c.year}</div>
    ${typeTags ? `<div class="cc-types">${typeTags}</div>` : ''}
    ${editorsHtml}
    ${approvedBar}
    ${completeBanner}
    <div class="cc-stats">
      <div class="cc-stat"><span class="cc-stat-n">${evCount}</span><span class="cc-stat-l">Events</span></div>
      <div class="cc-stat"><span class="cc-stat-n">${approvedCount}</span><span class="cc-stat-l">Approved</span></div>
      <div class="cc-stat"><span class="cc-stat-n">${totalSongs}</span><span class="cc-stat-l">Songs</span></div>
    </div>
    <div class="cc-cd-row">
      ${ring}
      <div class="cc-cd-info">
        <div class="cc-cd-label ${cdClass}" style="font-size:.6rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;margin-bottom:.1rem;">${cdLabel}</div>
        <div class="cc-cd-date">${c.eventDate ? fmtEventDate(c.eventDate) : '<span style="color:var(--gold);font-size:.6rem;">+ Add event date</span>'}</div>
      </div>
    </div>
    <span class="cc-edit-hint">Open Plan →</span>
  </div>`;
}

function renderCoupleListHTML(c) {
  const {totalSongs, evCount, approvedCount, shootDoneCount, isEditComplete, isShootComplete, isComplete} = _coupleStats(c);
  const typeTags = _typeTags(c, 'cc-type-tag');
  const days    = getDaysLeft(c);
  const urgency = isComplete ? 'complete' : countdownUrgency(days);
  const cdClass = isComplete ? 'cd-ok' : `cd-${urgency}`;
  const cdLabel = countdownLabel(days, isComplete);
  const completedLine2 = `${isEditComplete?'✂️ ':' '}${isShootComplete?'📷 ':''}${isComplete && c.completedAt ? '🎉 '+esc(c.completedAt) : ''}`;
  return `<div class="couple-list-row${isComplete?' is-complete':''}" onclick="selectCouple('${c.id}')">
    <div class="clr-name">${esc(c.name)}${isComplete?'&nbsp;<span class="cc-complete-stamp" style="font-size:.54rem;padding:.15rem .45rem;">✓</span>':''}${completedLine2}</div>
    <div class="clr-date">${MO[c.month]} ${c.year}</div>
    ${typeTags ? `<div class="clr-types">${typeTags}</div>` : '<div></div>'}
    <div class="clr-stats">
      <div class="clr-stat"><span class="clr-stat-n">${evCount}</span><span class="clr-stat-l">Ev</span></div>
      <div class="clr-stat"><span class="clr-stat-n">${approvedCount}</span><span class="clr-stat-l">✂️</span></div>
      <div class="clr-stat"><span class="clr-stat-n">${shootDoneCount}</span><span class="clr-stat-l">📷</span></div>
      <div class="clr-stat"><span class="clr-stat-n">${totalSongs}</span><span class="clr-stat-l">Songs</span></div>
    </div>
    <span class="cd-badge ${cdClass} clr-cd">${cdLabel}</span>
    <div class="clr-actions">
      ${_isAdmin() ? `<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openEditCouple('${c.id}')">✏️</button>
      <button class="btn btn-outline btn-sm" onclick="delCouple('${c.id}',event)">✕</button>` : ''}
    </div>
  </div>`;
}

function renderCoupleCompactHTML(c) {
  const {totalSongs, evCount, approvedCount, shootDoneCount, isEditComplete, isShootComplete, isComplete} = _coupleStats(c);
  const days    = getDaysLeft(c);
  const urgency = isComplete ? 'complete' : countdownUrgency(days);
  const cdClass = isComplete ? 'cd-ok' : `cd-${urgency}`;
  const cdLabel = countdownLabel(days, isComplete);
  const dotColor = isComplete ? 'var(--forest)' : urgency==='critical'||urgency==='overdue' ? '#c81e1e' : urgency==='urgent' ? '#c85014' : urgency==='soon' ? '#b48c28' : 'var(--rule2)';
  return `<div class="couple-compact-row${isComplete?' is-complete':''}" onclick="selectCouple('${c.id}')">
    <div class="ccr-dot" style="background:${dotColor};${isComplete?'box-shadow:0 0 0 3px rgba(45,74,62,.15);':''}"></div>
    <div class="ccr-name">${esc(c.name)}</div>
    <div class="ccr-date">${MO[c.month]} ${c.year}</div>
    <div class="ccr-ev">${evCount} ev · ${totalSongs} songs</div>
    <span class="cd-badge ${cdClass} ccr-cd" style="font-size:.54rem;padding:.16rem .45rem;">${cdLabel}</span>
    <div class="ccr-actions">
      ${_isAdmin() ? `<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openEditCouple('${c.id}')">✏️</button>
      <button class="btn btn-outline btn-sm" onclick="delCouple('${c.id}',event)">✕</button>` : ''}
    </div>
  </div>`;
}


function patchSummaryEvent(iid) {
  const card = document.getElementById('cse-event-' + iid);
  if (!card) return;
  const inst = insts.find(i=>i.id===iid); if (!inst) return;

  // ── Patch badges row ──────────────────────────────────
  const showPhotoSvc = !!(inst.servicePhoto||inst.services==='photo'||inst.services==='both');
  const showVideoSvc = !!(inst.serviceVideo||inst.services==='video'||inst.services==='both');
  const pcc = inst.photoChangesCount || 0;
  const vcc = inst.videoChangesCount || 0;
  const badges = {
    photochanges: inst.photoChangesNeeded && !inst.photoEditApproved
      ? `<div class="cse-photo-changes-badge">✂️📷🔄${pcc > 1 ? ' ×'+pcc : ''} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearPhotoChanges('${inst.id}')" title="Mark resolved">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoPhotoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></div>`
      : '',
    videochanges: inst.videoChangesNeeded && !inst.videoEditApproved
      ? `<div class="cse-video-changes-badge">✂️🎥🔄${vcc > 1 ? ' ×'+vcc : ''} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearVideoChanges('${inst.id}')" title="Mark resolved">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoVideoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></div>`
      : '',
    generalchanges: (inst.changesNeeded || inst.editorStatus === 'changes') && !inst.approved && !inst.photoChangesNeeded && !inst.videoChangesNeeded
      ? `<div class="cse-changes-badge" onclick="event.stopPropagation();clearChangesFlag('${inst.id}')" title="Click to remove" style="cursor:pointer;">🔄 Changes ✕</div>`
      : '',
    photoedit: inst.photoEditApproved ? `<div class="cse-photo-edit-badge">✂️📷 Photo Edited</div>` : '',
    videoedit: inst.videoEditApproved ? `<div class="cse-video-edit-badge">✂️🎥 Video Edited</div>` : '',
    editdone: inst.approved && !inst.servicePhoto && !inst.serviceVideo ? `<div class="cse-edit-done">✂️ Edit Done</div>` : '',
    photoshoot: inst.photoShootApproved && showPhotoSvc ? `<div class="cse-shoot-done">📷 Photo Shot</div>` : '',
    videoshoot: inst.videoShootApproved && showVideoSvc ? `<div class="cse-shoot-done cse-video-shoot-badge">🎥 Video Shot</div>` : '',
    shootdone: !showPhotoSvc && !showVideoSvc && inst.shootApproved ? `<div class="cse-shoot-done">📷 Shoot Done</div>` : '',
    paused: inst.editPaused ? `<div class="cse-pause-badge">⏸ Paused</div>` : '',
    upcoming: inst.editUpcoming ? `<div class="cse-pause-badge" style="background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.2);color:#1d4ed8;">🔜 Upcoming</div>` : '',
  };
  const allBadgesHtml = Object.values(badges).join('');
  let badgesRow = card.querySelector('.cse-badges-row');
  if (allBadgesHtml) {
    if (!badgesRow) {
      badgesRow = document.createElement('div');
      badgesRow.className = 'cse-badges-row';
      card.insertBefore(badgesRow, card.firstChild);
    }
    badgesRow.innerHTML = allBadgesHtml;
  } else {
    if (badgesRow) { badgesRow.classList.add('cse-row-exit'); setTimeout(()=>badgesRow.remove(), 200); }
  }

  function setRow(icon, newHtml, dataKey) {
    const existing = card.querySelector('[data-cse="' + dataKey + '"]');
    if (!newHtml) { if (existing) { existing.classList.add('cse-row-exit'); setTimeout(()=>existing.remove(), 200); } return; }
    if (existing) {
      const val = existing.querySelector('.cse-val');
      if (val && val.innerHTML === newHtml) return;
      if (val) {
        val.classList.remove('cse-row-pop');
        void val.offsetWidth;
        val.classList.add('cse-row-pop');
        val.innerHTML = newHtml;
      }
    } else {
      const row = document.createElement('div');
      row.className = 'cse-row cse-row-enter';
      row.dataset.cse = dataKey;
      row.innerHTML = `<span class="cse-icon">${icon}</span><span class="cse-val">${newHtml}</span>`;
      card.appendChild(row);
      void row.offsetWidth;
      row.classList.add('cse-row-entered');
    }
  }

  // Compute all values in display order
  const nameEl = card.querySelector('.cse-name');
  if (nameEl && nameEl.textContent !== (inst.eventType||'Event')) {
    nameEl.classList.remove('cse-row-pop'); void nameEl.offsetWidth;
    nameEl.classList.add('cse-row-pop');
    nameEl.textContent = inst.eventType || 'Event';
  }

  const loc  = inst.locationName || '';
  const addr = inst.locationAddress || '';
  const locVal = loc ? esc(loc) + (addr ? `<div class="cse-address">${esc(addr)}</div>` : '')
    : addr ? `<div class="cse-address">${esc(addr)}</div>` : '';

  let dateVal = '';
  if (inst.shootDay) {
    const d = new Date(inst.shootDay + 'T00:00:00');
    dateVal = d.toLocaleDateString('en-CA', { weekday:'short', year:'numeric', month:'short', day:'numeric' });
  }
  const timeStr = inst.timeFrom && inst.timeTo ? `${inst.timeFrom} – ${inst.timeTo}` : inst.timeFrom || inst.timeTo || '';

  const shooterParts = [];
  if (inst.shooter && inst.shooter.trim() && inst.shooter !== 'N/A') shooterParts.push(_userAvatarMini(inst.shooter)+esc(inst.shooter));
  if (showPhotoSvc) (inst.photographers||[]).forEach((n,i) => {
    if (n&&n.trim()&&n!=='N/A') {
      const cams = (inst.photographerCameras||[])[i];
      const camBadge = cams && cams > 1 ? ` <span class="cse-role">${cams}🎬</span>` : '';
      shooterParts.push(_userAvatarMini(n)+esc(n)+' <span class="cse-role">Photo</span>'+camBadge);
    }
  });
  if (showVideoSvc) (inst.videographers||[]).forEach((n,i) => {
    if (n&&n.trim()&&n!=='N/A') {
      const cams = (inst.videographerCameras||[])[i];
      const camBadge = cams && cams > 1 ? ` <span class="cse-role">${cams}🎬</span>` : '';
      shooterParts.push(_userAvatarMini(n)+esc(n)+' <span class="cse-role">Video</span>'+camBadge);
    }
  });

  const audioParts = [];
  if (showVideoSvc) {
    if ((inst.audioSource||[]).length)    audioParts.push('🔊 Source ×' + inst.audioSource.length);
    if ((inst.audioLav||[]).length)       audioParts.push('🎤 Lav ×' + inst.audioLav.length);
    if ((inst.audioInterview||[]).length) audioParts.push('🎬 Interviews ×' + inst.audioInterview.length);
  }

  const editorParts = [];
  if (showPhotoSvc && inst.photoEditor) editorParts.push(_userAvatarMini(inst.photoEditor)+esc(inst.photoEditor) + ' <span class="cse-role">Photo</span>');
  if (showVideoSvc && inst.videoEditor) editorParts.push(_userAvatarMini(inst.videoEditor)+esc(inst.videoEditor) + ' <span class="cse-role">Video</span>');
  if (!editorParts.length && (showPhotoSvc || showVideoSvc) && inst.editor) editorParts.push(_userAvatarMini(inst.editor)+esc(inst.editor));

  const driveParts = [];
  if (showPhotoSvc && inst.photoEditingDrive) driveParts.push('📷 ' + esc(inst.photoEditingDrive));
  if (showVideoSvc && inst.videoEditingDrive) driveParts.push('🎥 ' + esc(inst.videoEditingDrive));
  if (!driveParts.length && inst.editingDrive) driveParts.push(esc(inst.editingDrive));

  // Ordered row definitions: [dataKey, icon, html|'', sectionHeader|null]
  const rowDefs = [
    ['who',      '👤', inst.client ? esc(inst.client) : '',     null],
    ['location', '📍', locVal,                                  null],
    ['parking',  '🅿️', inst.parkingLocation ? esc(inst.parkingLocation) : '', null],
    ['date',     '📅', dateVal ? esc(dateVal) : '',             null],
    ['time',     '⏱',  timeStr ? esc(timeStr) : '',             null],
    ['_sec_prod', null, null,                                   'Production'],
    ['shooters', '📷', shooterParts.length ? shooterParts.join('<br>') : '', null],
    ['audio',    '🎙', audioParts.length ? audioParts.join(' · ') : '', null],
    ['_sec_post', null, null,                                   'Post Production'],
    ['editors',  '✂️', editorParts.length ? editorParts.join('<br>') : '', null],
    ['drives',   '💽', driveParts.length ? driveParts.join('<br>') : '', null],
  ];

  // Build ordered anchor list after .cse-name
  let anchor = nameEl; // insert after this node
  rowDefs.forEach(function([key, icon, html, sectionHeader]) {
    // Section header row
    if (sectionHeader !== undefined && sectionHeader !== null) {
      let secEl = card.querySelector('[data-cse="' + key + '"]');
      // Determine if section has any content (next data rows)
      const secIdx = rowDefs.findIndex(r => r[0] === key);
      const hasContent = rowDefs.slice(secIdx+1).some(r => r[3] === null && r[2]);
      if (!hasContent) {
        if (secEl) { secEl.classList.add('cse-row-exit'); setTimeout(()=>secEl.remove(), 200); }
        anchor = anchor; // keep anchor unchanged
        return;
      }
      if (!secEl) {
        secEl = document.createElement('div');
        secEl.className = 'cse-section-header';
        secEl.dataset.cse = key;
        secEl.textContent = sectionHeader;
        card.insertBefore(secEl, anchor.nextSibling);
        void secEl.offsetWidth;
        secEl.classList.add('cse-row-entered');
      } else if (anchor.nextSibling !== secEl) {
        card.insertBefore(secEl, anchor.nextSibling);
      }
      anchor = secEl;
      return;
    }
    let existing = card.querySelector('[data-cse="' + key + '"]');
    if (!html) {
      if (existing) { existing.classList.add('cse-row-exit'); setTimeout(()=>existing.remove(), 200); }
      return;
    }
    if (existing) {
      const val = existing.querySelector('.cse-val');
      if (val && val.innerHTML !== html) {
        val.classList.remove('cse-row-pop'); void val.offsetWidth;
        val.classList.add('cse-row-pop');
        val.innerHTML = html;
      }
      if (anchor.nextSibling !== existing) {
        card.insertBefore(existing, anchor.nextSibling);
      }
      anchor = existing;
    } else {
      const row = document.createElement('div');
      row.className = 'cse-row cse-row-enter';
      row.dataset.cse = key;
      row.innerHTML = `<span class="cse-icon">${icon}</span><span class="cse-val">${html}</span>`;
      card.insertBefore(row, anchor.nextSibling);
      void row.offsetWidth;
      row.classList.add('cse-row-entered');
      anchor = row;
    }
  });
}

function renderCoupleSummary() {
  const el = document.getElementById('coupleSummary'); if (!el) return;
  const co = couples.find(x=>x.id===cur); if (!co) { el.innerHTML=''; return; }
  let ci = insts.filter(i=>i.coupleId===co.id);
  // Editor role: only show events they're assigned to
  if (_isEditor()) {
    const _myIds = _editorInstIds();
    if (_myIds) ci = ci.filter(i => _myIds.has(i.id));
  }
  if (!ci.length) { el.innerHTML=''; return; }

  // Sort by shootDay date, events without date go to end
  const sorted = [...ci].sort((a,b) => {
    if (!a.shootDay && !b.shootDay) return 0;
    if (!a.shootDay) return 1;
    if (!b.shootDay) return -1;
    return new Date(a.shootDay) - new Date(b.shootDay);
  });

  const rows = sorted.map(inst => {
    // Date
    let dateHtml = '';
    if (inst.shootDay) {
      const d = new Date(inst.shootDay + 'T00:00:00');
      const dateStr = d.toLocaleDateString('en-CA', { weekday:'short', year:'numeric', month:'short', day:'numeric' });
      dateHtml = `<div class="cse-row" data-cse="date"><span class="cse-icon">📅</span><span class="cse-val">${esc(dateStr)}</span></div>`;
    }

    // Who's event
    const who = inst.client ? `<div class="cse-row" data-cse="who"><span class="cse-icon">👤</span><span class="cse-val">${esc(inst.client)}</span></div>` : '';

    // Time
    const timeStr = inst.timeFrom && inst.timeTo
      ? `${inst.timeFrom} – ${inst.timeTo}`
      : inst.timeFrom || inst.timeTo || '';
    const time = timeStr ? `<div class="cse-row" data-cse="time"><span class="cse-icon">⏱</span><span class="cse-val">${esc(timeStr)}</span></div>` : '';

    // Shooters — labelled by role
    const shooterParts = [];
    // Legacy shooter field (no specific role)
    if (inst.shooter && inst.shooter.trim() && inst.shooter !== 'N/A') {
      shooterParts.push(_userAvatarMini(inst.shooter)+esc(inst.shooter));
    }
    // Photographers — only if photo service active
    const showPhotoSvc2 = !!(inst.servicePhoto||inst.services==='photo'||inst.services==='both');
    const showVideoSvc2 = !!(inst.serviceVideo||inst.services==='video'||inst.services==='both');
    if (showPhotoSvc2) (inst.photographers||[]).forEach((n,i) => {
      if (n && n.trim() && n !== 'N/A') {
        const already = shooterParts.some(p => p.includes(esc(n)));
        if (!already) {
          const cams = (inst.photographerCameras||[])[i];
          const camBadge = cams && cams > 1 ? ` <span class="cse-role">${cams}🎬</span>` : '';
          shooterParts.push(_userAvatarMini(n)+esc(n) + ' <span class="cse-role">Photo</span>' + camBadge);
        }
      }
    });
    // Videographers — only if video service active
    if (showVideoSvc2) (inst.videographers||[]).forEach((n,i) => {
      if (n && n.trim() && n !== 'N/A') {
        const already = shooterParts.some(p => p.includes(esc(n)));
        if (!already) {
          const cams = (inst.videographerCameras||[])[i];
          const camBadge = cams && cams > 1 ? ` <span class="cse-role">${cams}🎬</span>` : '';
          shooterParts.push(_userAvatarMini(n)+esc(n) + ' <span class="cse-role">Video</span>' + camBadge);
        }
      }
    });
    const shooterHtml = shooterParts.length
      ? `<div class="cse-row" data-cse="shooters"><span class="cse-icon">📷</span><span class="cse-val">${shooterParts.join('<br>')}</span></div>`
      : '';

    const audioParts = [];
    if (showVideoSvc2) {
      if ((inst.audioSource||[]).length)    audioParts.push('🔊 Source ×' + inst.audioSource.length);
      if ((inst.audioLav||[]).length)       audioParts.push('🎤 Lav ×' + inst.audioLav.length);
      if ((inst.audioInterview||[]).length) audioParts.push('🎬 Interviews ×' + inst.audioInterview.length);
    }
    const audioHtml = audioParts.length
      ? `<div class="cse-row" data-cse="audio"><span class="cse-icon">🎙</span><span class="cse-val">${audioParts.join(' · ')}</span></div>`
      : '';

    // Location
    const loc = inst.locationName || '';
    const addr = inst.locationAddress || '';
    const locationHtml = loc
      ? `<div class="cse-row" data-cse="location"><span class="cse-icon">📍</span><span class="cse-val">${esc(loc)}${addr ? `<div class="cse-address">${esc(addr)}</div>` : ''}</span></div>`
      : (addr ? `<div class="cse-row" data-cse="location"><span class="cse-icon">📍</span><span class="cse-val"><div class="cse-address">${esc(addr)}</div></span></div>` : '');

    // Parking
    const parkingHtml = inst.parkingLocation
      ? `<div class="cse-row" data-cse="parking"><span class="cse-icon">🅿️</span><span class="cse-val">${esc(inst.parkingLocation)}</span></div>`
      : '';

    // Editors — filtered by active services
    const editorParts = [];
    if (showPhotoSvc2 && inst.photoEditor) editorParts.push(_userAvatarMini(inst.photoEditor)+esc(inst.photoEditor) + ' <span class="cse-role">Photo</span>');
    if (showVideoSvc2 && inst.videoEditor) editorParts.push(_userAvatarMini(inst.videoEditor)+esc(inst.videoEditor) + ' <span class="cse-role">Video</span>');
    if (!editorParts.length && (showPhotoSvc2 || showVideoSvc2) && inst.editor) editorParts.push(_userAvatarMini(inst.editor)+esc(inst.editor));
    const editorsHtml = editorParts.length
      ? `<div class="cse-row" data-cse="editors"><span class="cse-icon">✂️</span><span class="cse-val">${editorParts.join('<br>')}</span></div>`
      : '';

    // Drives — filtered by active services
    const driveParts = [];
    if (showPhotoSvc2 && inst.photoEditingDrive) driveParts.push('📷 ' + esc(inst.photoEditingDrive));
    if (showVideoSvc2 && inst.videoEditingDrive) driveParts.push('🎥 ' + esc(inst.videoEditingDrive));
    if (!driveParts.length && inst.editingDrive) driveParts.push(esc(inst.editingDrive));
    const drivesHtml = driveParts.length
      ? `<div class="cse-row" data-cse="drives"><span class="cse-icon">💽</span><span class="cse-val">${driveParts.join('<br>')}</span></div>`
      : '';

    // Changes note
    const changesNoteHtml = inst.changesNote
      ? `<div class="cse-row" data-cse="changesnote"><span class="cse-icon">🔄</span><span class="cse-val">${esc(inst.changesNote)}</span></div>`
      : '';

    const showPhotoSvc = !!(inst.servicePhoto||inst.services==='photo'||inst.services==='both');
    const showVideoSvc = !!(inst.serviceVideo||inst.services==='video'||inst.services==='both');
    const photoShootBadge = inst.photoShootApproved && showPhotoSvc
      ? `<div class="cse-shoot-done" id="cse-shoot-${inst.id}">📷 Photo Shot</div>` : '';
    const videoShootBadge = inst.videoShootApproved && showVideoSvc
      ? `<div class="cse-shoot-done cse-video-shoot-badge">🎥 Video Shot</div>` : '';
    const shootDoneBadge = !showPhotoSvc && !showVideoSvc && inst.shootApproved
      ? `<div class="cse-shoot-done" id="cse-shoot-${inst.id}">📷 Shoot Done</div>` : '';
    const editDoneBadge = inst.approved && !inst.servicePhoto && !inst.serviceVideo
      ? `<div class="cse-edit-done" id="cse-edit-${inst.id}">✂️ Edit Done</div>`
      : '';
    const photoEditBadge = inst.photoEditApproved
      ? `<div class="cse-photo-edit-badge" id="cse-edit-${inst.id}">✂️📷 Photo Edited</div>`
      : '';
    const videoEditBadge = inst.videoEditApproved
      ? `<div class="cse-video-edit-badge">✂️🎥 Video Edited</div>`
      : '';
    const pcc = inst.photoChangesCount || 0;
    const vcc = inst.videoChangesCount || 0;
    // Unified changes badge — one badge per change type
    const photoChangesBadge = inst.photoChangesNeeded && !inst.photoEditApproved
      ? `<div class="cse-photo-changes-badge">✂️📷🔄${pcc > 1 ? ' ×'+pcc : ''} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearPhotoChanges('${inst.id}')" title="Mark resolved">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoPhotoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></div>`
      : '';
    const videoChangesBadge = inst.videoChangesNeeded && !inst.videoEditApproved
      ? `<div class="cse-video-changes-badge">✂️🎥🔄${vcc > 1 ? ' ×'+vcc : ''} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearVideoChanges('${inst.id}')" title="Mark resolved">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoVideoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></div>`
      : '';
    const generalChangesBadge = (inst.changesNeeded || inst.editorStatus === 'changes') && !inst.approved && !inst.photoChangesNeeded && !inst.videoChangesNeeded
      ? `<div class="cse-changes-badge" onclick="event.stopPropagation();clearChangesFlag('${inst.id}')" title="Click to remove" style="cursor:pointer;">🔄 Changes ✕</div>`
      : '';
    const changesBadge = generalChangesBadge;
    const pauseBadge = inst.editPaused
      ? `<div class="cse-pause-badge">⏸ Paused</div>`
      : '';
    const upcomingBadge = inst.editUpcoming
      ? `<div class="cse-pause-badge" style="background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.2);color:#1d4ed8;">🔜 Upcoming</div>`
      : '';

    const hasBadge = changesBadge||generalChangesBadge||photoChangesBadge||videoChangesBadge||editDoneBadge||photoEditBadge||videoEditBadge||photoShootBadge||videoShootBadge||shootDoneBadge||pauseBadge||upcomingBadge;
    const badgesRowHtml = hasBadge
      ? '<div class="cse-badges-row">' + generalChangesBadge + photoChangesBadge + videoChangesBadge + photoEditBadge + videoEditBadge + editDoneBadge + photoShootBadge + videoShootBadge + shootDoneBadge + pauseBadge + upcomingBadge + '</div>'
      : '';

    return `<div class="couple-summary-event" id="cse-event-${inst.id}">
      ${badgesRowHtml}
      <div class="cse-name">${esc(inst.eventType||'Event')}</div>
      ${who}${locationHtml}${parkingHtml}${dateHtml}${time}
      ${shooterHtml||audioHtml ? `<div class="cse-section-header" data-cse="_sec_prod">Production</div>` : ''}
      ${shooterHtml}${audioHtml}
      ${editorsHtml||drivesHtml ? `<div class="cse-section-header" data-cse="_sec_post">Post Production</div>` : ''}
      ${editorsHtml}${drivesHtml}
    </div>`;
  }).join('');

  el.innerHTML = `<div class="couple-summary">
    <div class="couple-summary-head">
      <span class="couple-summary-title">Event Summary</span>
      <span class="couple-summary-count">${sorted.length} event${sorted.length===1?'':'s'}</span>
    </div>
    ${rows}
  </div>`;
}
function renderCoupleCard() {
  const el = document.getElementById('coupleCard'); if (!el) return;
  const c = couples.find(x=>x.id===cur); if (!c) return;
  // Update hero banner
  const heroName = document.getElementById('coupleHeroName');
  const heroSub  = document.getElementById('coupleHeroSub');
  const heroIcon = document.getElementById('coupleHeroIcon');
  if (heroName) heroName.textContent = c.name || 'Couple';
  if (heroSub)  heroSub.textContent  = c.weddingType || 'Event Planning';
  if (heroIcon) heroIcon.textContent = c.icon || '💍';
  const totalSongs    = songs.filter(s=>s.coupleId===c.id).length;
  const usedSongs     = songs.filter(s=>s.coupleId===c.id&&s.used).length;
  const {evCount, approvedCount, shootDoneCount, isEditComplete, isShootComplete, isComplete} = _coupleStats(c);
  const days          = getDaysLeft(c);
  const urgency       = isComplete ? 'complete' : countdownUrgency(days);
  const cdClass       = isComplete ? 'cd-ok' : `cd-${urgency}`;
  const types = (c.weddingTypes||[]);
  const typeTags = types.map(wt => {
    const w = WEDDING_TYPES.find(x=>x.id===wt); if (!w) return '';
    return `<span class="cc-type-tag" style="background:${w.color};border:1px solid ${w.border};color:${w.text};">${w.icon} ${w.label}</span>`;
  }).join('');
  const cdStrokeMap = { ok:'#4a7a55', soon:'#b48c28', urgent:'#c85014', critical:'#c81e1e', overdue:'#8b0000', complete:'#4a7a55', none:'var(--gold)' };
  const cdStroke = cdStrokeMap[urgency] || 'var(--gold)';
  const cdDaysDisp = isComplete ? '✓' : (days !== null ? (days < 0 ? `${Math.abs(days)}` : days > 999 ? '99+' : days) : '—');
  const cdMainLabel = isComplete
    ? 'All Events Approved'
    : days === null ? 'No date set'
    : days < 0 ? `${Math.abs(days)} days overdue`
    : days === 0 ? "Today's the day!"
    : days === 1 ? 'Tomorrow!'
    : `${days} days to go`;
  const cdDateLine = c.eventDate
    ? `📅 ${fmtEventDate(c.eventDate)}`
    : `<span style="color:var(--gold);cursor:pointer;text-decoration:underline dotted;" onclick="openEditCouple('${c.id}')">+ Set event date</span>`;

  el.innerHTML = `<div class="couple-info-card">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:.5rem;margin-bottom:.25rem;">
      <div>
        <div class="cic-name">${esc(c.name)}</div>
        ${isComplete ? '<div style="margin-top:.3rem;"><span class="cc-complete-stamp">✓ Project Complete</span></div>' : ''}
      </div>
      <button class="btn btn-outline btn-sm" style="flex-shrink:0;margin-top:.2rem;" onclick="openEditCouple('${c.id}')">✏️ Edit</button>
    </div>
    <div class="cic-date">${MO[c.month]} ${c.year}</div>
    ${typeTags ? `<div class="cic-types">${typeTags}</div>` : ''}
    ${(c.editors||[]).length ? `<div class="cc-editors" style="margin-top:.4rem;">${(c.editors||[]).map(e=>`<span class="cc-editor-chip"><span class="cc-editor-pic">${_userAvatar(e)}</span> ${esc(e)}</span>`).join('')}</div>` : ''}
    ${isComplete && c.completedAt ? `<div class="cc-complete-date" style="margin-top:.35rem;">🎉 Completed ${esc(c.completedAt)}</div>` : ''}
    <div class="cic-countdown ${cdClass}">
      <div class="cic-cd-days" style="color:${cdStroke};">${cdDaysDisp}</div>
      <div class="cic-cd-right">
        <div class="cic-cd-lbl" style="color:${cdStroke};">${cdMainLabel}</div>
        <div class="cic-cd-date">${cdDateLine}</div>
      </div>
    </div>
    <div class="cic-rule"></div>
    <div class="cic-stats">
      <div class="cic-stat"><span class="cic-stat-n">${evCount}</span><span class="cic-stat-l">Events</span></div>
      <div class="cic-stat"><span class="cic-stat-n">${approvedCount}</span><span class="cic-stat-l">✂️ Done</span></div>
      <div class="cic-stat"><span class="cic-stat-n">${shootDoneCount}</span><span class="cic-stat-l">📷 Done</span></div>
    </div>
    <div class="cic-progress-section">
      <div class="cic-progress-row">
        <div class="cic-progress-label">
          <span class="cic-progress-icon">✂️</span>
          <span class="cic-progress-name">Edits</span>
          <span class="cic-progress-frac">${approvedCount}/${evCount}</span>
        </div>
        <div class="cic-bar-track">
          <div class="cic-bar-fill cic-bar-edit" style="width:${evCount>0?Math.round(approvedCount/evCount*100):0}%"></div>
        </div>
        <span class="cic-progress-pct">${evCount>0?Math.round(approvedCount/evCount*100):0}%</span>
      </div>
      <div class="cic-progress-row">
        <div class="cic-progress-label">
          <span class="cic-progress-icon">📷</span>
          <span class="cic-progress-name">Shoots</span>
          <span class="cic-progress-frac">${shootDoneCount}/${evCount}</span>
        </div>
        <div class="cic-bar-track">
          <div class="cic-bar-fill cic-bar-shoot" style="width:${evCount>0?Math.round(shootDoneCount/evCount*100):0}%"></div>
        </div>
        <span class="cic-progress-pct">${evCount>0?Math.round(shootDoneCount/evCount*100):0}%</span>
      </div>
      <div class="cic-songs-row">
        <span class="cic-songs-lbl">🎵 Songs</span>
        <span class="cic-songs-val">${usedSongs} used / ${totalSongs} total</span>
      </div>
    </div>
    <button class="btn btn-outline btn-full btn-sm" onclick="openExport()" style="margin-top:.5rem;">📧 Email Music Plan</button>
  </div>`;
}

// ── DASHBOARD VIEW MODES ─────────────────────────────
function setDashView(mode, silent) {
  dashViewMode = mode;
  if (!silent && activeCompany) { localStorage.setItem(coKey('mt6_dashview'), mode); cloudSave(coKey('mt6_dashview'), mode); }
  ['vmGrid','vmList','vmCompact'].forEach(id => document.getElementById(id)?.classList.remove('active'));
  const map = { grid:'vmGrid', list:'vmList', compact:'vmCompact' };
  document.getElementById(map[mode])?.classList.add('active');
  renderDashboard();
}

// ── EDIT COUPLE ───────────────────────────────────────
function openEditCouple(id) {
  const c = couples.find(x=>x.id===id); if (!c) return;
  editingCoupleId = id;
  document.getElementById('eName').value = c.name;
  document.getElementById('eYear').value = c.year;
  document.getElementById('eMonth').value = c.month;
  document.getElementById('eEventDate').value = c.eventDate || '';
  document.getElementById('eEditDueDate').value = c.editDueDate || '';
  document.getElementById('eEditDueDuration').value = c.editDueDuration || (c.editDueDate ? '' : '90d');
  document.getElementById('eEditors').value = (c.editors||[]).join(', ');
  document.getElementById('eTheatrePass').value = c.theatrePass || '';
  document.querySelectorAll('#editWeddingTypeGrid .wt-btn').forEach(b => {
    b.classList.toggle('selected', (c.weddingTypes||[]).includes(b.dataset.wt));
  });
  document.getElementById('editCoupleModal').classList.add('open');
  setTimeout(()=>document.getElementById('eName').focus(), 80);
}
function closeEditCouple() {
  document.getElementById('editCoupleModal').classList.remove('open');
  editingCoupleId = null;
}
function saveEditCouple() {
  const name      = document.getElementById('eName').value.trim();
  const year      = +document.getElementById('eYear').value;
  const month     = +document.getElementById('eMonth').value;
  const eventDate = document.getElementById('eEventDate').value || '';
  const editDueDate = document.getElementById('eEditDueDate').value || '';
  const editDueDuration = document.getElementById('eEditDueDuration').value.trim() || '';
  const editors   = (document.getElementById('eEditors').value||'').split(',').map(e=>e.trim()).filter(Boolean);
  if (!name) return toast('Please enter a couple name.');
  const weddingTypes = [...document.querySelectorAll('#editWeddingTypeGrid .wt-btn.selected')].map(b=>b.dataset.wt);
  const c = couples.find(x=>x.id===editingCoupleId); if (!c) return;
  c.name = name; c.year = year; c.month = month; c.weddingTypes = weddingTypes; c.eventDate = eventDate; c.editors = editors;
  c.editDueDate = editDueDate; c.editDueDuration = editDueDuration;
  c.theatrePass = (document.getElementById('eTheatrePass').value||'').trim();
  sv();
  closeEditCouple();
  populateFilterYears(); populateFilterTypes();
  renderDashboard(); renderEditorFilter();
  if (cur === c.id) renderCoupleCard();
  toast(`Updated: ${name}`);
}

// ── APPROVAL ─────────────────────────────────────────
let _changesPromptIid = null;
let _changesPromptType = 'general'; // 'photo'|'video'|'general'

function togglePhotoEdit(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.photoEditApproved = !inst.photoEditApproved;
  inst.photoEditApprovedAt = inst.photoEditApproved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  if (inst.photoEditApproved) inst.photoChangesNeeded = false;
  const showVideo = !!(inst.serviceVideo||inst.services==='video'||inst.services==='both'||(inst.videographers||[]).some(v=>v&&v.trim()&&v!=='N/A'));
  if (inst.photoEditApproved && (!showVideo || inst.videoEditApproved)) {
    inst.approved = true; inst.approvedAt = inst.photoEditApprovedAt;
    inst.editCompletedAt = new Date().toISOString();
  } else { inst.approved = false; inst.approvedAt = null; delete inst.editCompletedAt; }
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard();
  toast(inst.photoEditApproved ? '📷 Photo edit done: '+inst.eventType : '↩ Photo edit reopened: '+inst.eventType);
  if (!inst.photoEditApproved) openChangesPrompt(iid, 'photo');
}

function toggleVideoEdit(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.videoEditApproved = !inst.videoEditApproved;
  inst.videoEditApprovedAt = inst.videoEditApproved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  if (inst.videoEditApproved) inst.videoChangesNeeded = false;
  const showPhoto = !!(inst.servicePhoto||inst.services==='photo'||inst.services==='both'||(inst.photographers||[]).some(p=>p&&p.trim()&&p!=='N/A'));
  if (inst.videoEditApproved && (!showPhoto || inst.photoEditApproved)) {
    inst.approved = true; inst.approvedAt = inst.videoEditApprovedAt;
    inst.editCompletedAt = new Date().toISOString();
  } else { inst.approved = false; inst.approvedAt = null; delete inst.editCompletedAt; }
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard();
  toast(inst.videoEditApproved ? '🎥 Video edit done: '+inst.eventType : '↩ Video edit reopened: '+inst.eventType);
  if (!inst.videoEditApproved) openChangesPrompt(iid, 'video');
}

function toggleApproval(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.approved = !inst.approved;
  inst.approvedAt = inst.approved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  // Track completion timestamp for analytics
  if (inst.approved) {
    inst.editCompletedAt = new Date().toISOString();
    inst.editorStatus = 'approved';
    // When unmarking changes flag on re-open, clear it
  } else if (inst.editorStatus === 'approved') {
    inst.editorStatus = '';
    delete inst.editCompletedAt;
  }
  // Update couple completedAt only when BOTH edit + shoot are done for all events
  const c = couples.find(x=>x.id===inst.coupleId);
  const myInsts = insts.filter(i=>i.coupleId===inst.coupleId);
  const allEditDone = myInsts.length > 0 && myInsts.every(i=>i.approved);
  const allBothDone = allEditDone && myInsts.every(i=>_isInstShootDone(i));
  if (c) {
    c.editCompletedAt = allEditDone ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
    c.completedAt     = allBothDone ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  }
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline();
  if (inst.approved) {
    setTimeout(function() {
      const eventEl = document.getElementById('cse-event-' + iid);
      const badgeEl = document.getElementById('cse-edit-' + iid);
      if (eventEl) {
        eventEl.classList.remove('just-shot');
        void eventEl.offsetWidth;
        eventEl.classList.add('just-shot');
      }
      if (badgeEl) {
        badgeEl.style.animation = 'none';
        void badgeEl.offsetWidth;
        badgeEl.style.animation = '';
      }
    }, 50);
  }
  if (allBothDone) { renderDashboard(); toast('🎉 All events fully complete!'); }
  else if (allEditDone) { renderDashboard(); toast('✂️ All edits done!'); }
  else { renderDashboard(); toast(inst.approved ? '✂️ Edit done: '+inst.eventType : '↩ Edit reopened: '+inst.eventType); }
  // Show changes prompt when UN-marking done (clicking it off)
  if (!inst.approved) { openChangesPrompt(iid); }
}

function openChangesPrompt(iid, type) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  const co = couples.find(x=>x.id===inst.coupleId);
  _changesPromptIid = iid;
  _changesPromptType = type || 'general';
  const nameEl = document.getElementById('changesPromptName');
  const typeLabel = type==='photo' ? '📷 Photo Edit' : type==='video' ? '🎥 Video Edit' : '✂️ Edit';
  if (nameEl) nameEl.textContent = typeLabel + ' — ' + (co ? co.name+' · ' : '') + (inst.eventType||'Event');
  document.getElementById('changesPromptOverlay').classList.add('open');
}

function confirmChanges(needsChanges) {
  document.getElementById('changesPromptOverlay').classList.remove('open');
  if (!_changesPromptIid) return;
  const inst = insts.find(x=>x.id===_changesPromptIid);
  const type = _changesPromptType;
  _changesPromptIid = null; _changesPromptType = 'general';
  if (!inst) return;
  const now = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  if (needsChanges) {
    if (type === 'photo') {
      inst.photoChangesNeeded = true; inst.photoEditApproved = false; inst.photoEditApprovedAt = null;
      inst.photoChangesCount = (inst.photoChangesCount || 0) + 1;
      toast('🔄 Photo changes needed: ' + inst.eventType);
    } else if (type === 'video') {
      inst.videoChangesNeeded = true; inst.videoEditApproved = false; inst.videoEditApprovedAt = null;
      inst.videoChangesCount = (inst.videoChangesCount || 0) + 1;
      toast('🔄 Video changes needed: ' + inst.eventType);
    } else {
      inst.changesNeeded = true; inst.editorStatus = 'changes'; inst.approved = false;
      inst.changesCount = (inst.changesCount || 0) + 1;
      toast('🔄 Changes needed: ' + inst.eventType);
    }
    inst.approved = false; inst.approvedAt = null; delete inst.editCompletedAt;
    sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard();
  } else {
    // Mistake — restore
    if (type === 'photo') {
      inst.photoEditApproved = true; inst.photoChangesNeeded = false;
      inst.photoEditApprovedAt = inst.photoEditApprovedAt || now;
      toast('✅ Photo edit restored: ' + inst.eventType);
    } else if (type === 'video') {
      inst.videoEditApproved = true; inst.videoChangesNeeded = false;
      inst.videoEditApprovedAt = inst.videoEditApprovedAt || now;
      toast('✅ Video edit restored: ' + inst.eventType);
    } else {
      inst.approved = true; inst.changesNeeded = false; inst.editorStatus = 'approved';
      inst.approvedAt = inst.approvedAt || now;
      if (!inst.editCompletedAt) inst.editCompletedAt = new Date().toISOString();
      toast('✅ Edit done restored: ' + inst.eventType);
    }
    sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard();
  }
}

function toggleEditUpcoming(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  inst.editUpcoming = !inst.editUpcoming;
  sv(); renderSections(); renderCoupleCard(); renderDashboard(); patchSummaryEvent(iid);
  toast(inst.editUpcoming ? '🔜 Marked as upcoming: '+inst.eventType : '↩ Upcoming cleared: '+inst.eventType);
}

function toggleEditPause(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  inst.editPaused = !inst.editPaused;
  sv(); renderSections(); renderCoupleCard(); renderDashboard(); patchSummaryEvent(iid);
  toast(inst.editPaused ? '⏸ Edit paused: '+inst.eventType : '▶ Edit resumed: '+inst.eventType);
}

function clearChangesFlag(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.changesNeeded = false;
  if (inst.editorStatus === 'changes') inst.editorStatus = 'approved';
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast('✅ Changes resolved: ' + inst.eventType);
}

function clearPhotoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.photoChangesNeeded = false;
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast('✅ Photo changes resolved: ' + inst.eventType);
}

function undoPhotoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.photoChangesNeeded = false;
  inst.photoChangesCount = Math.max(0, (inst.photoChangesCount || 1) - 1);
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast('↩ Photo changes badge removed: ' + inst.eventType);
}

function clearVideoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.videoChangesNeeded = false;
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast('✅ Video changes resolved: ' + inst.eventType);
}

function undoVideoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.videoChangesNeeded = false;
  inst.videoChangesCount = Math.max(0, (inst.videoChangesCount || 1) - 1);
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast('↩ Video changes badge removed: ' + inst.eventType);
}

function decrementPhotoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.photoChangesCount = Math.max(0, (inst.photoChangesCount || 1) - 1);
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast(inst.photoChangesCount > 0 ? '📷 Photo changes: ' + inst.photoChangesCount + '×' : '📷 Photo changes count cleared');
}

function decrementVideoChanges(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.videoChangesCount = Math.max(0, (inst.videoChangesCount || 1) - 1);
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline(); renderDashboard(); patchSummaryEvent(iid);
  toast(inst.videoChangesCount > 0 ? '🎥 Video changes: ' + inst.videoChangesCount + '×' : '🎥 Video changes count cleared');
}

function toggleImages(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  inst.imagesReceived   = !inst.imagesReceived;
  inst.imagesReceivedAt = inst.imagesReceived
    ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
    : null;
  sv();
  renderSections();
  renderCoupleCard();
  patchSummaryEvent(iid);
  toast(inst.imagesReceived ? '🖼 Images received: '+inst.eventType : '↩ Images unmarked: '+inst.eventType);
}

function toggleFootage(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  inst.footageReceived   = !inst.footageReceived;
  inst.footageReceivedAt = inst.footageReceived
    ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
    : null;
  sv();
  renderSections();
  renderCoupleCard();
  patchSummaryEvent(iid);
  toast(inst.footageReceived ? '📦 Footage received: '+inst.eventType : '↩ Footage unmarked: '+inst.eventType);
}

function _syncShootApproved(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  const showPhoto = !!(inst.servicePhoto||inst.services==='photo'||inst.services==='both');
  const showVideo = !!(inst.serviceVideo||inst.services==='video'||inst.services==='both');
  if (showPhoto && showVideo) {
    inst.shootApproved = !!(inst.photoShootApproved && inst.videoShootApproved);
  } else if (showPhoto) {
    inst.shootApproved = !!inst.photoShootApproved;
  } else if (showVideo) {
    inst.shootApproved = !!inst.videoShootApproved;
  }
  inst.shootApprovedAt = inst.shootApproved
    ? (inst.videoShootApprovedAt||inst.photoShootApprovedAt||new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}))
    : null;
}

function _shootDoneAnim(iid) {
  const eventEl = document.getElementById('cse-event-'+iid);
  if (eventEl) { eventEl.classList.remove('just-shot'); void eventEl.offsetWidth; eventEl.classList.add('just-shot'); }
}

function togglePhotoShoot(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.photoShootApproved = !inst.photoShootApproved;
  inst.photoShootApprovedAt = inst.photoShootApproved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  _syncShootApproved(iid);
  const co = couples.find(x=>x.id===inst.coupleId);
  const myInsts = insts.filter(i=>i.coupleId===inst.coupleId);
  const allShot = myInsts.every(i=>i.shootApproved);
  if (co) co.shootCompletedAt = allShot ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline();
  if (inst.photoShootApproved) { setTimeout(()=>{ _shootDoneAnim(iid); cseSummaryConfetti(); }, 50); }
  if (allShot) { renderDashboard(); toast('🎉 All shoots complete!'); }
  else { renderDashboard(); toast(inst.photoShootApproved ? '📷 Photo shot done: '+inst.eventType : '↩ Photo shoot reopened: '+inst.eventType); }
}

function toggleVideoShoot(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.videoShootApproved = !inst.videoShootApproved;
  inst.videoShootApprovedAt = inst.videoShootApproved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  _syncShootApproved(iid);
  const co = couples.find(x=>x.id===inst.coupleId);
  const myInsts = insts.filter(i=>i.coupleId===inst.coupleId);
  const allShot = myInsts.every(i=>i.shootApproved);
  if (co) co.shootCompletedAt = allShot ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline();
  if (inst.videoShootApproved) { setTimeout(()=>{ _shootDoneAnim(iid); cseSummaryConfetti(); }, 50); }
  if (allShot) { renderDashboard(); toast('🎉 All shoots complete!'); }
  else { renderDashboard(); toast(inst.videoShootApproved ? '🎥 Video shot done: '+inst.eventType : '↩ Video shoot reopened: '+inst.eventType); }
}

function toggleShootApproval(iid) {
  const inst = insts.find(x=>x.id===iid); if (!inst) return;
  inst.shootApproved   = !inst.shootApproved;
  inst.shootApprovedAt = inst.shootApproved ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  // Update couple shootCompletedAt
  const co = couples.find(x=>x.id===inst.coupleId);
  const myInsts = insts.filter(i=>i.coupleId===inst.coupleId);
  const allShot = myInsts.length > 0 && myInsts.every(i=>i.shootApproved);
  if (co) {
    co.shootCompletedAt = allShot ? new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : null;
  }
  sv(); renderSections(); renderCoupleCard(); renderCoupleSummary(); renderCoupleTimeline();
  if (inst.shootApproved) {
    // Trigger animation on the summary card after render
    setTimeout(function() {
      const eventEl = document.getElementById('cse-event-' + iid);
      const badgeEl = document.getElementById('cse-shoot-' + iid);
      if (eventEl) {
        eventEl.classList.remove('just-shot');
        void eventEl.offsetWidth; // reflow to restart animation
        eventEl.classList.add('just-shot');
      }
      if (badgeEl) {
        badgeEl.classList.remove('cse-shoot-done-flash');
        void badgeEl.offsetWidth;
        badgeEl.classList.add('cse-shoot-done-flash');
      }
      // Fire confetti burst near the summary panel
      cseSummaryConfetti();
    }, 50);
  }
  if (allShot) { renderDashboard(); toast('🎉 All shoots complete!'); }
  else { renderDashboard(); toast(inst.shootApproved ? '📷 Shoot marked done: '+inst.eventType : '↩ Shoot reopened: '+inst.eventType); }
}

function cseSummaryConfetti() {
  const summary = document.getElementById('coupleSummary');
  if (!summary) return;
  const rect = summary.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + 40;
  const colors = ['#2563eb','#1d6fa4','#4a7a55','#c19a4f','#b45309'];
  for (let i = 0; i < 28; i++) {
    const el = document.createElement('div');
    const size = 5 + Math.random() * 5;
    const angle = Math.random() * Math.PI * 2;
    const dist  = 40 + Math.random() * 90;
    const tx = Math.cos(angle) * dist;
    const ty = -(30 + Math.random() * 80);
    el.style.cssText = [
      'position:fixed',
      'pointer-events:none',
      'z-index:99999',
      'border-radius:' + (Math.random() > .5 ? '50%' : '2px'),
      'width:' + size + 'px',
      'height:' + size + 'px',
      'left:' + cx + 'px',
      'top:' + cy + 'px',
      'background:' + colors[Math.floor(Math.random()*colors.length)],
      'opacity:1',
      'transform:translate(0,0) rotate(0deg)',
      'transition:transform ' + (.5+Math.random()*.5) + 's cubic-bezier(.17,.67,.35,1.2), opacity .6s ease ' + (.3+Math.random()*.3) + 's',
    ].join(';');
    document.body.appendChild(el);
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        el.style.transform = 'translate('+tx+'px,'+ty+'px) rotate('+(Math.random()*360)+'deg)';
        el.style.opacity = '0';
        setTimeout(function() { el.remove(); }, 1200);
      });
    });
  }
}

// ── TREE (replaced by dashboard — kept as stub for any legacy calls) ──
function renderTree() { /* now handled by renderDashboard */ }
function toggleYr() {}

function showPH() { const m=document.getElementById('main'); if(m) m.innerHTML = `<div class="placeholder"><div class="icon">🎵</div><p>Select or add a couple to get started</p></div>`; }

// ── MAIN ─────────────────────────────────────────────


function buildFilmFrames(steps, idPrefix) {
  const firstIncomplete = steps.findIndex(s=>!s.done);
  const PHASE_ICONS = {
    send_contract:'📄', deposit:'💰', signed:'✍️', discovery:'📞',
    consultation:'🎨', storyboard:'📋', pre_wedding_shoot:'📸', final_meeting:'💍',
  };

  // Build sprocket holes to match number of frames
  const sprocketHoles = steps.map(() =>
    `<div class="ctl-film-sprocket"><div class="ctl-film-sprocket-hole"></div></div>`
  ).join('');

  const framesHtml = steps.map((s, idx) => {
    const isDone   = s.done;
    const isActive = !isDone && idx === firstIncomplete;
    const icon     = s.icon || PHASE_ICONS[s.id] || (s.subtype==='shoot'?'📷':s.subtype==='photo_edit'?'✂️📷':s.subtype==='video_edit'?'✂️🎥':s.subtype==='photo_review'?'🎬📷':s.subtype==='video_review'?'🎬🎥':s.subtype==='review'?'🎬':s.subtype==='edit'?'✂️':'⭐');
    const dateShort = s.date ? s.date.split(' ').slice(0,2).join(' ') : '';
    const frameClass = isDone ? 'done' : isActive ? 'active' : '';
    const padNum = String(idx+1).padStart(2,'0');

    return `<div class="ctl-film-frame ${frameClass}" onclick="ctlToggleDone('${s.id}')" data-label="${esc(s.label.replace(' — ',' '))}" onmouseenter="ctlFilmShowLabel(this)" onmouseleave="ctlFilmRestoreLabel(this)">
      <div class="ctl-film-frame-num">${padNum}</div>
      <div class="ctl-film-node">
        <span style="line-height:1">${icon}</span>
        ${isDone ? '<div class="ctl-film-check">✓</div>' : ''}
      </div>
      <div class="ctl-film-date" onclick="event.stopPropagation();ctlInlineDate('${s.id}',this)" title="Edit date" style="cursor:pointer;">${dateShort || (isDone ? '+ date' : '')}</div>
    </div>`;
  }).join('');

  return { framesHtml, sprocketHoles };
}
function renderJourneyOverview() {
  const elRight = document.getElementById('journeyOverviewPanel');
  const elFilm  = document.getElementById('filmStripPanel');
  if (!cur) {
    if (elRight) elRight.innerHTML = '';
    if (elFilm)  elFilm.innerHTML  = '';
    return;
  }
  const co = couples.find(x=>x.id===cur);
  if (!co) {
    if (elRight) elRight.innerHTML = '';
    if (elFilm)  elFilm.innerHTML  = '';
    return;
  }
  const steps = ctlGet(co.id);
  if (!steps || !steps.length) {
    if (elRight) elRight.innerHTML = '';
    if (elFilm)  elFilm.innerHTML  = '';
    return;
  }

  const total = steps.length;
  const done  = steps.filter(s=>s.done).length;
  const pct   = total > 0 ? Math.round(done/total*100) : 0;
  const firstIncomplete = steps.findIndex(s=>!s.done);

  // ── FILM STRIP (top of main) ──────────────────────────────
  if (elFilm) {
    const { framesHtml, sprocketHoles } = buildFilmFrames(steps, 'main');
    const _savedScroll = (document.getElementById('film-frames-main') || {}).scrollLeft || 0;
    elFilm.innerHTML = `<div class="ctl-visual-timeline">
      <div class="ctl-film-strip">
        <div class="ctl-film-header">
          <span class="ctl-film-title">◉ Client Journey</span>
          <span class="ctl-film-header-label" id="film-label-bar-main">&nbsp;</span>
          <div style="display:flex;align-items:center;gap:.7rem;">
            <button onclick="openTimeline('${co.id}')" style="font-family:'Outfit',sans-serif;font-size:.52rem;font-weight:700;letter-spacing:.08em;padding:.18rem .55rem;border-radius:20px;border:1px solid rgba(154,123,60,.4);background:rgba(154,123,60,.1);color:var(--gold-lt);cursor:pointer;text-transform:uppercase;">View All →</button>
          </div>
        </div>
        <div class="ctl-film-sprockets">${sprocketHoles}</div>
        <div class="ctl-film-scroll-wrap">
          <button class="ctl-film-arrow left hidden" id="film-arrow-left-main" onclick="ctlVtScroll('film-frames-main',-220)">◀</button>
          <div class="ctl-film-frames" id="film-frames-main" onscroll="ctlVtUpdateArrows('film-frames-main','film-arrow-left-main','film-arrow-right-main')">${framesHtml}</div>
          <button class="ctl-film-arrow right" id="film-arrow-right-main" onclick="ctlVtScroll('film-frames-main',220)">▶</button>
        </div>
        <div class="ctl-film-sprockets">${sprocketHoles}</div>
        <div class="ctl-film-progress"><div class="ctl-film-progress-fill" style="width:${pct}%"></div></div>
      </div>
    </div>`;
    const _newFrames = document.getElementById('film-frames-main');
    if (_newFrames && _savedScroll) _newFrames.scrollLeft = _savedScroll;
    setTimeout(()=>{
      ctlVtUpdateArrows('film-frames-main','film-arrow-left-main','film-arrow-right-main');
      const af=document.querySelector('#film-frames-main .ctl-film-frame.active');
      const bar=document.getElementById('film-label-bar-main');
      if(bar) bar.textContent=af?af.dataset.label:' ';
    },50);
  }

  // ── VERTICAL LIST (right panel) ───────────────────────────
  if (elRight) {
    const stepsHtml = steps.map((s, idx) => {
      const isDone   = s.done;
      const isActive = !isDone && idx === firstIncomplete;
      const isEvent  = s.type === 'event';
      const dateShort = s.date ? s.date.split(' ').slice(0,2).join(' ') : '';
      return `<div class="cj-sb-step${isDone?' done':''}${isActive?' active':''}${isEvent?' event-step':''}"
        onclick="ctlToggleDone('${s.id}')" title="${isDone?'Mark incomplete':'Mark complete'}">
        <div class="cj-sb-dot">${isDone?'✓':isActive?'◉':''}</div>
        <div class="cj-sb-info">
          <span class="cj-sb-icon">${s.icon||'⭐'}</span>
          <span class="cj-sb-label">${esc(s.label.replace(' — ',' '))}</span>
        </div>
        <span class="cj-sb-date" onclick="event.stopPropagation();ctlInlineDate('${s.id}',this)" title="Edit date">${esc(dateShort||'+ date')}</span>
      </div>`;
    }).join('');

    elRight.innerHTML = `<div class="cj-sidebar-panel">
      <div class="cj-sb-header">
        <span class="cj-sb-title">✦ Client Journey</span>
        <div style="display:flex;align-items:center;gap:.5rem;">
          <span class="cj-sb-fraction">${done} of ${total}</span>
          <button onclick="openTimeline('${co.id}')" class="cj-sb-open-btn">Edit ↗</button>
        </div>
      </div>
      <div class="cj-sb-progress-bar"><div class="cj-sb-progress-fill" style="width:${pct}%"></div></div>
      <div class="cj-sb-steps">${stepsHtml}</div>
    </div>`;
  }
}

function renderMain() {
  if (!cur) return showPH();
  const c = couples.find(x=>x.id===cur); if (!c) return showPH();
  document.getElementById('main').innerHTML = `
    <div id="filmStripPanel" style="margin-bottom:1.5rem;"></div>
    <div class="panel setup-panel admin-only" id="setupPanel" style="margin-bottom:1.5rem;">
      <div class="panel-title setup-panel-header" onclick="toggleSetupPanel()" style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;">
        <span>Event Setup</span>
        <span class="setup-panel-chev" id="setupPanelChev">▲</span>
      </div>
      <div class="setup-panel-body" id="setupPanelBody">
        <p style="font-size:.76rem;color:var(--ink4);margin-bottom:.85rem;">Click an event to add it as a section. Add the same event multiple times for different clients. Use ⠿ handle to reorder.</p>
        <div class="setup-grid" id="setupGrid"></div>
      </div>
    </div>
    <div class="view-toggle">
      <button class="vbtn active" id="vbS" onclick="setView('sections')">By Event</button>
      <button class="vbtn" id="vbF" onclick="setView('flat')">All Songs</button>
    </div>
    <div id="secView"><div id="dupWarn"></div><div id="secCont"></div></div>
    <div id="flatView" style="display:none">
      <div class="filter-bar" id="fBar"></div>
      <div class="flat-wrap">
        <div class="flat-head"><h2>${esc(c.name)}</h2><span class="badge" id="fBadge">0 songs</span></div>
        <div id="fTable"></div>
      </div>
    </div>`;
  renderSetup(); renderView(); renderJourneyOverview(); setTimeout(restoreSetupPanel, 0);
}

// ── INSTANCES ────────────────────────────────────────
function getInsts(cid) { return insts.filter(i=>i.coupleId===cid).sort((a,b)=>a.order-b.order); }

function addInst(catId, evType) {
  const inst = { id:uid(), coupleId:cur, catId, eventType:evType, client:'', order:Date.now() };
  insts.push(inst);
  openSec[inst.id] = true;
  // Sync timeline event steps
  const _addCo = couples.find(x=>x.id===cur);
  if (_addCo) ctlGet(_addCo.id); // ensures event step is created
  // Pre-populate from song library (all languages combined, English first)
  let order = 0;
  ['en','hi','pa','inst'].forEach(lang => {
    const key = evType + '|' + lang;
    (songLib[key] || []).forEach(entry => {
      if (entry.title && entry.title.trim()) {
        songs.push({ id:uid(), coupleId:cur, instanceId:inst.id, title:entry.title.trim(), artist:(entry.artist||'').trim(), used:false, usedAt:null, order:order++, libLang:lang });
      }
    });
  });
  sv(); renderSetup(); renderSections(); renderCoupleCard();
  const preCount = order;
  toast(`Added: ${evType}${preCount ? ' ('+preCount+' songs pre-loaded)' : ''}`);
  // Show services prompt
  showServicesPrompt(inst.id);
}

function showServicesPrompt(iid) {
  // Prompt is always rendered inline by buildSec — nothing to do
}

function setServices(iid, val) {
  var inst = insts.find(function(i){ return i.id===iid; }); if (!inst) return;
  // Migrate legacy single-value field
  if (inst.services === 'photo' || inst.services === 'both') inst.servicePhoto = true;
  if (inst.services === 'video' || inst.services === 'both') inst.serviceVideo = true;
  inst.services = null;
  // Toggle independently
  if (val === 'photo') inst.servicePhoto = !inst.servicePhoto;
  if (val === 'video') inst.serviceVideo = !inst.serviceVideo;
  // Re-run ctlGet FIRST to create/remove photo_edit, video_edit, review steps in memory
  var co = couples.find(function(x){ return x.id === cur; });
  if (co) ctlGet(co.id);
  // NOW save the updated timeline
  sv();
  // Update service button active states in place
  document.querySelectorAll('#svcprompt_' + iid + ' .ev-svc-btn, #svcbar_' + iid + ' .ev-svc-btn').forEach(function(btn) {
    var isPhoto = btn.textContent.includes('Photo');
    btn.className = 'ev-svc-btn' + ((isPhoto ? inst.servicePhoto : inst.serviceVideo) ? ' active' : '');
  });
  // Full journey re-render to reflect new steps in filmstrip + list
  if (typeof renderJourneyOverview === 'function') renderJourneyOverview();
  // Update event summary to reflect service changes (crew/editors visibility)
  if (typeof renderCoupleSummary === 'function') renderCoupleSummary();
  // If modal is open for this inst, rebuild sb with updated buttons then re-inject
  // Rebuild card-face action buttons to reflect service toggle
  (function() {
    var oldBtns = document.getElementById('evBtns_' + iid);
    if (oldBtns) {
      var tmp = document.createElement('div');
      tmp.innerHTML = buildSec(inst);
      var fresh = tmp.querySelector('#evBtns_' + iid);
      if (fresh) { oldBtns.parentNode.replaceChild(fresh, oldBtns); setTimeout(_attachBtnDrag, 60); }
    }
  })();
  if (_evModalOpen === iid) {
    var bodyEl = document.getElementById('evModalBody');
    // Step 1: save which panels are currently open
    var openPanelIds = [];
    (bodyEl || document).querySelectorAll('.ev-panel.open').forEach(function(p) {
      if (p.id) openPanelIds.push(p.id);
    });
    // Step 2: move sb back to its ev-section so renderSections can replace it cleanly
    var sbEl = document.getElementById('sb' + iid);
    var sec  = document.querySelector('.ev-section[data-iid="' + iid + '"]');
    if (sbEl && sec && bodyEl && bodyEl.contains(sbEl)) {
      sbEl.style.display = 'none';
      sec.appendChild(sbEl);
    }
    // Step 3: rebuild all sections (creates fresh sb with correct buttons/panels)
    renderSections();
    // Step 4: grab the newly rebuilt sb and inject into modal
    var sbNew = document.getElementById('sb' + iid);
    if (bodyEl && sbNew) {
      sbNew.style.display = '';
      bodyEl.innerHTML = '';
      bodyEl.appendChild(sbNew);
      // Step 5: restore previously open panels (skip songs if video just turned off)
      openPanelIds.forEach(function(pid) {
        var panel = document.getElementById(pid);
        if (panel) panel.classList.add('open');
      });
      setTimeout(function(){ renderDateQuick(iid); }, 50);
      setTimeout(_attachPanelDrag, 80);
    }
  }
}

function rmInst(iid) {
  const i = insts.find(x=>x.id===iid); if (!i) return;
  const n = songs.filter(s=>s.instanceId===iid).length;
  if (n && !confirm(`Remove "${i.eventType}"${i.client?' ('+i.client+')':''}? Deletes ${n} song(s).`)) return;
  insts = insts.filter(x=>x.id!==iid);
  songs = songs.filter(s=>s.instanceId!==iid);
  delete openSec[iid];
  sv(); renderSetup(); renderSections(); renderCoupleCard();
}

function updateClient(iid, val) {
  const i = insts.find(x=>x.id===iid); if (i) { i.client = val.trim(); sv(); }
  const b = document.querySelector(`[data-b="${iid}"]`); if (b) b.textContent = i?.client ? '👤 '+i.client : '';
  const t = document.querySelector(`[data-t="${iid}"]`);
  if (t) { t.className='inst-tag'+(i?.client?' hc':''); const sp=t.querySelector('span'); if(sp) sp.textContent=i?.client?i.eventType+' · '+i.client:i?.eventType||''; }
  patchSummaryEvent(iid);
}

// ── SETUP ────────────────────────────────────────────
function toggleSetupPanel() {
  const body = document.getElementById('setupPanelBody');
  const chev = document.getElementById('setupPanelChev');
  const panel = document.getElementById('setupPanel');
  if (!body) return;
  const collapsed = body.classList.toggle('setup-panel-collapsed');
  if (chev) chev.textContent = collapsed ? '▼' : '▲';
  if (panel) panel.classList.toggle('setup-panel-is-collapsed', collapsed);
  try { localStorage.setItem('mt6_setup_collapsed', collapsed ? '1' : ''); } catch(e) {}
}

function restoreSetupPanel() {
  try {
    if (localStorage.getItem('mt6_setup_collapsed') === '1') {
      const body = document.getElementById('setupPanelBody');
      const chev = document.getElementById('setupPanelChev');
      const panel = document.getElementById('setupPanel');
      if (body) body.classList.add('setup-panel-collapsed');
      if (chev) chev.textContent = '▼';
      if (panel) panel.classList.add('setup-panel-is-collapsed');
    }
  } catch(e) {}
}

function renderSetup() {
  const g = document.getElementById('setupGrid'); if (!g) return;
  const ii = getInsts(cur);
  g.innerHTML = CATS.map(cat => {
    const ci = ii.filter(i=>i.catId===cat.id);
    const byT = {}; ci.forEach(i=>{ if(!byT[i.eventType]) byT[i.eventType]=[]; byT[i.eventType].push(i); });
    const tags = ci.length ? `<div class="inst-tags">${ci.map(i=>`
      <div class="inst-tag${i.client?' hc':''}" data-t="${i.id}">
        <span>${esc(i.client ? i.eventType+' · '+i.client : i.eventType)}</span>
        <button onclick="rmInst('${i.id}')">✕</button>
      </div>`).join('')}</div>` : '';
    const chips = cat.events.map(ev => {
      const n = (byT[ev]||[]).length;
      return `<button class="chip" onclick="addInst('${cat.id}','${esc(ev)}')" title="Add ${ev}">+ ${esc(ev)}${n>0?`<span class="chip-count">${n}</span>`:''}</button>`;
    }).join('');
    return `<div class="setup-card">
      <div class="setup-card-title">${cat.icon} ${cat.label}</div>
      ${tags}
      <div class="chip-list">${chips}</div>
      <div class="custom-row">
        <input type="text" id="cevt${cat.id}" placeholder="Custom event…" onkeydown="if(event.key==='Enter')addCustom('${cat.id}')">
        <button class="btn btn-gold btn-sm" onclick="addCustom('${cat.id}')">+ Add</button>
      </div>
    </div>`;
  }).join('');
}

function addCustom(catId) {
  const inp = document.getElementById('cevt'+catId);
  const n = inp?.value.trim(); if (!n) return toast('Enter an event name.');
  inp.value = ''; addInst(catId, n);
}

// ── VIEW ─────────────────────────────────────────────
function setView(v) {
  view = v;
  ['vbS','vbF'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById(v==='sections'?'vbS':'vbF')?.classList.add('active');
  document.getElementById('secView').style.display = v==='sections' ? 'block' : 'none';
  document.getElementById('flatView').style.display = v==='flat'     ? 'block' : 'none';
  renderView();
}
function renderView() { if (view==='sections') renderSections(); else renderFlat(); }

// ── SECTIONS ─────────────────────────────────────────
function toggleCollapseAll() {
  const ii = getInsts(cur);
  if (!ii.length) return;
  const btn = document.getElementById('collapseAllBtn');
  // Check if any are open
  const anyOpen = ii.some(i => openSec[i.id]);
  if (anyOpen) {
    // Collapse all
    ii.forEach(i => { openSec[i.id] = false; });
    if (btn) btn.textContent = '⊕ Expand All';
  } else {
    // Expand all
    ii.forEach(i => { openSec[i.id] = true; });
    if (btn) btn.textContent = '⊖ Collapse All';
  }
  sv(); renderSections();
}

function updateCollapseBtn() {
  const btn = document.getElementById('collapseAllBtn');
  if (!btn) return;
  const ii = getInsts(cur);
  const anyOpen = ii.some(i => openSec[i.id]);
  btn.textContent = anyOpen ? '⊖ Collapse All' : '⊕ Expand All';
}

function renderDateQuick(iid) {
  const el = document.getElementById('dq_' + iid);
  if (!el) return;
  const inst = insts.find(function(i){ return i.id===iid; });
  if (!inst) return;
  const today = new Date();
  today.setHours(0,0,0,0);
  const fmt = function(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dy = String(d.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+dy;
  };
  const labelFn = function(d) {
    return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
  };
  const chips = [];
  chips.push({l:'Today', v: fmt(today)});
  const tom = new Date(today); tom.setDate(tom.getDate()+1);
  chips.push({l:'Tomorrow', v: fmt(tom)});
  const d = new Date(today); d.setDate(d.getDate()+1);
  let weekends = 0;
  while (weekends < 6) {
    if (d.getDay()===6 || d.getDay()===0) {
      chips.push({l: labelFn(d), v: fmt(d)});
      weekends++;
    }
    d.setDate(d.getDate()+1);
  }
  el.innerHTML = chips.map(function(ch) {
    const active = inst.shootDay === ch.v ? ' style="background:var(--gold);color:var(--ink);border-color:var(--gold);"' : '';
    return '<button class="ev-date-chip"' + active + ' onclick="setDateQuick(\x27' + iid + '\x27,\x27' + ch.v + '\x27)">' + ch.l + '</button>';
  }).join('');
}

function setDateQuick(iid, val) {
  const inst = insts.find(function(i){ return i.id===iid; });
  if (!inst) return;
  inst.shootDay = val;
  sv();
  const input = document.querySelector('input[data-iid="' + iid + '"].shoot-day-input');
  if (input) input.value = val;
  renderCoupleSummary(); renderCoupleTimeline();
  renderDateQuick(iid);
  renderSections();
}


function buildAudioRows(iid, type, rows, icon, label) {
  var rowsHtml = rows.map(function(row, idx) {
    return '<div class="ev-audio-row" id="audiorow_' + iid + '_' + type + '_' + idx + '">' +
      '<div class="ev-audio-row-who">' +
        '<input class="ev-prod-input" type="text" placeholder="Who recorded?" ' +
          'value="' + esc(row.who||'') + '" ' +
          'oninput="updateAudioField(\x27' + iid + '\x27,\x27' + type + '\x27,' + idx + ',\x27who\x27,this.value)">' +
      '</div>' +
      '<div class="ev-audio-row-what">' +
        '<input class="ev-prod-input" type="text" placeholder="What was recorded?" ' +
          'value="' + esc(row.what||'') + '" ' +
          'oninput="updateAudioField(\x27' + iid + '\x27,\x27' + type + '\x27,' + idx + ',\x27what\x27,this.value)">' +
      '</div>' +
      '<button class="ev-crew-remove" onclick="removeAudioRow(\x27' + iid + '\x27,\x27' + type + '\x27,' + idx + ')" title="Remove">✕</button>' +
    '</div>';
  }).join('');

  var hasRows = rows.length > 0;
  return '<div class="ev-audio-type' + (hasRows ? ' active' : '') + '" id="audioblock_' + iid + '_' + type + '">' +
    '<div class="ev-audio-type-head">' +
      '<span class="ev-audio-icon">' + icon + '</span>' +
      '<span class="ev-audio-type-label">' + label + '</span>' +
      '<span class="ev-audio-count">' + (hasRows ? rows.length + ' recorder' + (rows.length !== 1 ? 's' : '') : '') + '</span>' +
      '<button class="ev-audio-add-btn" onclick="addAudioRow(\x27' + iid + '\x27, \x27' + type + '\x27)">+ Add</button>' +
    '</div>' +
    (hasRows ? '<div class="ev-audio-rows">' + rowsHtml + '</div>' : '') +
  '</div>';
}

function addAudioRow(iid, type) {
  var inst = insts.find(function(i){ return i.id===iid; }); if (!inst) return;
  var key = 'audio' + type.charAt(0).toUpperCase() + type.slice(1);
  if (!inst[key]) inst[key] = [];
  inst[key].push({who:'', what:''});
  sv(); renderSections();
  patchSummaryEvent(iid);
}

function removeAudioRow(iid, type, idx) {
  var inst = insts.find(function(i){ return i.id===iid; }); if (!inst) return;
  var key = 'audio' + type.charAt(0).toUpperCase() + type.slice(1);
  if (!inst[key]) return;
  inst[key].splice(idx, 1);
  sv(); renderSections();
  patchSummaryEvent(iid);
}

function updateAudioField(iid, type, idx, field, val) {
  var inst = insts.find(function(i){ return i.id===iid; }); if (!inst) return;
  var key = 'audio' + type.charAt(0).toUpperCase() + type.slice(1);
  if (!inst[key]) inst[key] = [];
  if (!inst[key][idx]) inst[key][idx] = {who:'', what:''};
  inst[key][idx][field] = val;
  sv();
  patchSummaryEvent(iid);
}

function renderSections() {
  const el = document.getElementById('secCont'); if (!el) return;
  let ii = getInsts(cur);
  // Editor role: only show events they're assigned to
  if (_isEditor()) {
    const _myIds = _editorInstIds();
    if (_myIds) ii = ii.filter(i => _myIds.has(i.id));
  }
  if (!ii.length) {
    el.innerHTML = '<div class="empty-s"><div class="ico">☝️</div><p>Click an event in <strong>Event Setup</strong> above to add it here.</p></div>';
    return;
  }
  el.innerHTML = CATS.map(cat => {
    const ci = ii.filter(i=>i.catId===cat.id); if (!ci.length) return '';
    const cnt = songs.filter(s=>s.coupleId===cur && ci.some(i=>i.id===s.instanceId)).length;
    return `<div class="cat-group">
      <div class="cat-head">
        <span class="cat-lbl">${cat.icon} ${cat.label}</span>
        <div class="cat-line"></div>
        <span class="cat-cnt">${cnt} song${cnt!==1?'s':''}</span>
      </div>
      <div class="inst-list" data-catid="${cat.id}">
        ${ci.map(i=>buildSec(i)).join('')}
      </div>
    </div>`;
  }).filter(Boolean).join('');
  attachEventDrag();
  setTimeout(_attachPanelDrag, 80);
  setTimeout(_attachBtnDrag, 60);
  setTimeout(attachSongDrag, 30);
  checkDuplicates();
  updateCollapseBtn();
  // If a modal is open, re-inject its content and restore open panels
  if (_evModalOpen) {
    // Save which panels are currently open BEFORE re-render wipes them
    const openPanels = [];
    document.querySelectorAll('.ev-panel.open').forEach(function(p) {
      if (p.id) openPanels.push(p.id);
    });
    setTimeout(function() {
      const bodyEl = document.getElementById('evModalBody');
      const sbEl = document.getElementById('sb' + _evModalOpen);
      if (bodyEl && sbEl) {
        sbEl.style.display='';
        bodyEl.innerHTML='';
        bodyEl.appendChild(sbEl);
        // Restore open panels
        openPanels.forEach(function(pid) {
          const panel = document.getElementById(pid);
          if (panel) panel.classList.add('open');
        });
        if (typeof renderDateQuick === 'function') renderDateQuick(_evModalOpen);
        // Restore active tab
        const savedTab = _evTabState[_evModalOpen];
        if (savedTab) switchEvTab(_evModalOpen, savedTab);
      }
    }, 10);
  }
}

// Returns the library language ('en'|'hi'|'pa'|null) for a song in a given event.
// First checks the song's own libLang field (set when pre-populated).
// Falls back to scanning the library by title match (covers manually-added library songs).
function getSongGenres(song, evType) {
  // Returns array of active genre keys — supports both old s.lang and new s.genres
  if (song.genres && song.genres.length) return song.genres;
  const single = song.lang || song.libLang;
  if (single) return [single];
  // Fallback: scan library
  if (!evType) return [];
  const titleKey = song.title.trim().toLowerCase();
  for (const lang of ['en','hi','pa','inst']) {
    const entries = songLib[evType + '|' + lang] || [];
    if (entries.some(e => e.title && e.title.trim().toLowerCase() === titleKey)) return [lang];
  }
  return [];
}

function getLangForSong(song, evType) {
  if (!evType) return null;
  // Lang stored directly on song (from manual add or pre-populate)
  if (song.lang) return song.lang;
  if (song.libLang) return song.libLang;
  // Fallback: scan preset library by title
  const titleKey = song.title.trim().toLowerCase();
  for (const lang of ['en','hi','pa','inst']) {
    const entries = songLib[evType + '|' + lang] || [];
    if (entries.some(e => e.title && e.title.trim().toLowerCase() === titleKey)) return lang;
  }
  return null;
}

const LANG_LABELS = { en:'EN', hi:'HI', pa:'PA' };
const LANG_FULL   = { en:'English', hi:'Hindi', pa:'Punjabi' };

function getDupSet() {
  // Returns a Set of normalised title keys that appear in 2+ different events for this couple
  if (!cur) return new Set();
  const mySongs = songs.filter(s=>s.coupleId===cur);
  const dupKeys = new Set();
  const seenInst = {}; // title -> [instanceId]
  mySongs.forEach(s=>{
    const k = s.title.trim().toLowerCase();
    if (!seenInst[k]) seenInst[k]=[];
    if (!seenInst[k].includes(s.instanceId)) seenInst[k].push(s.instanceId);
  });
  Object.entries(seenInst).forEach(([k,iids])=>{ if(iids.length>1) dupKeys.add(k); });
  return dupKeys;
}


// ── INLINE ASSIGN HELPERS (used from unassigned drill-down) ─
function setInstCrew0(iid, role, val) {
  // Set index 0 of photographers/videographers array
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) inst[role] = [''];
  inst[role][0] = val;
  sv();
  if (val.trim()) saveCrewName(role, val.trim());
}
function setInstCrewNA(iid, role, makeNA) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) inst[role] = [''];
  inst[role][0] = makeNA ? 'N/A' : '';
  sv();
  // Re-render the drill-down to reflect change
  renderOvDrill();
}

// ── CREW & VENDOR HELPERS ─────────────────────────────────
function switchEvTab(iid, tab) {
  _evTabState[iid] = tab;
  ['shoot','edit'].forEach(t => {
    document.getElementById('etab_'+t+'_'+iid)?.classList.toggle('active', t===tab);
    document.getElementById('epane_'+t+'_'+iid)?.classList.toggle('active', t===tab);
  });
}


// ── CREW NAME SUGGESTIONS ────────────────────────────────
// mt6_crew_<company> → { photographers: Set, videographers: Set }
// We collect names from all existing inst.photographers[], inst.videographers[], inst.shooter

function getKnownCrew(role) {
  // Pull from all insts for this company
  const names = new Set();
  insts.forEach(i => {
    if (role === 'photographers') {
      (i.photographers||[]).forEach(n => { if(n.trim()) names.add(n.trim()); });
      // also legacy inst.shooter for photographers
    } else if (role === 'videographers') {
      (i.videographers||[]).forEach(n => { if(n.trim()) names.add(n.trim()); });
      if (i.shooter && i.shooter.trim()) names.add(i.shooter.trim());
    }
  });
  // Also load persisted custom crew roster
  try {
    const stored = JSON.parse(localStorage.getItem(coKey('mt6_crew_'+role)) || '[]');
    stored.forEach(n => { if(n) names.add(n); });
  } catch(e) {}
  return [...names].sort();
}

function saveCrewName(role, name) {
  if (!name.trim()) return;
  try {
    const key = coKey('mt6_crew_'+role);
    const stored = new Set(JSON.parse(localStorage.getItem(key)||'[]'));
    stored.add(name.trim());
    const arr = [...stored];
    localStorage.setItem(key, JSON.stringify(arr));
    cloudSave(key, arr);
  } catch(e) {}
}

function deleteCrewName(role, name, iid) {
  try {
    const key = coKey('mt6_crew_'+role);
    const stored = new Set(JSON.parse(localStorage.getItem(key)||'[]'));
    stored.delete(name);
    const arr = [...stored];
    localStorage.setItem(key, JSON.stringify(arr));
    cloudSave(key, arr);
  } catch(e) {}
  // Close all suggestion lists for this role
  document.querySelectorAll('.crew-suggest-list').forEach(el => el.classList.remove('open'));
  // re-render to refresh any open dropdowns (just close; user re-focuses to see updated list)
}

function openCrewSuggest(iid, role, idx, inputEl) {
  // Close all others first
  document.querySelectorAll('.crew-suggest-list').forEach(el => el.classList.remove('open'));
  const listId = 'crewsug_'+role+'_'+iid+'_'+idx;
  let list = document.getElementById(listId);
  if (!list) return;
  renderCrewSuggestList(iid, role, idx, inputEl.value, list);
  list.classList.add('open');
}

function filterCrewSuggest(iid, role, idx, inputEl) {
  const listId = 'crewsug_'+role+'_'+iid+'_'+idx;
  const list = document.getElementById(listId);
  if (!list) return;
  renderCrewSuggestList(iid, role, idx, inputEl.value, list);
  list.classList.add('open');
  updateCrewMember(iid, role, idx, inputEl.value);
}

function renderCrewSuggestList(iid, role, idx, query, list) {
  const all = getKnownCrew(role);
  const q   = query.trim().toLowerCase();
  const filtered = q ? all.filter(n => n.toLowerCase().includes(q)) : all;

  if (!filtered.length && !q) {
    list.innerHTML = '<div class="loc-searching" style="font-style:normal;">Start typing a name or enter a new one</div>';
    return;
  }

  const items = filtered.map(name => {
    const safe = esc(name).replace(/'/g,"\'");
    return `<div class="crew-suggest-item">
      <span onclick="selectCrewName('${iid}','${role}',${idx},'${safe}')">${esc(name)}</span>
      <span class="del" onclick="event.stopPropagation();deleteCrewName('${role}','${safe}','${iid}');renderCrewSuggestList('${iid}','${role}',${idx},'${q}',document.getElementById('crewsug_${role}_${iid}_${idx}'))" title="Remove from list">✕</span>
    </div>`;
  });

  // "Add new" option if typed name not in list
  const inst = insts.find(i=>i.id===iid);
  const members = inst ? (inst[role]||[]) : [];
  const typedName = members[idx] || '';
  if (typedName.trim() && !all.some(n=>n.toLowerCase()===typedName.trim().toLowerCase())) {
    const safe = esc(typedName.trim()).replace(/'/g,"\'");
    items.push(`<div class="crew-suggest-divider">New</div>
      <div class="crew-suggest-item" onclick="selectCrewName('${iid}','${role}',${idx},'${safe}')">
        <span>+ Add "${esc(typedName.trim())}"</span>
      </div>`);
  }

  list.innerHTML = items.join('') || '<div class="loc-searching" style="font-style:normal;">No matches</div>';
}

function selectCrewName(iid, role, idx, name) {
  updateCrewMember(iid, role, idx, name);
  saveCrewName(role, name);
  // Update input value
  const inp = document.getElementById('crewinp_'+role+'_'+iid+'_'+idx);
  if (inp) inp.value = name;
  // Close list
  const list = document.getElementById('crewsug_'+role+'_'+iid+'_'+idx);
  if (list) list.classList.remove('open');
}

// Close crew dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.crew-suggest-wrap') && !e.target.closest('.crew-suggest-list')) {
    document.querySelectorAll('.crew-suggest-list').forEach(el => el.classList.remove('open'));
  }
});

// ── LOCATION AUTOCOMPLETE (OpenStreetMap Nominatim) ──────
let _locTimers = {};

// ── Location Roster (saved per company) ──────────────────
// Each entry: { name, address, parking }
function getLocRoster() {
  try { return JSON.parse(localStorage.getItem(coKey('mt6_locations')) || '[]'); }
  catch(e) { return []; }
}
function saveLocRoster(roster) {
  localStorage.setItem(coKey('mt6_locations'), JSON.stringify(roster));
  cloudSave(coKey('mt6_locations'), roster);
}
function saveLocationToRoster(name, address, parking) {
  if (!name.trim()) return;
  const roster = getLocRoster();
  // Update existing or add new
  const idx = roster.findIndex(l => l.name.toLowerCase() === name.trim().toLowerCase());
  const entry = { name: name.trim(), address: (address||'').trim(), parking: (parking||'').trim() };
  if (idx >= 0) roster[idx] = entry; else roster.unshift(entry);
  saveLocRoster(roster);
}
function deleteLocationFromRoster(name) {
  const roster = getLocRoster().filter(l => l.name.toLowerCase() !== name.toLowerCase());
  saveLocRoster(roster);
}

function locInput(fieldId, iid, field) {
  const inp = document.getElementById(fieldId);
  if (!inp) return;
  const q = inp.value.trim();
  updateInstField(iid, field, inp.value);
  // NOTE: roster save only happens on Enter or picking from suggestions
  const listId = fieldId + '_sug';
  const list = document.getElementById(listId);
  if (!list) return;
  if (!q) { list.classList.remove('open'); return; }
  clearTimeout(_locTimers[fieldId]);
  // Show saved locations immediately, then fetch from Nominatim
  showLocSuggestions(q, list, inp, iid, field);
  _locTimers[fieldId] = setTimeout(() => fetchLocSuggestions(q, list, inp, iid, field), 500);
}

function locSearch(fieldId, iid, field) {
  const inp = document.getElementById(fieldId);
  if (!inp) return;
  const q = inp.value.trim();
  if (!q || q.length < 2) return;
  const listId = fieldId + '_sug';
  const list = document.getElementById(listId);
  if (!list) return;
  clearTimeout(_locTimers[fieldId]);
  showLocSuggestions(q, list, inp, iid, field);
  fetchLocSuggestions(q, list, inp, iid, field);
}

function makeSavedLocItem(l, inputId, iid, field) {
  const div = document.createElement('div');
  div.className = 'loc-suggest-item loc-saved-item';
  div.dataset.action = 'saved';
  div.dataset.inputId = inputId;
  div.dataset.iid = iid;
  div.dataset.name = l.name;
  div.dataset.address = l.address || '';
  div.dataset.parking = l.parking || '';
  const inner = document.createElement('div');
  inner.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:.5rem;';
  const info = document.createElement('div');
  info.innerHTML = '<div class="loc-main">⭐ ' + esc(l.name) + '</div>'
    + (l.address ? '<div class="loc-sub">' + esc(l.address) + '</div>' : '')
    + (l.parking ? '<div class="loc-sub" style="color:var(--ink5);">🅿️ ' + esc(l.parking) + '</div>' : '');
  const del = document.createElement('button');
  del.className = 'loc-del-btn';
  del.title = 'Remove from saved';
  del.textContent = '✕';
  del.dataset.action = 'delete';
  del.dataset.name = l.name;
  del.dataset.inputId = inputId;
  del.dataset.iid = iid;
  del.dataset.field = field;
  inner.appendChild(info);
  inner.appendChild(del);
  div.appendChild(inner);
  return div;
}

function makeNomItem(displayName, main, sub, inputId, iid, field) {
  const div = document.createElement('div');
  div.className = 'loc-suggest-item';
  div.dataset.action = 'nominatim';
  div.dataset.inputId = inputId;
  div.dataset.iid = iid;
  div.dataset.field = field;
  div.dataset.address = displayName;
  div.innerHTML = '<div class="loc-main">' + esc(main) + '</div>'
    + (sub ? '<div class="loc-sub">' + esc(sub) + '</div>' : '');
  return div;
}

function showLocSuggestions(q, list, inp, iid, field) {
  const roster = getLocRoster();
  const ql = q.toLowerCase();
  const matches = roster.filter(l =>
    l.name.toLowerCase().includes(ql) ||
    (l.address && l.address.toLowerCase().includes(ql))
  );
  list.innerHTML = '';
  if (!matches.length) {
    list.innerHTML = '<div class="loc-searching">Searching…</div>';
    list.classList.add('open');
    return;
  }
  matches.forEach(l => list.appendChild(makeSavedLocItem(l, inp.id, iid, field)));
  const searching = document.createElement('div');
  searching.className = 'loc-searching';
  searching.textContent = 'Searching more…';
  list.appendChild(searching);
  list.classList.add('open');
}

function deleteLocEntry(nameEnc, inputId, iid, field) {
  const name = decodeURIComponent(nameEnc);
  deleteLocationFromRoster(name);
  const inp = document.getElementById(inputId);
  const list = document.getElementById(inputId + '_sug');
  if (inp && list) showLocSuggestions(inp.value.trim(), list, inp, iid, field);
}

async function fetchLocSuggestions(q, list, inp, iid, field) {
  try {
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&q=' + encodeURIComponent(q) + '&addressdetails=1';
    const res  = await fetch(url, { headers:{ 'Accept-Language':'en' } });
    const data = await res.json();
    const roster = getLocRoster();
    const ql = q.toLowerCase();
    const savedMatches = roster.filter(l =>
      l.name.toLowerCase().includes(ql) ||
      (l.address && l.address.toLowerCase().includes(ql))
    );
    list.innerHTML = '';
    savedMatches.forEach(l => list.appendChild(makeSavedLocItem(l, inp.id, iid, field)));
    if (savedMatches.length && data.length) {
      const sep = document.createElement('div');
      sep.className = 'loc-section-label';
      sep.textContent = '🌐 From the web';
      list.appendChild(sep);
    }
    if (data.length) {
      data.forEach(r => {
        const parts = r.display_name.split(', ');
        const main = parts.slice(0,2).join(', ');
        const sub  = parts.slice(2,4).join(', ');
        list.appendChild(makeNomItem(r.display_name, main, sub, inp.id, iid, field));
      });
    } else if (!savedMatches.length) {
      list.innerHTML = '<div class="loc-searching">No results found</div>';
    }
    list.classList.add('open');
  } catch(e) {
    // Keep saved results visible on fetch fail
  }
}

function selectSavedLocationEnc(inputId, iid, nameEnc, addrEnc, parkEnc) {
  selectSavedLocation(inputId, iid, decodeURIComponent(nameEnc), decodeURIComponent(addrEnc), decodeURIComponent(parkEnc));
}

function selectSavedLocation(inputId, iid, name, address, parking) {
  // Fill name
  const nameInp = document.getElementById('locname_' + iid);
  if (nameInp) { nameInp.value = name; updateInstField(iid, 'locationName', name); }
  // Fill address
  const addrInp = document.getElementById('locaddr_' + iid);
  if (addrInp) { addrInp.value = address; updateInstField(iid, 'locationAddress', address); }
  // Fill parking
  const parkInp = document.getElementById('locpark_' + iid);
  if (parkInp) { parkInp.value = parking; updateInstField(iid, 'parkingLocation', parking); }
  // Close all suggestion lists
  document.querySelectorAll('.loc-suggest-list').forEach(el => el.classList.remove('open'));
  refreshLocMap(iid);
  sv();
}

function selectLocationEnc(inputId, iid, field, safeAddr) {
  selectLocation(inputId, iid, field, decodeURIComponent(safeAddr));
}

function selectLocation(inputId, iid, field, address) {
  const inp = document.getElementById(inputId);
  if (inp) inp.value = address;
  updateInstField(iid, field, address);
  const list = document.getElementById(inputId + '_sug');
  if (list) list.classList.remove('open');
  if (field === 'locationName') autoFillAddress(iid, address);
  if (field === 'locationAddress' || field === 'locationName') refreshLocMap(iid);
  // Save to roster whenever a location is confirmed
  _scheduleSaveLocation(iid);
}

function _scheduleSaveLocation(iid) {
  // Kept for use when picking from suggestions
  clearTimeout(_locTimers['_save_' + iid]);
  _locTimers['_save_' + iid] = setTimeout(function() {
    const inst = insts.find(i=>i.id===iid); if (!inst) return;
    if (inst.locationName) saveLocationToRoster(inst.locationName, inst.locationAddress, inst.parkingLocation);
  }, 300);
}

function locCommit(fieldId, iid, field, event) {
  if (event && event.key !== 'Enter') return;
  const inp = document.getElementById(fieldId);
  if (!inp) return;
  const list = document.getElementById(fieldId + '_sug');
  if (list) list.classList.remove('open');
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  // Save latest value of this field first (in case it just changed)
  updateInstField(iid, field, inp.value);
  // Re-read inst after update
  const updInst = insts.find(i=>i.id===iid);
  if (updInst && updInst.locationName) {
    saveLocationToRoster(updInst.locationName, updInst.locationAddress, updInst.parkingLocation);
    toast('📍 Location saved');
  }
  inp.blur();
}

function autoFillAddress(iid, name) {
  // First check if this location is already in the roster — if so, fill all fields from there
  const roster = getLocRoster();
  const saved = roster.find(l => l.name.toLowerCase() === name.trim().toLowerCase());
  if (saved) {
    if (saved.address) {
      updateInstField(iid, 'locationAddress', saved.address);
      const addrInp = document.getElementById('locaddr_' + iid);
      if (addrInp) addrInp.value = saved.address;
    }
    if (saved.parking) {
      updateInstField(iid, 'parkingLocation', saved.parking);
      const parkInp = document.getElementById('locpark_' + iid);
      if (parkInp) parkInp.value = saved.parking;
    }
    refreshLocMap(iid);
    return;
  }
  // Otherwise fetch from Nominatim for address only (no parking info available)
  const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(name) + '&addressdetails=1';
  fetch(url, { headers:{ 'Accept-Language':'en' } })
    .then(r => r.json())
    .then(data => {
      if (!data.length) return;
      const addr = data[0].display_name;
      updateInstField(iid, 'locationAddress', addr);
      const addrInp = document.getElementById('locaddr_' + iid);
      if (addrInp) addrInp.value = addr;
      refreshLocMap(iid);
    }).catch(function(){});
}

function refreshLocMap(iid) { /* map embed removed */ }

function openGoogleMapsSearch(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const q = inst.locationName || inst.locationAddress || '';
  const url = q ? 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(q) : 'https://www.google.com/maps';
  window.open(url, '_blank');
}

// Delegated handler for all location suggestion actions (capture phase so modal stopPropagation can't block it)
document.addEventListener('mousedown', function(e) {
  // Only close if clicking completely outside a loc-suggest-wrap
  if (!e.target.closest('.loc-suggest-wrap')) {
    document.querySelectorAll('.loc-suggest-list').forEach(el => el.classList.remove('open'));
    return;
  }
  // Delete saved location
  const delBtn = e.target.closest('[data-action="delete"]');
  if (delBtn) {
    e.stopPropagation();
    const name = delBtn.dataset.name;
    const inputId = delBtn.dataset.inputId;
    const iid = delBtn.dataset.iid;
    const field = delBtn.dataset.field;
    deleteLocationFromRoster(name);
    const inp = document.getElementById(inputId);
    const list = document.getElementById(inputId + '_sug');
    if (inp && list) showLocSuggestions(inp.value.trim(), list, inp, iid, field);
    return;
  }
  // Select saved location
  const savedItem = e.target.closest('[data-action="saved"]');
  if (savedItem) {
    e.preventDefault();
    selectSavedLocation(savedItem.dataset.inputId, savedItem.dataset.iid,
      savedItem.dataset.name, savedItem.dataset.address, savedItem.dataset.parking);
    return;
  }
  // Select nominatim result
  const nomItem = e.target.closest('[data-action="nominatim"]');
  if (nomItem) {
    e.preventDefault();
    selectLocation(nomItem.dataset.inputId, nomItem.dataset.iid,
      nomItem.dataset.field, nomItem.dataset.address);
    return;
  }
}, true);
function addCrewMember(iid, role) {
  // role: 'photographers' | 'videographers'
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) inst[role] = [''];
  const max = role === 'photographers' ? 4 : 4;
  if (inst[role].length >= max) {
    inst[role].push(''); // allow more if user explicitly clicks + Add
  } else {
    inst[role].push('');
  }
  sv(); rerenderCrewBlock(iid, role);
  updateSvcCounts(iid);
}

function updateCrewMember(iid, role, idx, val) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) inst[role] = [];
  inst[role][idx] = val;
  sv();
  if (val.trim()) saveCrewName(role, val.trim());
  patchSummaryEvent(iid);
}

function removeCrewMember(iid, role, idx) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) return;
  inst[role].splice(idx, 1);
  if (!inst[role].length) inst[role] = [''];
  sv(); rerenderCrewBlock(iid, role);
  updateSvcCounts(iid);
}

function rerenderCrewBlock(iid, role) {
  const el = document.getElementById('crewblock_'+role+'_'+iid);
  if (!el) return;
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  el.innerHTML = buildCrewRows(iid, role, inst[role]||['']);
  renderSections();
}

function updateSvcCounts(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  // Count slots (rows), not filled names — field appearing = counts
  const photoCount = (inst.photographers||['']).length;
  const videoCount = (inst.videographers||['']).length;
  // Update all count badges for this inst (card + modal)
  ['svcprompt_'+iid, 'sb'+iid].forEach(function(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const btns = container.querySelectorAll('.ev-svc-btn');
    btns.forEach(function(btn) {
      const badge = btn.querySelector('.ev-svc-count');
      if (!badge) return;
      const isPhoto = btn.textContent.includes('Photo');
      const newCount = isPhoto ? photoCount : videoCount;
      const oldCount = parseInt(badge.textContent) || 0;
      if (newCount === oldCount) return;
      // Animate: scale down → update → scale up
      badge.style.transition = 'transform .12s ease, opacity .12s ease';
      badge.style.transform = 'scale(0.5)';
      badge.style.opacity = '0.3';
      setTimeout(function() {
        badge.textContent = newCount;
        badge.style.transform = 'scale(1.25)';
        badge.style.opacity = '1';
        setTimeout(function() {
          badge.style.transform = 'scale(1)';
        }, 120);
      }, 100);
    });
  });
}

function buildCrewRows(iid, role, members) {
  const icon  = role==='photographers' ? '📷' : '🎥';
  const ph    = role==='photographers' ? 'Photographer name…' : 'Videographer name…';
  const camKey = role==='photographers' ? 'photographerCameras' : 'videographerCameras';
  const inst  = insts.find(i=>i.id===iid) || {};
  const cams  = inst[camKey] || [];
  return members.map((name, idx) => {
    const canRemove = members.length > 1;
    const inpId  = 'crewinp_'+role+'_'+iid+'_'+idx;
    const listId = 'crewsug_'+role+'_'+iid+'_'+idx;
    const isNA   = name === 'N/A';
    const camVal = cams[idx] || '';
    return `<div class="ev-crew-row" style="flex-wrap:wrap;gap:.3rem;">
      <span style="font-size:.7rem;color:var(--ink5);flex-shrink:0;min-width:24px;">${icon} ${idx+1}</span>
      ${isNA
        ? `<span class="crew-na-chip" onclick="setCrewNA('${iid}','${role}',${idx},false)" title="Click to assign someone">N/A — click to assign</span>`
        : `<div class="crew-suggest-wrap" style="flex:1;min-width:120px;">
            <input class="ev-prod-input" type="text" id="${inpId}" placeholder="${ph}"
              value="${esc(name)}" autocomplete="off"
              onfocus="openCrewSuggest('${iid}','${role}',${idx},this)"
              oninput="filterCrewSuggest('${iid}','${role}',${idx},this)">
            <div class="crew-suggest-list" id="${listId}"></div>
          </div>`
      }
      ${!isNA ? `<div style="display:flex;align-items:center;gap:.25rem;flex-shrink:0;">
        <span style="font-size:.6rem;color:var(--ink4);white-space:nowrap;">🎬 Cams</span>
        <input class="ev-prod-input" type="number" min="1" max="10" placeholder="1"
          style="width:3.2rem;text-align:center;"
          value="${esc(String(camVal))}"
          oninput="updateCrewCameras('${iid}','${camKey}',${idx},this.value)">
      </div>` : ''}
      <button class="crew-na-btn${isNA?' active':''}" onclick="setCrewNA('${iid}','${role}',${idx},${!isNA})" title="N/A toggle">N/A</button>
      ${canRemove ? `<button class="ev-crew-remove" onclick="removeCrewMember('${iid}','${role}',${idx})" title="Remove">✕</button>` : '<span style="width:22px;flex-shrink:0;"></span>'}
    </div>`;
  }).join('');
}

function updateCrewCameras(iid, camKey, idx, val) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[camKey]) inst[camKey] = [];
  inst[camKey][idx] = val ? parseInt(val) : '';
  sv();
  patchSummaryEvent(iid);
}

function setCrewNA(iid, role, idx, makeNA) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst[role]) inst[role] = [''];
  inst[role][idx] = makeNA ? 'N/A' : '';
  sv(); rerenderCrewBlock(iid, role);
}

function addVendor(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  if (!inst.vendors) inst.vendors = [];
  inst.vendors.push({ type:'', name:'' });
  sv(); rerenderVendors(iid);
}

function updateVendor(iid, idx, field, val) {
  const inst = insts.find(i=>i.id===iid); if (!inst||!inst.vendors) return;
  inst.vendors[idx][field] = val;
  sv();
}

function removeVendor(iid, idx) {
  const inst = insts.find(i=>i.id===iid); if (!inst||!inst.vendors) return;
  inst.vendors.splice(idx, 1);
  sv(); rerenderVendors(iid);
}

function rerenderVendors(iid) {
  const el = document.getElementById('vendorrows_'+iid); if (!el) return;
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  el.innerHTML = buildVendorRows(iid, inst.vendors||[]);
}

function buildVendorRows(iid, vendors) {
  if (!vendors.length) return '<div style="font-size:.68rem;font-style:italic;color:var(--ink5);padding:.2rem 0;">No vendors added yet.</div>';
  return vendors.map(function(v, idx) {
    var row = document.createElement('div');
    row.className = 'ev-vendor-row';
    row.innerHTML =
      '<input class="ev-prod-input ev-vendor-type" type="text" placeholder="Type (DJ, Décor…)" value="' + esc(v.type||'') + '" oninput="updateVendor(\'' + iid + '\',' + idx + ',\'type\',this.value)">' +
      '<input class="ev-prod-input" type="text" placeholder="Vendor name…" value="' + esc(v.name||'') + '" oninput="updateVendor(\'' + iid + '\',' + idx + ',\'name\',this.value)">' +
      '<button class="ev-crew-remove" onclick="removeVendor(\'' + iid + '\',' + idx + ')" title="Remove">✕</button>';
    return row.outerHTML;
  }).join('');
}
function buildSec(inst) {
  const isApproved = !!inst.approved;
  const ss   = songs.filter(s=>s.instanceId===inst.id).sort((a,b)=>(a.order||0)-(b.order||0));
  const u    = ss.filter(s=>s.used).length, av = ss.length - u;
  const dups = getDupSet();

  const rows = ss.length ? ss.map(s => {
    const isDup  = dups.has(s.title.trim().toLowerCase());
    const sGenres = getSongGenres(s, inst.eventType);
    const langPicker = `<span class="song-lang-pick" title="Select all that apply — click to toggle">
      <button class="slpbtn${sGenres.includes('en')?' on':''}" data-lang="en" onclick="setSongLang('${s.id}',this,'en')" title="English">EN</button>
      <button class="slpbtn${sGenres.includes('hi')?' on':''}" data-lang="hi" onclick="setSongLang('${s.id}',this,'hi')" title="Hindi">HI</button>
      <button class="slpbtn${sGenres.includes('pa')?' on':''}" data-lang="pa" onclick="setSongLang('${s.id}',this,'pa')" title="Punjabi">PA</button>
      <button class="slpbtn${sGenres.includes('inst')?' on':''}" data-lang="inst" onclick="setSongLang('${s.id}',this,'inst')" title="Instrumental">🎻</button>
    </span>`;
    return `
    <div class="song-item${s.used?' used':''}${isApproved?' approved-item':''}" data-sid="${s.id}">
      <div class="song-drag-handle" title="Drag to reorder">⠿</div>
      <button class="ck-btn${s.used?' on':''}" onclick="toggleUsed('${s.id}')">${s.used?'✓':''}</button>
      <div class="s-info">
        <div class="s-title${s.used?' strike':''}">${esc(s.title)}${isDup?'<span class="dup-badge">DUP</span>':''}</div>
        ${s.artist ? `<div class="s-artist">${esc(s.artist)}</div>` : ''}
      </div>
      ${langPicker}
      <div class="s-used">${s.usedAt ? 'Used '+s.usedAt : ''}</div>
      <button class="rm-song" onclick="rmSong('${s.id}')">✕</button>
    </div>`;
  }).join('')
    : '<div class="empty-ev">No songs yet — add one below</div>';

  const isShootApproved  = _isInstShootDone(inst);
  const isPhotoShootDone = !!(inst.photoShootApproved);
  const isVideoShootDone = !!(inst.videoShootApproved);
  const hasPhotographer = (inst.photographers||[]).some(p=>p&&p.trim()&&p!=='N/A');
  const hasVideographer = (inst.videographers||[]).some(v=>v&&v.trim()&&v!=='N/A');
  const hasShooter = hasPhotographer || hasVideographer || (inst.shooter&&inst.shooter.trim()&&inst.shooter!=='N/A');
  // Service flags — purely from selection, not from crew
  const showPhoto = !!(inst.servicePhoto || inst.services==='photo' || inst.services==='both');
  const showVideo = !!(inst.serviceVideo || inst.services==='video' || inst.services==='both');
  // Received buttons also appear if crew was added even without service selection
  const showImagesBtn = showPhoto;
  const showFootageBtn = showVideo;
  const isPhotoEditDone = !!inst.photoEditApproved;
  const isVideoEditDone = !!inst.videoEditApproved;
  const changesFlag = inst.changesNeeded
    ? `<span class="ev-changes-flag" onclick="clearChangesFlag('${inst.id}')" title="Changes needed — click to resolve">🔄 Changes · Resolve</span>`
    : '';
  const photoChgCount = inst.photoChangesCount || 0;
  const videoChgCount = inst.videoChangesCount || 0;
  const photoChgRounds = photoChgCount > 1 ? ' \xd7' + photoChgCount : '';
  const videoChgRounds = videoChgCount > 1 ? ' \xd7' + videoChgCount : '';
  const photoChangesFlag = inst.photoChangesNeeded
    ? `<span class="ev-changes-flag">✂️📷🔄${photoChgRounds} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearPhotoChanges('${inst.id}')">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoPhotoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></span>`
    : (photoChgCount > 0 ? `<span class="ev-changes-flag ev-changes-resolved">📷 ${photoChgCount}\xd7 done <span class="ev-chg-undo" onclick="event.stopPropagation();decrementPhotoChanges('${inst.id}')" title="Reduce count">−</span></span>` : '');
  const videoChangesFlag = inst.videoChangesNeeded
    ? `<span class="ev-changes-flag">✂️🎥🔄${videoChgRounds} <span class="ev-chg-resolve" onclick="event.stopPropagation();clearVideoChanges('${inst.id}')">Resolve</span><span class="ev-chg-undo" onclick="event.stopPropagation();undoVideoChanges('${inst.id}')" title="Remove — was a mistake">✕</span></span>`
    : (videoChgCount > 0 ? `<span class="ev-changes-flag ev-changes-resolved">🎥 ${videoChgCount}\xd7 done <span class="ev-chg-undo" onclick="event.stopPropagation();decrementVideoChanges('${inst.id}')" title="Reduce count">−</span></span>` : '');
  // ── Drag-reorderable buttons ───────────────────────────────────────────────
  const _iid = inst.id;
  const _DH = '<span class="ev-btn-drag-handle">&#x2807;</span>';
  const _undo = '<span style="opacity:.6;font-size:.58rem;margin-left:.3rem;">&#x21a9;</span>';
  const _btnMap = {};
  _btnMap['photoShot'] = showPhoto
    ? '<button class="ev-approve-btn ev-draggable shoot-btn' + (isPhotoShootDone ? ' approved' : '') + '" data-bid="photoShot" onclick="event.stopPropagation();togglePhotoShoot(\'' + _iid + '\')">' + _DH + (isPhotoShootDone ? '<span>📷 Photo Shot' + (inst.photoShootApprovedAt ? ' · ' + inst.photoShootApprovedAt : '') + '</span>' + _undo : '<span>📷 Photo Shot</span>') + '</button>'
    : null;
  _btnMap['videoShot'] = showVideo
    ? '<button class="ev-approve-btn ev-draggable shoot-btn' + (isVideoShootDone ? ' approved' : '') + '" data-bid="videoShot" onclick="event.stopPropagation();toggleVideoShoot(\'' + _iid + '\')">' + _DH + (isVideoShootDone ? '<span>🎥 Video Shot' + (inst.videoShootApprovedAt ? ' · ' + inst.videoShootApprovedAt : '') + '</span>' + _undo : '<span>🎥 Video Shot</span>') + '</button>'
    : null;
  const hasLegacyShooter = !!(inst.shooter && inst.shooter.trim() && inst.shooter !== 'N/A');
  _btnMap['shootDone'] = (!showPhoto && !showVideo && hasLegacyShooter)
    ? '<button class="ev-approve-btn ev-draggable shoot-btn' + (isShootApproved ? ' approved' : '') + '" data-bid="shootDone" onclick="event.stopPropagation();toggleShootApproval(\'' + _iid + '\')">' + _DH + (isShootApproved ? '<span>📷 Shoot Done' + (inst.shootApprovedAt ? ' · ' + inst.shootApprovedAt : '') + '</span>' + _undo : '<span>📷 Shoot Done</span>') + '</button>'
    : null;
  _btnMap['photoEdit'] = showPhoto
    ? '<button class="ev-approve-btn ev-draggable' + (isPhotoEditDone ? ' approved' : '') + '" data-bid="photoEdit" onclick="event.stopPropagation();togglePhotoEdit(\'' + _iid + '\')">' + _DH + (isPhotoEditDone ? '<span>✂️📷 Photo Edited' + (inst.photoEditApprovedAt ? ' · ' + inst.photoEditApprovedAt : '') + '</span>' + _undo : '<span>✂️📷 Photo Edit</span>') + '</button>' + photoChangesFlag
    : null;
  _btnMap['videoEdit'] = showVideo
    ? '<button class="ev-approve-btn ev-draggable' + (isVideoEditDone ? ' approved' : '') + '" data-bid="videoEdit" onclick="event.stopPropagation();toggleVideoEdit(\'' + _iid + '\')">' + _DH + (isVideoEditDone ? '<span>✂️🎥 Video Edited' + (inst.videoEditApprovedAt ? ' · ' + inst.videoEditApprovedAt : '') + '</span>' + _undo : '<span>✂️🎥 Video Edit</span>') + '</button>' + videoChangesFlag
    : null;
  _btnMap['editDone'] = (!showPhoto && !showVideo && hasLegacyShooter)
    ? '<button class="ev-approve-btn ev-draggable' + (isApproved ? ' approved' : '') + '" data-bid="editDone" onclick="event.stopPropagation();toggleApproval(\'' + _iid + '\')">' + _DH + (isApproved ? '<span>✂️ Edit Done' + (inst.approvedAt ? ' · ' + inst.approvedAt : '') + '</span>' + _undo : '<span>✂️ Edit Done</span>') + '</button>' + changesFlag
    : null;
  _btnMap['footage'] = showFootageBtn
    ? '<button class="ev-approve-btn ev-draggable" data-bid="footage" id="ftgBtn_' + _iid + '" onclick="event.stopPropagation();toggleFootage(\'' + _iid + '\')" style="font-size:.6rem;' + (inst.footageReceived ? 'background:rgba(59,111,196,.08);border-color:rgba(59,111,196,.35);color:#3b6fc4;' : '') + '">' + _DH + (inst.footageReceived ? '<span>📦 Footage In' + (inst.footageReceivedAt ? ' · ' + inst.footageReceivedAt : '') + '</span>' + _undo : '<span>📦 Footage</span>') + '</button>'
    : null;
  _btnMap['images'] = showImagesBtn
    ? '<button class="ev-approve-btn ev-draggable" data-bid="images" id="imgBtn_' + _iid + '" onclick="event.stopPropagation();toggleImages(\'' + _iid + '\')" style="font-size:.6rem;' + (inst.imagesReceived ? 'background:rgba(59,111,196,.08);border-color:rgba(59,111,196,.35);color:#3b6fc4;' : '') + '">' + _DH + (inst.imagesReceived ? '<span>🖼 Images In' + (inst.imagesReceivedAt ? ' · ' + inst.imagesReceivedAt : '') + '</span>' + _undo : '<span>🖼 Images</span>') + '</button>'
    : null;
  _btnMap['pause'] = (showPhoto || showVideo) ? '<button class="ev-pause-btn ev-draggable' + (inst.editPaused ? ' paused' : '') + '" data-bid="pause" onclick="event.stopPropagation();toggleEditPause(\'' + _iid + '\')">' + _DH + (inst.editPaused ? '⏸ Paused ↩' : '⏸ Pause') + '</button>' : null;
  _btnMap['upcoming'] = (showPhoto || showVideo) ? '<button class="ev-pause-btn ev-draggable' + (inst.editUpcoming ? ' paused' : '') + '" data-bid="upcoming" style="' + (inst.editUpcoming ? 'background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.2);color:#1d4ed8;' : '') + '" onclick="event.stopPropagation();toggleEditUpcoming(\'' + _iid + '\')">' + _DH + (inst.editUpcoming ? '🔜 Upcoming ↩' : '🔜 Upcoming') + '</button>' : null;
  const _defaultOrder = ['photoShot','videoShot','shootDone','photoEdit','videoEdit','editDone','footage','images','pause','upcoming'];
  const _active = _defaultOrder.filter(k => _btnMap[k] != null);
  const _saved = (inst.buttonOrder || []).filter(k => _active.includes(k));
  const _ordered = [..._saved, ..._active.filter(k => !_saved.includes(k))];
  // Fixed 3-row grouping: shoot | edit | utility
  const _shootKeys = ['photoShot','videoShot','shootDone'];
  const _editKeys  = ['photoEdit','videoEdit','editDone'];
  const _utilKeys  = ['footage','images','pause','upcoming'];
  const _bothServices = showPhoto && showVideo;
  let _rowGroups;
  if (_bothServices) {
    // 3 rows: shoot | edit | utility
    const _row1 = _ordered.filter(k => _shootKeys.includes(k));
    const _row2 = _ordered.filter(k => _editKeys.includes(k));
    const _row3 = _ordered.filter(k => _utilKeys.includes(k));
    _rowGroups = [_row1, _row2, _row3].filter(r => r.length > 0);
  } else {
    // 2 rows: shoot+edit together | utility
    const _row1 = _ordered.filter(k => _shootKeys.includes(k) || _editKeys.includes(k));
    const _row2 = _ordered.filter(k => _utilKeys.includes(k));
    _rowGroups = [_row1, _row2].filter(r => r.length > 0);
  }
  const _rowsHtml = _rowGroups.map(rk =>
    '<div class="ev-approve-row">' +
    rk.map(k => '<span class="ev-btn-wrap" draggable="true" data-bid="' + k + '" data-iid="' + _iid + '">' + _btnMap[k] + '</span>').join('') +
    '</div>'
  ).join('');
  const approveBtn      = '<div class="ev-approve-rows" id="evBtns_'  + _iid + '">' + _rowsHtml + '</div>';
  const approveBtnModal = '<div class="ev-approve-rows" id="evBtnsM_' + _iid + '">' + _rowsHtml + '</div>';
  // ── Build crew rows ──────────────────────────────────────
  const photographers  = inst.photographers && inst.photographers.length ? inst.photographers : [''];
  const videographers  = inst.videographers && inst.videographers.length ? inst.videographers : [''];
  const vendors        = inst.vendors || [];
  const maxCrew        = 4;

  // ── Shooting pane ────────────────────────────────────────
  const shootPane = `
  <div class="ev-crew-section">
    ${showPhoto ? `<div class="ev-crew-block">
      <div class="ev-crew-block-head">
        <span class="ev-crew-block-label">📷 Photographers</span>
        <button class="ev-crew-add-btn" onclick="addCrewMember('${inst.id}','photographers')">+ Add</button>
      </div>
      <div class="ev-crew-rows" id="crewblock_photographers_${inst.id}">
        ${buildCrewRows(inst.id, 'photographers', photographers)}
      </div>
    </div>` : ''}
    ${showVideo ? `<div class="ev-crew-block">
      <div class="ev-crew-block-head">
        <span class="ev-crew-block-label">🎥 Videographers</span>
        <button class="ev-crew-add-btn" onclick="addCrewMember('${inst.id}','videographers')">+ Add</button>
      </div>
      <div class="ev-crew-rows" id="crewblock_videographers_${inst.id}">
        ${buildCrewRows(inst.id, 'videographers', videographers)}
      </div>
    </div>` : ''}
    ${!showPhoto && !showVideo ? `<div style="font-size:.7rem;color:var(--ink4);padding:.5rem .2rem;font-style:italic;">Select a service above to see crew fields.</div>` : ''}
  </div>
  ${showVideo ? `<div class="ev-audio-req">
    <div class="ev-audio-req-label">🎙 Audio Capture</div>
    ${buildAudioRows(inst.id, 'source',    inst.audioSource    || [], '🔊', 'Source Audio')}
    ${buildAudioRows(inst.id, 'lav',       inst.audioLav       || [], '🎤', 'Lav / Lapel Mic')}
    ${buildAudioRows(inst.id, 'interview', inst.audioInterview || [], '🎬', 'Interviews')}
  </div>` : ''}
  <div class="ev-prod-grid">
    <div class="ev-prod-field">
      <span class="ev-prod-label">📅 Shoot Day</span>
      <input class="ev-prod-input" type="date"
        value="${esc(inst.shootDay||'')}"
        onblur="updateInstField('${inst.id}','shootDay',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
      <div class="ev-date-quick" id="dq_${inst.id}"></div>
    </div>
    <div class="ev-prod-field">
      <span class="ev-prod-label">⏱ Shoot Time</span>
      <div class="ev-prod-time">
        <input class="ev-prod-input" type="time" style="width:auto;flex:1;"
          value="${esc(inst.timeFrom||'')}"
          onblur="updateInstField('${inst.id}','timeFrom',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
        <span>–</span>
        <input class="ev-prod-input" type="time" style="width:auto;flex:1;"
          value="${esc(inst.timeTo||'')}"
          onblur="updateInstField('${inst.id}','timeTo',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
      </div>
    </div>
    <div class="ev-prod-field">
      <span class="ev-prod-label">📋 Edit Due Date</span>
      <div style="display:flex;gap:.4rem;align-items:center;">
        <input class="ev-prod-input" type="text" placeholder="e.g. 90d, 3m"
          style="width:4.5rem;flex:none;text-align:center;"
          id="dueQuick_${inst.id}"
          value="${inst.erDueDuration || ''}"
          onkeydown="if(event.key==='Enter'){applyDueDuration('${inst.id}',this.value);this.blur();}"
          onblur="applyDueDuration('${inst.id}',this.value)">
        <input class="ev-prod-input" type="date" style="flex:1;"
          id="dueCal_${inst.id}"
          value="${esc(inst.erDueDate || (inst.shootDay ? new Date(new Date(inst.shootDay+'T00:00:00').getTime()+90*86400000).toISOString().slice(0,10) : ''))}"
          onchange="updateInstField('${inst.id}','erDueDate',this.value);clearDueDuration('${inst.id}');">
      </div>
      <div style="font-size:.48rem;color:var(--ink5);margin-top:.15rem;">Type days (90d) or months (3m) from shoot, or pick a date</div>
    </div>
    ${showVideo ? `<div class="ev-backup-block">
      <div class="ev-footage-row">
        <button class="ev-footage-btn${inst.footageReceived?' received':''}"
          onclick="toggleFootage('${inst.id}')">
          ${inst.footageReceived ? '📦 Footage Received ↩' : '📦 Mark Footage Received'}
        </button>
        ${inst.footageReceived && inst.footageReceivedAt
          ? `<span class="ev-footage-date">Received ${esc(inst.footageReceivedAt)}</span>`
          : ''}
      </div>
      ${inst.footageReceived ? `
      <div class="ev-backup-fields">
        <div class="ev-prod-field" style="flex:1;">
          <span class="ev-prod-label">💾 Backed up to</span>
          <input class="ev-prod-input" type="text" placeholder="e.g. WD My Passport / NAS Drive 2…"
            value="${esc(inst.footageBackupLocation||'')}"
            onblur="updateInstField('${inst.id}','footageBackupLocation',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
        </div>
        <label class="ev-backup-check">
          <input type="checkbox" ${inst.footageDoubleBackup?'checked':''} onchange="updateInstField('${inst.id}','footageDoubleBackup',this.checked)">
          <span>☁️ Double backed up online</span>
        </label>
      </div>` : ''}
    </div>` : ''}
    ${showPhoto ? `<div class="ev-backup-block">
      <div class="ev-footage-row">
        <button class="ev-footage-btn${inst.imagesReceived?' received':''}"
          onclick="toggleImages('${inst.id}')">
          ${inst.imagesReceived ? '🖼 Images Received ↩' : '🖼 Mark Images Received'}
        </button>
        ${inst.imagesReceived && inst.imagesReceivedAt
          ? `<span class="ev-footage-date">Received ${esc(inst.imagesReceivedAt)}</span>`
          : ''}
      </div>
      ${inst.imagesReceived ? `
      <div class="ev-backup-fields">
        <div class="ev-prod-field" style="flex:1;">
          <span class="ev-prod-label">💾 Backed up to</span>
          <input class="ev-prod-input" type="text" placeholder="e.g. WD My Passport / NAS Drive 2…"
            value="${esc(inst.imagesBackupLocation||'')}"
            onblur="updateInstField('${inst.id}','imagesBackupLocation',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
        </div>
        <label class="ev-backup-check">
          <input type="checkbox" ${inst.imagesDoubleBackup?'checked':''} onchange="updateInstField('${inst.id}','imagesDoubleBackup',this.checked)">
          <span>☁️ Double backed up online</span>
        </label>
      </div>` : ''}
    </div>` : ''}
    <div class="ev-prod-field full">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.35rem;">
        <span class="ev-prod-label" style="margin-bottom:0;">📍 Location Name</span>
        <button class="loc-maps-btn" onclick="openGoogleMapsSearch('${inst.id}')" title="Search on Google Maps">🗺 Google Maps</button>
      </div>
      <div class="loc-suggest-wrap">
        <input class="ev-prod-input" type="text" id="locname_${inst.id}" placeholder="e.g. The Grand Banquet Hall"
          value="${esc(inst.locationName||'')}" autocomplete="off"
          oninput="locInput('locname_${inst.id}','${inst.id}','locationName')"
          onkeydown="if(event.key==='Enter'){locSearch('locname_${inst.id}','${inst.id}','locationName');}locCommit('locname_${inst.id}','${inst.id}','locationName',event)">
        <div class="loc-suggest-list" id="locname_${inst.id}_sug"></div>
      </div>
    </div>
    <div class="ev-prod-field full">
      <span class="ev-prod-label">🗺 Location Address</span>
      <div class="loc-suggest-wrap">
        <input class="ev-prod-input" type="text" id="locaddr_${inst.id}" placeholder="Full address…"
          value="${esc(inst.locationAddress||'')}" autocomplete="off"
          oninput="locInput('locaddr_${inst.id}','${inst.id}','locationAddress')"
          onkeydown="if(event.key==='Enter'){locSearch('locaddr_${inst.id}','${inst.id}','locationAddress');}locCommit('locaddr_${inst.id}','${inst.id}','locationAddress',event)">
        <div class="loc-suggest-list" id="locaddr_${inst.id}_sug"></div>
      </div>
    </div>

    <div class="ev-prod-field full">
      <span class="ev-prod-label">🅿️ Parking Location</span>
      <div class="loc-suggest-wrap">
        <input class="ev-prod-input" type="text" id="locpark_${inst.id}" placeholder="Parking notes or address…"
          value="${esc(inst.parkingLocation||'')}" autocomplete="off"
          oninput="locInput('locpark_${inst.id}','${inst.id}','parkingLocation')"
          onkeydown="if(event.key==='Enter'){locSearch('locpark_${inst.id}','${inst.id}','parkingLocation');}locCommit('locpark_${inst.id}','${inst.id}','parkingLocation',event)">
        <div class="loc-suggest-list" id="locpark_${inst.id}_sug"></div>
      </div>
    </div>
  </div>
`;

  // ── Editing pane ─────────────────────────────────────────
  const editPane = `
  <div class="ev-prod-grid">
    ${showPhoto ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">📷 Photo Editor</span>
      <input class="ev-prod-input" type="text" placeholder="Photo editor name…"
        value="${esc(inst.photoEditor||inst.editor||'')}"
        onblur="updateInstField('${inst.id}','photoEditor',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
    ${showVideo ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">🎥 Video Editor</span>
      <input class="ev-prod-input" type="text" placeholder="Video editor name…"
        value="${esc(inst.videoEditor||inst.editor||'')}"
        onblur="updateInstField('${inst.id}','videoEditor',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
    ${!showPhoto && !showVideo ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">✂️ Editor</span>
      <input class="ev-prod-input" type="text" placeholder="Editor name…"
        value="${esc(inst.editor||'')}"
        onblur="updateInstField('${inst.id}','editor',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
    ${showPhoto ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">📷 Photo Drive / Project Location</span>
      <input class="ev-prod-input" type="text" placeholder="e.g. Samsung T7 / MacBook Internal…"
        value="${esc(inst.photoEditingDrive||inst.editingDrive||'')}"
        onblur="updateInstField('${inst.id}','photoEditingDrive',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
    ${showVideo ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">🎥 Video Drive / Project Location</span>
      <input class="ev-prod-input" type="text" placeholder="e.g. WD Black / NAS Drive 2…"
        value="${esc(inst.videoEditingDrive||inst.editingDrive||'')}"
        onblur="updateInstField('${inst.id}','videoEditingDrive',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
    ${!showPhoto && !showVideo ? `<div class="ev-prod-field full">
      <span class="ev-prod-label">💽 Editing Drive / Project Location</span>
      <input class="ev-prod-input" type="text" placeholder="e.g. Samsung T7 Black / MacBook Internal / NAS…"
        value="${esc(inst.editingDrive||'')}"
        onblur="updateInstField('${inst.id}','editingDrive',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">
    </div>` : ''}
  </div>`;

  // ── Tabbed wrapper ────────────────────────────────────────
  const _activeTab = _evTabState[inst.id] || 'shoot';
  const prodSection = `
  <div class="ev-info-tabs">
    <button class="ev-info-tab${_activeTab==='shoot'?' active':''}" id="etab_shoot_${inst.id}" onclick="switchEvTab('${inst.id}','shoot')">📷 Shooting</button>
    <button class="ev-info-tab${_activeTab==='edit'?' active':''}" id="etab_edit_${inst.id}" onclick="switchEvTab('${inst.id}','edit')">✂️ Editing</button>
  </div>
  <div class="ev-info-pane${_activeTab==='shoot'?' active':''}" id="epane_shoot_${inst.id}">${shootPane}</div>
  <div class="ev-info-pane${_activeTab==='edit'?' active':''}" id="epane_edit_${inst.id}">${editPane}</div>`;

  // Notes section
  const notesSection = `
  <div class="ev-notes-section">
    <div class="ev-notes-label">📝 Notes</div>
    <textarea class="ev-notes-textarea"
      placeholder="Add notes about this event, client requests, special instructions…"
      onblur="updateInstField('${inst.id}','notes',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()"
    >${esc(inst.notes||'')}</textarea>
  </div>`;

  // Song Change Log section
  const changelog = inst.changelog || [];
  const clOpen = openSec['cl_'+inst.id] !== false && changelog.length > 0;
  const clEntries = changelog.length ? changelog.map((entry, ei) => {
    const songRows = (entry.songs||[]).map((s,si)=>`
      <div class="ev-changelog-song">
        <span class="ev-changelog-song-num">${si+1}</span>
        <span class="ev-changelog-song-title">${esc(s.title)}</span>
        ${s.artist ? `<span class="ev-changelog-song-artist">— ${esc(s.artist)}</span>` : ''}
      </div>`).join('');
    return `<div class="ev-changelog-entry">
      <div class="ev-changelog-entry-head">
        <span class="ev-changelog-date">📅 ${esc(entry.date)}</span>
        <button class="ev-changelog-btn" style="font-size:.55rem;padding:.18rem .45rem;color:var(--ink5);" onclick="event.stopPropagation();removeChangelog('${inst.id}',${ei})">✕ Remove</button>
      </div>
      ${entry.note ? `<div class="ev-changelog-note-text">"${esc(entry.note)}"</div>` : ''}
      <div class="ev-changelog-songs">${songRows || '<span style="font-size:.68rem;color:var(--ink5);font-style:italic;">No songs in snapshot.</span>'}</div>
    </div>`;
  }).join('') : `<div class="ev-changelog-empty">No snapshots yet. Save a copy of the current songs before the client makes changes.</div>`;

  const changelogSection = `
  <div class="ev-changelog-section">
    <div class="ev-changelog-head" onclick="toggleChangelog('${inst.id}')">
      <span class="ev-changelog-title">🔄 Client Change Log <span style="opacity:.6;font-weight:400;text-transform:none;letter-spacing:0;font-size:.58rem;">— original song snapshots</span></span>
      <div style="display:flex;align-items:center;gap:.6rem;" onclick="event.stopPropagation()">
        ${changelog.length ? `<span class="ev-changelog-count">${changelog.length} snapshot${changelog.length!==1?'s':''}</span>` : ''}
        <button class="ev-changelog-btn" onclick="snapshotSongs('${inst.id}')">📸 Snapshot Current Songs</button>
      </div>
    </div>
    <div class="ev-changelog-body${clOpen?' open':''}" id="clb${inst.id}">
      <div class="ev-cl-snapshot-wrap" style="margin-bottom:.7rem;padding-bottom:.7rem;border-bottom:1px solid var(--rule);">
        <input class="ev-cl-note-input" id="cln${inst.id}" placeholder="Optional note — e.g. 'Client requested changes on call 20 Feb'…">
        <button class="btn btn-outline btn-sm" onclick="snapshotSongsFromInput('${inst.id}')">+ Save with Note</button>
      </div>
      ${clEntries}
    </div>
  </div>`;

  const isBothDone = isApproved && isShootApproved;
  return `
  <div class="ev-section${isBothDone?' approved':isApproved?' edit-done':isShootApproved?' shoot-done':''}" data-iid="${inst.id}" onclick="if(!event.target.closest('.ev-svc-btn')&&!event.target.closest('.ev-approve-rows'))openEvModal('${inst.id}')" style="cursor:pointer;">
    <div class="ev-head">
      <div class="ev-head-top">
        <div class="ev-drag-handle" data-iid="${inst.id}" title="Drag to reorder" onclick="event.stopPropagation()">⠿</div>
        <div class="ev-name-wrap">
          <div class="ev-name-edit-wrap">
            <div class="ev-name" id="evn${inst.id}" onclick="event.stopPropagation();startEvNameEdit('${inst.id}')" title="Click to rename" style="cursor:pointer;">${esc(inst.eventType)}${isApproved?'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--forest);margin-left:.4rem;vertical-align:middle;"></span>':''}${isShootApproved?'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#3b6fc4;margin-left:.3rem;vertical-align:middle;"></span>':''}</div>
          </div>
          <div class="ev-client" data-b="${inst.id}">${inst.client ? '👤 '+esc(inst.client) : ''}</div>
        </div>
        <div class="ev-meta" style="flex:1;">
          ${av>0 ? `<span class="pill pill-a">${av} available</span>` : ''}
          ${u>0  ? `<span class="pill pill-u">${u} used</span>` : ''}
        </div>
        ${_isAdmin() ? `<button class="rm-inst" onclick="event.stopPropagation();rmInst('${inst.id}')">Remove</button>` : ''}
        <span class="chev">▼</span>
      </div>
    </div>
    <div class="ev-svc-prompt" id="svcprompt_${inst.id}">
      <span class="ev-svc-prompt-label">Services</span>
      <button class="ev-svc-btn${(inst.servicePhoto||inst.services==='photo'||inst.services==='both')?' active':''}" onclick="setServices('${inst.id}','photo')">📷 Photo <span class="ev-svc-count">${photographers.length}</span></button>
      <button class="ev-svc-btn${(inst.serviceVideo||inst.services==='video'||inst.services==='both')?' active':''}" onclick="setServices('${inst.id}','video')">🎥 Video <span class="ev-svc-count">${videographers.length}</span></button>
    </div>
    ${approveBtn}
    <div id="sb${inst.id}" style="display:none">

      <div class="ev-svc-bar" id="svcbar_${inst.id}">
        <span class="ev-svc-bar-label">🎬 Services</span>
        <button class="ev-svc-btn${(inst.servicePhoto||inst.services==='photo'||inst.services==='both')?' active':''}" onclick="setServices('${inst.id}','photo')">📷 Photo <span class="ev-svc-count">${photographers.length}</span></button>
        <button class="ev-svc-btn${(inst.serviceVideo||inst.services==='video'||inst.services==='both')?' active':''}" onclick="setServices('${inst.id}','video')">🎥 Video <span class="ev-svc-count">${videographers.length}</span></button>
      </div>

      <div class="ev-panels-wrap" id="evPanelsWrap_${inst.id}" data-iid="${inst.id}">

      <div class="ev-panel ev-panel-draggable" draggable="true" data-panel="status" id="evp_status_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_status_${inst.id}',event)">
          <span class="ev-panel-title">⚡ Status &amp; Actions</span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" style="padding:.6rem .85rem;" onclick="event.stopPropagation()">
          ${approveBtnModal}
        </div>
      </div>

      <div class="ev-panel ev-panel-draggable" draggable="true" data-panel="info" id="evp_info_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_info_${inst.id}',event)">
          <span class="ev-panel-title">👤 Event Info</span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" onclick="event.stopPropagation()">
          <div class="cl-row" style="margin-bottom:.5rem;">
            <span class="cl-lbl">✏️ Event Name</span>
            <input class="cl-input" type="text" placeholder="e.g. Mehndi, Ceremony…"
                   value="${esc(inst.eventType||'')}"
                   onblur="updateInstField('${inst.id}','eventType',this.value);updateEvNameDisplay('${inst.id}')" onkeydown="if(event.key===\'Enter\')this.blur()"
                   onkeydown="if(event.key==='Enter')this.blur()">
          </div>
          <div class="cl-row" style="margin-bottom:.5rem;">
            <span class="cl-lbl">👤 Who's event?</span>
            <input class="cl-input" type="text" placeholder="e.g. Sarah, Bride's side…"
                   value="${esc(inst.client)}"
                   oninput="updateClient('${inst.id}',this.value)"
                   onkeydown="if(event.key==='Enter')document.getElementById('t${inst.id}')?.focus()">
          </div>
          <div class="cl-row" style="margin-bottom:.5rem;">
            <span class="cl-lbl">🔄 Changes Note</span>
            <textarea class="cl-input ev-changes-textarea" placeholder="Describe changes requested by client…"
                   rows="2"
                   onblur="updateInstField('${inst.id}','changesNote',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">${esc(inst.changesNote||'')}</textarea>
          </div>
          ${prodSection}
        </div>
      </div>

      <div class="ev-panel ev-panel-draggable" draggable="true" data-panel="vendor" id="evp_vendor_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_vendor_${inst.id}',event)">
          <span class="ev-panel-title">🎪 Vendors</span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" onclick="event.stopPropagation()">
          <div style="margin-bottom:.5rem;">
            <button class="ev-crew-add-btn" onclick="addVendor('${inst.id}')">+ Add Vendor</button>
          </div>
          <div class="ev-vendor-rows" id="vendorrows_${inst.id}">
            ${buildVendorRows(inst.id, vendors)}
          </div>
        </div>
      </div>

      ${showVideo ? `<div class="ev-panel ev-panel-draggable" draggable="true" data-panel="songs" id="evp_songs_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_songs_${inst.id}',event)">
          <span class="ev-panel-title">🎵 Songs <span style="font-weight:400;opacity:.7;">(${u} used · ${av} available)</span></span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" onclick="event.stopPropagation()">
          <div class="song-add">
            <div class="lang-pick" id="lp${inst.id}">
              <button class="lpbtn" data-lang="en" onclick="setLangPick('${inst.id}','en',this)">EN</button>
              <button class="lpbtn" data-lang="hi" onclick="setLangPick('${inst.id}','hi',this)">HI</button>
              <button class="lpbtn on" data-lang="pa" onclick="setLangPick('${inst.id}','pa',this)">PA</button>
              <button class="lpbtn" data-lang="inst" onclick="setLangPick('${inst.id}','inst',this)" title="Instrumental">🎻</button>
            </div>
            <div class="suggest-wrap">
              <input type="text" id="t${inst.id}" placeholder="Song title"
                     oninput="showSugg('${inst.id}',this.value)"
                     onkeydown="handleSuggKey(event,'${inst.id}')"
                     autocomplete="off">
              <div class="suggest-list" id="sug${inst.id}" style="display:none"></div>
            </div>
            <input type="text" id="a${inst.id}" placeholder="Artist (optional)" onkeydown="if(event.key==='Enter')qAdd('${inst.id}')">
            <button class="btn btn-gold" onclick="qAdd('${inst.id}')">+ Add</button>
            <button class="rand-btn" onclick="rollRandomSong('${inst.id}')" title="Pick a random song from library + history">🎲 Random</button>
          </div>
          <div id="rrev${inst.id}"></div>
          <div class="song-list" id="sl${inst.id}">${rows}</div>
        </div>
      </div>` : ''}

      <div class="ev-panel ev-panel-draggable" draggable="true" data-panel="notes" id="evp_notes_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_notes_${inst.id}',event)">
          <span class="ev-panel-title">📝 Notes</span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" onclick="event.stopPropagation()">
          ${notesSection}
        </div>
      </div>

      <div class="ev-panel ev-panel-draggable" draggable="true" data-panel="cl" id="evp_cl_${inst.id}">
        <div class="ev-panel-head" onclick="toggleEvPanel('evp_cl_${inst.id}',event)">
          <span class="ev-panel-title">📋 Change Log ${changelog.length ? '<span style="font-weight:400;opacity:.7;">('+changelog.length+' snapshot'+(changelog.length!==1?'s':'')+')</span>' : ''}</span>
          <span class="ev-panel-drag-handle" title="Drag to reorder">⠿</span><span class="ev-panel-chev">▼</span>
        </div>
        <div class="ev-panel-body" onclick="event.stopPropagation()">
          ${changelogSection}
        </div>
      </div>

      </div>
    </div>
  </div>`;
}


// ── INLINE EVENT NAME EDIT ────────────────────────────────
function startEvNameEdit(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const nameEl = document.getElementById('evn'+iid); if (!nameEl) return;
  const cur_val = inst.eventType;
  nameEl.outerHTML = `<input class="ev-name-edit-input" id="evni${iid}"
    value="${esc(cur_val)}"
    onblur="saveEvName('${iid}',this)"
    onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value='${esc(cur_val).replace(/'/g,"\'")}';this.blur();}">`;
  setTimeout(()=>{ const el=document.getElementById('evni'+iid); if(el){el.focus();el.select();} }, 20);
}
function saveEvName(iid, inp) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const newName = inp.value.trim() || inst.eventType;
  const oldName = inst.eventType;
  inst.eventType = newName;
  // Keep timeline event step label in sync
  const _rnCo = couples.find(x=>x.id===inst.coupleId);
  if (_rnCo && _rnCo.timeline) {
    const _rnStep = _rnCo.timeline.find(s=>s.id==='evt_'+iid);
    if (_rnStep) _rnStep.label = newName;
  }
  sv();
  // Update header display
  const wrap = inp.closest('.ev-name-edit-wrap');
  if (wrap) {
    const isApp = !!inst.approved;
    wrap.innerHTML = `<div class="ev-name" id="evn${iid}" onclick="startEvNameEdit('${iid}')" title="Click to rename">${esc(newName)}${isApp?'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--forest);margin-left:.5rem;vertical-align:middle;"></span>':''}</div><span class="ev-name-pencil" onclick="startEvNameEdit('${iid}')">✏️</span>`;
  }
  if (newName !== oldName) toast(`Renamed to: ${newName}`);
}

// ── INST FIELD UPDATE ─────────────────────────────────────
function updateEvNameDisplay(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const nameEl = document.getElementById('evn'+iid);
  if (nameEl) { const t = nameEl.childNodes[0]; if(t) t.textContent = inst.eventType||''; }
  const titleEl = document.getElementById('evModalTitle');
  const co = couples.find(x=>x.id===inst.coupleId);
  if (titleEl) titleEl.textContent = (inst.eventType||'Event') + (inst.client ? ' · '+inst.client : '') + (co ? '  —  '+co.name : '');
  renderCoupleSummary(); renderCoupleTimeline();
}

function updateInstField(iid, field, value) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  inst[field] = value;
  sv();
  // Update editor filter if needed
  if (field === 'editor') renderEditorFilter();
  if (field === 'shooter') renderShooterFilter();
  // Live-patch the summary for fields that appear there
  const summaryFields = ['eventType','client','changesNote','shootDay','timeFrom','timeTo',
    'shooter','locationName','locationAddress','parkingLocation',
    'editor','photoEditor','videoEditor','editingDrive','photoEditingDrive','videoEditingDrive'];
  if (summaryFields.includes(field)) patchSummaryEvent(iid);
  // Re-render journey if event-related fields change
  const journeyFields = ['eventType','shootDay'];
  if (journeyFields.includes(field)) {
    const co = couples.find(x=>x.id===cur);
    if (co) { ctlGet(co.id); }
    if (typeof renderJourneyOverview === 'function') renderJourneyOverview();
  }
}

// ── DUE DATE DURATION HELPERS ────────────────────────────
function applyDueDuration(iid, raw) {
  const inst = insts.find(i => i.id === iid); if (!inst) return;
  const val = (raw || '').trim().toLowerCase();
  if (!val) return; // empty — do nothing

  // Parse: "90d" or "90" = days, "3m" = months
  const match = val.match(/^(\d+)\s*(d|m|days?|months?)?$/i);
  if (!match) { toast('Use format like 90d or 3m'); return; }
  const num = parseInt(match[1], 10);
  const unit = (match[2] || 'd').charAt(0); // 'd' or 'm'

  // Base date: shootDay, or eventDate, or today
  const couple = couples.find(c => c.id === inst.coupleId);
  let base;
  if (inst.shootDay) {
    base = new Date(inst.shootDay + 'T00:00:00');
  } else if (couple && couple.eventDate) {
    base = new Date(couple.eventDate + 'T00:00:00');
  } else {
    base = new Date(); base.setHours(0, 0, 0, 0);
  }

  if (unit === 'm') {
    base.setMonth(base.getMonth() + num);
  } else {
    base.setDate(base.getDate() + num);
  }

  const dateStr = base.toISOString().slice(0, 10);
  inst.erDueDate = dateStr;
  inst.erDueDuration = val; // remember what was typed
  sv();

  // Update the calendar input
  const calInput = document.getElementById('dueCal_' + iid);
  if (calInput) calInput.value = dateStr;
}

function clearDueDuration(iid) {
  const inst = insts.find(i => i.id === iid); if (!inst) return;
  inst.erDueDuration = ''; // clear the typed duration since user picked a specific date
  const quickInput = document.getElementById('dueQuick_' + iid);
  if (quickInput) quickInput.value = '';
}

// ── COUPLE-LEVEL DUE DATE HELPERS ─────────────────────────
// Auto-fill due date when event date changes (if duration is set)
function autoFillCoupleDueDate(prefix) {
  const durInput = document.getElementById(prefix + 'EditDueDuration');
  const dur = (durInput?.value || '').trim();
  if (dur) calcCoupleDueDate(prefix);
}

// Calculate due date from duration (e.g. "90d", "3m") relative to event date
function calcCoupleDueDate(prefix) {
  const durInput = document.getElementById(prefix + 'EditDueDuration');
  const calInput = document.getElementById(prefix + 'EditDueDate');
  const evInput  = document.getElementById(prefix + 'EventDate');
  if (!durInput || !calInput) return;

  const val = (durInput.value || '').trim().toLowerCase();
  if (!val) return;

  const match = val.match(/^(\d+)\s*(d|m|days?|months?)?$/i);
  if (!match) { toast('Use format like 90d or 3m'); return; }
  const num = parseInt(match[1], 10);
  const unit = (match[2] || 'd').charAt(0);

  // Base: event date if available, otherwise today
  let base;
  const evVal = evInput?.value || '';
  if (evVal) {
    base = new Date(evVal + 'T00:00:00');
  } else {
    base = new Date(); base.setHours(0, 0, 0, 0);
  }

  if (unit === 'm') {
    base.setMonth(base.getMonth() + num);
  } else {
    base.setDate(base.getDate() + num);
  }

  calInput.value = base.toISOString().slice(0, 10);
}

// ── SONG CHANGE LOG ───────────────────────────────────────
function toggleChangelog(iid) {
  const key = 'cl_'+iid;
  openSec[key] = openSec[key]===false ? true : false; sv();
  const body = document.getElementById('clb'+iid);
  if (body) body.classList.toggle('open', openSec[key]!==false);
}

function snapshotSongs(iid) {
  _doSnapshot(iid, '');
}

function snapshotSongsFromInput(iid) {
  const noteEl = document.getElementById('cln'+iid);
  const note = noteEl ? noteEl.value.trim() : '';
  _doSnapshot(iid, note);
  if (noteEl) noteEl.value = '';
}

function _doSnapshot(iid, note) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const curSongs = songs.filter(s=>s.instanceId===iid && s.used)
    .sort((a,b)=>(a.order||0)-(b.order||0))
    .map(s=>({ title:s.title, artist:s.artist||'', order:s.order||0 }));
  if (!curSongs.length) { toast('No used songs to snapshot. Mark songs as used first (✓).'); return; }
  if (!inst.changelog) inst.changelog = [];
  const date = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  inst.changelog.unshift({ date, note, songs: curSongs });
  openSec['cl_'+iid] = true;
  sv(); renderSections();
  toast('📸 Snapshot saved — '+curSongs.length+' song'+(curSongs.length!==1?'s':'')+' recorded');
}

function removeChangelog(iid, idx) {
  const inst = insts.find(i=>i.id===iid); if (!inst || !inst.changelog) return;
  inst.changelog.splice(idx, 1);
  sv(); renderSections();
  toast('Snapshot removed.');
}


// ── RANDOM SONG PICKER ───────────────────────────────────
function rollRandomSong(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const lang = getLangPick(iid);

  // Build pool: library + history for this event+lang, excluding songs already in this event
  const alreadyTitles = new Set(
    songs.filter(s=>s.instanceId===iid).map(s=>s.title.trim().toLowerCase())
  );
  const pool = [];
  const seen = new Set();

  // From song library (preset)
  const libKey = inst.eventType + '|' + lang;
  (songLib[libKey]||[]).forEach(e => {
    if (!e.title) return;
    const k = e.title.trim().toLowerCase();
    if (!seen.has(k) && !alreadyTitles.has(k)) {
      seen.add(k);
      pool.push({ title:e.title, artist:e.artist||'', src:'Library' });
    }
  });

  // From song history for ALL langs if pool is thin, otherwise just this lang
  const langKeys = pool.length < 5
    ? ['en','hi','pa','inst'].map(l => inst.eventType+'|'+l)
    : [inst.eventType + '|' + lang];
  langKeys.forEach(hk => {
    (songHist[hk]||[]).forEach(e => {
      if (!e.title) return;
      const k = e.title.trim().toLowerCase();
      if (!seen.has(k) && !alreadyTitles.has(k)) {
        seen.add(k);
        pool.push({ title:e.title, artist:e.artist||'', src:'History' });
      }
    });
  });

  const revEl = document.getElementById('rrev'+iid);
  if (!revEl) return;

  if (!pool.length) {
    revEl.innerHTML = '<div style="font-size:.72rem;color:var(--ink4);font-style:italic;padding:.4rem 0 .2rem;">No songs in library or history for this event yet.</div>';
    return;
  }

  // Fisher-Yates pick
  const pick = pool[Math.floor(Math.random() * pool.length)];

  revEl.innerHTML = `
  <div class="rand-reveal">
    <span class="rand-dice">🎲</span>
    <div class="rand-info">
      <div class="rand-title">${esc(pick.title)}</div>
      ${pick.artist ? `<div class="rand-artist">${esc(pick.artist)}</div>` : ''}
      <div class="rand-src">from ${pick.src}</div>
    </div>
    <div class="rand-actions">
      <button class="rand-add-btn" onclick="addRandSong('${iid}','${esc(pick.title).replace(/'/g,"\'")}','${esc(pick.artist).replace(/'/g,"\'")}')">+ Add</button>
      <button class="rand-skip-btn" onclick="rollRandomSong('${iid}')">↺ Roll</button>
      <button class="rand-skip-btn" onclick="document.getElementById('rrev${iid}').innerHTML=''">✕</button>
    </div>
  </div>`;
}

function addRandSong(iid, title, artist) {
  const tE = document.getElementById('t'+iid);
  const aE = document.getElementById('a'+iid);
  if (tE) tE.value = title;
  if (aE) aE.value = artist;
  document.getElementById('rrev'+iid).innerHTML = '';
  qAdd(iid);
}

// ── EDITOR FILTER ─────────────────────────────────────────

// ── DASHBOARD INTEL PANELS ───────────────────────────────


// ── OVERVIEW DRILL-DOWN MODAL ────────────────────────────
let ovDrillMode = ''; // 'edit-couples' | 'edit-events' | 'edit-done' | 'shoot-couples' | 'shoot-events' | 'shoot-done'
let ovDrillTab  = 'pending';

let ovDrillYear = null; // null = all years, number = specific year

function openOvDrill(mode, year) {
  ovDrillMode = mode;
  ovDrillYear = year || null;
  const baseTitle = {
    'edit-couples':              'Couples Left to Edit',
    'edit-events':               'Events Left to Edit',
    'edit-done':                 'Edits Completed',
    'shoot-couples':             'Couples Left to Shoot',
    'shoot-events':              'Events Left to Shoot',
    'shoot-done':                'Shoots Completed',
    'unassigned-edit-couples':   'Unassigned — Couples (Edit)',
    'unassigned-edit-events':    'Unassigned — Events (Edit)',
    'unassigned-edit-done':      'Unassigned — Edits',
    'unassigned-shoot-couples':  'Unassigned — Couples (Shoot)',
    'unassigned-shoot-events':   'Unassigned — Events (Shoot)',
    'unassigned-shoot-done':     'Unassigned — Shoots',
  };
  const title = (baseTitle[mode] || 'Breakdown') + (ovDrillYear ? ' — ' + ovDrillYear : '');
  document.getElementById('ovDrillTitle').textContent = title;
  // Tabs only shown for done modes
  const isDone  = mode.endsWith('-done');
  const tabsEl  = document.getElementById('ovDrillTabs');
  if (tabsEl) tabsEl.style.display = isDone ? 'flex' : 'none';
  ovDrillTab = 'pending';
  document.getElementById('ovTabPending').classList.add('active');
  document.getElementById('ovTabDone').classList.remove('active');
  document.getElementById('ovDrillOverlay').classList.add('open');
  renderOvDrill();
}
function closeOvDrill() {
  document.getElementById('ovDrillOverlay').classList.remove('open');
}
function setOvTab(tab) {
  ovDrillTab = tab;
  document.getElementById('ovTabPending').classList.toggle('active', tab==='pending');
  document.getElementById('ovTabDone').classList.toggle('active', tab==='done');
  renderOvDrill();
}

function renderOvDrill() {
  const body   = document.getElementById('ovDrillBody'); if (!body) return;
  const MO2    = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const isEdit = ovDrillMode.startsWith('edit');

  // Editor role: filter to only their events
  let _visInsts = insts;
  if (_isEditor()) {
    const _myIds = _editorInstIds();
    if (_myIds) _visInsts = insts.filter(function(i){ return _myIds.has(i.id); });
  }

  // Scoped at function level so all branches can use it
  const _thisYear       = new Date().getFullYear();
  // If a specific year was selected filter to that year;
  // for shoot modes default to current+future; for edit modes default to all years
  const _currentCoupleIds = ovDrillYear
    ? new Set(couples.filter(co => co.year === ovDrillYear).map(co => co.id))
    : new Set(couples.map(co => co.id));

  const dateLbl = co => (co.month && co.year) ? `${MO2[co.month-1]||''} ${co.year}` : '';

  function coupleRow(co, evRows, pct) {
    const pctHtml = pct !== undefined ? `<div class="ovdrill-couple-pct">${pct}%</div>` : '';
    return `<div class="ovdrill-couple-row">
      <div class="ovdrill-couple-head" onclick="closeOvDrill();selectCoupleFromDash('${co.id}')">
        <div class="ovdrill-couple-name">${esc(co.name)}</div>
        <div class="ovdrill-couple-date">${dateLbl(co)}</div>
        ${pctHtml}
      </div>
      ${evRows ? '<div class="ovdrill-events">'+evRows+'</div>' : ''}
    </div>`;
  }

  function eventRow(i, co) {
    const hrs  = calcHours(i.timeFrom, i.timeTo);
    const who  = isEdit ? (i.editor||'') : (i.shooter||'');
    const date = isEdit ? '' : (i.shootDay || co.eventDate || '');
    const datePart = date ? new Date(date+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : '';
    const approvedDate = isEdit ? (i.approvedAt||'') : (i.shootApprovedAt||'');
    const meta = [who, hrs, datePart, approvedDate ? '✓ '+approvedDate : ''].filter(Boolean).join(' · ');
    const isDone = isEdit ? !!i.approved : _isInstShootDone(i);
    return `<div class="ovdrill-event-row" onclick="closeOvDrill();goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${co.id}','${i.id}')},150)">
      <span class="ovdrill-event-status ${isDone?'done':'pending'}"></span>
      <span class="ovdrill-event-name">${esc(i.eventType||'Event')}</span>
      <span class="ovdrill-event-meta">${esc(meta)}</span>
    </div>`;
  }

  // ── UNASSIGNED ──────────────────────────────────────────
  if (ovDrillMode.startsWith('unassigned-')) {
    const isEditUna = ovDrillMode.includes('edit');

    function isUnassignedInst(i) {
      if (isEditUna) return !i.editor || !i.editor.trim();
      const photos =(i.photographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
      const vids   =(i.videographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
      const photoNA=(i.photographers||[]).some(n=>n==='N/A');
      const vidNA  =(i.videographers||[]).some(n=>n==='N/A');
      return !photos.length && !vids.length && !photoNA && !vidNA;
    }

    const unaInsts = _visInsts.filter(i => _currentCoupleIds.has(i.coupleId) && isUnassignedInst(i));

    document.getElementById('ovBadgePending').textContent = unaInsts.length;
    document.getElementById('ovBadgeDone').textContent    = '';
    const tabsEl3 = document.getElementById('ovDrillTabs');
    if (tabsEl3) tabsEl3.style.display = 'none';

    if (!unaInsts.length) {
      body.innerHTML = '<div class="ovdrill-empty">No unassigned events! ✓</div>';
      return;
    }

    const byCo = {};
    unaInsts.forEach(i => { if(!byCo[i.coupleId]) byCo[i.coupleId]=[]; byCo[i.coupleId].push(i); });
    const sortedIds = Object.keys(byCo).sort((a,b)=>{
      const ca=couples.find(x=>x.id===a), cb=couples.find(x=>x.id===b);
      if(!ca||!cb) return 0;
      return ca.year!==cb.year ? ca.year-cb.year : (ca.name||'').localeCompare(cb.name||'');
    });

    body.innerHTML = sortedIds.map(cid => {
      const co = couples.find(x=>x.id===cid); if (!co) return '';
      const rows = byCo[cid].map(i => {
        if (isEditUna) {
          // Edit: single editor field
          return `<div class="ovdrill-assign-row">
            <div class="ovdrill-assign-info">
              <div class="ovdrill-assign-name">${esc(i.eventType||'Event')}</div>
              <div class="ovdrill-assign-meta">${esc(co.name)} · ${co.year}</div>
            </div>
            <input class="ovdrill-assign-input" type="text" placeholder="Assign editor…" value="${esc(i.editor||'')}"
              onblur="updateInstField('${i.id}','editor',this.value);renderDashboard()" onkeydown="if(event.key===\'Enter\')this.blur()">
          </div>`;
        }
        // Shoot: separate photographer(s) and videographer(s) assignment with N/A option
        const photoNA = (i.photographers||[]).some(n=>n==='N/A');
        const vidNA   = (i.videographers||[]).some(n=>n==='N/A');
        const photo0  = (i.photographers||[''])[0] === 'N/A' ? '' : ((i.photographers||[''])[0]||'');
        const vid0    = (i.videographers||[''])[0] === 'N/A' ? '' : ((i.videographers||[''])[0]||'');
        return `<div class="ovdrill-assign-row">
          <div class="ovdrill-assign-info">
            <div class="ovdrill-assign-name">${esc(i.eventType||'Event')}</div>
            <div class="ovdrill-assign-meta">${esc(co.name)} · ${co.year}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.3rem;margin-top:.15rem;">
            <div style="display:flex;align-items:center;gap:.4rem;">
              <span style="font-size:.6rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--ink5);width:22px;flex-shrink:0;">📷</span>
              ${photoNA
                ? `<span class="crew-na-chip" style="font-size:.68rem;padding:.18rem .5rem;" onclick="setInstCrewNA('${i.id}','photographers',false);renderDashboard()">N/A — click to assign</span>`
                : `<input class="ovdrill-assign-input" type="text" placeholder="Assign photographer…" value="${esc(photo0)}"
                    oninput="setInstCrew0('${i.id}','photographers',this.value);renderDashboard()">`
              }
              <button class="crew-na-btn${photoNA?' active':''}" onclick="setInstCrewNA('${i.id}','photographers',${!photoNA});renderDashboard()" title="Not needed">N/A</button>
            </div>
            <div style="display:flex;align-items:center;gap:.4rem;">
              <span style="font-size:.6rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--ink5);width:22px;flex-shrink:0;">🎥</span>
              ${vidNA
                ? `<span class="crew-na-chip" style="font-size:.68rem;padding:.18rem .5rem;" onclick="setInstCrewNA('${i.id}','videographers',false);renderDashboard()">N/A — click to assign</span>`
                : `<input class="ovdrill-assign-input" type="text" placeholder="Assign videographer…" value="${esc(vid0)}"
                    oninput="setInstCrew0('${i.id}','videographers',this.value);renderDashboard()">`
              }
              <button class="crew-na-btn${vidNA?' active':''}" onclick="setInstCrewNA('${i.id}','videographers',${!vidNA});renderDashboard()" title="Not needed">N/A</button>
            </div>
          </div>
        </div>`;
      }).join('');
      return `<div class="ovdrill-couple-row">
        <div class="ovdrill-couple-head" onclick="closeOvDrill();selectCoupleFromDash('${co.id}')">
          <div class="ovdrill-couple-name">${esc(co.name)}</div>
          <div class="ovdrill-couple-date">${dateLbl(co)}</div>
        </div>
        <div class="ovdrill-events">${rows}</div>
      </div>`;
    }).join('');
    return;
  }

  // ── COUPLES LEFT (edit-couples, shoot-couples) ──────────
  if (ovDrillMode === 'edit-couples' || ovDrillMode === 'shoot-couples') {
    const relevantInsts = _visInsts.filter(i => isEdit
      ? (!!i.editor && _currentCoupleIds.has(i.coupleId))
      : _currentCoupleIds.has(i.coupleId));
    const coupleIds = [...new Set(relevantInsts.map(i=>i.coupleId))];
    const leftCouples = [];
    coupleIds.forEach(cid => {
      const co = couples.find(x=>x.id===cid); if (!co) return;
      const mine = relevantInsts.filter(i=>i.coupleId===cid);
      const doneCt = isEdit ? mine.filter(i=>i.approved).length : mine.filter(i=>_isInstShootDone(i)).length;
      if (doneCt < mine.length) {
        const pct = Math.round(doneCt/mine.length*100);
        // Couples views: names only, no event rows expanded
        const evRows = null;
        leftCouples.push({ co, evRows, pct });
      }
    });
    // Sort by year then name
    leftCouples.sort((a,b) => a.co.year!==b.co.year ? a.co.year-b.co.year : (a.co.name||'').localeCompare(b.co.name||''));
    document.getElementById('ovBadgePending').textContent = leftCouples.length;
    document.getElementById('ovBadgeDone').textContent    = '';
    if (!leftCouples.length) {
      body.innerHTML = '<div class="ovdrill-empty">All clients complete! 🎉</div>';
      return;
    }
    body.innerHTML = leftCouples.map(({co,evRows,pct}) => coupleRow(co, evRows, pct)).join('');
    return;
  }

  // ── EVENTS LEFT (edit-events, shoot-events) ─────────────
  if (ovDrillMode === 'edit-events' || ovDrillMode === 'shoot-events') {
    const pendingInsts = _visInsts.filter(i => isEdit
      ? (!i.approved && _currentCoupleIds.has(i.coupleId))
      : (!_isInstShootDone(i) && _currentCoupleIds.has(i.coupleId)));
    document.getElementById('ovBadgePending').textContent = pendingInsts.length;
    document.getElementById('ovBadgeDone').textContent    = '';
    if (!pendingInsts.length) {
      body.innerHTML = '<div class="ovdrill-empty">All events complete! 🎉</div>';
      return;
    }
    // Group by couple, sort by year then name
    const byCo = {};
    pendingInsts.forEach(i => { if(!byCo[i.coupleId]) byCo[i.coupleId]=[]; byCo[i.coupleId].push(i); });
    const sortedCoupleIds = Object.keys(byCo).sort((a,b)=>{
      const ca=couples.find(x=>x.id===a), cb=couples.find(x=>x.id===b);
      if(!ca||!cb) return 0;
      return ca.year!==cb.year ? ca.year-cb.year : (ca.name||'').localeCompare(cb.name||'');
    });
    body.innerHTML = sortedCoupleIds.map(cid => {
      const co = couples.find(x=>x.id===cid); if (!co) return '';
      const rows = byCo[cid].map(i => eventRow(i, co)).join('');
      return coupleRow(co, rows);
    }).join('');
    return;
  }

  // ── COMPLETED (edit-done, shoot-done) ───────────────────
  if (ovDrillMode === 'edit-done' || ovDrillMode === 'shoot-done') {
    const doneInsts = _visInsts
      .filter(i => isEdit ? (i.approved && !!i.editor && _currentCoupleIds.has(i.coupleId)) : (_isInstShootDone(i) && _currentCoupleIds.has(i.coupleId)))
      .slice().reverse();

    // Shoots complete: just a flat list of shot events — no tabs, no badge split
    if (!isEdit) {
      document.getElementById('ovBadgePending').textContent = '';
      document.getElementById('ovBadgeDone').textContent    = doneInsts.length;
      const tabsEl = document.getElementById('ovDrillTabs');
      if (tabsEl) tabsEl.style.display = 'none';
      if (!doneInsts.length) {
        body.innerHTML = '<div class="ovdrill-empty">No shoots marked done yet.</div>';
        return;
      }
      const byCo = {};
      doneInsts.forEach(i => { if(!byCo[i.coupleId]) byCo[i.coupleId]=[]; byCo[i.coupleId].push(i); });
      const sortedIds = Object.keys(byCo).sort((a,b)=>{
        const ca=couples.find(x=>x.id===a), cb=couples.find(x=>x.id===b);
        if(!ca||!cb) return 0;
        return ca.year!==cb.year ? ca.year-cb.year : (ca.name||'').localeCompare(cb.name||'');
      });
      const exportBtn = `<div style="padding:.75rem .4rem 0;text-align:center;">
        <button class="btn btn-outline btn-sm" onclick="exportDoneList('${ovDrillMode}')" style="width:100%;">
          📧 Export Full List to jsingh4@mac.com
        </button>
      </div>`;
      body.innerHTML = sortedIds.map(cid => {
        const co = couples.find(x=>x.id===cid); if (!co) return '';
        const rows = byCo[cid].map(i => eventRow(i, co)).join('');
        return coupleRow(co, rows);
      }).join('') + exportBtn;
      return;
    }

    // Edits complete: last 20, no tabs
    document.getElementById('ovBadgePending').textContent = '';
    document.getElementById('ovBadgeDone').textContent    = doneInsts.length;
    const tabsEl2 = document.getElementById('ovDrillTabs');
    if (tabsEl2) tabsEl2.style.display = 'none';

    const preview  = doneInsts.slice(0, 20);
    const allCount = doneInsts.length;

    if (!preview.length) {
      body.innerHTML = '<div class="ovdrill-empty">Nothing completed yet.</div>';
      return;
    }

    const byCo = {};
    preview.forEach(i => { if(!byCo[i.coupleId]) byCo[i.coupleId]=[]; byCo[i.coupleId].push(i); });
    const sortedIds2 = Object.keys(byCo).sort((a,b)=>{
      const ca=couples.find(x=>x.id===a), cb=couples.find(x=>x.id===b);
      if(!ca||!cb) return 0;
      return ca.year!==cb.year ? ca.year-cb.year : (ca.name||'').localeCompare(cb.name||'');
    });
    const listHtml = sortedIds2.map(cid => {
      const co = couples.find(x=>x.id===cid); if (!co) return '';
      const rows = byCo[cid].map(i => eventRow(i, co)).join('');
      return coupleRow(co, rows);
    }).join('');

    const exportBtn = `<div style="padding:.75rem .4rem 0;text-align:center;">
      <div style="font-family:'Outfit',sans-serif;font-size:.62rem;color:var(--ink5);margin-bottom:.5rem;">
        Showing last ${Math.min(20,allCount)} of ${allCount} completed edits
      </div>
      <button class="btn btn-outline btn-sm" onclick="exportDoneList('${ovDrillMode}')" style="width:100%;">
        📧 Export Full List to jsingh4@mac.com
      </button>
    </div>`;

    body.innerHTML = listHtml + exportBtn;
    return;
  }
}

function exportDoneList(mode) {
  const isEdit = mode.startsWith('edit');
  const label  = isEdit ? 'Edits' : 'Shoots';
  const doneInsts = _visInsts.filter(i => (isEdit ? (i.approved && !!i.editor) : (_isInstShootDone(i) && !!i.shooter)))
    .slice().reverse();
  const sep  = '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━';
  const thin = '─────────────────────────────────────────';
  const date = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  let body = `${label} Completed — Full List\n`;
  body += `Generated ${date}\n${sep}\n\n`;
  body += `Total: ${doneInsts.length} completed ${label.toLowerCase()}\n\n`;
  doneInsts.forEach((i, idx) => {
    const co  = couples.find(x=>x.id===i.coupleId);
    const who = isEdit ? i.editor : i.shooter;
    const hrs = calcHours(i.timeFrom, i.timeTo);
    body += `${idx+1}. ${co?co.name:'Unknown'} — ${i.eventType||'Event'}\n`;
    body += `   ${who ? (isEdit?'✂️ ':'📷 ')+who : ''}${hrs?' · '+hrs:''}${i.approvedAt?' · Approved '+i.approvedAt:''}\n`;
  });
  const subject = encodeURIComponent(`Cloud IX Concierge — ${label} Completed List`);
  const encoded = encodeURIComponent(body);
  window.location.href = `mailto:jsingh4@mac.com?subject=${subject}&body=${encoded}`;
}
function calcHours(timeFrom, timeTo) {
  // Returns a string like "6h" or "6h 30m" or "" if not calculable
  if (!timeFrom || !timeTo) return '';
  const parse = t => { const [h,m] = t.split(':').map(Number); return isNaN(h)||isNaN(m) ? null : h*60+m; };
  const a = parse(timeFrom), b = parse(timeTo);
  if (a===null||b===null) return '';
  const diff = b - a;
  if (diff <= 0) return '';
  const h = Math.floor(diff/60), m = diff%60;
  return m ? `${h}h ${m}m` : `${h}h`;
}
// ── Production Clock helpers ─────────────────────────────
function _elapsedStr(dateStr) {
  if (!dateStr) return '';
  var start = new Date(dateStr);
  var now = new Date();
  var diff = now - start;
  if (diff < 0) return 'not started';
  var mins  = Math.floor(diff / 60000);
  var hours = Math.floor(mins / 60);
  var days  = Math.floor(hours / 24);
  var weeks = Math.floor(days / 7);
  if (weeks > 0) return weeks + 'w ' + (days % 7) + 'd';
  if (days > 0)  return days + 'd ' + (hours % 24) + 'h';
  if (hours > 0) return hours + 'h ' + (mins % 60) + 'm';
  return mins + 'm';
}
function _formatClockDate(dateStr) {
  if (!dateStr) return '';
  var d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}
function _clockHtml(instId, startedAt, grouped, groupInstIds) {
  // For grouped cards, find earliest editStartedAt in the group
  if (grouped && groupInstIds) {
    var earliest = null;
    groupInstIds.forEach(function(gid) {
      var gi = insts.find(function(x){return x.id===gid;});
      if (gi && gi.editStartedAt) {
        if (!earliest || gi.editStartedAt < earliest) earliest = gi.editStartedAt;
      }
    });
    startedAt = earliest || '';
    instId = groupInstIds[0]; // use first inst for editing
  }
  if (!startedAt) {
    return '<div class="prod-card-clock" onclick="event.stopPropagation();startProdClock(\'' + instId + '\'' + (grouped && groupInstIds ? ',true' : '') + ')" title="Start production clock">' +
      '<span class="clock-icon">🕐</span><span style="opacity:.5;">Start clock</span></div>';
  }
  var elapsed = _elapsedStr(startedAt);
  var started = _formatClockDate(startedAt);
  return '<div class="prod-card-clock" onclick="event.stopPropagation();editProdClock(\'' + instId + '\',event' + (grouped && groupInstIds ? ',true' : '') + ')" title="Click to edit start date">' +
    '<span class="clock-icon">🕐</span><span class="clock-elapsed">' + esc(elapsed) + '</span>' +
    '<span class="clock-start">· Started ' + esc(started) + '</span></div>';
}
function startProdClock(instId, applyToGroup) {
  var now = new Date().toISOString();
  if (applyToGroup) {
    // Find the inst, then all insts in the same couple+category
    var inst = insts.find(function(x){return x.id===instId;}); if (!inst) return;
    insts.forEach(function(i) {
      if (i.coupleId===inst.coupleId && i.catId===inst.catId && i.editor && !i.editStartedAt) {
        i.editStartedAt = now;
      }
    });
  } else {
    var inst = insts.find(function(x){return x.id===instId;}); if (!inst) return;
    inst.editStartedAt = now;
  }
  sv();
  renderDashPanels('coDashPanels','coDashBanner');
  toast('Production clock started');
}
function editProdClock(instId, evt, isGroup) {
  // Close any existing popover
  var old = document.getElementById('clockEditPop'); if (old) old.remove();
  var inst = insts.find(function(x){return x.id===instId;}); if (!inst) return;
  var pop = document.createElement('div');
  pop.id = 'clockEditPop';
  pop.className = 'prod-clock-edit';
  var curVal = inst.editStartedAt ? inst.editStartedAt.slice(0,16) : '';
  var groupArg = isGroup ? ',true' : '';
  pop.innerHTML = '<label>Started At</label>' +
    '<input type="datetime-local" id="clockEditInput" value="' + esc(curVal) + '">' +
    '<div class="clock-edit-btns">' +
      '<button class="clock-clear" onclick="clearProdClock(\'' + instId + '\'' + groupArg + ')">Clear</button>' +
      '<button class="clock-save" onclick="saveProdClock(\'' + instId + '\'' + groupArg + ')">Save</button>' +
    '</div>';
  pop.style.position = 'fixed';
  pop.style.left = Math.min(evt.clientX, window.innerWidth - 220) + 'px';
  pop.style.top = Math.min(evt.clientY + 8, window.innerHeight - 140) + 'px';
  document.body.appendChild(pop);
  setTimeout(function() {
    document.addEventListener('click', function _closePop(e) {
      if (!pop.contains(e.target)) { pop.remove(); document.removeEventListener('click', _closePop); }
    });
  }, 50);
}
function saveProdClock(instId, applyToGroup) {
  var inst = insts.find(function(x){return x.id===instId;}); if (!inst) return;
  var val = document.getElementById('clockEditInput')?.value;
  if (val) {
    var iso = new Date(val).toISOString();
    if (applyToGroup) {
      insts.forEach(function(i) {
        if (i.coupleId===inst.coupleId && i.catId===inst.catId && i.editor) i.editStartedAt = iso;
      });
    } else {
      inst.editStartedAt = iso;
    }
  }
  var pop = document.getElementById('clockEditPop'); if (pop) pop.remove();
  sv();
  renderDashPanels('coDashPanels','coDashBanner');
  toast('Clock updated');
}
function clearProdClock(instId, applyToGroup) {
  var inst = insts.find(function(x){return x.id===instId;}); if (!inst) return;
  if (applyToGroup) {
    insts.forEach(function(i) {
      if (i.coupleId===inst.coupleId && i.catId===inst.catId) delete i.editStartedAt;
    });
  } else {
    delete inst.editStartedAt;
  }
  var pop = document.getElementById('clockEditPop'); if (pop) pop.remove();
  sv();
  renderDashPanels('coDashPanels','coDashBanner');
  toast('Clock cleared');
}

function renderDashPanels(panelId, bannerId) {
  const panelEl    = document.getElementById(panelId || 'dashPanels');
  const overviewEl = document.getElementById(bannerId || 'overviewBanner');
  if (!panelEl) return;

  // ── Editor role: shadow couples/insts with filtered versions ──
  // We create local `couples` and `insts` that shadow the globals
  let _couples = couples;
  let _insts = insts;
  if (_isEditor()) {
    const myName = _editorName();
    // Find inst IDs where this editor is assigned (editing or shooting)
    const myInstIds = new Set();
    const myCoupleIds = new Set();
    insts.forEach(function(i) {
      const isMyEdit = (i.editor||'').trim() === myName;
      const isMyShoot = (i.shooter||'').trim() === myName;
      const isMyPhoto = (i.photographers||[]).some(function(p){ return (p||'').trim() === myName; });
      const isMyVideo = (i.videographers||[]).some(function(v){ return (v||'').trim() === myName; });
      if (isMyEdit || isMyShoot || isMyPhoto || isMyVideo) {
        myInstIds.add(i.id);
        myCoupleIds.add(i.coupleId);
      }
    });
    couples.forEach(function(c) {
      if ((c.editors||[]).some(function(e){ return e.trim() === myName; })) myCoupleIds.add(c.id);
    });
    _couples = couples.filter(function(c){ return myCoupleIds.has(c.id); });
    _insts = insts.filter(function(i){ return myInstIds.has(i.id); });
  }
  // Use _couples and _insts throughout this function for filtered data

  const today = new Date(); today.setHours(0,0,0,0);
  const MOS   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // ── Helper: date badge ──────────────────────────────────
  function dateBadge(dateStr, cls) {
    if (!dateStr) return `<div class="shoot-mini-badge past"><div class="shoot-mini-day" style="font-size:.5rem;">–</div></div>`;
    const d = new Date(dateStr + 'T00:00:00');
    const days = Math.round((d - today) / 86400000);
    const urg = days < 0 ? 'past' : days <= 7 ? 'urgent' : days <= 30 ? 'soon' : '';
    return `<div class="shoot-mini-badge ${urg}"><div class="shoot-mini-day">${d.getDate()}</div><div class="shoot-mini-mon">${MOS[d.getMonth()]}</div></div>`;
  }

  function daysLabel(dateStr) {
    if (!dateStr) return '';
    const days = Math.round((new Date(dateStr+'T00:00:00') - today) / 86400000);
    if (days < 0)  return ` <span style="font-size:.54rem;color:var(--ink5);">${Math.abs(days)}d ago</span>`;
    if (days === 0) return ` <span style="font-size:.54rem;color:var(--forest);">Today</span>`;
    if (days === 1) return ` <span style="font-size:.54rem;color:#b45309;">Tomorrow</span>`;
    return ` <span style="font-size:.54rem;color:var(--ink5);">${days}d</span>`;
  }

  // ── OVERVIEW BANNER ─────────────────────────────────────
  if (overviewEl) {
    const totalCouples   = _couples.length;
    const totalInsts     = _insts.length;
    // Editing: all events regardless of shoot status
    const editingTotal   = _insts.length;
    const editingDone    = _insts.filter(i=>i.approved).length;
    const editingLeft    = editingTotal - editingDone;
    const couplesToEdit  = new Set(_insts.filter(i=>!i.approved).map(i=>i.coupleId)).size;
    // Shooting: per-year breakdown (current year + future years only)
    const thisYear = new Date().getFullYear();
    const currentCoupleIds = new Set(_couples.filter(co => co.year >= thisYear).map(co => co.id));
    const shootingTotal  = _insts.filter(i=>currentCoupleIds.has(i.coupleId)).length;
    const shootingDone   = _insts.filter(i=>_isInstShootDone(i) && currentCoupleIds.has(i.coupleId)).length;
    const shootingLeft   = shootingTotal - shootingDone;
    const couplesToShoot = new Set(_insts.filter(i=>!_isInstShootDone(i) && currentCoupleIds.has(i.coupleId)).map(i=>i.coupleId)).size;

    // Build year list: all years >= thisYear that have at least one couple (even without shooter yet)
    const shootYears = [...new Set(
      _couples.filter(co=>co.year>=thisYear).map(co=>co.year)
    )].sort((a,b)=>a-b);

    // Edit year list: all years that have at least one couple
    const editYears = [...new Set(_couples.map(co=>co.year))].sort((a,b)=>b-a);

    function editYearRows(mode) {
      // mode: '_couples' | 'events' | 'done'
      if (!editYears.length) return `<div class="ov-shoot-empty">No _couples yet</div>`;
      const drillMode = mode==='done' ? 'edit-done' : mode==='_couples' ? 'edit-_couples' : 'edit-events';
      return editYears.map(yr => {
        const yrCoupleIds = new Set(_couples.filter(co=>co.year===yr).map(co=>co.id));
        let total, done, leftCount, unassigned;
        if (mode === '_couples') {
          const allYrCouples  = _couples.filter(co=>yrCoupleIds.has(co.id));
          const totalCo       = allYrCouples.length;
          const doneCo        = allYrCouples.filter(co=>{
            const ci=_insts.filter(i=>i.coupleId===co.id);
            return ci.length>0 && ci.every(i=>i.approved);
          }).length;
          // Unassigned: no editor assigned
          unassigned = allYrCouples.filter(co=>{
            const ci=_insts.filter(i=>i.coupleId===co.id);
            return ci.length>0 && ci.every(i=>!i.editor);
          }).length;
          total=totalCo; done=doneCo; leftCount=totalCo-doneCo;
        } else {
          const yrInsts = _insts.filter(i=>yrCoupleIds.has(i.coupleId));
          total      = yrInsts.length;
          done       = yrInsts.filter(i=>i.approved).length;
          leftCount  = total - done;
          unassigned = yrInsts.filter(i=>!i.editor).length;
        }
        const pct     = total > 0 ? Math.round(done/total*100) : 0;
        const allDone = total > 0 && done === total && unassigned === 0;
        const mainTxt = mode === 'done' ? `${done}/${total}` : `${leftCount} left`;
        const unaMode = 'unassigned-edit-events';
        const unaTxt  = (mode === 'events' && unassigned > 0) ? `<span class="ov-unassigned-link" onclick="event.stopPropagation();openOvDrill('${unaMode}',${yr})" title="Click to assign">· ${unassigned} unassigned</span>` : '';
        const rowClick = 'openOvDrill(\'' + drillMode + '\',' + yr + ')';
        return `<div class="ov-year-row" onclick="${rowClick}" title="${yr} — click to see details">
          <span class="ov-year-label">${yr}</span>
          <div class="ov-year-bar-wrap"><div class="ov-year-bar-fill" style="width:${pct}%;background:rgba(74,122,85,.85);"></div></div>
          <span class="ov-year-stats">${mainTxt}${unaTxt}${allDone?'<span class="ov-year-all-done">✓</span>':''}</span>
        </div>`;
      }).join('');
    }

    function shootYearRows(mode) {
      // mode: '_couples' | 'events' | 'done'
      if (!shootYears.length) return `<div class="ov-shoot-empty">No shoots scheduled</div>`;
      const drillMode = mode==='done' ? 'shoot-done' : mode==='_couples' ? 'shoot-_couples' : 'shoot-events';
      return shootYears.map(yr => {
        const yrCoupleIds = new Set(_couples.filter(co=>co.year===yr).map(co=>co.id));
        let total, done, leftCount, unassigned;
        if (mode === '_couples') {
          const allYrCouples = _couples.filter(co=>yrCoupleIds.has(co.id));
          const totalCo      = allYrCouples.length;
          const doneCo       = allYrCouples.filter(co=>{
            const sh=_insts.filter(i=>i.coupleId===co.id);
            return sh.length>0 && sh.every(i=>_isInstShootDone(i));
          }).length;
          // Unassigned _couples: have _insts but none have any shooter/photographer/videographer
          unassigned = allYrCouples.filter(co=>{
            const ci=_insts.filter(i=>i.coupleId===co.id);
            return ci.length>0 && ci.every(i=>{
              const photos=(i.photographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
              const vids  =(i.videographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
              const photoNA=(i.photographers||[]).some(n=>n==='N/A');
              const vidNA  =(i.videographers||[]).some(n=>n==='N/A');
              return !i.shooter && !photos.length && !vids.length && !photoNA && !vidNA;
            });
          }).length;
          total=totalCo; done=doneCo; leftCount=totalCo-doneCo;
        } else {
          const yrInsts = _insts.filter(i=>yrCoupleIds.has(i.coupleId));
          total      = yrInsts.length;
          done       = yrInsts.filter(i=>_isInstShootDone(i)).length;
          leftCount  = total - done;
          unassigned = yrInsts.filter(i=>{
            const photos = (i.photographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
            const vids   = (i.videographers||[]).filter(n=>n&&n!=='N/A'&&n.trim());
            const photoNA= (i.photographers||[]).some(n=>n==='N/A');
            const vidNA  = (i.videographers||[]).some(n=>n==='N/A');
            const hasShooter = !!i.shooter;
            const hasPhotos  = photos.length>0 || photoNA;
            const hasVids    = vids.length>0   || vidNA;
            return !hasShooter && !hasPhotos && !hasVids;
          }).length;
        }
        const pct     = total > 0 ? Math.round(done/total*100) : 0;
        const allDone = total > 0 && done === total && unassigned === 0;
        const isCur   = yr === thisYear;
        const mainTxt = mode === 'done' ? `${done}/${total}` : `${leftCount} left`;
        const unaMode = 'unassigned-shoot-events';
        const unaTxt  = (mode === 'events' && unassigned > 0) ? `<span class="ov-unassigned-link" onclick="event.stopPropagation();openOvDrill('${unaMode}',${yr})" title="Click to assign">· ${unassigned} unassigned</span>` : '';
        const rowClick = 'openOvDrill(\'' + drillMode + '\',' + yr + ')';
        return `<div class="ov-year-row" onclick="${rowClick}" title="${yr} — click to see details">
          <span class="ov-year-label${isCur?' current-yr':''}">${yr}</span>
          <div class="ov-year-bar-wrap"><div class="ov-year-bar-fill" style="width:${pct}%;background:rgba(37,99,235,.7);"></div></div>
          <span class="ov-year-stats">${mainTxt}${unaTxt}${allDone?'<span class="ov-year-all-done">✓</span>':''}</span>
        </div>`;
      }).join('');
    }

    function donut(done, total, color) {
      const cx = 22, cy = 22, r = 18, sw = 4;
      const pct = total > 0 ? Math.min(done / total, 1) : 0;
      const pctLabel = total > 0 ? Math.round(pct * 100) + '%' : '–';
      // Arc from top (12 o'clock), sweeping clockwise
      // Start point always at top: (cx, cy - r)
      const startX = cx;
      const startY = cy - r;
      // End point at angle = pct * 360 degrees, measured from top clockwise
      const angleDeg = pct * 360;
      const angleRad = (angleDeg - 90) * Math.PI / 180; // -90 to start at top
      const endX = cx + r * Math.cos(angleRad);
      const endY = cy + r * Math.sin(angleRad);
      const largeArc = angleDeg > 180 ? 1 : 0;
      // Build the arc path (only if pct > 0)
      let arcPath = '';
      if (pct >= 1) {
        // Full circle: draw as two semicircles
        arcPath = `<path d="M ${startX} ${startY} A ${r} ${r} 0 1 1 ${startX - 0.001} ${startY}" fill="none" stroke="${color}" stroke-width="${sw}" stroke-linecap="round"/>`;
      } else if (pct > 0) {
        arcPath = `<path d="M ${startX} ${startY} A ${r} ${r} 0 ${largeArc} 1 ${endX.toFixed(3)} ${endY.toFixed(3)}" fill="none" stroke="${color}" stroke-width="${sw}" stroke-linecap="round"/>`;
      }
      return `<svg width="44" height="44" viewBox="0 0 44 44" class="ov-donut">
        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--rule2)" stroke-width="${sw}"/>
        ${arcPath}
        <text x="${cx}" y="${cy+4}" text-anchor="middle" font-family="Outfit,sans-serif" font-size="9" font-weight="700" fill="${color}">${pctLabel}</text>
      </svg>`;
    }

    // Couples done/left editing and shooting
    const couplesDoneEditing = _couples.filter(co => {
      const ci = _insts.filter(i=>i.coupleId===co.id);
      return ci.length > 0 && ci.every(i=>i.approved);
    }).length;
    const couplesTotalEditing = new Set(_insts.map(i=>i.coupleId)).size;
    const couplesDoneShooting = _couples.filter(co => {
      if (!currentCoupleIds.has(co.id)) return false;
      const shInsts = _insts.filter(i=>i.coupleId===co.id);
      return shInsts.length > 0 && shInsts.every(i=>_isInstShootDone(i));
    }).length;
    const couplesTotalShooting = new Set(_insts.filter(i=>currentCoupleIds.has(i.coupleId)).map(i=>i.coupleId)).size;

    overviewEl.style.display = 'grid';
    overviewEl.innerHTML = `
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(couplesDoneEditing, couplesTotalEditing, 'rgba(74,122,85,1)')}
          <div class="ov-info">
            <div class="ov-big">${couplesToEdit}<span> left</span></div>
            <div class="ov-label">Couples to Edit</div>
            <div class="ov-sub">${couplesDoneEditing} of ${couplesTotalEditing} complete</div>
          </div>
        </div>
        ${editYearRows('_couples')}
      </div>
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(editingDone, editingTotal, 'rgba(74,122,85,1)')}
          <div class="ov-info">
            <div class="ov-big">${editingLeft}<span> left</span></div>
            <div class="ov-label">Events to Edit</div>
            <div class="ov-sub">${editingDone} of ${editingTotal} complete</div>
          </div>
        </div>
        ${editYearRows('events')}
      </div>
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(editingDone, editingTotal, 'rgba(74,122,85,1)')}
          <div class="ov-info">
            <div class="ov-big">${editingDone}<span> done</span></div>
            <div class="ov-label">Edits Complete</div>
            <div class="ov-sub">${Math.round(editingTotal>0?editingDone/editingTotal*100:0)}% of all events</div>
          </div>
        </div>
        ${editYearRows('done')}
      </div>
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(couplesDoneShooting, couplesTotalShooting, 'rgba(37,99,235,1)')}
          <div class="ov-info">
            <div class="ov-big">${couplesToShoot}<span> left</span></div>
            <div class="ov-label">Couples to Shoot</div>
            <div class="ov-sub">${couplesDoneShooting} of ${couplesTotalShooting} complete</div>
          </div>
        </div>
        ${shootYearRows('_couples')}
      </div>
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(shootingDone, shootingTotal, 'rgba(37,99,235,1)')}
          <div class="ov-info">
            <div class="ov-big">${shootingLeft}<span> left</span></div>
            <div class="ov-label">Events to Shoot</div>
            <div class="ov-sub">${shootingDone} of ${shootingTotal} complete</div>
          </div>
        </div>
        ${shootYearRows('events')}
      </div>
      <div class="ov-card ov-shoot-card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
          ${donut(shootingDone, shootingTotal, 'rgba(37,99,235,1)')}
          <div class="ov-info">
            <div class="ov-big">${shootingDone}<span> shot</span></div>
            <div class="ov-label">Shoots Complete</div>
            <div class="ov-sub">${Math.round(shootingTotal>0?shootingDone/shootingTotal*100:0)}% of all events</div>
          </div>
        </div>
        ${shootYearRows('done')}
      </div>`;
  }

  // ── PANEL 1: EDITORS ────────────────────────────────────
  // Build editorMap: active (not approved) and old (approved) entries
  const editorActive = {}; // ed → { new:[], changes:[], unset:[] }
  const editorOld    = {}; // ed → [{ coupleName, eventType, status, hours, approvedAt }]

  _insts.forEach(i => {
    if (!i.editor) return;
    const ed = i.editor.trim(); if (!ed) return;
    const couple = _couples.find(c=>c.id===i.coupleId); if (!couple) return;
    const hours  = calcHours(i.timeFrom, i.timeTo);
    const entry  = { coupleName:couple.name, coupleId:couple.id, eventType:i.eventType||'', instId:i.id,
                     status:i.editorStatus||'', hours, approvedAt:i.approvedAt||'', editStartedAt:i.editStartedAt||'' };
    if ((i.approved && !i.changesNeeded) || i.editorStatus==='approved' && !i.changesNeeded) {
      if (!editorOld[ed]) editorOld[ed] = [];
      editorOld[ed].push(entry);
    } else {
      if (!editorActive[ed]) editorActive[ed] = { new:[], changes:[], unset:[] };
      const bucket = (i.changesNeeded || i.editorStatus==='changes') ? 'changes' : i.editorStatus==='new' ? 'new' : 'unset';
      editorActive[ed][bucket].push(entry);
    }
  });

  // Couple-level editors: editors listed on a couple (via Edit Couple form) who
  // don't yet have any inst-level assignment for that couple. This ensures they
  // appear in the Boardroom panels even before specific events are assigned.
  const editorCoupleLevel = {}; // ed → [{ coupleName, coupleId }]
  _couples.forEach(c => {
    (c.editors||[]).forEach(e => {
      const ed = e.trim(); if (!ed) return;
      const hasInstEntry = _insts.some(i => i.coupleId === c.id && (i.editor||'').trim() === ed);
      if (!hasInstEntry) {
        if (!editorCoupleLevel[ed]) editorCoupleLevel[ed] = [];
        editorCoupleLevel[ed].push({ coupleName: c.name, coupleId: c.id });
      }
    });
  });

  // All editors = union of inst-level active + old + couple-level
  let allEditors = [...new Set([...Object.keys(editorActive), ...Object.keys(editorOld), ...Object.keys(editorCoupleLevel)])].sort();

  // Editor role: only show their own column
  if (_isEditor()) {
    const myName = _editorName();
    allEditors = allEditors.filter(ed => ed === myName);
  }

  function makeChip(p) {
    const sc = p.status==='new' ? 'new' : p.status==='changes' ? 'changes' : '';
    const dot = sc ? `<span class="chip-status-dot ${sc}"></span>` : '';
    const hrs = p.hours ? ` <span style="font-size:.55rem;opacity:.7;">(${p.hours})</span>` : '';
    const label = p.eventType ? `${esc(p.coupleName)} · ${esc(p.eventType)}` : esc(p.coupleName);
    return `<span class="editor-proj-chip ${sc}" onclick="goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${p.coupleId}','${p.instId}')},150)" title="${esc(p.coupleName)} — ${esc(p.eventType)}">${dot}${label}${hrs}</span>`;
  }

  const editorHtml = allEditors.length ? allEditors.map(ed => {
    const initials = ed.split(' ').map(w=>w[0]||'').join('').slice(0,2).toUpperCase();
    const active   = editorActive[ed] || { new:[], changes:[], unset:[] };
    const newBlock     = active.new.length     ? `<div class="editor-status-group"><span class="editor-status-label new">New Project</span><div class="editor-projects">${active.new.map(makeChip).join('')}</div></div>` : '';
    const changesBlock = active.changes.length ? `<div class="editor-status-group"><span class="editor-status-label changes">Changes</span><div class="editor-projects">${active.changes.map(makeChip).join('')}</div></div>` : '';
    const unsetBlock   = active.unset.length   ? `<div class="editor-status-group"><div class="editor-projects">${active.unset.map(makeChip).join('')}</div></div>` : '';
    const noActive     = !active.new.length && !active.changes.length && !active.unset.length && !(editorCoupleLevel[ed]||[]).length
      ? `<div style="font-size:.68rem;font-style:italic;color:var(--ink5);padding:.2rem 0;">Nothing in progress</div>` : '';

    // Couple-level associations (editor on couple but no specific event assignment yet)
    const clCouples = editorCoupleLevel[ed] || [];
    const coupleBlock = clCouples.length
      ? `<div class="editor-status-group"><span class="editor-status-label" style="color:var(--ink5);">Couple${clCouples.length>1?'s':''}</span><div class="editor-projects">${clCouples.map(cl =>
          `<span class="editor-proj-chip" title="${esc(cl.coupleName)} — no events assigned yet">${esc(cl.coupleName)}</span>`
        ).join('')}</div></div>` : '';

    // Old projects
    const oldAll = (editorOld[ed] || []).slice().reverse(); // most recent first
    const oldPreview = oldAll.slice(0,2);
    const oldRest    = oldAll.slice(2);
    const uid_op     = 'op_' + ed.replace(/\W/g,'_');
    const makeOldItem = (p) => {
      const sc = p.status==='new' ? 'new' : p.status==='changes' ? 'changes' : '';
      const badge = sc ? `<span class="old-proj-badge ${sc}">${sc==='new'?'New':'Changes'}</span>` : '';
      const hrs   = p.hours ? `· ${p.hours}` : '';
      const when  = p.approvedAt ? `Approved ${p.approvedAt}` : 'Approved';
      return `<div class="old-proj-item">
        <div class="old-proj-dot">✓</div>
        <div style="flex:1;min-width:0;">
          <div class="old-proj-name">${esc(p.coupleName)} · ${esc(p.eventType)} ${badge}</div>
          <div class="old-proj-meta">${when} ${hrs}</div>
        </div>
      </div>`;
    };
    const oldPreviewHtml = oldPreview.map(makeOldItem).join('');
    const oldRestHtml    = oldRest.map(makeOldItem).join('');
    const moreBtn = oldRest.length
      ? `<button class="old-projects-btn" id="${uid_op}_more" onclick="toggleOldMore('${uid_op}')">
           <span>+${oldRest.length} more</span><span class="op-arrow">▾</span>
         </button>
         <div class="old-projects-list" id="${uid_op}_list">${oldRestHtml}</div>` : '';
    const oldBlock = oldAll.length
      ? `<div style="margin-top:.5rem;">
          <button class="old-projects-btn" id="${uid_op}_btn" onclick="toggleOldProjects('${uid_op}')">
            <span>🗂 Old Projects (${oldAll.length})</span><span class="op-arrow">▾</span>
          </button>
          <div class="old-projects-list" id="${uid_op}_drawer">
            ${oldPreviewHtml}${oldRestHtml ? moreBtn : ''}
          </div>
        </div>` : '';

    const safeEd = esc(ed).replace(/'/g, "\'");
    return `<div class="editor-row">
      <div class="editor-avatar">${_userAvatar(ed)}</div>
      <div class="editor-info">
        <div class="editor-name">✂️ ${esc(ed)}</div>
        ${newBlock}${changesBlock}${unsetBlock}${coupleBlock}${noActive}
        ${oldBlock}
        ${_isAdmin() ? `<button class="panel-assign-btn" onclick="openAssign('${safeEd}')">+ Assign event</button>` : ''}
      </div>
    </div>`;
  }).join('') : `<div class="intel-empty">No editors assigned yet</div>`;

  // ── IN PRODUCTION PANEL ─────────────────────────────────
  // Collect revision items separately (used by both In Production and Revisions panels)
  const revisionProjects = []; // items needing changes
  const editingEl = document.getElementById('coDashEditing');
  if (editingEl) {
    // Collect all active (non-approved) edit projects, newest couple year first
    // Changes/revisions go to a separate panel
    const activeProjects = []; // non-revision items
    allEditors.forEach(ed => {
      const active = editorActive[ed] || { new:[], changes:[], unset:[] };
      [...active.new, ...active.unset].forEach(p => {
        activeProjects.push({ ...p, editor: ed });
      });
      active.changes.forEach(p => {
        revisionProjects.push({ ...p, editor: ed });
      });
    });
    // Also catch inst-level photo/video changes that might not have editorStatus='changes'
    _insts.forEach(i => {
      if (!i.editor || !i.editor.trim()) return;
      // Editor role: only include own assignments
      if (_isEditor() && (i.editor||'').trim() !== _editorName()) return;
      const couple = _couples.find(c=>c.id===i.coupleId); if (!couple) return;
      const alreadyInRevisions = revisionProjects.some(r => r.instId === i.id);
      if (alreadyInRevisions) return;
      if (i.photoChangesNeeded || i.videoChangesNeeded) {
        const hours = calcHours(i.timeFrom, i.timeTo);
        const entry = { coupleName:couple.name, coupleId:couple.id, eventType:i.eventType||'', instId:i.id,
                        status:'changes', hours, approvedAt:'', editor:i.editor.trim(),
                        _photoChanges: !!i.photoChangesNeeded, _videoChanges: !!i.videoChangesNeeded };
        revisionProjects.push(entry);
        // Remove from activeProjects if it was added there
        const idx = activeProjects.findIndex(p => p.instId === i.id);
        if (idx !== -1) activeProjects.splice(idx, 1);
      }
    });

    // Sort active: new first, then unset; within each by couple name
    activeProjects.sort((a,b) => {
      const statusOrder = { new:0, '':1 };
      const so = (statusOrder[a.status]??1) - (statusOrder[b.status]??1);
      if (so !== 0) return so;
      return (a.coupleName||'').localeCompare(b.coupleName||'');
    });

    const hasSomething = activeProjects.length || Object.keys(editorCoupleLevel).length;
    if (!allEditors.length || !hasSomething) {
      editingEl.innerHTML = `<div class="prod-panel">
        <div class="prod-panel-head">
          <span class="prod-panel-title">In Production</span>
          <span class="prod-panel-sub">Active edit projects</span>
        </div>
        <div class="prod-no-editors">No active edit projects right now</div>
      </div>`;
    } else {
      // Group back by editor for column layout
      const byEditor = {};
      activeProjects.forEach(p => {
        if (!byEditor[p.editor]) byEditor[p.editor] = [];
        byEditor[p.editor].push(p);
      });

      const totalActive = activeProjects.length;
      const colsHtml = allEditors
        .filter(ed => (byEditor[ed]?.length) || (editorCoupleLevel[ed]?.length))
        .map(ed => {
          const projects = byEditor[ed] || [];
          const clCouples = editorCoupleLevel[ed] || [];
          const initials = ed.split(' ').map(w=>w[0]||'').join('').slice(0,2).toUpperCase();

          // Show up to 6 projects: Changes first, then New, then unset
          const statusOrder = {changes:0, new:1, '':2};
          const sorted = [...projects].sort((a,b)=>(statusOrder[a.status]??2)-(statusOrder[b.status]??2));

          // Group category sub-events: if ALL of a couple's events in a category (e.g. Reception)
          // are assigned to this editor, consolidate into one card like "(Couple) Reception"
          const grouped = [];
          const consumed = new Set();
          // Check each CATS category for full coverage
          CATS.forEach(cat => {
            // Group by coupleId within this category
            const byCoupleInCat = {};
            sorted.forEach(p => {
              const inst2 = _insts.find(x=>x.id===p.instId);
              if (inst2 && inst2.catId === cat.id) {
                if (!byCoupleInCat[p.coupleId]) byCoupleInCat[p.coupleId] = [];
                byCoupleInCat[p.coupleId].push(p);
              }
            });
            Object.keys(byCoupleInCat).forEach(cid => {
              const catProjects = byCoupleInCat[cid];
              // How many total _insts does this couple have in this category?
              const totalInCat = _insts.filter(i => i.coupleId === cid && i.catId === cat.id).length;
              if (catProjects.length > 1 && catProjects.length === totalInCat) {
                // All sub-events covered — consolidate into one card
                // Use the most urgent status from the group
                const bestStatus = catProjects.some(p=>p.status==='changes') ? 'changes'
                  : catProjects.some(p=>p.status==='new') ? 'new' : '';
                grouped.push({
                  ...catProjects[0],
                  eventType: cat.label,
                  status: bestStatus,
                  _grouped: true,
                  _groupInstIds: catProjects.map(p=>p.instId)
                });
                catProjects.forEach(p => consumed.add(p.instId));
              }
            });
          });
          // Add remaining ungrouped projects
          sorted.forEach(p => { if (!consumed.has(p.instId)) grouped.push(p); });
          const activeSlots = grouped.slice(0, 6);

          const makeCard = (p) => {
            const inst2 = _insts.find(x=>x.id===p.instId);
            const isPaused   = !p._grouped && !!inst2?.editPaused;
            const isUpcoming = !p._grouped && !!inst2?.editUpcoming;
            const statusBadge = p.status === 'new'
              ? `<span class="prod-badge new">New</span>`
              : p.status === 'changes'
                ? `<span class="prod-badge changes">Changes</span>`
                : '';
            const pauseBadge    = isPaused   ? `<span class="prod-badge" style="background:rgba(88,28,235,.07);border:1px solid rgba(88,28,235,.25);color:#5b21b6;">⏸ Paused</span>` : '';
            const upcomingBadge = isUpcoming ? `<span class="prod-badge" style="background:rgba(37,99,235,.08);border:1px solid rgba(37,99,235,.2);color:#1d4ed8;">🔜 Upcoming</span>` : '';
            const hrsBadge = p.hours ? `<span class="prod-badge hours">${esc(p.hours)}</span>` : '';
            const clickTarget = p._grouped ? p._groupInstIds[0] : p.instId;

            // Photo/video service badges — only show if service exists AND edit not yet done
            let svcHtml = '';
            if (p._grouped && p._groupInstIds) {
              // Grouped: show if ANY inst in group has that service still pending
              let anyPhoto = false, anyVideo = false;
              p._groupInstIds.forEach(gid => {
                const gi = _insts.find(x=>x.id===gid);
                if (gi) {
                  if ((gi.servicePhoto||gi.services==='photo'||gi.services==='both') && !gi.photoEditApproved) anyPhoto = true;
                  if ((gi.serviceVideo||gi.services==='video'||gi.services==='both') && !gi.videoEditApproved) anyVideo = true;
                }
              });
              if (anyPhoto) svcHtml += `<span class="prod-card-svc photo">📷 Photo</span>`;
              if (anyVideo) svcHtml += `<span class="prod-card-svc video">🎥 Video</span>`;
            } else if (inst2) {
              const iPhoto = !!(inst2.servicePhoto||inst2.services==='photo'||inst2.services==='both') && !inst2.photoEditApproved;
              const iVideo = !!(inst2.serviceVideo||inst2.services==='video'||inst2.services==='both') && !inst2.videoEditApproved;
              if (iPhoto) svcHtml += `<span class="prod-card-svc photo">📷 Photo</span>`;
              if (iVideo) svcHtml += `<span class="prod-card-svc video">🎥 Video</span>`;
            }

            // Due date
            let dueHtml = '';
            if (inst2) {
              const co = _couples.find(c=>c.id===inst2.coupleId);
              let dueDateStr = inst2.erDueDate || '';
              if (!dueDateStr && inst2.shootDay) {
                const sd2 = new Date(inst2.shootDay+'T00:00:00');
                sd2.setDate(sd2.getDate()+90);
                dueDateStr = sd2.toISOString().slice(0,10);
              }
              if (!dueDateStr && co && co.eventDate) {
                const ed2 = new Date(co.eventDate+'T00:00:00');
                ed2.setDate(ed2.getDate()+90);
                dueDateStr = ed2.toISOString().slice(0,10);
              }
              if (dueDateStr) {
                const dd = new Date(dueDateStr+'T00:00:00');
                const dl = Math.round((dd - today) / 86400000);
                const absD = Math.abs(dl);
                const cls = dl < 0 ? ' overdue' : dl <= 14 ? ' soon' : '';
                const txt = dl < 0 ? `${absD}d overdue` : dl === 0 ? 'Due today' : `${dl}d left`;
                dueHtml = `<span class="prod-card-due${cls}">${txt}</span>`;
              }
            }

            const metaHtml = (svcHtml || dueHtml)
              ? `<div class="prod-card-meta">${svcHtml}${dueHtml}</div>` : '';

            // Production clock
            const clockHtml = _clockHtml(p.instId, p.editStartedAt, p._grouped, p._groupInstIds);

            return `<div class="prod-project-card" onclick="goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${p.coupleId}','${clickTarget}')},150)">
              <div class="prod-project-couple">${esc(p.coupleName)}</div>
              <div class="prod-project-event">${esc(p.eventType||'')}</div>
              ${statusBadge||pauseBadge||upcomingBadge||hrsBadge ? `<div class="prod-project-badges">${statusBadge}${pauseBadge}${upcomingBadge}${hrsBadge}</div>` : ''}
              ${metaHtml}
              ${clockHtml}
            </div>`;
          };

          const activeCards = activeSlots.map(p=>makeCard(p)).join('');

          // Couple-level cards: show couple name but no event (editor is on the couple, not assigned to a specific event)
          const coupleCards = clCouples.map(cl =>
            `<div class="prod-project-card" style="opacity:.65;border-style:dashed;">
              <div class="prod-project-couple">${esc(cl.coupleName)}</div>
              <div class="prod-project-event" style="font-style:italic;font-size:.6rem;">No events assigned yet</div>
            </div>`
          ).join('');

          const countDisplay = grouped.length + clCouples.length;

          return `<div class="prod-editor-col">
            <div class="prod-editor-name-row">
              <div class="prod-editor-avatar">${_userAvatar(ed)}</div>
              <div class="prod-editor-name">${esc(ed)}</div>
              <div class="prod-editor-count">${countDisplay}</div>
            </div>
            ${activeCards}${coupleCards}
          </div>`;
        }).join('');

      const activeEdCount = allEditors.filter(ed=>(byEditor[ed]?.length)||(editorCoupleLevel[ed]?.length)).length;
      editingEl.innerHTML = `<div class="prod-panel">
        <div class="prod-panel-head">
          <span class="prod-panel-title">In Production</span>
          <span class="prod-panel-sub">${totalActive} project${totalActive===1?'':'s'} · ${activeEdCount} editor${activeEdCount===1?'':'s'}</span>
          ${_isAdmin() ? '<button class="panel-assign-btn" style="margin-top:0;" onclick="openAssign(\'\')">+ Assign</button>' : ''}
        </div>
        <div class="prod-editor-grid">${colsHtml}</div>
      </div>`;
    }
  }

  // ── REVISIONS PANEL ──────────────────────────────────────
  const revWrap = document.getElementById('coDashRevisionsWrap');
  const revEl = document.getElementById('coDashRevisions');
  if (revEl && revWrap) {
    if (!revisionProjects.length) {
      revWrap.style.display = 'none';
    } else {
      revWrap.style.display = '';
      // Sort: by couple name then event
      revisionProjects.sort((a,b) => (a.coupleName||'').localeCompare(b.coupleName||'') || (a.eventType||'').localeCompare(b.eventType||''));

      // Apply same category grouping as In Production
      const revGrouped = [];
      const revConsumed = new Set();
      CATS.forEach(cat => {
        const byCoupleInCat = {};
        revisionProjects.forEach(p => {
          const inst2 = _insts.find(x=>x.id===p.instId);
          if (inst2 && inst2.catId === cat.id) {
            const key = p.coupleId + '|' + p.editor;
            if (!byCoupleInCat[key]) byCoupleInCat[key] = [];
            byCoupleInCat[key].push(p);
          }
        });
        Object.keys(byCoupleInCat).forEach(key => {
          const catProjects = byCoupleInCat[key];
          const cid = catProjects[0].coupleId;
          const totalInCat = _insts.filter(i => i.coupleId === cid && i.catId === cat.id).length;
          if (catProjects.length > 1 && catProjects.length === totalInCat) {
            const hasPhoto = catProjects.some(p => p._photoChanges);
            const hasVideo = catProjects.some(p => p._videoChanges);
            revGrouped.push({
              ...catProjects[0],
              eventType: cat.label,
              _grouped: true,
              _groupInstIds: catProjects.map(p=>p.instId),
              _photoChanges: hasPhoto,
              _videoChanges: hasVideo
            });
            catProjects.forEach(p => revConsumed.add(p.instId));
          }
        });
      });
      revisionProjects.forEach(p => { if (!revConsumed.has(p.instId)) revGrouped.push(p); });

      const revCards = revGrouped.map(p => {
        const inst2 = _insts.find(x=>x.id===p.instId);
        const hasPhoto = p._photoChanges || !!inst2?.photoChangesNeeded;
        const hasVideo = p._videoChanges || !!inst2?.videoChangesNeeded;
        const hasGeneral = !hasPhoto && !hasVideo;
        const photoBadge = hasPhoto ? `<span class="rev-badge photo">📷 Photo</span>` : '';
        const videoBadge = hasVideo ? `<span class="rev-badge video">🎥 Video</span>` : '';
        const generalBadge = hasGeneral ? `<span class="rev-badge changes">🔄 Changes</span>` : '';
        const clickTarget = p._grouped ? p._groupInstIds[0] : p.instId;
        // Due date
        let revDueHtml = '';
        if (inst2) {
          const co = _couples.find(c=>c.id===inst2.coupleId);
          let dd2 = inst2.erDueDate || '';
          if (!dd2 && inst2.shootDay) { const s=new Date(inst2.shootDay+'T00:00:00'); s.setDate(s.getDate()+90); dd2=s.toISOString().slice(0,10); }
          if (!dd2 && co && co.eventDate) { const e2=new Date(co.eventDate+'T00:00:00'); e2.setDate(e2.getDate()+90); dd2=e2.toISOString().slice(0,10); }
          if (dd2) {
            const dObj=new Date(dd2+'T00:00:00'), dl2=Math.round((dObj-today)/86400000), abs2=Math.abs(dl2);
            const cls2 = dl2<0?' overdue':dl2<=14?' soon':'';
            const txt2 = dl2<0?abs2+'d overdue':dl2===0?'Due today':dl2+'d left';
            revDueHtml = `<span class="prod-card-due${cls2}" style="margin-top:.25rem;display:inline-block;">${txt2}</span>`;
          }
        }
        return `<div class="rev-card" onclick="goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${p.coupleId}','${clickTarget}')},150)">
          <div class="rev-card-couple">${esc(p.coupleName)}</div>
          <div class="rev-card-event">${esc(p.eventType||'')}</div>
          <div class="rev-card-editor">✂️ ${esc(p.editor)}</div>
          <div class="rev-card-badges">${generalBadge}${photoBadge}${videoBadge}</div>
          ${revDueHtml}
        </div>`;
      }).join('');

      revEl.innerHTML = `<div class="rev-panel">
        <div class="rev-panel-head">
          <span class="rev-panel-title">Revisions</span>
          <span class="rev-panel-sub">${revGrouped.length} item${revGrouped.length===1?'':'s'} need${revGrouped.length===1?'s':''} attention</span>
        </div>
        <div class="rev-grid">${revCards}</div>
      </div>`;
    }
  }

  // ── OVERDUE & ALMOST DUE PANELS ───────────────────────────
  // Compute effective due date for each active (non-approved) inst with an editor
  // (today is already declared earlier in this function)
  const ALMOST_DUE_DAYS = 14; // show as "almost due" when within 14 days
  const DEFAULT_DUE_DAYS = 90;
  const overdueItems = [];
  const almostDueItems = [];

  // Collect revision instIds so we can exclude them from overdue/almost due
  const revisionInstIds = new Set(revisionProjects.map(r => r.instId));

  _insts.forEach(i => {
    if (!i.editor || !i.editor.trim()) return;
    // Editor role: only include own assignments
    if (_isEditor() && (i.editor||'').trim() !== _editorName()) return;
    // Skip items already in the Revisions panel
    if (revisionInstIds.has(i.id)) return;
    // Skip fully approved items (but keep items that were approved then got changes back)
    const isFullyDone = ((i.approved && !i.changesNeeded && !i.photoChangesNeeded && !i.videoChangesNeeded)
      || (i.editorStatus === 'approved' && !i.changesNeeded && !i.photoChangesNeeded && !i.videoChangesNeeded));
    if (isFullyDone) return;
    const couple = _couples.find(c => c.id === i.coupleId); if (!couple) return;

    // Effective due date for this event: explicit inst erDueDate, or shootDay + 90, or eventDate + 90
    let dueDateStr = i.erDueDate || '';
    if (!dueDateStr && i.shootDay) {
      const sd = new Date(i.shootDay + 'T00:00:00');
      sd.setDate(sd.getDate() + DEFAULT_DUE_DAYS);
      dueDateStr = sd.toISOString().slice(0, 10);
    }
    if (!dueDateStr && couple.eventDate) {
      const ed = new Date(couple.eventDate + 'T00:00:00');
      ed.setDate(ed.getDate() + DEFAULT_DUE_DAYS);
      dueDateStr = ed.toISOString().slice(0, 10);
    }
    if (!dueDateStr) return; // no date info at all

    const dueDate = new Date(dueDateStr + 'T00:00:00');
    const daysLeft = Math.round((dueDate - today) / 86400000);

    const entry = {
      coupleName: couple.name, coupleId: couple.id, eventType: i.eventType || '',
      instId: i.id, editor: i.editor.trim(), dueDate: dueDateStr, daysLeft,
      catId: i.catId || ''
    };

    if (daysLeft < 0) {
      overdueItems.push(entry);
    } else if (daysLeft <= ALMOST_DUE_DAYS) {
      almostDueItems.push(entry);
    }
  });

  // Check couple-level project due dates (separate from event-level)
  _couples.forEach(c => {
    if (!c.editDueDate) return;
    // Editor role: skip _couples where editor has no assignments
    if (_isEditor()) {
      var myIds = _editorCoupleIds();
      if (myIds && !myIds.has(c.id)) return;
    }
    // Skip if couple is fully completed
    if (c.completedAt) return;
    // Check if couple has any unfinished events
    const coupleInsts = _insts.filter(i => i.coupleId === c.id);
    const allDone = coupleInsts.length > 0 && coupleInsts.every(i =>
      (i.approved && !i.changesNeeded && !i.photoChangesNeeded && !i.videoChangesNeeded)
      || (i.editorStatus === 'approved' && !i.changesNeeded && !i.photoChangesNeeded && !i.videoChangesNeeded));
    if (allDone) return;

    const dueDate = new Date(c.editDueDate + 'T00:00:00');
    const daysLeft = Math.round((dueDate - today) / 86400000);
    const editorNames = (c.editors || []).join(', ') || 'Unassigned';
    const entry = {
      coupleName: c.name, coupleId: c.id, eventType: 'Full Project',
      instId: coupleInsts.length ? coupleInsts[0].id : '', editor: editorNames,
      dueDate: c.editDueDate, daysLeft, catId: '', _isProject: true
    };

    if (daysLeft < 0) {
      overdueItems.push(entry);
    } else if (daysLeft <= ALMOST_DUE_DAYS) {
      almostDueItems.push(entry);
    }
  });

  // Sort: most urgent first
  overdueItems.sort((a, b) => a.daysLeft - b.daysLeft);
  almostDueItems.sort((a, b) => a.daysLeft - b.daysLeft);

  // Helper: apply category grouping to a list of due items
  function groupDueItems(items) {
    const grouped = [];
    const consumed = new Set();
    CATS.forEach(cat => {
      const byCoupleEditor = {};
      items.forEach(p => {
        if (p._isProject) return; // project-level items don't group
        if (p.catId === cat.id) {
          const key = p.coupleId + '|' + p.editor;
          if (!byCoupleEditor[key]) byCoupleEditor[key] = [];
          byCoupleEditor[key].push(p);
        }
      });
      Object.keys(byCoupleEditor).forEach(key => {
        const catItems = byCoupleEditor[key];
        const cid = catItems[0].coupleId;
        const totalInCat = _insts.filter(x => x.coupleId === cid && x.catId === cat.id).length;
        if (catItems.length > 1 && catItems.length === totalInCat) {
          grouped.push({
            ...catItems[0],
            eventType: cat.label,
            _grouped: true,
            _groupInstIds: catItems.map(p => p.instId),
            daysLeft: Math.min(...catItems.map(p => p.daysLeft))
          });
          catItems.forEach(p => consumed.add(p.instId));
        }
      });
    });
    items.forEach(p => { if (p._isProject || !consumed.has(p.instId)) grouped.push(p); });
    return grouped;
  }

  function renderDueCard(p, cardClass) {
    const absD = Math.abs(p.daysLeft);
    const daysText = p.daysLeft < 0
      ? `${absD} day${absD === 1 ? '' : 's'} overdue`
      : p.daysLeft === 0
        ? 'Due today'
        : `${p.daysLeft} day${p.daysLeft === 1 ? '' : 's'} left`;
    const fmtDate = p.dueDate;
    const clickTarget = p._grouped ? p._groupInstIds[0] : p.instId;
    const projectStyle = p._isProject ? ' style="border-width:2px;"' : '';
    const eventLabel = p._isProject
      ? `<div class="due-card-event" style="font-weight:500;letter-spacing:.1em;">📋 FULL PROJECT</div>`
      : `<div class="due-card-event">${esc(p.eventType)}</div>`;
    const clickAction = clickTarget
      ? `goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${p.coupleId}','${clickTarget}')},150)`
      : `goToAllCouples()`;
    // Photo/video service
    let dueSvcHtml = '';
    if (!p._isProject) {
      if (p._grouped && p._groupInstIds) {
        let anyP = false, anyV = false;
        p._groupInstIds.forEach(gid => {
          const gi = _insts.find(x=>x.id===gid);
          if (gi) {
            if ((gi.servicePhoto||gi.services==='photo'||gi.services==='both') && !gi.photoEditApproved) anyP = true;
            if ((gi.serviceVideo||gi.services==='video'||gi.services==='both') && !gi.videoEditApproved) anyV = true;
          }
        });
        if (anyP) dueSvcHtml += `<span class="prod-card-svc photo">📷</span>`;
        if (anyV) dueSvcHtml += `<span class="prod-card-svc video">🎥</span>`;
      } else {
        const di = _insts.find(x=>x.id===p.instId);
        if (di) {
          if ((di.servicePhoto||di.services==='photo'||di.services==='both') && !di.photoEditApproved) dueSvcHtml += `<span class="prod-card-svc photo">📷</span>`;
          if ((di.serviceVideo||di.services==='video'||di.services==='both') && !di.videoEditApproved) dueSvcHtml += `<span class="prod-card-svc video">🎥</span>`;
        }
      }
    }
    const svcRow = dueSvcHtml ? `<div style="display:flex;gap:.25rem;margin-top:.2rem;">${dueSvcHtml}</div>` : '';
    return `<div class="${cardClass}"${projectStyle} onclick="${clickAction}">
      <div class="due-card-couple">${esc(p.coupleName)}</div>
      ${eventLabel}
      <div class="due-card-editor">✂️ ${esc(p.editor)}</div>
      ${svcRow}
      <div class="due-card-days">${daysText}</div>
      <div class="due-card-date">Due ${fmtDate}</div>
    </div>`;
  }

  // Render Overdue panel
  const overdueWrap = document.getElementById('coDashOverdueWrap');
  const overdueEl = document.getElementById('coDashOverdue');
  if (overdueEl && overdueWrap) {
    const grouped = groupDueItems(overdueItems);
    if (!grouped.length) {
      overdueWrap.style.display = 'none';
    } else {
      overdueWrap.style.display = '';
      const cards = grouped.map(p => renderDueCard(p, 'overdue-card')).join('');
      overdueEl.innerHTML = `<div class="overdue-panel">
        <div class="overdue-panel-head">
          <span class="overdue-panel-title">Overdue</span>
          <span class="overdue-panel-sub">${grouped.length} project${grouped.length === 1 ? '' : 's'} past due</span>
        </div>
        <div class="overdue-grid">${cards}</div>
      </div>`;
    }
  }

  // Render Almost Due panel
  const almostDueWrap = document.getElementById('coDashAlmostDueWrap');
  const almostDueEl = document.getElementById('coDashAlmostDue');
  if (almostDueEl && almostDueWrap) {
    const grouped = groupDueItems(almostDueItems);
    if (!grouped.length) {
      almostDueWrap.style.display = 'none';
    } else {
      almostDueWrap.style.display = '';
      const cards = grouped.map(p => renderDueCard(p, 'almostdue-card')).join('');
      almostDueEl.innerHTML = `<div class="almostdue-panel">
        <div class="almostdue-panel-head">
          <span class="almostdue-panel-title">Almost Due</span>
          <span class="almostdue-panel-sub">${grouped.length} project${grouped.length === 1 ? '' : 's'} due within ${ALMOST_DUE_DAYS} days</span>
        </div>
        <div class="almostdue-grid">${cards}</div>
      </div>`;
    }
  }

  // ── PANEL 2: SHOOTERS ────────────────────────────────────
  // Build per-shooter: upcoming events + past (old) shots
  const shooterUpcoming = {}; // shooterName → [event objects sorted by date]
  const shooterPast     = {}; // shooterName → [past events, most recent first]

  // Gather all instanced with shooter + date
  const allShootEvents = [];
  _insts.forEach(i => {
    const couple = _couples.find(c=>c.id===i.coupleId); if (!couple) return;
    const dateStr  = i.shootDay || couple.eventDate || '';
    const dateObj  = dateStr ? new Date(dateStr+'T00:00:00') : null;
    const daysAway = dateObj ? Math.round((dateObj - today) / 86400000) : null;
    const hours    = calcHours(i.timeFrom, i.timeTo);
    const isShot   = _isInstShootDone(i);

    // Collect all shooters from all sources (deduplicated)
    const shooterSet = new Set();
    if (i.shooter && i.shooter.trim() && i.shooter !== 'N/A') shooterSet.add(i.shooter.trim());
    (i.photographers||[]).forEach(n => { if (n && n.trim() && n !== 'N/A') shooterSet.add(n.trim()); });
    (i.videographers||[]).forEach(n => { if (n && n.trim() && n !== 'N/A') shooterSet.add(n.trim()); });

    // If no crew assigned yet, still add the event under a placeholder so it shows up
    if (!shooterSet.size) shooterSet.add('_unassigned');

    shooterSet.forEach(sh => {
      allShootEvents.push({ shooter:sh, couple, instId:i.id, eventType:i.eventType||'', dateStr, dateObj, daysAway, hours, approved: isShot });
    });
  });

  allShootEvents.forEach(e => {
    const sh = e.shooter;
    const isPast = e.daysAway !== null && e.daysAway < 0;
    if (isPast || e.approved) {
      if (!shooterPast[sh]) shooterPast[sh] = [];
      shooterPast[sh].push(e);
    } else {
      if (!shooterUpcoming[sh]) shooterUpcoming[sh] = [];
      shooterUpcoming[sh].push(e);
    }
  });

  // Sort upcoming by soonest first; past by most recent first
  Object.keys(shooterUpcoming).forEach(sh => shooterUpcoming[sh].sort((a,b)=>a.daysAway-b.daysAway));
  Object.keys(shooterPast).forEach(sh => shooterPast[sh].sort((a,b)=> b.daysAway === null ? -1 : (b.daysAway - a.daysAway)));

  let allShooters = [...new Set([...Object.keys(shooterUpcoming), ...Object.keys(shooterPast)])]
    .sort((a, b) => {
      if (a === '_unassigned') return 1;
      if (b === '_unassigned') return -1;
      const aNext = (shooterUpcoming[a]||[])[0]; // already sorted soonest first
      const bNext = (shooterUpcoming[b]||[])[0];
      if (aNext && bNext) return aNext.daysAway - bNext.daysAway;
      if (aNext) return -1; // a has upcoming, b doesn't
      if (bNext) return 1;  // b has upcoming, a doesn't
      return a.localeCompare(b); // both have no upcoming — alphabetical
    });

  function shootEventRow(e, isPast) {
    const db = dateBadge(e.dateStr, isPast ? 'past' : '');
    const dl = e.dateStr ? daysLabel(e.dateStr) : '';
    const hrs = e.hours ? `<span class="shoot-event-hours">${e.hours}</span>` : '';
    return `<div class="shoot-event-item">
      ${db}
      <div class="shoot-event-details">
        <div class="shoot-event-couple" onclick="goToAllCouples();setTimeout(function(){selectCoupleAndOpen('${e.couple.id}','${e.instId}')},150)">${esc(e.couple.name)}</div>
        <div class="shoot-event-info">${esc(e.eventType)}${dl} ${hrs}</div>
      </div>
    </div>`;
  }

  // Editor role: only show their own shooter column
  if (_isEditor()) {
    const myName = _editorName();
    allShooters = allShooters.filter(sh => sh === myName);
  }

  const shooterHtml = allShooters.length ? allShooters.map(sh => {
    const isUnassigned = sh === '_unassigned';
    const displayName = isUnassigned ? 'No Crew Assigned' : sh;
    const initials = isUnassigned ? '?' : sh.split(' ').map(w=>w[0]||'').join('').slice(0,2).toUpperCase();
    const upcoming  = (shooterUpcoming[sh]||[]).slice(0,5);
    const past      = (shooterPast[sh]||[]).slice().reverse().slice(0); // most recent first
    const pastPreview = past.slice(0,2);
    const pastRest    = past.slice(2);

    const upcomingHtml = upcoming.length
      ? upcoming.map(e=>shootEventRow(e,false)).join('')
      : `<div style="font-size:.66rem;font-style:italic;color:var(--ink5);padding:.2rem 0;">No upcoming shoots</div>`;

    const uid_sh = 'sh_' + sh.replace(/\W/g,'_');
    const makePastItem = (e) => {
      const dl = e.dateStr ? daysLabel(e.dateStr) : '';
      const hrs = e.hours ? ` · ${e.hours}` : '';
      return `<div class="old-proj-item">
        <div class="old-proj-dot">📷</div>
        <div style="flex:1;min-width:0;">
          <div class="old-proj-name">${esc(e.couple.name)} · ${esc(e.eventType)}</div>
          <div class="old-proj-meta">${e.dateStr ? e.dateStr : 'No date'}${hrs}</div>
        </div>
      </div>`;
    };
    const pastPreviewHtml = pastPreview.map(makePastItem).join('');
    const pastRestHtml    = pastRest.map(makePastItem).join('');
    const pastMoreBtn = pastRest.length
      ? `<button class="old-projects-btn" id="${uid_sh}_more" onclick="toggleOldMore('${uid_sh}')">
           <span>+${pastRest.length} more</span><span class="op-arrow">▾</span>
         </button>
         <div class="old-projects-list" id="${uid_sh}_list">${pastRestHtml}</div>` : '';
    const pastBlock = past.length
      ? `<div style="margin-top:.45rem;">
          <button class="old-projects-btn" id="${uid_sh}_btn" onclick="toggleOldProjects('${uid_sh}')">
            <span>📸 Previous Shoots (${past.length})</span><span class="op-arrow">▾</span>
          </button>
          <div class="old-projects-list" id="${uid_sh}_drawer">
            ${pastPreviewHtml}${pastRest.length ? pastMoreBtn : ''}
          </div>
        </div>` : '';

    return `<div class="shooter-block">
      <div class="shooter-block-head">
        <div class="shooter-avatar">${_userAvatar(displayName)}</div>
        <div class="shooter-name">📷 ${esc(displayName)}</div>
      </div>
      ${upcomingHtml}
      ${pastBlock}
    </div>`;
  }).join('') : `<div class="intel-empty">No shooters assigned yet</div>`;

  // ── NEXT SHOOTS panel (all upcoming across all shooters) ──
  const allUpcoming = Object.values(shooterUpcoming).flat()
    .sort((a,b) => (a.daysAway??9999) - (b.daysAway??9999));
  // Deduplicate by instId (an event with multiple shooters may appear multiple times)
  const seenInst = new Set();
  let uniqueUpcoming = allUpcoming.filter(e => {
    if (seenInst.has(e.instId)) return false;
    seenInst.add(e.instId); return true;
  });
  // Editor role: only show shoots they're involved in
  if (_isEditor()) {
    const myIds = _editorInstIds();
    if (myIds) uniqueUpcoming = uniqueUpcoming.filter(e => myIds.has(e.instId));
  }
  const upcomingPreview = uniqueUpcoming.slice(0, 12);

  function nextShootRow(e) {
    let dayNum = '–', monStr = '', urgCls = '', daysCls = '', daysStr = '';
    if (e.dateObj) {
      dayNum  = e.dateObj.getDate();
      monStr  = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][e.dateObj.getMonth()];
      const d = e.daysAway;
      urgCls  = d < 0 ? 'past' : d <= 7 ? 'urgent' : d <= 30 ? 'soon' : '';
      daysCls = urgCls;
      daysStr = d < 0 ? `${Math.abs(d)}d ago` : d === 0 ? 'Today' : d === 1 ? 'Tomorrow' : `${d}d`;
    }
    const inst = _insts.find(i=>i.id===e.instId);
    // Crew
    const crew = [];
    if (e.shooter) crew.push(e.shooter);
    if (inst) {
      (inst.photographers||[]).filter(n=>n&&n!=='N/A'&&n.trim()).forEach(n=>{ if(!crew.includes(n)) crew.push(n); });
      (inst.videographers||[]).filter(n=>n&&n!=='N/A'&&n.trim()).forEach(n=>{ if(!crew.includes(n)) crew.push(n); });
    }
    // Time
    const timeFrom = inst?.timeFrom || '';
    const timeTo   = inst?.timeTo   || '';
    const timePart = timeFrom
      ? (timeTo ? `${timeFrom} – ${timeTo}` : timeFrom)
      : '';
    // Location
    const locName    = inst?.locationName    || '';
    const locAddress = inst?.locationAddress || '';
    const locParking = inst?.parkingLocation || '';
    return `<div class="next-shoot-row">
      <div class="next-shoot-date ${urgCls}">
        <div class="next-shoot-day">${dayNum}</div>
        <div class="next-shoot-mon">${monStr}</div>
      </div>
      <div class="next-shoot-info">
        <div class="next-shoot-couple" onclick="goToAllCouples();setTimeout(()=>selectCoupleAndOpen('${e.couple.id}','${e.instId}'),120)">${esc(e.couple.name)}</div>
        <div class="next-shoot-event">${esc(e.eventType)}</div>
        ${crew.length ? `<div class="next-shoot-crew">👥 ${crew.map(n=>esc(n)).join(' · ')}</div>` : ''}
        ${timePart ? `<div class="next-shoot-crew" style="color:var(--ink5);">⏱ ${esc(timePart)}</div>` : ''}
        ${locName ? `<div class="next-shoot-crew" style="color:var(--ink5);">📍 ${esc(locName)}</div>` : ''}
        ${locAddress ? `<div class="next-shoot-crew" style="color:var(--ink5);font-size:.58rem;">${esc(locAddress)}</div>` : ''}
        ${locParking ? `<div class="next-shoot-crew" style="color:var(--ink5);">🅿️ ${esc(locParking)}</div>` : ''}
      </div>
      <div class="next-shoot-days ${daysCls}">${daysStr}</div>
    </div>`;
  }

  const nextShootsHtml = upcomingPreview.length
    ? upcomingPreview.map(e => nextShootRow(e)).join('')
    : `<div class="intel-empty">No upcoming shoots</div>`;

  panelEl.style.display = 'grid';
  panelEl.innerHTML = `
    <div class="intel-panel">
      <div class="intel-panel-head">
        <span class="intel-panel-title">Editors in Progress</span>
        ${_isAdmin() ? '<button class="panel-assign-btn" style="margin-top:0;" onclick="openAssign(\'\')">+ Assign</button>' : ''}
      </div>
      ${editorHtml}
    </div>
    <div class="intel-panel">
      <div class="intel-panel-head">
        <span class="intel-panel-title">Next Shoots</span>
        <span class="intel-panel-count">${uniqueUpcoming.length} upcoming</span>
      </div>
      <div class="next-shoots-panel">${nextShootsHtml}</div>
    </div>
    <div class="intel-panel">
      <div class="intel-panel-head">
        <span class="intel-panel-title">Shooters</span>
        <span class="intel-panel-count">${allShooters.length} assigned</span>
      </div>
      ${shooterHtml}
    </div>`;

  // ── PRODUCTION ANALYTICS PANEL ────────────────────────────
  renderAnalyticsPanel();
}


// ── Production Analytics Panel ───────────────────────────
let _analyticsView = 'event'; // 'event' | 'editor'

function renderAnalyticsPanel() {
  var wrap = document.getElementById('coDashAnalyticsWrap');
  var el   = document.getElementById('coDashAnalytics');
  if (!wrap || !el) return;

  // Collect completed events with both start and completion timestamps
  var records = [];
  insts.forEach(function(i) {
    if (!i.editStartedAt || !i.editCompletedAt) return;
    if (!i.editor) return;
    // Editor role: only show own records
    if (_isEditor() && (i.editor||'').trim() !== _editorName()) return;
    var start = new Date(i.editStartedAt);
    var end   = new Date(i.editCompletedAt);
    var ms    = end - start;
    if (ms < 0) return; // invalid
    var days  = ms / 86400000;
    var couple = couples.find(function(c){return c.id===i.coupleId;});
    records.push({
      eventType: i.eventType || 'Unknown',
      catId: i.catId || '',
      editor: i.editor.trim(),
      days: days,
      coupleName: couple ? couple.name : '',
      instId: i.id
    });
  });

  if (!records.length) {
    wrap.style.display = 'none';
    return;
  }
  wrap.style.display = '';

  var evTab = _analyticsView === 'event' ? ' active' : '';
  var edTab = _analyticsView === 'editor' ? ' active' : '';

  var body = '';
  if (_analyticsView === 'event') {
    body = _renderEventAnalytics(records);
  } else {
    body = _renderEditorAnalytics(records);
  }

  el.innerHTML = '<div class="analytics-panel">' +
    '<div class="analytics-panel-head">' +
      '<span class="analytics-panel-title">⏱ Production Analytics</span>' +
      '<span class="analytics-panel-sub">' + records.length + ' completed event' + (records.length===1?'':'s') + '</span>' +
    '</div>' +
    '<div class="analytics-tabs">' +
      '<div class="analytics-tab' + evTab + '" onclick="_analyticsView=\'event\';renderAnalyticsPanel()">By Event Type</div>' +
      '<div class="analytics-tab' + edTab + '" onclick="_analyticsView=\'editor\';renderAnalyticsPanel()">By Editor</div>' +
    '</div>' +
    '<div class="analytics-body">' + body + '</div>' +
  '</div>';
}

function _fmtAvgDays(days) {
  if (days < 1) {
    var hrs = Math.round(days * 24);
    return hrs + 'h';
  }
  if (days < 7) return days.toFixed(1) + 'd';
  var weeks = days / 7;
  if (weeks < 4) return weeks.toFixed(1) + 'w';
  return (days / 30).toFixed(1) + 'mo';
}

function _speedClass(days) {
  if (days <= 7) return 'avg-fast';
  if (days <= 21) return 'avg-med';
  return 'avg-slow';
}

function _avgOf(arr) {
  if (!arr.length) return 0;
  return arr.reduce(function(s,x){return s+x;}, 0) / arr.length;
}

function _renderEventAnalytics(records) {
  // Group by eventType
  var byEvent = {};
  records.forEach(function(r) {
    if (!byEvent[r.eventType]) byEvent[r.eventType] = [];
    byEvent[r.eventType].push(r);
  });

  var eventTypes = Object.keys(byEvent).sort(function(a,b) {
    return _avgOf(byEvent[a].map(function(r){return r.days;})) - _avgOf(byEvent[b].map(function(r){return r.days;}));
  });

  var rows = eventTypes.map(function(ev) {
    var recs = byEvent[ev];
    var avg = _avgOf(recs.map(function(r){return r.days;}));
    var fastest = Math.min.apply(null, recs.map(function(r){return r.days;}));
    var slowest = Math.max.apply(null, recs.map(function(r){return r.days;}));
    var cls = _speedClass(avg);
    return '<tr>' +
      '<td style="font-weight:600;">' + esc(ev) + '</td>' +
      '<td class="avg-val ' + cls + '">' + _fmtAvgDays(avg) + '</td>' +
      '<td>' + _fmtAvgDays(fastest) + '</td>' +
      '<td>' + _fmtAvgDays(slowest) + '</td>' +
      '<td><span class="sample-count">' + recs.length + '</span></td>' +
    '</tr>';
  }).join('');

  // Overall average
  var overallAvg = _avgOf(records.map(function(r){return r.days;}));
  var overallCls = _speedClass(overallAvg);

  return '<table class="analytics-table">' +
    '<thead><tr><th>Event Type</th><th>Avg</th><th>Fastest</th><th>Slowest</th><th>Done</th></tr></thead>' +
    '<tbody>' + rows +
    '<tr style="border-top:2px solid var(--rule);">' +
      '<td style="font-weight:700;">Overall</td>' +
      '<td class="avg-val ' + overallCls + '">' + _fmtAvgDays(overallAvg) + '</td>' +
      '<td></td><td></td>' +
      '<td><span class="sample-count">' + records.length + '</span></td>' +
    '</tr>' +
    '</tbody></table>';
}

function _renderEditorAnalytics(records) {
  // Group by editor → eventType
  var byEditor = {};
  records.forEach(function(r) {
    if (!byEditor[r.editor]) byEditor[r.editor] = {};
    if (!byEditor[r.editor][r.eventType]) byEditor[r.editor][r.eventType] = [];
    byEditor[r.editor][r.eventType].push(r);
  });

  var editors = Object.keys(byEditor).sort();
  var allEventTypes = [...new Set(records.map(function(r){return r.eventType;}))].sort();

  var html = editors.map(function(ed) {
    var evMap = byEditor[ed];
    var allRecs = [];
    Object.values(evMap).forEach(function(arr){arr.forEach(function(r){allRecs.push(r);});});
    var overallAvg = _avgOf(allRecs.map(function(r){return r.days;}));
    var overallCls = _speedClass(overallAvg);
    var initials = ed.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2);

    var rows = allEventTypes.filter(function(ev){return !!evMap[ev];}).map(function(ev) {
      var recs = evMap[ev];
      var avg = _avgOf(recs.map(function(r){return r.days;}));
      var cls = _speedClass(avg);
      return '<tr>' +
        '<td style="padding-left:1.2rem;">' + esc(ev) + '</td>' +
        '<td class="avg-val ' + cls + '">' + _fmtAvgDays(avg) + '</td>' +
        '<td><span class="sample-count">' + recs.length + '</span></td>' +
      '</tr>';
    }).join('');

    return '<table class="analytics-table" style="margin-bottom:1rem;">' +
      '<thead><tr>' +
        '<th colspan="3" style="font-size:.7rem;padding-bottom:.4rem;">' +
          '<span style="display:inline-flex;align-items:center;gap:.4rem;">' +
            '<span style="width:22px;height:22px;border-radius:50%;background:var(--gold);color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;overflow:hidden;">' + _userAvatar(ed) + '</span>' +
            esc(ed) +
            '<span style="font-weight:400;color:var(--muted);margin-left:.2rem;">avg ' +
              '<span class="' + overallCls + '" style="font-weight:700;">' + _fmtAvgDays(overallAvg) + '</span>' +
              ' · ' + allRecs.length + ' done</span>' +
          '</span>' +
        '</th>' +
      '</tr>' +
      '<tr><th>Event</th><th>Avg Time</th><th>Done</th></tr></thead>' +
      '<tbody>' + rows + '</tbody></table>';
  }).join('');

  return html || '<div class="analytics-empty">No completed events with editor data yet.</div>';
}

// ══ CLIENT TIMELINE ══════════════════════════════════════

const CTL_FIXED_STEPS = [
  { id:'send_contract',    label:'Send Contract to Fill',              icon:'📄', section:'pre' },
  { id:'deposit',          label:'Contract Deposit Received',          icon:'💰', section:'pre' },
  { id:'signed',           label:'Contract Signed',                    icon:'✍️',  section:'pre' },
  { id:'discovery',        label:'Discovery Call',                     icon:'📞', section:'pre' },
  { id:'consultation',     label:'Creative Consultation',              icon:'🎨', section:'pre' },
  { id:'storyboard',       label:'Storyboarding',                      icon:'📋', section:'pre' },
  { id:'pre_wedding_shoot',label:'Pre-Wedding Shoot',                  icon:'📸', section:'pre' },
  { id:'final_meeting',    label:'Weddings for Dummies / Final Meeting',icon:'💍', section:'pre' },
  { id:'usb_delivery',     label:'Final USB Delivery',                 icon:'💾', section:'post' },
];

// Get or init timeline for a couple
function ctlGet(coupleId) {
  const co = couples.find(x=>x.id===coupleId); if (!co) return [];
  if (!co.timeline) co.timeline = [];

  // Ensure all pre-production fixed steps exist
  CTL_FIXED_STEPS.forEach(fs => {
    if (!co.timeline.find(s=>s.id===fs.id)) {
      co.timeline.push({ id:fs.id, label:fs.label, icon:fs.icon, fixed:true, type:'fixed', section:fs.section||'pre', done:false, date:'', person:'', notes:'' });
    }
  });
  // Remove legacy product_review fixed step (now handled per-event)
  co.timeline = co.timeline.filter(s => s.id !== 'product_review');

  // Ensure shoot + edit steps exist per event
  const ci = insts.filter(i=>i.coupleId===coupleId);
  ci.forEach(inst => {
    const showPhoto = !!(inst.servicePhoto || inst.services==='photo' || inst.services==='both');
    const showVideo = !!(inst.serviceVideo || inst.services==='video' || inst.services==='both');
    const bothServices = showPhoto && showVideo;
    const evtName = inst.eventType || 'Event';

    const shootId      = 'evt_shoot_'      + inst.id;
    const editId       = 'evt_edit_'       + inst.id;
    const photoEditId  = 'evt_photo_edit_' + inst.id;
    const videoEditId  = 'evt_video_edit_' + inst.id;

    // Shoot step (always one)
    if (!co.timeline.find(s=>s.id===shootId)) {
      co.timeline.push({ id:shootId, label:evtName + ' — Shoot', icon:'📷', type:'event', subtype:'shoot', instId:inst.id, done:false, date:'', person:'', notes:'' });
    }

    if (bothServices) {
      // Both services: ensure separate photo + video edit steps exist
      if (!co.timeline.find(s=>s.id===photoEditId)) {
        // Migrate existing single edit step data if present
        const oldEdit = co.timeline.find(s=>s.id===editId);
        co.timeline.push({ id:photoEditId, label:evtName + ' — Photo Edit', icon:'✂️📷', type:'event', subtype:'photo_edit', instId:inst.id, done: oldEdit?oldEdit.done:false, date: oldEdit?oldEdit.date:'', person:'', notes:'' });
      }
      if (!co.timeline.find(s=>s.id===videoEditId)) {
        co.timeline.push({ id:videoEditId, label:evtName + ' — Video Edit', icon:'✂️🎥', type:'event', subtype:'video_edit', instId:inst.id, done:false, date:'', person:'', notes:'' });
      }
      // Remove old combined edit step
      co.timeline = co.timeline.filter(s=>s.id!==editId);
    } else {
      // Single service: one edit step labelled by which service is active
      const singleLabel = showPhoto ? (evtName + ' — Photo Edit') : showVideo ? (evtName + ' — Video Edit') : (evtName + ' — Edit');
      const singleIcon  = showPhoto ? '✂️📷' : showVideo ? '✂️🎥' : '✂️';
      const singleSubtype = showPhoto ? 'photo_edit' : showVideo ? 'video_edit' : 'edit';
      if (!co.timeline.find(s=>s.id===editId)) {
        // Migrate from split steps if switching back
        const oldPhoto = co.timeline.find(s=>s.id===photoEditId);
        const oldVideo = co.timeline.find(s=>s.id===videoEditId);
        const oldDone  = oldPhoto ? oldPhoto.done : oldVideo ? oldVideo.done : false;
        const oldDate  = oldPhoto ? oldPhoto.date : oldVideo ? oldVideo.date : '';
        co.timeline.push({ id:editId, label:singleLabel, icon:singleIcon, type:'event', subtype:singleSubtype, instId:inst.id, done:oldDone, date:oldDate, person:'', notes:'' });
      } else {
        // Update label/icon/subtype on existing step to reflect current service
        const existing = co.timeline.find(s=>s.id===editId);
        if (existing) { existing.label = singleLabel; existing.icon = singleIcon; existing.subtype = singleSubtype; }
      }
      // Remove split steps
      co.timeline = co.timeline.filter(s=>s.id!==photoEditId && s.id!==videoEditId);
    }

    // Per-edit review steps — only for both services
    const reviewId       = 'evt_review_'       + inst.id;
    const photoReviewId  = 'evt_photo_review_' + inst.id;
    const videoReviewId  = 'evt_video_review_' + inst.id;
    if (bothServices) {
      if (!co.timeline.find(s=>s.id===photoReviewId)) {
        const old = co.timeline.find(s=>s.id===reviewId);
        co.timeline.push({ id:photoReviewId, label:evtName + ' — Photo Review', icon:'🎬📷', type:'event', subtype:'photo_review', instId:inst.id, done:old?old.done:false, date:old?old.date:'', person:'', notes:'' });
      }
      if (!co.timeline.find(s=>s.id===videoReviewId)) {
        co.timeline.push({ id:videoReviewId, label:evtName + ' — Video Review', icon:'🎬🎥', type:'event', subtype:'video_review', instId:inst.id, done:false, date:'', person:'', notes:'' });
      }
    } else {
      // Remove review steps when not both services
      co.timeline = co.timeline.filter(s=>s.id!==photoReviewId && s.id!==videoReviewId);
    }
    // Always remove standalone review (no longer used)
    co.timeline = co.timeline.filter(s=>s.id!==reviewId);
    // If switched back to single service, remove split reviews too
    if (!bothServices) {
      co.timeline = co.timeline.filter(s=>s.id!==photoReviewId && s.id!==videoReviewId);
    }

    // Migrate old single evt_ step if present
    co.timeline = co.timeline.filter(s => s.id !== 'evt_' + inst.id);
  });

  // Remove stale event steps for deleted insts
  co.timeline = co.timeline.filter(s =>
    s.type !== 'event' || ci.some(i =>
      'evt_shoot_'+i.id===s.id || 'evt_edit_'+i.id===s.id ||
      'evt_photo_edit_'+i.id===s.id || 'evt_video_edit_'+i.id===s.id ||
      'evt_photo_review_'+i.id===s.id || 'evt_video_review_'+i.id===s.id
    )
  );

  // Auto-sync shoot/edit done state from inst data
  ci.forEach(inst => {
    const showPhoto = !!(inst.servicePhoto || inst.services==='photo' || inst.services==='both');
    const showVideo = !!(inst.serviceVideo || inst.services==='video' || inst.services==='both');
    const bothServices = showPhoto && showVideo;

    const shootStep     = co.timeline.find(s=>s.id==='evt_shoot_'+inst.id);
    const editStep      = co.timeline.find(s=>s.id==='evt_edit_'+inst.id);
    const photoEditStep = co.timeline.find(s=>s.id==='evt_photo_edit_'+inst.id);
    const videoEditStep = co.timeline.find(s=>s.id==='evt_video_edit_'+inst.id);

    // Always sync step labels from current inst eventType
    const evtNameNow = inst.eventType || 'Event';
    const shootStepLabel = co.timeline.find(s=>s.id==='evt_shoot_'+inst.id);
    const editStepLabel  = co.timeline.find(s=>s.id==='evt_edit_'+inst.id);
    const peStepLabel    = co.timeline.find(s=>s.id==='evt_photo_edit_'+inst.id);
    const veStepLabel    = co.timeline.find(s=>s.id==='evt_video_edit_'+inst.id);
    const prStepLabel    = co.timeline.find(s=>s.id==='evt_photo_review_'+inst.id);
    const vrStepLabel    = co.timeline.find(s=>s.id==='evt_video_review_'+inst.id);
    if (shootStepLabel) shootStepLabel.label = evtNameNow + ' — Shoot';
    if (editStepLabel)  editStepLabel.label  = showPhoto ? (evtNameNow + ' — Photo Edit') : showVideo ? (evtNameNow + ' — Video Edit') : (evtNameNow + ' — Edit');
    if (peStepLabel)    peStepLabel.label    = evtNameNow + ' — Photo Edit';
    if (veStepLabel)    veStepLabel.label    = evtNameNow + ' — Video Edit';
    if (prStepLabel)    prStepLabel.label    = evtNameNow + ' — Photo Review';
    if (vrStepLabel)    vrStepLabel.label    = evtNameNow + ' — Video Review';

    if (shootStep && !shootStep.manualOverride) {
      const shootDone = _isInstShootDone(inst);
      if (shootDone && !shootStep.done) { shootStep.done = true; shootStep.date = inst.shootApprovedAt || inst.photoShootApprovedAt || inst.videoShootApprovedAt || ''; }
      else if (!shootDone && shootStep.autoSet) { shootStep.done = false; shootStep.date = ''; }
      shootStep.autoSet = shootDone;
    }
    if (bothServices) {
      if (photoEditStep && !photoEditStep.manualOverride) {
        const photoDone = !!inst.photoEditApproved;
        if (photoDone && !photoEditStep.done) { photoEditStep.done = true; photoEditStep.date = inst.photoEditApprovedAt || ''; }
        else if (!photoDone && photoEditStep.autoSet) { photoEditStep.done = false; photoEditStep.date = ''; }
        photoEditStep.autoSet = photoDone;
      }
      if (videoEditStep && !videoEditStep.manualOverride) {
        const videoDone = !!inst.videoEditApproved;
        if (videoDone && !videoEditStep.done) { videoEditStep.done = true; videoEditStep.date = inst.videoEditApprovedAt || ''; }
        else if (!videoDone && videoEditStep.autoSet) { videoEditStep.done = false; videoEditStep.date = ''; }
        videoEditStep.autoSet = videoDone;
      }
    } else {
      if (editStep && !editStep.manualOverride) {
        const editDone = !!inst.approved;
        if (editDone && !editStep.done) { editStep.done = true; editStep.date = inst.approvedAt || inst.photoEditApprovedAt || inst.videoEditApprovedAt || ''; }
        else if (!editDone && editStep.autoSet) { editStep.done = false; editStep.date = ''; }
        editStep.autoSet = editDone;
      }
    }
  });

  // Always sort: event steps are always ordered by date+subtype; fixed/custom respect user order
  {
    const fixedOrder = CTL_FIXED_STEPS.map(f=>f.id);
    const POST_STEP_IDS = ['usb_delivery'];
    const subtypeOrder = { shoot:0, photo_edit:1, photo_review:2, video_edit:3, video_review:4, edit:1, review:2 };
    co.timeline.sort((a,b) => {
      const rank = s => {
        if (s.type === 'fixed') {
          if (POST_STEP_IDS.includes(s.id)) return 9000000 + POST_STEP_IDS.indexOf(s.id);
          return fixedOrder.indexOf(s.id);
        }
        if (s.type === 'event') {
          const inst = insts.find(i =>
            s.id === 'evt_shoot_'+i.id || s.id === 'evt_edit_'+i.id ||
            s.id === 'evt_photo_edit_'+i.id || s.id === 'evt_video_edit_'+i.id ||
            s.id === 'evt_photo_review_'+i.id || s.id === 'evt_video_review_'+i.id
          );
          const dateVal = inst?.shootDay || '9999-99-99';
          const dateNum = parseInt(dateVal.replace(/-/g,'') || '99999999');
          const evtRank = dateNum < 99990000 ? dateNum - 20000000 : 99990000;
          const stepOffset = subtypeOrder[s.subtype] || 0;
          return 1000 + evtRank * 10 + stepOffset;
        }
        return 8999999;
      };
      return rank(a) - rank(b);
    });
    // Always force USB delivery to absolute last position
    const usbIdx = co.timeline.findIndex(s => s.id === 'usb_delivery');
    if (usbIdx !== -1 && usbIdx !== co.timeline.length - 1) {
      const [usb] = co.timeline.splice(usbIdx, 1);
      co.timeline.push(usb);
    }
  }
  return co.timeline;
}

function ctlSave(coupleId, skipFilmRender) {
  sv();
  if (!skipFilmRender) renderCoupleTimeline();
}

// ── Sidebar mini timeline ─────────────────────────────────
function renderCoupleTimeline() {
  const el = document.getElementById('coupleTimeline'); if (!el) return;
  renderJourneyOverview();
  el.innerHTML = ''; // journey now shown in journeyOverviewPanel below
}

// ── Full timeline modal ───────────────────────────────────
let _ctlCoupleId = null;
let _ctlEditingId = null; // step id currently being edited inline

function openTimeline(coupleId) {
  _ctlCoupleId = coupleId;
  _ctlEditingId = null;
  const co = couples.find(x=>x.id===coupleId); if (!co) return;
  document.getElementById('ctlTitle').textContent = co.name;
  document.getElementById('ctlSubtitle').textContent = 'Client Journey · Booking to Delivery';
  renderTimelineBody();
  document.getElementById('ctlOverlay').classList.add('open');
  setTimeout(_attachCtlDrag, 80);
}

function closeTimeline() {
  document.getElementById('ctlOverlay').classList.remove('open');
  _ctlCoupleId = null; _ctlEditingId = null;
}




function ctlFilmShowLabel(frameEl) {
  const strip = frameEl.closest('.ctl-film-strip');
  const bar = strip && strip.querySelector('.ctl-film-header-label');
  if (bar) bar.textContent = frameEl.dataset.label || '';
}
function ctlFilmRestoreLabel(frameEl) {
  const strip = frameEl.closest('.ctl-film-strip');
  const bar = strip && strip.querySelector('.ctl-film-header-label');
  if (!bar) return;
  const active = strip.querySelector('.ctl-film-frame.active');
  bar.textContent = active ? active.dataset.label : ' ';
}
function ctlVtScroll(id, delta) {
  const el = document.getElementById(id); if (!el) return;
  el.scrollBy({ left: delta, behavior: 'smooth' });
  setTimeout(()=>ctlVtUpdateArrows(id), 350);
}
function ctlVtUpdateArrows(id, leftId, rightId) {
  const el = document.getElementById(id); if (!el) return;
  const wrap = el.parentElement;
  const leftBtn  = leftId  ? document.getElementById(leftId)  : wrap && wrap.querySelector('.ctl-film-arrow.left, .ctl-vt-arrow.left');
  const rightBtn = rightId ? document.getElementById(rightId) : wrap && wrap.querySelector('.ctl-film-arrow.right, .ctl-vt-arrow.right');
  if (leftBtn)  leftBtn.classList.toggle('hidden',  el.scrollLeft <= 2);
  if (rightBtn) rightBtn.classList.toggle('hidden', el.scrollLeft + el.clientWidth >= el.scrollWidth - 2);
}
function buildVisualTimeline(steps) {
  if (!steps || !steps.length) return '';
  const total = steps.length;
  const done  = steps.filter(s=>s.done).length;
  const pct   = total > 0 ? Math.round(done/total*100) : 0;
  const { framesHtml, sprocketHoles } = buildFilmFrames(steps, 'modal');

  const html = `<div class="ctl-visual-timeline">
    <div class="ctl-film-strip">
      <div class="ctl-film-header">
        <span class="ctl-film-title">◉ Journey Overview</span>
        <span class="ctl-film-header-label" id="film-label-bar-modal">&nbsp;</span>
        <span class="ctl-film-fraction">${done} of ${total} complete</span>
      </div>
      <div class="ctl-film-sprockets">${sprocketHoles}</div>
      <div class="ctl-film-scroll-wrap">
        <button class="ctl-film-arrow left hidden" id="film-arrow-left-modal" onclick="ctlVtScroll('film-frames-modal',-220)">◀</button>
        <div class="ctl-film-frames" id="film-frames-modal" onscroll="ctlVtUpdateArrows('film-frames-modal','film-arrow-left-modal','film-arrow-right-modal')">${framesHtml}</div>
        <button class="ctl-film-arrow right" id="film-arrow-right-modal" onclick="ctlVtScroll('film-frames-modal',220)">▶</button>
      </div>
      <div class="ctl-film-sprockets">${sprocketHoles}</div>
      <div class="ctl-film-progress"><div class="ctl-film-progress-fill" style="width:${pct}%"></div></div>
    </div>
  </div>`;
  setTimeout(()=>{ ctlVtUpdateArrows('film-frames-modal','film-arrow-left-modal','film-arrow-right-modal'); const af=document.querySelector('#film-frames-modal .ctl-film-frame.active'); const bar=document.getElementById('film-label-bar-modal'); if(bar) bar.textContent=af?af.dataset.label:' '; },50);
  return html;
}

function renderTimelineBody() {
  const el = document.getElementById('ctlBody'); if (!el) return;
  const steps = ctlGet(_ctlCoupleId);
  const co = couples.find(x=>x.id===_ctlCoupleId);
  const coName = co ? co.name : 'Events';

  function buildStep(s, isLastInSection) {
    const isEditing = _ctlEditingId === s.id;
    const isEvent   = s.type === 'event';
    const isCustom  = s.type === 'custom';
    const isAutoSet = !!s.autoSet;

    const metaHtml = (!isEditing && (s.date || s.person || s.notes)) ? `
      <div class="ctl-step-meta">
        ${s.date   ? `<span class="ctl-step-chip date">📅 ${esc(s.date)}</span>` : ''}
        ${s.person ? `<span class="ctl-step-chip person">👤 ${esc(s.person)}</span>` : ''}
      </div>
      ${s.notes ? `<div class="ctl-step-notes">${esc(s.notes)}</div>` : ''}
    ` : '';

    const autoNote = isAutoSet ? `<span class="ctl-step-chip" style="opacity:.6;margin-left:.3rem;font-size:.5rem;">auto</span>` : '';

    const actionsHtml = !isEditing ? `
      <div class="ctl-step-actions">
        ${!isAutoSet ? `<button class="ctl-step-btn primary" onclick="ctlToggleDone('${s.id}')">${s.done ? '↩ Mark Undone' : '✓ Mark Done'}</button>` : ''}
        <button class="ctl-step-btn" onclick="ctlStartEdit('${s.id}')">✏️ Edit</button>
        ${isCustom ? `<button class="ctl-step-btn danger" onclick="ctlDeleteStep('${s.id}')">✕ Remove</button>` : ''}
      </div>
    ` : `
      <div class="ctl-step-form">
        ${isCustom ? `<input type="text" id="ctlLabel_${s.id}" value="${esc(s.label||'')}" placeholder="Step name…">` : ''}
        <div class="ctl-step-form-row">
          <input type="date" id="ctlDate_${s.id}" value="${s.date ? ctlDateToInput(s.date) : ''}" placeholder="Date completed">
          <input type="text" id="ctlPerson_${s.id}" value="${esc(s.person||'')}" placeholder="Assigned person">
        </div>
        <textarea id="ctlNotes_${s.id}" placeholder="Notes…">${esc(s.notes||'')}</textarea>
        <div class="ctl-step-form-row" style="justify-content:flex-end;">
          <button class="ctl-step-btn primary" onclick="event.stopPropagation();ctlSaveStep('${s.id}')">Save</button>
          <button class="ctl-step-btn" onclick="event.stopPropagation();ctlCancelEdit()">Cancel</button>
        </div>
      </div>
    `;

    return `<div class="ctl-step${s.done?' done':''}${isEvent?' event-type':''}${isCustom?' custom-type':''}" id="ctls_${s.id}" draggable="${isEditing?'false':'true'}" data-stepid="${s.id}">
      <div class="ctl-step-dot-col">
        ${!isEditing ? '<span class="ctl-step-drag-handle" title="Drag to reorder">⠿</span>' : ''}
        <div class="ctl-step-dot" onclick="ctlToggleDone('${s.id}')" title="${s.done?'Mark undone':'Mark done'}">${s.done?'✓':''}</div>
        ${!isLastInSection ? '<div class="ctl-step-line"></div>' : ''}
      </div>
      <div class="ctl-step-content" onclick="if(!_ctlEditingId||_ctlEditingId!=='${s.id}')ctlStartEdit('${s.id}')">
        <div class="ctl-step-name">${s.icon||'•'} ${esc(s.label)}${autoNote}${isCustom?`<span class="ctl-step-chip" style="margin-left:.3rem;">Custom</span>`:''}</div>
        ${metaHtml}
        ${actionsHtml}
      </div>
    </div>`;
  }

  const POST_STEP_IDS = ['usb_delivery'];
  const preSteps    = steps.filter(s=>s.type==='fixed' && !POST_STEP_IDS.includes(s.id));
  const postSteps   = steps.filter(s=>POST_STEP_IDS.includes(s.id));
  const eventSteps  = steps.filter(s=>s.type==='event');
  const customSteps = steps.filter(s=>s.type==='custom');

  const preHtml    = preSteps.map((s,i,a)   => buildStep(s, i===a.length-1)).join('');
  const customHtml = customSteps.map((s,i,a)=> buildStep(s, i===a.length-1)).join('');

  // Group event steps by instId — sorted by shootDay to match filmstrip order
  const ci = insts.filter(i=>i.coupleId===_ctlCoupleId).sort((a,b) => {
    const da = a.shootDay || '9999-99-99';
    const db = b.shootDay || '9999-99-99';
    return da < db ? -1 : da > db ? 1 : 0;
  });

  const productionEventsHtml = ci.map(inst => {
    const shootStep = eventSteps.find(s=>s.id==='evt_shoot_'+inst.id);
    if (!shootStep) return '';
    const stepsHtml = buildStep(shootStep, true);
    const allDone = shootStep.done;
    return `
      <div class="ctl-event-block" id="ctlEvtBlock_${inst.id}">
        <div class="ctl-event-block-label${allDone?' done':''}">
          🎬 ${esc(inst.eventType||'Event')}
          ${inst.shootDay ? '<span style="opacity:.5;font-weight:400;margin-left:.4rem;">'+inst.shootDay+'</span>' : ''}
        </div>
        <div class="ctl-step-group" id="ctlGroup_evt_shoot_${inst.id}">${stepsHtml}</div>
      </div>`;
  }).filter(Boolean).join('');

  const postProductionEventsHtml = ci.map(inst => {
    const showPhoto = !!(inst.servicePhoto || inst.services==='photo' || inst.services==='both');
    const showVideo = !!(inst.serviceVideo || inst.services==='video' || inst.services==='both');
    const bothServices = showPhoto && showVideo;

    const photoReviewStep = eventSteps.find(s=>s.id==='evt_photo_review_'+inst.id);
    const videoReviewStep = eventSteps.find(s=>s.id==='evt_video_review_'+inst.id);
    if (bothServices) {
      const photoEditStep = eventSteps.find(s=>s.id==='evt_photo_edit_'+inst.id);
      const videoEditStep = eventSteps.find(s=>s.id==='evt_video_edit_'+inst.id);
      if (!photoEditStep && !videoEditStep && !photoReviewStep && !videoReviewStep) return '';
      const allDone = (photoEditStep?.done && photoReviewStep?.done && videoEditStep?.done && videoReviewStep?.done);
      const stepsHtml = [
        photoEditStep   ? buildStep(photoEditStep,   false) : '',
        photoReviewStep ? buildStep(photoReviewStep, false) : '',
        videoEditStep   ? buildStep(videoEditStep,   false) : '',
        videoReviewStep ? buildStep(videoReviewStep, true)  : ''
      ].join('');
      return `
        <div class="ctl-event-block" id="ctlEvtBlock_edit_${inst.id}">
          <div class="ctl-event-block-label${allDone?' done':''}">
            ✂️ ${esc(inst.eventType||'Event')}
            ${inst.shootDay ? '<span style="opacity:.5;font-weight:400;margin-left:.4rem;">'+inst.shootDay+'</span>' : ''}
          </div>
          <div class="ctl-step-group" id="ctlGroup_evt_edit_${inst.id}">${stepsHtml}</div>
        </div>`;
    } else {
      const editStep = eventSteps.find(s=>s.id==='evt_edit_'+inst.id);
      if (!editStep) return '';
      const stepsHtml = buildStep(editStep, true);
      const allDone = !!editStep.done;
      return `
        <div class="ctl-event-block" id="ctlEvtBlock_edit_${inst.id}">
          <div class="ctl-event-block-label${allDone?' done':''}">
            ✂️ ${esc(inst.eventType||'Event')}
            ${inst.shootDay ? '<span style="opacity:.5;font-weight:400;margin-left:.4rem;">'+inst.shootDay+'</span>' : ''}
          </div>
          <div class="ctl-step-group" id="ctlGroup_evt_edit_${inst.id}">${stepsHtml}</div>
        </div>`;
    }
  }).filter(Boolean).join('');

  const postStepsHtml = postSteps.map((s,i,a) => buildStep(s, i===a.length-1)).join('');

  const total = steps.length, done = steps.filter(s=>s.done).length;
  const pct = total > 0 ? Math.round(done/total*100) : 0;

  el.innerHTML = `
    ${buildVisualTimeline(steps)}
    <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:1.2rem;">
      <div style="flex:1;height:6px;border-radius:3px;background:var(--rule);overflow:hidden;">
        <div style="height:100%;border-radius:3px;background:rgba(74,122,85,.85);width:${pct}%;transition:width .5s;"></div>
      </div>
      <span style="font-family:'Outfit',sans-serif;font-size:.65rem;font-weight:700;color:var(--ink4);white-space:nowrap;">${done} of ${total} complete</span>
    </div>
    ${preSteps.length ? `
      <div class="ctl-section-label">📋 Pre-Production</div>
      <div class="ctl-step-group" id="ctlGroup_pre">${preHtml}</div>
    ` : ''}
    ${productionEventsHtml ? `
      <div class="ctl-section-label">🎬 Production</div>
      ${productionEventsHtml}
    ` : ''}
    ${(postProductionEventsHtml || postSteps.length) ? `
      <div class="ctl-section-label">✂️ Post Production</div>
      ${postProductionEventsHtml}
      ${postSteps.length ? `<div class="ctl-step-group" id="ctlGroup_post">${postStepsHtml}</div>` : ''}
    ` : ''}
    ${customSteps.length ? `
      <div class="ctl-section-label">⭐ Custom Steps</div>
      <div class="ctl-step-group" id="ctlGroup_custom">${customHtml}</div>
    ` : ''}
    <div class="ctl-add-step" onclick="ctlAddStep()">+ Add custom step</div>
  `;
  setTimeout(_attachCtlDrag, 50);
}

// ── Actions ───────────────────────────────────────────────

function ctlInlineDate(stepId, triggerEl) {
  // Remove any existing picker
  const existing = document.getElementById('_ctlInlinePicker');
  if (existing) { existing.remove(); if (existing.dataset.stepId === stepId) return; }

  // Find the step
  let co = null, step = null;
  for (const candidate of couples) {
    const s = (candidate.timeline||[]).find(s=>s.id===stepId);
    if (s) { co = candidate; step = s; break; }
  }
  if (!co || !step) return;

  // Build picker
  const picker = document.createElement('div');
  picker.id = '_ctlInlinePicker';
  picker.dataset.stepId = stepId;
  picker.style.cssText = 'position:fixed;z-index:9999;background:var(--warm-white);border:1px solid var(--gold-line);border-radius:10px;padding:.6rem .8rem;box-shadow:0 8px 32px rgba(0,0,0,.18);display:flex;flex-direction:column;gap:.4rem;min-width:200px;';

  const currentVal = step.date ? ctlDateToInput(step.date) : '';
  picker.innerHTML = `
    <div style="font-family:'Outfit',sans-serif;font-size:.6rem;font-weight:700;color:var(--gold);letter-spacing:.08em;text-transform:uppercase;margin-bottom:.1rem;">
      ${esc(step.label.replace(' — ',' '))}
    </div>
    <input type="date" id="_ctlInlineDateInput" value="${currentVal}"
      style="font-family:'Outfit',sans-serif;font-size:.72rem;padding:.3rem .5rem;border:1px solid var(--gold-line);border-radius:6px;background:var(--parchment);color:var(--ink);outline:none;width:100%;box-sizing:border-box;">
    <div style="display:flex;gap:.4rem;justify-content:flex-end;">
      <button onclick="document.getElementById('_ctlInlinePicker').remove()"
        style="font-family:'Outfit',sans-serif;font-size:.58rem;padding:.2rem .55rem;border-radius:6px;border:1px solid var(--rule2);background:transparent;color:var(--ink4);cursor:pointer;">Cancel</button>
      <button onclick="ctlInlineDateSave('${stepId}')"
        style="font-family:'Outfit',sans-serif;font-size:.58rem;font-weight:700;padding:.2rem .6rem;border-radius:6px;border:none;background:var(--gold);color:#fff;cursor:pointer;">Save</button>
      ${step.date ? `<button onclick="ctlInlineDateClear('${stepId}')"
        style="font-family:'Outfit',sans-serif;font-size:.58rem;padding:.2rem .5rem;border-radius:6px;border:1px solid var(--rule2);background:transparent;color:var(--ink5);cursor:pointer;">Clear</button>` : ''}
    </div>`;

  document.body.appendChild(picker);

  // Position near trigger element
  const rect = triggerEl.getBoundingClientRect();
  let top = rect.bottom + 6;
  let left = rect.left;
  if (top + 130 > window.innerHeight) top = rect.top - 130;
  if (left + 210 > window.innerWidth) left = window.innerWidth - 215;
  picker.style.top = top + 'px';
  picker.style.left = left + 'px';

  // Focus and select date input
  setTimeout(() => { const inp = document.getElementById('_ctlInlineDateInput'); if(inp) inp.focus(); }, 30);

  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function _close(e) {
      if (!picker.contains(e.target) && e.target !== triggerEl) {
        picker.remove(); document.removeEventListener('click', _close);
      }
    });
  }, 100);
}

function ctlInlineDateSave(stepId) {
  const inp = document.getElementById('_ctlInlineDateInput'); if (!inp) return;
  let co = null, step = null;
  for (const candidate of couples) {
    const s = (candidate.timeline||[]).find(s=>s.id===stepId);
    if (s) { co = candidate; step = s; break; }
  }
  if (!co || !step) return;
  if (inp.value) {
    step.date = new Date(inp.value+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    step.manualOverride = true;
  } else {
    step.date = '';
  }
  document.getElementById('_ctlInlinePicker')?.remove();
  ctlSave(co.id);
  if (typeof renderJourneyOverview === 'function') renderJourneyOverview();
  if (_ctlCoupleId) renderTimelineBody();
}

function ctlInlineDateClear(stepId) {
  let co = null, step = null;
  for (const candidate of couples) {
    const s = (candidate.timeline||[]).find(s=>s.id===stepId);
    if (s) { co = candidate; step = s; break; }
  }
  if (!co || !step) return;
  step.date = '';
  step.manualOverride = true;
  document.getElementById('_ctlInlinePicker')?.remove();
  ctlSave(co.id);
  if (typeof renderJourneyOverview === 'function') renderJourneyOverview();
  if (_ctlCoupleId) renderTimelineBody();
}

function ctlToggleDone(stepId, coupleId) {
  let co = null, step = null;
  const tryIds = [coupleId, _ctlCoupleId, cur].filter(Boolean);
  for (const id of tryIds) {
    const candidate = couples.find(x=>x.id===id);
    if (candidate) { const s=(candidate.timeline||[]).find(s=>s.id===stepId); if(s){co=candidate;step=s;break;} }
  }
  if (!step) { for (const candidate of couples) { const s=(candidate.timeline||[]).find(s=>s.id===stepId); if(s){co=candidate;step=s;break;} } }
  if (!co || !step) return;
  step.done = !step.done;
  if (step.done && !step.date) step.date = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  if (!step.done) step.date = '';
  step.manualOverride = true;
  step.autoSet = false;
  ctlSave(co.id, true);

  // Surgical film strip update — patch classes/content in place, no scroll reset
  const steps = ctlGet(co.id);
  const firstIncomplete = steps.findIndex(s=>!s.done);
  const PHASE_ICONS = { send_contract:'📄', deposit:'💰', signed:'✍️', discovery:'📞', consultation:'🎨', storyboard:'📋', pre_wedding_shoot:'📸', final_meeting:'💍' };
  ['main','modal'].forEach(function(prefix) {
    const framesEl = document.getElementById('film-frames-' + prefix);
    if (!framesEl) return;
    const frames = framesEl.querySelectorAll('.ctl-film-frame');
    frames.forEach(function(frame, idx) {
      const s = steps[idx]; if (!s) return;
      const isDone = s.done;
      const isActive = !isDone && idx === firstIncomplete;
      frame.className = 'ctl-film-frame' + (isDone?' done':isActive?' active':'');
      const node = frame.querySelector('.ctl-film-node');
      if (node) {
        const icon = s.icon || PHASE_ICONS[s.id] || (s.subtype==='shoot'?'📷':s.subtype==='photo_edit'?'✂️📷':s.subtype==='video_edit'?'✂️🎥':s.subtype==='photo_review'?'🎬📷':s.subtype==='video_review'?'🎬🎥':s.subtype==='review'?'🎬':s.subtype==='edit'?'✂️':'⭐');
        node.innerHTML = '<span style="line-height:1">' + icon + '</span>' + (isDone?'<div class="ctl-film-check">✓</div>':'');
      }
      const dateEl = frame.querySelector('.ctl-film-date');
      if (dateEl) {
        const dateShort = s.date ? s.date.split(' ').slice(0,2).join(' ') : '';
        dateEl.textContent = dateShort || (isDone ? '+ date' : '');
      }
    });
    // Update fraction + progress
    const total = steps.length;
    const done = steps.filter(s=>s.done).length;
    const pct = total > 0 ? Math.round(done/total*100) : 0;
    const strip = framesEl.closest('.ctl-film-strip');
    if (strip) {
      const frac = strip.querySelector('.ctl-film-fraction'); if (frac) frac.textContent = done + ' of ' + total + ' complete';
      const fill = strip.querySelector('.ctl-film-progress-fill'); if (fill) fill.style.width = pct + '%';
    }
  });

  // Update sidebar list without touching film strip
  if (typeof renderJourneyOverview === 'function') {
    const elRight = document.getElementById('journeyOverviewPanel');
    if (elRight) {
      // Only re-render the sidebar, not the film strip
      const steps2 = ctlGet(co.id);
      const total = steps2.length;
      const done = steps2.filter(s=>s.done).length;
      const pct = total > 0 ? Math.round(done/total*100) : 0;
      const firstInc = steps2.findIndex(s=>!s.done);
      const stepsHtml = steps2.map(function(s, idx) {
        const isDone = s.done;
        const isActive = !isDone && idx === firstInc;
        const isEvent = s.type === 'event';
        const dateShort = s.date ? s.date.split(' ').slice(0,2).join(' ') : '';
        return '<div class="cj-sb-step'+(isDone?' done':'')+(isActive?' active':'')+(isEvent?' event-step':'')+'" onclick="ctlToggleDone(\''+s.id+'\')" title="'+(isDone?'Mark incomplete':'Mark complete')+'">'
          +'<div class="cj-sb-dot">'+(isDone?'✓':isActive?'◉':'')+'</div>'
          +'<div class="cj-sb-info"><span class="cj-sb-icon">'+(s.icon||'⭐')+'</span><span class="cj-sb-label">'+esc(s.label.replace(' — ',' '))+'</span></div>'
          +'<span class="cj-sb-date" onclick="event.stopPropagation();ctlInlineDate(\''+s.id+'\',this)" title="Edit date">'+esc(dateShort||'+ date')+'</span>'
          +'</div>';
      }).join('');
      elRight.innerHTML = '<div class="cj-sidebar-panel">'
        +'<div class="cj-sb-header"><span class="cj-sb-title">✦ Client Journey</span>'
        +'<div style="display:flex;align-items:center;gap:.5rem;"><span class="cj-sb-fraction">'+done+' of '+total+'</span>'
        +'<button onclick="openTimeline(\''+co.id+'\')" class="cj-sb-open-btn">Edit ↗</button></div></div>'
        +'<div class="cj-sb-progress-bar"><div class="cj-sb-progress-fill" style="width:'+pct+'%"></div></div>'
        +'<div class="cj-sb-steps">'+stepsHtml+'</div></div>';
    }
  }

  if (_ctlCoupleId) renderTimelineBody();
}
function ctlStartEdit(stepId) {
  if (_ctlEditingId === stepId) return;
  _ctlEditingId = stepId;
  renderTimelineBody();
  // Focus first input
  setTimeout(() => {
    const inp = document.getElementById('ctlDate_' + stepId);
    if (inp) inp.focus();
  }, 60);
}

function ctlCancelEdit() {
  _ctlEditingId = null;
  renderTimelineBody();
}

function ctlSaveStep(stepId) {
  const co = couples.find(x=>x.id===_ctlCoupleId); if (!co) return;
  const step = co.timeline.find(s=>s.id===stepId); if (!step) return;
  const dateInp   = document.getElementById('ctlDate_'   + stepId);
  const personInp = document.getElementById('ctlPerson_' + stepId);
  const notesInp  = document.getElementById('ctlNotes_'  + stepId);
  const labelInp  = document.getElementById('ctlLabel_'  + stepId);
  if (labelInp && labelInp.value.trim()) step.label = labelInp.value.trim();
  if (dateInp?.value)   step.date   = new Date(dateInp.value+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  else                  step.date   = '';
  if (personInp)        step.person = personInp.value.trim();
  if (notesInp)         step.notes  = notesInp.value.trim();
  _ctlEditingId = null;
  ctlSave(_ctlCoupleId);
  renderTimelineBody();
}

function ctlAddStep() {
  const co = couples.find(x=>x.id===_ctlCoupleId); if (!co) return;
  const newStep = {
    id: 'custom_' + uid(), label: 'Custom Step', icon: '⭐',
    fixed:false, type:'custom', done:false, date:'', person:'', notes:''
  };
  co.timeline.push(newStep);
  _ctlEditingId = newStep.id;
  ctlSave(_ctlCoupleId);
  renderTimelineBody();
  // Also let them rename it — focus the label by scrolling into view
  setTimeout(() => {
    const el = document.getElementById('ctls_' + newStep.id);
    if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
  }, 100);
}

function ctlDeleteStep(stepId) {
  const co = couples.find(x=>x.id===_ctlCoupleId); if (!co) return;
  co.timeline = co.timeline.filter(s=>s.id!==stepId);
  ctlSave(_ctlCoupleId);
  renderTimelineBody();
}

// helper: convert "15 Jan 2025" → "2025-01-15" for date input
function ctlDateToInput(str) {
  if (!str) return '';
  const months = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
  const parts = str.split(' ');
  if (parts.length !== 3) return '';
  return `${parts[2]}-${months[parts[1]]||'01'}-${parts[0].padStart(2,'0')}`;
}

function toggleOldProjects(uid) {
  const btn    = document.getElementById(uid+'_btn');
  const drawer = document.getElementById(uid+'_drawer');
  if (!btn||!drawer) return;
  const open = drawer.classList.toggle('open');
  btn.classList.toggle('open', open);
}
function toggleOldMore(uid) {
  const btn  = document.getElementById(uid+'_more');
  const list = document.getElementById(uid+'_list');
  if (!btn||!list) return;
  const open = list.classList.toggle('open');
  btn.classList.toggle('open', open);
  btn.querySelector('span').textContent = open ? 'Show less' : '+' + (list.children.length) + ' more';
}

// ── EDITOR ASSIGN MODAL ──────────────────────────────────
let assignSelInstId = null;
let assignSelStatus = 'new';

function openAssign(prefillEditor) {
  assignSelInstId = null;
  assignSelStatus = 'new';
  document.getElementById('assignEditorInp').value = prefillEditor || '';
  document.getElementById('assignSearchInp').value = '';
  document.getElementById('asBtnNew').classList.add('on');
  document.getElementById('asBtnChanges').classList.remove('on');
  renderAssignEventList();
  document.getElementById('assignOverlay').classList.add('open');
  const focusEl = prefillEditor ? 'assignSearchInp' : 'assignEditorInp';
  setTimeout(()=>document.getElementById(focusEl).focus(), 60);
}

function closeAssign() {
  document.getElementById('assignOverlay').classList.remove('open');
}

function selectAssignStatus(s) {
  assignSelStatus = s;
  document.getElementById('asBtnNew').classList.toggle('on', s==='new');
  document.getElementById('asBtnChanges').classList.toggle('on', s==='changes');
}

function renderAssignEventList() {
  const box = document.getElementById('assignEventList'); if (!box) return;
  const q = (document.getElementById('assignSearchInp')?.value || '').trim().toLowerCase();
  const today = new Date(); today.setHours(0,0,0,0);
  const MOS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // Build rows with date info for sorting
  const rows = [];
  couples.forEach(couple => {
    insts.filter(i=>i.coupleId===couple.id).forEach(i => {
      const dateStr = i.shootDay || couple.eventDate || '';
      const dateObj = dateStr ? new Date(dateStr + 'T00:00:00') : null;
      const daysAway = dateObj ? Math.round((dateObj - today) / 86400000) : null;
      rows.push({ instId:i.id, coupleName:couple.name, eventType:i.eventType||'Event',
                  currentEditor:i.editor||'', currentStatus:i.editorStatus||'',
                  dateObj, daysAway });
    });
  });

  // Soonest upcoming first, then past (most recent first), then undated
  rows.sort((a, b) => {
    const aUp = a.daysAway !== null && a.daysAway >= 0;
    const bUp = b.daysAway !== null && b.daysAway >= 0;
    const aPast = a.daysAway !== null && a.daysAway < 0;
    const bPast = b.daysAway !== null && b.daysAway < 0;
    if (aUp && bUp)     return a.daysAway - b.daysAway;
    if (aUp)            return -1;
    if (bUp)            return 1;
    if (aPast && bPast) return b.daysAway - a.daysAway;
    if (aPast)          return -1;
    if (bPast)          return 1;
    return a.coupleName.localeCompare(b.coupleName);
  });

  // Filter by search
  const filtered = q
    ? rows.filter(r =>
        r.coupleName.toLowerCase().includes(q) ||
        r.eventType.toLowerCase().includes(q) ||
        r.currentEditor.toLowerCase().includes(q))
    : rows;

  if (!filtered.length) {
    box.innerHTML = `<div style="font-size:.72rem;color:var(--ink5);font-style:italic;padding:.5rem .4rem;">${q ? 'No events match "'+esc(q)+'".' : 'No events yet.'}</div>`;
    return;
  }

  box.innerHTML = filtered.map(r => {
    const sel = r.instId === assignSelInstId;

    // Date badge
    let badgeClass = 'no-date', dayTxt = '–', monTxt = '';
    if (r.dateObj) {
      dayTxt = r.dateObj.getDate();
      monTxt = MOS[r.dateObj.getMonth()];
      badgeClass = r.daysAway < 0 ? 'urgent' : r.daysAway <= 30 ? 'soon' : '';
    }
    const dateBadge = `<div class="assign-date-badge ${badgeClass}">
      <div class="assign-date-day">${dayTxt}</div>
      ${monTxt ? `<div class="assign-date-mon">${monTxt}</div>` : ''}
    </div>`;

    const daysLabel = r.daysAway === null    ? ''
      : r.daysAway < 0  ? `<span style="font-size:.54rem;color:#c2410c;"> · ${Math.abs(r.daysAway)}d ago</span>`
      : r.daysAway === 0 ? `<span style="font-size:.54rem;color:var(--forest);"> · Today</span>`
      : r.daysAway <= 30 ? `<span style="font-size:.54rem;color:#b45309;"> · ${r.daysAway}d</span>`
      :                    `<span style="font-size:.54rem;color:var(--ink5);"> · ${r.daysAway}d</span>`;

    const statusDot = r.currentStatus === 'new'
      ? '<span style="font-size:.54rem;color:var(--forest);margin-left:.3rem;">● New</span>'
      : r.currentStatus === 'changes'
      ? '<span style="font-size:.54rem;color:#c2410c;margin-left:.3rem;">● Changes</span>'
      : '';
    const editorNote = r.currentEditor
      ? `<span style="font-size:.6rem;color:var(--ink5);"> · ${esc(r.currentEditor)}</span>` : '';

    return `<div class="assign-event-row${sel?' selected':''}" onclick="selectAssignEvent('${r.instId}',this)">
      ${dateBadge}
      <div style="flex:1;min-width:0;">
        <div class="assign-event-couple">${esc(r.coupleName)}${editorNote}${statusDot}</div>
        <div class="assign-event-type">${esc(r.eventType)}${daysLabel}</div>
      </div>
    </div>`;
  }).join('');
}

function selectAssignEvent(instId, el) {
  assignSelInstId = instId;
  document.querySelectorAll('.assign-event-row').forEach(r => r.classList.remove('selected'));
  el.classList.add('selected');
}

function saveAssign() {
  const editorName = document.getElementById('assignEditorInp').value.trim();
  if (!editorName) { document.getElementById('assignEditorInp').focus(); toast('Enter an editor name.'); return; }
  if (!assignSelInstId) { toast('Select an event to assign.'); return; }
  const inst = insts.find(i=>i.id===assignSelInstId); if (!inst) return;
  inst.editor = editorName;
  inst.editorStatus = assignSelStatus;
  if (!inst.editStartedAt) inst.editStartedAt = new Date().toISOString();
  sv();
  renderDashboard();
  renderEditorFilter();
  closeAssign();
  toast(`Assigned ${editorName} → ${inst.eventType} (${assignSelStatus==='new'?'New Project':'Changes'})`);
}

function removeEditorAssignment(instId) {
  const inst = insts.find(i=>i.id===instId); if (!inst) return;
  if (!confirm('Remove this assignment?')) return;
  inst.editor = '';
  inst.editorStatus = '';
  delete inst.editStartedAt;
  sv();
  renderDashboard();
  renderEditorFilter();
}
let editorFilter = ''; // '' = all
let shooterFilter = ''; // '' = all

function renderEditorFilter() {
  const bar = document.getElementById('editorFilterBar'); if (!bar) return;
  // Editor role: hide filter bar — they only see their own data
  if (_isEditor()) { bar.style.display='none'; return; }
  // Collect all unique editors from inst records + couple records
  const editorSet = new Set();
  insts.forEach(i => { if (i.editor) editorSet.add(i.editor.trim()); });
  couples.forEach(c => (c.editors||[]).forEach(e => editorSet.add(e.trim())));
  const editors = [...editorSet].sort();
  if (!editors.length) { bar.style.display='none'; return; }
  bar.style.display='flex';
  bar.innerHTML = `<span class="editor-filter-label">👤 Editor</span>
    <span class="editor-chip${editorFilter===''?' on':''}" onclick="setEditorFilter('')">All</span>
    ${editors.map(e=>`<span class="editor-chip${editorFilter===e?' on':''}" onclick="setEditorFilter('${esc(e).replace(/'/g,"\'")}')"><span class="cc-editor-pic">${_userAvatar(e)}</span> ${esc(e)}</span>`).join('')}`;
}

function setEditorFilter(ed) {
  editorFilter = ed;
  renderEditorFilter();
  renderDashboard();
}

function renderShooterFilter() {
  const bar = document.getElementById('shooterFilterBar'); if (!bar) return;
  // Editor role: hide filter bar — they only see their own data
  if (_isEditor()) { bar.style.display='none'; return; }
  const shooterSet = new Set();
  insts.forEach(i => { if (i.shooter) shooterSet.add(i.shooter.trim()); });
  const shooters = [...shooterSet].sort();
  if (!shooters.length) { bar.style.display='none'; return; }
  bar.style.display='flex';
  bar.innerHTML = `<span class="editor-filter-label">📷 Shooter</span>
    <span class="editor-chip${shooterFilter===''?' on':''}" onclick="setShooterFilter('')">All</span>
    ${shooters.map(s=>`<span class="editor-chip${shooterFilter===s?' on':''}" onclick="setShooterFilter('${esc(s).replace(/'/g,"\'")}')"><span class="cc-editor-pic">${_userAvatar(s)}</span> ${esc(s)}</span>`).join('')}`;
}

function setShooterFilter(sh) {
  shooterFilter = sh;
  renderShooterFilter();
  renderDashboard();
}

function toggleEvPanel(panelId, e) {
  if (e) {
    e.stopPropagation();
    e.preventDefault();
    // Only toggle if click came from the head itself, not from body content bubbling up
    const head = e.currentTarget;
    const body = head && head.nextElementSibling;
    if (body && body.classList.contains('ev-panel-body') && body.contains(e.target)) return;
  }
  const panel = document.getElementById(panelId);
  if (panel) panel.classList.toggle('open');
}

let _evModalOpen = null;
const _evTabState = {}; // iid → 'shoot'|'edit'

function togSec(id, h) {
  openEvModal(id);
}

function openEvModal(iid) {
  const inst = insts.find(i=>i.id===iid); if (!inst) return;
  const overlay = document.getElementById('evModalOverlay');
  const titleEl = document.getElementById('evModalTitle');
  const bodyEl  = document.getElementById('evModalBody');
  const boxEl   = document.getElementById('evModalBox');
  if (!overlay || !titleEl || !bodyEl) { console.error('Modal elements missing'); return; }
  _evModalOpen = iid;
  const co = couples.find(x=>x.id===inst.coupleId);
  titleEl.textContent = (inst.eventType||'Event') + (inst.client ? ' · ' + inst.client : '') + (co ? '  —  ' + co.name : '');
  // Editor readonly mode
  if (boxEl) {
    if (_isEditor()) boxEl.classList.add('editor-readonly');
    else boxEl.classList.remove('editor-readonly');
  }
  const sbEl = document.getElementById('sb' + iid);
  bodyEl.innerHTML = '';
  if (sbEl) {
    sbEl.style.display = '';
    bodyEl.appendChild(sbEl);
  } else {
    bodyEl.innerHTML = '<p style="padding:1rem;color:var(--ink4);">Content not found — try closing and reopening.</p>';
  }
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';


  setTimeout(function(){ renderDateQuick(iid); }, 50);
  setTimeout(_attachPanelDrag, 80);
}

function closeEvModal() {
  const overlay = document.getElementById('evModalOverlay');
  const bodyEl  = document.getElementById('evModalBody');
  if (!overlay) return;
  overlay.classList.remove('open');
  document.body.style.overflow = '';
  if (_evModalOpen) {
    const sbEl = document.getElementById('sb' + _evModalOpen);
    const sec  = document.querySelector('.ev-section[data-iid="' + _evModalOpen + '"]');
    if (sbEl && sec) { sbEl.style.display = 'none'; sec.appendChild(sbEl); }
    _evModalOpen = null;
  }
  // Editor: navigate back to previous view
  if (_isEditor() && _editorPrevView) {
    var prev = _editorPrevView;
    _editorPrevView = null;
    if (prev === 'boardroom') { goToDashboard(); return; }
    if (prev === 'clientLounge') { goToAllCouples(); return; }
    if (prev === 'editingRoom') { goToEditingRoom(); return; }
    goToDashboard();
    return;
  }
  updateCollapseBtn();
}

// ── EVENT DRAG-REORDER (handle-only, no draggable attr on section) ──────────
// Uses pointer events on the handle to implement drag entirely in JS
let evDrag = { active:false, iid:null, catId:null, ghost:null, startY:0, sections:[] };

function attachEventDrag() {
  document.querySelectorAll('.ev-drag-handle').forEach(handle => {
    // Remove any previously attached listeners to avoid duplicates
    if (handle._evDS) {
      handle.removeEventListener('mousedown', handle._evDS);
      handle.removeEventListener('touchstart', handle._evDS);
    }
    handle._evDS = evDragStart;
    handle.addEventListener('mousedown', handle._evDS);
    handle.addEventListener('touchstart', handle._evDS, { passive:false });
  });
}

function evDragStart(e) {
  if (e.type === 'touchstart') e.preventDefault();
  const iid  = e.currentTarget.dataset.iid;
  const sec  = document.querySelector(`.ev-section[data-iid="${iid}"]`);
  const list = sec?.closest('.inst-list');
  if (!sec || !list) return;

  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const rect    = sec.getBoundingClientRect();

  // ghost
  const ghost = sec.cloneNode(true);
  ghost.style.cssText = `position:fixed;left:${rect.left}px;top:${rect.top}px;width:${rect.width}px;opacity:.55;pointer-events:none;z-index:9999;transition:none;box-shadow:0 8px 32px rgba(0,0,0,.6);`;
  document.body.appendChild(ghost);

  sec.classList.add('is-dragging');

  evDrag = {
    active: true, iid, catId: list.dataset.catid,
    ghost, startY: clientY, offsetY: clientY - rect.top,
    sections: [...list.querySelectorAll('.ev-section')]
  };

  document.addEventListener('mousemove', evDragMove);
  document.addEventListener('touchmove',  evDragMove, { passive:false });
  document.addEventListener('mouseup',   evDragEnd);
  document.addEventListener('touchend',  evDragEnd);
}

function evDragMove(e) {
  if (!evDrag.active) return;
  if (e.type==='touchmove') e.preventDefault();
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  evDrag.ghost.style.top = (clientY - evDrag.offsetY) + 'px';

  // find drop target
  evDrag.sections.forEach(s => s.classList.remove('drag-over-top','drag-over-bot'));
  for (const s of evDrag.sections) {
    if (s.dataset.iid === evDrag.iid) continue;
    const r = s.getBoundingClientRect();
    if (clientY >= r.top && clientY <= r.bottom) {
      s.classList.add(clientY < r.top + r.height/2 ? 'drag-over-top' : 'drag-over-bot');
      break;
    }
  }
}

function evDragEnd(e) {
  if (!evDrag.active) return;
  document.removeEventListener('mousemove', evDragMove);
  document.removeEventListener('touchmove',  evDragMove);
  document.removeEventListener('mouseup',   evDragEnd);
  document.removeEventListener('touchend',  evDragEnd);

  evDrag.ghost.remove();
  document.querySelector(`.ev-section[data-iid="${evDrag.iid}"]`)?.classList.remove('is-dragging');

  // find target
  let targetIid = null, insertBefore = true;
  for (const s of evDrag.sections) {
    if (s.classList.contains('drag-over-top'))  { targetIid = s.dataset.iid; insertBefore = true;  break; }
    if (s.classList.contains('drag-over-bot'))  { targetIid = s.dataset.iid; insertBefore = false; break; }
  }
  evDrag.sections.forEach(s => s.classList.remove('drag-over-top','drag-over-bot'));

  if (targetIid && targetIid !== evDrag.iid) {
    // reorder in data
    const catInsts = insts.filter(i=>i.coupleId===cur && i.catId===evDrag.catId).sort((a,b)=>a.order-b.order);
    const fi = catInsts.findIndex(i=>i.id===evDrag.iid);
    const ti = catInsts.findIndex(i=>i.id===targetIid);
    if (fi>=0 && ti>=0) {
      const [moved] = catInsts.splice(fi,1);
      const newTi   = insertBefore ? catInsts.findIndex(i=>i.id===targetIid) : catInsts.findIndex(i=>i.id===targetIid)+1;
      catInsts.splice(newTi<0?catInsts.length:newTi, 0, moved);
      catInsts.forEach((x,idx)=>x.order=idx);
      sv(); renderSections();
    }
  }
  evDrag.active = false;
}

// ── SONG DRAG-REORDER (same pointer-based approach) ──────────────────────────
let sDrag = { active:false, sid:null, iid:null, ghost:null, items:[] };

function attachSongDrag() {
  document.querySelectorAll('.song-drag-handle').forEach(handle => {
    if (handle._sDragS) {
      handle.removeEventListener('mousedown', handle._sDragS);
      handle.removeEventListener('touchstart', handle._sDragS);
    }
    handle._sDragS = sDragStart;
    handle.addEventListener('mousedown', handle._sDragS);
    handle.addEventListener('touchstart', handle._sDragS, { passive:false });
  });
}

function sDragStart(e) {
  if (e.type==='touchstart') e.preventDefault();
  const item = e.currentTarget.closest('.song-item');
  const list = item?.closest('.song-list');
  if (!item || !list) return;

  const sid = item.dataset.sid;
  const iid = list.id.replace('sl','');
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const rect    = item.getBoundingClientRect();

  const ghost = item.cloneNode(true);
  ghost.style.cssText = `position:fixed;left:${rect.left}px;top:${rect.top}px;width:${rect.width}px;opacity:.5;pointer-events:none;z-index:9999;background:var(--panel);border-radius:8px;`;
  document.body.appendChild(ghost);
  item.classList.add('is-dragging');

  sDrag = { active:true, sid, iid, ghost, offsetY: clientY-rect.top, items:[...list.querySelectorAll('.song-item')] };

  document.addEventListener('mousemove', sDragMove);
  document.addEventListener('touchmove',  sDragMove, { passive:false });
  document.addEventListener('mouseup',   sDragEnd);
  document.addEventListener('touchend',  sDragEnd);
}

function sDragMove(e) {
  if (!sDrag.active) return;
  if (e.type==='touchmove') e.preventDefault();
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  sDrag.ghost.style.top = (clientY - sDrag.offsetY) + 'px';
  sDrag.items.forEach(s=>s.classList.remove('drag-over-top','drag-over-bot'));
  for (const s of sDrag.items) {
    if (s.dataset.sid===sDrag.sid) continue;
    const r = s.getBoundingClientRect();
    if (clientY >= r.top && clientY <= r.bottom) {
      s.classList.add(clientY < r.top+r.height/2 ? 'drag-over-top' : 'drag-over-bot');
      break;
    }
  }
}

function sDragEnd() {
  if (!sDrag.active) return;
  document.removeEventListener('mousemove', sDragMove);
  document.removeEventListener('touchmove',  sDragMove);
  document.removeEventListener('mouseup',   sDragEnd);
  document.removeEventListener('touchend',  sDragEnd);

  sDrag.ghost.remove();
  document.querySelector(`.song-item[data-sid="${sDrag.sid}"]`)?.classList.remove('is-dragging');

  let targetSid = null, insertBefore = true;
  for (const s of sDrag.items) {
    if (s.classList.contains('drag-over-top'))  { targetSid = s.dataset.sid; insertBefore = true;  break; }
    if (s.classList.contains('drag-over-bot'))  { targetSid = s.dataset.sid; insertBefore = false; break; }
  }
  sDrag.items.forEach(s=>s.classList.remove('drag-over-top','drag-over-bot'));

  if (targetSid && targetSid !== sDrag.sid) {
    const instSongs = songs.filter(s=>s.instanceId===sDrag.iid).sort((a,b)=>(a.order||0)-(b.order||0));
    const fi = instSongs.findIndex(s=>s.id===sDrag.sid);
    const ti = instSongs.findIndex(s=>s.id===targetSid);
    if (fi>=0 && ti>=0) {
      const [moved] = instSongs.splice(fi,1);
      const newTi   = insertBefore ? instSongs.findIndex(s=>s.id===targetSid) : instSongs.findIndex(s=>s.id===targetSid)+1;
      instSongs.splice(newTi<0?instSongs.length:newTi, 0, moved);
      instSongs.forEach((s,idx)=>s.order=idx);
      sv(); renderSections();
    }
  }
  sDrag.active = false;
}

// ── SONG SUGGESTIONS ─────────────────────────────────
function getSongPool(evType, lang) {
  // Pool: current couple's songs → this evType+lang library → this evType history → full library → full history
  const seen = new Set(), result = [];

  // 1. Current couple's existing songs
  songs.filter(s=>s.coupleId===cur).forEach(s=>{
    const key = s.title.toLowerCase();
    if (!seen.has(key)) { seen.add(key); result.push({ title:s.title, artist:s.artist||'', src:'current' }); }
  });

  // 2. Song library — matching evType+lang first, then all other keys
  const libKeysFirst = lang && evType ? [evType+'|'+lang] : [];
  const allLibKeys = Object.keys(songLib);
  const libKeyOrder = [...new Set([...libKeysFirst, ...allLibKeys])];
  libKeyOrder.forEach(k => {
    (songLib[k]||[]).forEach(e => {
      if (!e.title) return;
      const key = e.title.toLowerCase();
      if (!seen.has(key)) { seen.add(key); result.push({ title:e.title, artist:e.artist||'', src:'library' }); }
    });
  });

  // 3. Song history — matching evType first, then all other keys
  const histKeysFirst = evType ? ['en','hi','pa','inst'].map(l=>evType+'|'+l) : [];
  const allHistKeys = Object.keys(songHist);
  const histKeyOrder = [...new Set([...histKeysFirst, ...allHistKeys])];
  histKeyOrder.forEach(k => {
    (songHist[k]||[]).forEach(e => {
      if (!e.title) return;
      const key = e.title.toLowerCase();
      if (!seen.has(key)) { seen.add(key); result.push({ title:e.title, artist:e.artist||'', src:'history' }); }
    });
  });

  return result;
}

let suggIdx = -1;

function showSugg(iid, q) {
  const box = document.getElementById('sug'+iid); if (!box) return;
  q = q.trim();
  if (q.length < 2) { box.style.display='none'; return; }
  const ql = q.toLowerCase();
  const inst = insts.find(i=>i.id===iid);
  const lang = getLangPick(iid);
  const matches = getSongPool(inst?.eventType, lang).filter(s=>s.title.toLowerCase().includes(ql)).slice(0,10);
  if (!matches.length) { box.style.display='none'; return; }

  suggIdx = -1;
  box.innerHTML = matches.map((s,idx)=>{
    const tl = s.title.toLowerCase(), qi = tl.indexOf(ql);
    const hl = qi>=0
      ? esc(s.title.slice(0,qi)) + '<mark>'+esc(s.title.slice(qi,qi+q.length))+'</mark>' + esc(s.title.slice(qi+q.length))
      : esc(s.title);
    const srcLabel = s.src==='history' ? 'hist' : s.src==='library' ? 'lib' : '';
    const histBadge = srcLabel ? `<span style="font-size:.5rem;opacity:.5;margin-left:.3rem;">${srcLabel}</span>` : '';
    return `<div class="suggest-item" data-idx="${idx}" data-title="${esc(s.title)}" data-artist="${esc(s.artist)}"
      onmousedown="pickSugg(event,'${iid}',this)">
      <div class="sug-title">${hl}${histBadge}</div>
      ${s.artist ? `<div class="sug-artist">${esc(s.artist)}</div>` : ''}
    </div>`;
  }).join('');
  box.style.display = 'block';
}

function pickSugg(e, iid, el) {
  e.preventDefault();
  document.getElementById('t'+iid).value  = uesc(el.dataset.title  || '');
  document.getElementById('a'+iid).value  = uesc(el.dataset.artist || '');
  document.getElementById('sug'+iid).style.display = 'none';
  qAdd(iid);
}

function handleSuggKey(e, iid) {
  const box   = document.getElementById('sug'+iid); if (!box || box.style.display==='none') { if(e.key==='Enter') qAdd(iid); return; }
  const items = [...box.querySelectorAll('.suggest-item')];
  if (e.key==='ArrowDown') { e.preventDefault(); suggIdx=Math.min(suggIdx+1,items.length-1); items.forEach((it,i)=>it.classList.toggle('active',i===suggIdx)); }
  else if (e.key==='ArrowUp') { e.preventDefault(); suggIdx=Math.max(suggIdx-1,0); items.forEach((it,i)=>it.classList.toggle('active',i===suggIdx)); }
  else if (e.key==='Enter') {
    if (suggIdx>=0 && items[suggIdx]) { items[suggIdx].dispatchEvent(new MouseEvent('mousedown',{bubbles:true})); }
    else { box.style.display='none'; qAdd(iid); }
  }
  else if (e.key==='Escape') { box.style.display='none'; }
}

function setLangPick(iid, lang, btn) {
  document.querySelectorAll(`#lp${iid} .lpbtn`).forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

function getLangPick(iid) {
  return document.querySelector(`#lp${iid} .lpbtn.on`)?.dataset.lang || 'pa';
}

function setSongLang(sid, btn, newLang) {
  const s = songs.find(x=>x.id===sid); if (!s) return;
  const inst = insts.find(i=>i.id===s.instanceId);

  // Migrate legacy single lang to genres array on first touch
  if (!s.genres) {
    const legacy = s.lang || s.libLang;
    s.genres = legacy ? [legacy] : [];
  }

  const idx = s.genres.indexOf(newLang);
  if (idx > -1) {
    // Already active — deselect only if another genre stays on
    if (s.genres.length > 1) {
      s.genres.splice(idx, 1);
      // Remove from history for the deselected genre
      if (inst) {
        const oldKey = inst.eventType + '|' + newLang;
        if (songHist[oldKey]) {
          songHist[oldKey] = songHist[oldKey].filter(e => !(e.title.trim().toLowerCase() === s.title.trim().toLowerCase() && e.coupleId === s.coupleId));
          if (!songHist[oldKey].length) delete songHist[oldKey];
        }
      }
    }
  } else {
    // Not active — add it and register in history
    s.genres.push(newLang);
    if (inst) {
      const newKey = inst.eventType + '|' + newLang;
      if (!songHist[newKey]) songHist[newKey] = [];
      const already = songHist[newKey].some(e => e.title.trim().toLowerCase() === s.title.trim().toLowerCase() && e.coupleId === s.coupleId);
      if (!already) {
        const couple = couples.find(c => c.id === s.coupleId);
        const addedAt = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
        songHist[newKey].push({ title: s.title, artist: s.artist||'', coupleId: s.coupleId, coupleName: couple?.name||'', eventType: inst.eventType, client: inst.client||'', addedAt });
      }
      // If this is the only genre (just switched from another), remove from old genre histories
      if (s.genres.length === 1) {
        // Song only has the new genre — clean up any stale history entries under other genres
        ['en','hi','pa','inst'].forEach(otherLang => {
          if (otherLang === newLang) return;
          const oldKey = inst.eventType + '|' + otherLang;
          if (songHist[oldKey]) {
            songHist[oldKey] = songHist[oldKey].filter(e => !(e.title.trim().toLowerCase() === s.title.trim().toLowerCase() && e.coupleId === s.coupleId));
            if (!songHist[oldKey].length) delete songHist[oldKey];
          }
        });
      }
    }
  }

  // Keep s.lang in sync with first genre for backward compat
  s.lang = s.genres[0] || null;
  delete s.libLang;

  // Update buttons inline — no full re-render needed
  const row = btn.closest('.song-lang-pick');
  if (row) row.querySelectorAll('.slpbtn').forEach(b => b.classList.toggle('on', s.genres.includes(b.dataset.lang)));

  sv();
}

function qAdd(iid) {
  const tE = document.getElementById('t'+iid), aE = document.getElementById('a'+iid);
  const title = tE?.value.trim(); if (!title) return toast('Enter a song title.');
  const lang  = getLangPick(iid);
  const inst  = insts.find(i => i.id === iid);
  const order = songs.filter(s=>s.instanceId===iid).length;
  const artist = aE?.value.trim() || '';
  songs.push({ id:uid(), coupleId:cur, instanceId:iid, title, artist, used:false, usedAt:null, order, lang });

  // Auto-save to history library (keyed by eventType|lang, allows multiple entries per title across couples)
  if (inst) {
    const hKey = inst.eventType + '|' + lang;
    if (!songHist[hKey]) songHist[hKey] = [];
    const couple = couples.find(c => c.id === cur);
    const addedAt = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    // Allow duplicate titles if from different couples — track per coupleId
    const already = songHist[hKey].some(e => e.title.trim().toLowerCase() === title.toLowerCase() && e.coupleId === cur);
    if (!already) songHist[hKey].push({ title, artist, coupleId: cur, coupleName: couple?.name||'', eventType: inst.eventType, client: inst.client||'', addedAt });
  }

  sv();
  if (tE) tE.value=''; if (aE) aE.value='';
  document.getElementById('sug'+iid)?.style && (document.getElementById('sug'+iid).style.display='none');
  renderSections();
  setTimeout(()=>document.getElementById('t'+iid)?.focus(), 60);
  toast(`Added: "${title}"`);
}

// Song drag is now attached at end of renderSections via setTimeout

// ── DUPLICATE DETECTION ─────────────────────────────
function checkDuplicates() {
  const el = document.getElementById('dupWarn');
  if (!el || !cur) return;

  // Find songs that appear in 2+ different events within this couple only
  const mySongs = songs.filter(s => s.coupleId === cur);
  const seen = {}; // normalised title → { title, iids[] }
  mySongs.forEach(s => {
    const key = s.title.trim().toLowerCase();
    if (!seen[key]) seen[key] = { title: s.title, iids: [] };
    if (!seen[key].iids.includes(s.instanceId)) seen[key].iids.push(s.instanceId);
  });

  const warnings = [];
  Object.values(seen).forEach(d => {
    if (d.iids.length > 1) {
      const evTags = d.iids.map(iid => {
        const inst = insts.find(i => i.id === iid);
        if (!inst) return '<em>unknown</em>';
        const client = inst.client ? `<span style="color:var(--gold);font-weight:600;"> · ${esc(inst.client)}</span>` : '';
        return `<span style="color:var(--ink)">${esc(inst.eventType)}${client}</span>`;
      });
      warnings.push(`<strong>${esc(d.title)}</strong> — used in: ${evTags.join('<span style="color:var(--ink4)"> &amp; </span>')}`);
    }
  });

  if (!warnings.length) { el.innerHTML = ''; return; }

  el.innerHTML = `<div class="dup-banner">
    <div class="dup-icon">⚠️</div>
    <div>
      <div style="font-weight:700;margin-bottom:.25rem;">Duplicate songs detected (${warnings.length})</div>
      <ul>${warnings.map(w=>`<li>• ${w}</li>`).join('')}</ul>
    </div>
  </div>`;
}

// ── FLAT VIEW ────────────────────────────────────────
function renderFlat() {
  const fBar=document.getElementById('fBar'), fTab=document.getElementById('fTable'), fBadge=document.getElementById('fBadge');
  if (!fBar||!fTab) return;
  const ii = getInsts(cur);
  const filters = [{k:'all',l:'All'},{k:'used',l:'✓ Used'}, ...ii.map(i=>({k:i.id,l:i.client?i.eventType+' · '+i.client:i.eventType}))];
  fBar.innerHTML = filters.map(f=>`<button class="fbtn${ff===f.k?' on':''}" onclick="setFF('${esc(f.k)}')">${esc(f.l)}</button>`).join('')
    + `<input class="search" type="text" placeholder="🔍 Search…" oninput="fs=this.value;renderFlat()" value="${esc(fs)}">`;

  let fil = songs.filter(s=>s.coupleId===cur);
  if (ff==='used')    fil = fil.filter(s=>s.used);
  else if (ff!=='all') fil = fil.filter(s=>s.instanceId===ff);
  if (fs) { const ql=fs.toLowerCase(); fil=fil.filter(s=>s.title.toLowerCase().includes(ql)||(s.artist||'').toLowerCase().includes(ql)); }

  if (sortCol) {
    fil = [...fil].sort((a,b)=>{
      let av='',bv='';
      if      (sortCol==='title')  { av=a.title.toLowerCase(); bv=b.title.toLowerCase(); }
      else if (sortCol==='artist') { av=(a.artist||'').toLowerCase(); bv=(b.artist||'').toLowerCase(); }
      else if (sortCol==='event')  { const ai=insts.find(i=>i.id===a.instanceId),bi=insts.find(i=>i.id===b.instanceId); av=(ai?.eventType||'').toLowerCase(); bv=(bi?.eventType||'').toLowerCase(); }
      else if (sortCol==='used')   { av=a.used?'1':'0'; bv=b.used?'1':'0'; }
      return av<bv?-sortDir:av>bv?sortDir:0;
    });
  }

  const tot=songs.filter(s=>s.coupleId===cur).length, usN=songs.filter(s=>s.coupleId===cur&&s.used).length;
  if (fBadge) fBadge.textContent = `${usN} used · ${tot-usN} available`;

  if (!fil.length) { fTab.innerHTML=`<div class="empty-s"><div class="ico">🎵</div><p>${tot===0?'No songs yet.':'No songs match.'}</p></div>`; return; }

  const arr = d=>`<span class="sort-arrow">${d===1?'▲':'▼'}</span>`;
  const th  = (col,lbl)=>`<th onclick="setSort('${col}')">${lbl}${sortCol===col?arr(sortDir):''}</th>`;

  fTab.innerHTML = `<table><thead><tr>
    <th style="width:30px"></th>${th('title','Song')}${th('artist','Artist')}${th('event','Event')}${th('used','Used')}<th style="width:28px"></th>
  </tr></thead><tbody>${fil.map(s=>{
    const inst=insts.find(i=>i.id===s.instanceId);
    return `<tr class="${s.used?'ur':''}">
      <td><button class="ck-btn${s.used?' on':''}" onclick="toggleUsed('${s.id}')">${s.used?'✓':''}</button></td>
      <td><span style="font-weight:500;${s.used?'text-decoration:line-through;color:var(--ink4);':'color:var(--ink);'}">${esc(s.title)}</span></td>
      <td style="color:var(--ink4);font-size:.78rem;">${esc(s.artist||'—')}</td>
      <td><span class="ev-chip">${esc(inst?.eventType||'?')}</span>${inst?.client?`<div style="font-size:.62rem;color:var(--gold);font-weight:600;margin-top:2px">👤 ${esc(inst.client)}</div>`:''}</td>
      <td style="font-size:.66rem;color:var(--ink4);font-style:italic">${s.usedAt?'Used '+s.usedAt:'—'}</td>
      <td><button class="rm-song" onclick="rmSong('${s.id}')">✕</button></td>
    </tr>`;
  }).join('')}</tbody></table>`;
}

function setSort(col) { if(sortCol===col) sortDir=-sortDir; else{sortCol=col;sortDir=1;} renderFlat(); }
function setFF(f)    { ff=f; renderFlat(); }

// ── SONG ACTIONS ─────────────────────────────────────
function toggleUsed(id) {
  const s=songs.find(x=>x.id===id); if (!s) return;
  s.used=!s.used; s.usedAt=s.used ? new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}) : null;
  sv(); renderView(); checkDuplicates(); renderCoupleCard();
  toast(s.used?`✓ Used: "${s.title}"`:(`Unmarked: "${s.title}"`));
}
function rmSong(id) {
  const s = songs.find(x=>x.id===id); if (!s) return;
  const inst = insts.find(i=>i.id===s.instanceId);
  songs = songs.filter(x=>x.id!==id);

  // Remove from songHist if no remaining song with same title exists in this eventType+lang combo
  if (inst && s.lang) {
    const hKey = inst.eventType + '|' + s.lang;
    const titleLower = s.title.trim().toLowerCase();
    const stillExists = songs.some(o =>
      o.coupleId === s.coupleId &&
      o.title.trim().toLowerCase() === titleLower &&
      (o.lang === s.lang || o.libLang === s.lang) &&
      insts.find(i=>i.id===o.instanceId)?.eventType === inst.eventType
    );
    if (!stillExists && songHist[hKey]) {
      songHist[hKey] = songHist[hKey].filter(e => !(e.title.trim().toLowerCase() === titleLower && e.coupleId === s.coupleId));
      if (!songHist[hKey].length) delete songHist[hKey];
    }
  }

  sv(); renderView(); checkDuplicates(); renderCoupleCard();
}

// ── SONG LIBRARY ─────────────────────────────────────
function openLibrary() { curLibLang='en'; renderLibrary(); document.getElementById('libModal').classList.add('open'); }
function closeLibrary() { saveLibNow(); document.getElementById('libModal').classList.remove('open'); }

function setLibLang(lang, btn) {
  saveLibNow();
  curLibLang = lang;
  document.querySelectorAll('.lang-tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderLibrary();
}

// libOpenSec: which event bodies are expanded in library
const libOpenSec = {};

function toggleLibGenre(catId) {
  const keys = CATS.find(c=>c.id===catId)?.events.map(ev=>ev+'|'+curLibLang) || [];
  const anyOpen = keys.some(k=>libOpenSec[k]===true);
  keys.forEach(k=>{ libOpenSec[k] = anyOpen ? false : true; });
  renderLibrary();
}

function renderLibrary() {
  const el = document.getElementById('libContent'); if (!el) return;
  el.innerHTML = CATS.map(cat=>{
    const keys = cat.events.map(ev=>ev+'|'+curLibLang);
    const anyOpen = keys.some(k=>libOpenSec[k]===true);
    const toggleLabel = anyOpen ? '⊖ Collapse' : '⊕ Expand';
    return `
    <div style="margin-bottom:1.4rem;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:.9rem;font-weight:700;color:var(--ink);padding-bottom:.5rem;margin-bottom:.6rem;border-bottom:1px solid var(--rule);display:flex;align-items:center;justify-content:space-between;">
        <span>${cat.icon} ${cat.label}</span>
        <button class="lib-genre-toggle" data-catid="${cat.id}">${toggleLabel}</button>
      </div>
      ${cat.events.map(ev=>{
        const key   = ev+'|'+curLibLang;
        const saved = songLib[key] || [];
        const cnt   = saved.filter(x=>x&&x.title).length;
        const isOpen = libOpenSec[key] === true;
        const rows = [];
        for (let r=0;r<10;r++) {
          const entry = saved[r] || {title:'',artist:''};
          rows.push(`
            <div class="lib-song-row">
              <span class="lib-num">${r+1}</span>
              <input type="text" placeholder="Song title…"
                     data-libkey="${esc(key)}" data-idx="${r}" data-field="title"
                     value="${esc(entry.title||'')}"
                     oninput="libChange(this)"
                     onkeydown="libKeyNav(event,this)">
              <input type="text" placeholder="Artist…"
                     data-libkey="${esc(key)}" data-idx="${r}" data-field="artist"
                     value="${esc(entry.artist||'')}"
                     oninput="libChange(this)"
                     onkeydown="libKeyNav(event,this)">
            </div>`);
        }
        return `
          <div class="lib-ev-block">
            <div class="lib-ev-head" onclick="toggleLibEv('${esc(key)}',this)">
              <span class="lib-ev-title">${esc(ev)}</span>
              <span class="lib-ev-count">${cnt>0?cnt+' song'+(cnt!==1?'s':'') :''}</span>
              <span class="lib-ev-chev${isOpen?' open':''}">▼</span>
            </div>
            <div class="lib-ev-body${isOpen?' open':''}" id="lev_${esc(key).replace(/[^a-z0-9]/gi,'_')}">
              <div style="display:grid;grid-template-columns:18px 1fr 1fr;gap:.35rem;margin-bottom:.35rem;padding:.1rem 0;">
                <span></span>
                <span style="font-size:.65rem;color:var(--ink4);font-weight:600;letter-spacing:.05rem;">TITLE</span>
                <span style="font-size:.65rem;color:var(--ink4);font-weight:600;letter-spacing:.05rem;">ARTIST</span>
              </div>
              ${rows.join('')}
            </div>
          </div>`;
      }).join('')}
    </div>`;
  }).join('');
}

// Delegated click handler for lib-genre-toggle buttons
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.lib-genre-toggle');
  if (btn && btn.dataset.catid) toggleLibGenre(btn.dataset.catid);
});

function toggleLibEv(key, headEl) {
  libOpenSec[key] = libOpenSec[key]===true ? false : true;
  const bodyId = 'lev_'+key.replace(/[^a-z0-9]/gi,'_');
  const body = document.getElementById(bodyId);
  const chev = headEl.querySelector('.lib-ev-chev');
  if (body) { body.classList.toggle('open', libOpenSec[key]===true); }
  if (chev) { chev.classList.toggle('open', libOpenSec[key]===true); }
}

function libChange(inp) {
  saveLibNow();
  // update count badge for this key
  const key = inp.dataset.libkey;
  const saved = songLib[uesc(key)] || [];
  const cnt = saved.filter(x=>x&&x.title).length;
  const head = inp.closest('.lib-ev-block')?.querySelector('.lib-ev-count');
  if (head) head.textContent = cnt>0 ? cnt+' song'+(cnt!==1?'s':'') : '';
}

function libKeyNav(e, inp) {
  if (e.key==='Enter') {
    e.preventDefault();
    // move to next title field in same event
    const allInputs = [...inp.closest('.lib-ev-body').querySelectorAll('input')];
    const idx = allInputs.indexOf(inp);
    allInputs[idx+1]?.focus();
  }
}

function saveLibNow() {
  // Read all visible lib inputs and save
  document.querySelectorAll('[data-libkey]').forEach(inp => {
    const key   = uesc(inp.dataset.libkey);
    const r     = +inp.dataset.idx;
    const field = inp.dataset.field;
    if (!songLib[key]) songLib[key] = [];
    while (songLib[key].length <= r) songLib[key].push({title:'',artist:''});
    songLib[key][r][field] = inp.value.trim();
  });
  // clean up empty entries at the end
  Object.keys(songLib).forEach(k=>{
    songLib[k] = songLib[k].filter(x=>x&&(x.title||x.artist));
    if (!songLib[k].length) delete songLib[k];
  });
  sv();
}

// ── SONG HISTORY ─────────────────────────────────────
let curHistLang = 'en';

function openHistory() {
  curHistLang = 'en';
  document.querySelectorAll('#histLangTabs .lang-tab').forEach((b,i)=>b.classList.toggle('on',i===0));
  renderHistory();
  document.getElementById('histModal').classList.add('open');
}
function closeHistory() { document.getElementById('histModal').classList.remove('open'); }

function setHistLang(lang, btn) {
  curHistLang = lang;
  document.querySelectorAll('#histLangTabs .lang-tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderHistory();
}

function renderHistory() {
  const el = document.getElementById('histContent'); if (!el) return;

  // Build a lookup: normalised "evType|lang|titleLower" → all matching live song records with full metadata
  const liveLookup = {}; // key → [{coupleName, eventType, client, addedAt}]
  songs.forEach(s => {
    const inst   = insts.find(i => i.id === s.instanceId); if (!inst) return;
    const couple = couples.find(c => c.id === s.coupleId);
    const langs  = s.genres && s.genres.length ? s.genres : (s.lang || s.libLang ? [s.lang || s.libLang] : []);
    if (!langs.length) return;
    langs.forEach(lang => {
      const lk     = inst.eventType + '|' + lang + '|' + s.title.trim().toLowerCase();
      if (!liveLookup[lk]) liveLookup[lk] = [];
      liveLookup[lk].push({
        coupleName: couple?.name || '',
        eventType:  inst.eventType,
        client:     inst.client || '',
        addedAt:    s.usedAt || ''
      });
    });
  });

  const sections = CATS.map(cat => {
    const evRows = cat.events.map(ev => {
      const key     = ev + '|' + curHistLang;
      const entries = (songHist[key] || []).filter(e => e.title);
      if (!entries.length) return '';

      const rows = entries.map((e, idx) => {
        // Look up live metadata for this entry
        const lk   = ev + '|' + curHistLang + '|' + e.title.trim().toLowerCase();
        const live = liveLookup[lk] || [];

        // Prefer stored fields if present (new entries), fall back to live lookup
        const coupleName = e.coupleName || live.map(l=>l.coupleName).filter(Boolean)[0] || '';
        const client     = e.client     !== undefined ? e.client : (live.map(l=>l.client).filter(Boolean)[0] || '');
        const addedAt    = e.addedAt    || '';

        // Build meta chips
        const coupleChip = coupleName ? `<span class="hist-meta-couple">👫 ${esc(coupleName)}</span>` : '';
        const evChip     = ev         ? `<span class="hist-meta-ev">📋 ${esc(ev)}${client ? ` <span class="hist-meta-client">· ${esc(client)}</span>` : ''}</span>` : '';
        const dateChip   = addedAt    ? `<span class="hist-meta-date">🗓 ${esc(addedAt)}</span>` : '';

        return `<div class="hist-song-row" data-histkey="${esc(key)}" data-histidx="${idx}">
          <div class="hist-song-body">
            <div class="hist-song-main">
              <span class="hist-song-title">${esc(e.title)}</span>
              ${e.artist ? `<span class="hist-song-artist">${esc(e.artist)}</span>` : ''}
            </div>
            <div class="hist-song-meta">
              ${coupleChip}${evChip}${dateChip}
            </div>
          </div>
          <button class="rm-hist-btn" onclick="rmHistEntry('${esc(key)}',${idx})" title="Remove from history">✕</button>
        </div>`;
      }).join('');

      return `<div class="lib-ev-block" style="margin-bottom:.5rem;">
        <div class="lib-ev-head" style="cursor:default;">
          <span class="lib-ev-title">${esc(ev)}</span>
          <span class="lib-ev-count">${entries.length} song${entries.length!==1?'s':''}</span>
        </div>
        <div class="lib-ev-body open">${rows}</div>
      </div>`;
    }).filter(Boolean).join('');

    if (!evRows) return '';
    return `<div style="margin-bottom:1.4rem;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:.9rem;font-weight:700;color:var(--ink);padding-bottom:.5rem;margin-bottom:.6rem;border-bottom:1px solid var(--rule);">${cat.icon} ${cat.label}</div>
      ${evRows}
    </div>`;
  }).filter(Boolean).join('');

  el.innerHTML = sections || `<div class="hist-empty">No history yet for this language. Songs you add manually to any event will appear here.</div>`;
}

function rmHistEntry(key, idx) {
  const uKey = uesc(key);
  if (!songHist[uKey]) return;
  songHist[uKey].splice(idx, 1);
  if (!songHist[uKey].length) delete songHist[uKey];
  sv();
  renderHistory();
}

// ── EXPORT ───────────────────────────────────────────
function openExport() {
  const c=couples.find(x=>x.id===cur); if(!c) return;
  document.getElementById('exportTitle').value = c.name+' — Music Plan';
  document.getElementById('exportNotes').value = '';
  document.getElementById('exportModal').classList.add('open');
}
function closeExport() { document.getElementById('exportModal').classList.remove('open'); }

function doExport() {
  const c=couples.find(x=>x.id===cur); if(!c) return;
  const title=document.getElementById('exportTitle').value || c.name+' — Music Plan';
  const notes=document.getElementById('exportNotes').value;
  closeExport(); generateDoc(c,title,notes);
}

function generateDoc(couple, docTitle, notes) {
  const ii  = getInsts(couple.id);
  const date = MO[couple.month] + ' ' + couple.year;
  const tot  = songs.filter(s=>s.coupleId===couple.id).length;
  const usN  = songs.filter(s=>s.coupleId===couple.id&&s.used).length;
  const sep  = '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━';
  const thin = '─────────────────────────────────────────';

  let body = '';
  body += docTitle + '\n';
  body += sep + '\n';
  body += '📅 ' + date + '   |   🎵 ' + tot + ' songs across ' + ii.length + ' events   |   ✓ ' + usN + ' used\n';
  if (notes) body += '\n📌 Note: ' + notes + '\n';
  body += '\n';

  // Summary table
  body += '📊 SUMMARY\n' + thin + '\n';
  body += padR('Event', 28) + padR('Client', 18) + padR('Used', 6) + 'Total\n';
  body += thin + '\n';
  ii.forEach(i => {
    const ss = songs.filter(s=>s.instanceId===i.id);
    const u  = ss.filter(s=>s.used).length;
    body += padR(i.eventType, 28) + padR(i.client||'—', 18) + padR(String(u), 6) + ss.length + '\n';
  });
  body += thin + '\n';
  body += padR('TOTAL', 28) + padR('', 18) + padR(String(usN), 6) + tot + '\n\n';

  // Detail per event
  body += '🎵 SONG BREAKDOWN\n' + sep + '\n\n';
  CATS.forEach(cat => {
    const ci = ii.filter(i=>i.catId===cat.id); if (!ci.length) return;
    body += cat.label.toUpperCase() + '\n';
    ci.forEach(i => {
      const ss   = songs.filter(s=>s.instanceId===i.id).sort((a,b)=>(a.order||0)-(b.order||0));
      const used = ss.filter(s=>s.used);
      body += '\n  ' + i.eventType;
      if (i.client) body += '  (👤 ' + i.client + ')';
      if (i.editor)   body += '  ✂️ ' + i.editor;
      if (i.shooter)  body += '  📷 ' + i.shooter;
      if (i.shootDay) body += '  📅 ' + i.shootDay;
      if (i.timeFrom) body += '  ⏱ ' + i.timeFrom + (i.timeTo?' – '+i.timeTo:'');
      body += '\n';
      body += '  ' + thin.slice(0,36) + '\n';
      if (used.length) {
        used.forEach((s,n) => {
          body += '  ' + String(n+1).padStart(2,' ') + '. ' + s.title;
          if (s.artist) body += ' — ' + s.artist;
          if (s.usedAt) body += '  (used ' + s.usedAt + ')';
          body += '\n';
        });
      } else {
        body += '  No songs marked as used yet.\n';
      }
      // Event notes
      if (i.notes) body += '\n  📝 Notes: ' + i.notes + '\n';
    });
    body += '\n';
  });

  body += sep + '\n';
  body += 'Sent via Cloud IX Concierge · ' + new Date().toLocaleDateString('en-GB') + '\n';

  const subject = encodeURIComponent(docTitle);
  // mailto body limit is ~2000 chars in some clients — we warn if big
  const encodedBody = encodeURIComponent(body);
  const mailto = 'mailto:jsingh4@mac.com?subject=' + subject + '&body=' + encodedBody;

  // Open email client
  window.location.href = mailto;
  toast('📧 Email client opening — music plan ready to send!');
}

function padR(str, len) {
  str = String(str||'');
  return str.length >= len ? str.slice(0,len-1)+' ' : str + ' '.repeat(len - str.length);
}

// ── THEME ─────────────────────────────────────────────

function toggleDark() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  setTheme(isDark ? 'light' : 'dark');
}

function setTheme(name) {
  if (name === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('darkToggleBtn').textContent = '☀️';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('darkToggleBtn').textContent = '🌙';
  }
  localStorage.setItem('mt6_theme', name);
}

function initTheme() {
  localStorage.removeItem('mt6_theme');
  setTheme('light');
}


// ── COMPANY / LOGIN ──────────────────────────────────────
const DEFAULT_COMPANIES = [
  { id:'dream',   name:'Dream Productions',        icon:'🎬' },
  { id:'supreme', name:'The Supreme Film Studios',  icon:'🎥' },
];
let companies = ld('mt6_companies', DEFAULT_COMPANIES);


// ── Device layout ─────────────────────────────────────────
let _deviceLayout = localStorage.getItem('mt_device_layout') || null;

function applyDeviceLayout(layout) {
  document.body.setAttribute('data-layout', layout || 'desktop');
}

function selectDevice(layout) {
  _deviceLayout = layout;
  localStorage.setItem('mt_device_layout', layout);
  applyDeviceLayout(layout);
  document.getElementById('loginDeviceStep').style.display = 'none';
  document.getElementById('loginCompanyStep').style.display = '';
  const icons = { desktop:'🖥 Desktop', tablet:'📱 iPad / Tablet', mobile:'📲 Mobile' };
  const badge = document.getElementById('loginDeviceBadge');
  if (badge) badge.textContent = (icons[layout] || layout) + ' mode';
  renderCompanyGrid();
}

// ── Background colour picker ──────────────────────────────
var _bgSwatches = [
  {c:'#f9f6f0',n:'Parchment'},{c:'#fdf8f4',n:'Cream'},{c:'#f5f0e8',n:'Warm Sand'},
  {c:'#f0ece4',n:'Linen'},{c:'#eee8de',n:'Wheat'},{c:'#f4f1eb',n:'Bone'},
  {c:'#f0f2f6',n:'Ice Blue'},{c:'#eef2ed',n:'Sage'},{c:'#f5f0f5',n:'Lavender'},
  {c:'#f8f0f0',n:'Blush'},{c:'#ffffff',n:'White'},{c:'#0e0e12',n:'Midnight'}
];

function setBgColor(color) {
  document.documentElement.style.setProperty('--canvas', color);
  localStorage.setItem('mt6_bg_color', color);
  document.querySelectorAll('.bg-swatch').forEach(function(el) {
    el.classList.toggle('active', el.dataset.bg === color);
  });
  var lv = document.getElementById('loginView'); if (lv) lv.style.background = color;
  var as = document.getElementById('authScreen'); if (as) as.style.background = color;
}

// ── Profile Picture ──────────────────────────────────────
function handleProfilePic(input) {
  if (!input.files || !input.files[0] || !_currentUser) return;
  var file = input.files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement('canvas');
      var size = 96;
      canvas.width = size; canvas.height = size;
      var ctx = canvas.getContext('2d');
      var sx = 0, sy = 0, sw = img.width, sh = img.height;
      if (sw > sh) { sx = (sw - sh) / 2; sw = sh; }
      else { sy = (sh - sw) / 2; sh = sw; }
      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      // Save into user record
      _currentUser.profilePic = dataUrl;
      var u = _appUsers.find(function(x){ return x.username === _currentUser.username; });
      if (u) u.profilePic = dataUrl;
      localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
      cloudSave('mt6_users', _appUsers);
      _applyProfilePic();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function removeProfilePic() {
  if (!_currentUser) return;
  delete _currentUser.profilePic;
  var u = _appUsers.find(function(x){ return x.username === _currentUser.username; });
  if (u) delete u.profilePic;
  localStorage.setItem('mt6_users', JSON.stringify(_appUsers));
  cloudSave('mt6_users', _appUsers);
  _applyProfilePic();
}

function _applyProfilePic() {
  if (!_currentUser) return;
  var pic = _currentUser.profilePic || null;
  var initials = _currentUser.displayName.split(' ').map(function(w){ return (w[0]||'').toUpperCase(); }).join('').slice(0,2);
  var badgeEl = document.getElementById('badgeAvatar');
  if (badgeEl) {
    badgeEl.innerHTML = pic ? '<img src="' + pic + '" alt="">' : initials;
  }
  var previewEl = document.getElementById('profilePicPreview');
  if (previewEl) {
    previewEl.innerHTML = pic ? '<img src="' + pic + '" alt="" style="width:100%;height:100%;object-fit:cover;">' : initials;
  }
}

// Get avatar HTML for any user by display name — returns <img> or initials text
function _userAvatar(displayName) {
  var initials = (displayName||'').split(' ').map(function(w){ return (w[0]||'').toUpperCase(); }).join('').slice(0,2) || '?';
  var user = _appUsers.find(function(u){ return u.displayName === displayName; });
  if (user && user.profilePic) {
    return '<img src="' + user.profilePic + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  }
  return initials;
}

// Inline mini avatar (14px circle) for use in text rows
function _userAvatarMini(displayName) {
  var user = _appUsers.find(function(u){ return u.displayName === displayName; });
  if (user && user.profilePic) {
    return '<span style="display:inline-block;width:14px;height:14px;border-radius:50%;overflow:hidden;vertical-align:middle;margin-right:3px;"><img src="' + user.profilePic + '" style="width:100%;height:100%;object-fit:cover;"></span>';
  }
  return '';
}

function _renderModalBgPicker() {
  var el = document.getElementById('modalBgPicker'); if (!el) return;
  var saved = localStorage.getItem('mt6_bg_color') || '#f9f6f0';
  el.innerHTML = _bgSwatches.map(function(s) {
    return '<button class="bg-swatch' + (s.c === saved ? ' active' : '') + '" data-bg="' + s.c + '" onclick="setBgColor(\'' + s.c + '\')" title="' + s.n + '" style="background:' + s.c + ';"></button>';
  }).join('') +
  '<label class="bg-swatch bg-swatch-custom" title="Custom colour">' +
    '<input type="color" value="' + saved + '" onchange="setBgColor(this.value)" style="position:absolute;opacity:0;width:0;height:0;">' +
    '🎨</label>';
}

(function _restoreBgColor() {
  var saved = localStorage.getItem('mt6_bg_color');
  if (saved) {
    document.documentElement.style.setProperty('--canvas', saved);
    var lv = document.getElementById('loginView'); if (lv) lv.style.background = saved;
  }
})();

function showDevicePicker() {
  document.getElementById('loginDeviceStep').style.display = '';
  document.getElementById('loginCompanyStep').style.display = 'none';
}

function renderCompanyGrid() {
  const grid = document.getElementById('companyGrid');
  if (!grid) return;

  let visibleCos = companies;
  if (_isEditorPlus()) {
    // Editor+ sees their owned companies + companies where they're assigned as editor
    const owned = _currentUser.companies || [];
    const edName = _editorName();
    visibleCos = companies.filter(function(co) {
      if (owned.indexOf(co.id) !== -1) return true; // owned company
      try {
        var instsData = JSON.parse(localStorage.getItem('mt6_i_' + co.id) || '[]');
        var couplesData = JSON.parse(localStorage.getItem('mt6_c_' + co.id) || '[]');
        var hasInst = instsData.some(function(i) {
          return (i.editor||'').trim() === edName ||
                 (i.photoEditor||'').trim() === edName ||
                 (i.videoEditor||'').trim() === edName ||
                 (i.shooter||'').trim() === edName ||
                 (i.photographers||[]).some(function(p){ return (p||'').trim() === edName; }) ||
                 (i.videographers||[]).some(function(v){ return (v||'').trim() === edName; });
        });
        var hasCouple = couplesData.some(function(c) {
          return (c.editors||[]).some(function(e){ return e.trim() === edName; });
        });
        return hasInst || hasCouple;
      } catch(e) { return false; }
    });
    if (!visibleCos.length) visibleCos = companies;
  } else if (_currentUser && _currentUser.role === 'editor') {
    const edName = _editorName();
    visibleCos = companies.filter(function(co) {
      try {
        var instsData = JSON.parse(localStorage.getItem('mt6_i_' + co.id) || '[]');
        var couplesData = JSON.parse(localStorage.getItem('mt6_c_' + co.id) || '[]');
        var hasInst = instsData.some(function(i) {
          return (i.editor||'').trim() === edName ||
                 (i.photoEditor||'').trim() === edName ||
                 (i.videoEditor||'').trim() === edName ||
                 (i.shooter||'').trim() === edName ||
                 (i.photographers||[]).some(function(p){ return (p||'').trim() === edName; }) ||
                 (i.videographers||[]).some(function(v){ return (v||'').trim() === edName; });
        });
        var hasCouple = couplesData.some(function(c) {
          return (c.editors||[]).some(function(e){ return e.trim() === edName; });
        });
        return hasInst || hasCouple;
      } catch(e) { return false; }
    });
    if (!visibleCos.length) visibleCos = companies;
  }

  const showAdd = _isGlobalAdmin() || _isEditorPlus();
  const ownedCos = (_currentUser && _currentUser.companies) || [];
  grid.innerHTML = visibleCos.map(co => {
    var canDelete = _isGlobalAdmin() || (_isEditorPlus() && ownedCos.indexOf(co.id) !== -1);
    return `<div class="company-card" onclick="selectCompanyDash('${co.id}')">
      ${canDelete ? `<button class="co-delete-btn" onclick="event.stopPropagation();removeCompany('${co.id}')" title="Remove company">✕</button>` : ''}
      <span class="company-card-icon">${co.icon}</span>
      <div class="company-card-name">${esc(co.name)}</div>
      <div class="company-card-hint">Open workspace</div>
    </div>`;
  }).join('') + (showAdd ? `
    <div class="company-card add-new" onclick="openNewCo()">
      <span class="company-card-icon">＋</span>
      <div class="company-card-name">Add Company</div>
      <div class="company-card-hint">New workspace</div>
    </div>` : '');
}


// Normalise all inst fields to proper booleans/defaults to prevent undefined behaviour
function normaliseInsts() {
  insts.forEach(function(i) {
    i.erEditType=i.erEditType||''; i.erProgress=i.erProgress||0; i.erDueDate=i.erDueDate||'';
    i.erDeliveryStatus=i.erDeliveryStatus||''; i.erFirstDraft=!!i.erFirstDraft;
    i.erExportComplete=!!i.erExportComplete; i.erUsbNeeded=!!i.erUsbNeeded;
    i.erGalleryUploaded=!!i.erGalleryUploaded; i.erClientNotified=!!i.erClientNotified;
    i.erDelivered=!!i.erDelivered; i.erDeliveredAt=i.erDeliveredAt||'';
    i.changesNeeded      = !!i.changesNeeded;
    i.photoChangesNeeded = !!i.photoChangesNeeded;
    i.videoChangesNeeded = !!i.videoChangesNeeded;
    i.photoEditApproved  = !!i.photoEditApproved;
    i.videoEditApproved  = !!i.videoEditApproved;
    i.approved           = !!i.approved;
    i.shootApproved      = !!i.shootApproved;
    i.photoShootApproved = !!i.photoShootApproved;
    i.videoShootApproved = !!i.videoShootApproved;
    i.footageReceived    = !!i.footageReceived;
    i.imagesReceived     = !!i.imagesReceived;
    i.editPaused         = !!i.editPaused;
    i.editUpcoming       = !!i.editUpcoming;
    i.photoChangesCount  = i.photoChangesCount  || 0;
    i.videoChangesCount  = i.videoChangesCount  || 0;
    i.changesCount       = i.changesCount       || 0;
    // If changesNeeded but no photo/video service, treat as general changes
    // If has photo/video service and changesNeeded, migrate to typed changes
    const hasPhoto = !!(i.servicePhoto || i.services==='photo' || i.services==='both');
    const hasVideo = !!(i.serviceVideo || i.services==='video' || i.services==='both');
    if (i.changesNeeded && !i.photoChangesNeeded && !i.videoChangesNeeded) {
      if (hasPhoto) { i.photoChangesNeeded = true; i.changesNeeded = false; }
      else if (hasVideo) { i.videoChangesNeeded = true; i.changesNeeded = false; }
    }
  });
}

async function loadCompanyData(id) {
  activeCompany = id;
  _saveSession();
  var _lco=companies.find(function(x){return x.id===id;});if(_lco)setCompanyLabel(_lco.name);
  // Pull from cloud first (overwrites localStorage cache)
  await cloudPull(id);
  couples      = ld(coKey('mt6_c'),    []);
  songs        = ld(coKey('mt6_s'),    []);
  insts        = ld(coKey('mt6_i'),    []);
  openSec      = ld(coKey('mt6_os'),   {});
  openYr       = ld(coKey('mt6_oy'),   {});
  songLib      = ld(coKey('mt6_lib'),  {});
  songHist     = ld(coKey('mt6_hist'), {});
  dashViewMode = localStorage.getItem(coKey('mt6_dashview')) || 'grid';
  normaliseInsts();
  // Migrate all clients: re-run ctlGet on every couple to fix ordering, labels, stale steps
  couples.forEach(function(co) { ctlGet(co.id); });
  _svLocal();
  cur = null;
  editorFilter = '';
  shooterFilter = '';
  const co = companies.find(x=>x.id===id);
  if (co) {
    document.getElementById('coDashIcon').textContent = '🏢';
    document.getElementById('coDashName').textContent = 'Boardroom';
    const bcName = document.getElementById('bc_company_name');
    if (bcName) bcName.textContent = co.name || 'Dashboard';
  }
  initYears();
}

async function selectCompanyDash(id) {
  await loadCompanyData(id);
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('companyDashView').style.display=''; var _gh2=document.getElementById('globalHeader');if(_gh2)_gh2.style.display=''; setPageLabel('Boardroom');
  renderDashPanels('coDashPanels','coDashBanner');
  _applyRoleVisibility();
  _saveSession();
}

async function selectCompanyClients(id) {
  await loadCompanyData(id);
  const co = companies.find(x=>x.id===id);
  const heroName = document.getElementById('allClientsHeroName');
  const heroIcon = document.getElementById('allClientsIcon');
  if (heroName) heroName.textContent = 'Client Lounge';
  if (heroIcon) heroIcon.textContent = '👥';
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('companyDashView').style.display = 'none';
  document.getElementById('mainApp').style.display=''; var _gh3=document.getElementById('globalHeader');if(_gh3)_gh3.style.display='';
  document.getElementById('dashView').style.display=''; setPageLabel('Client Lounge');
  document.getElementById('editorView').style.display = 'none';
  renderDashboard();
  renderEditorFilter();
  renderShooterFilter();
}

async function selectCompany(id) {
  activeCompany = id;
  _saveSession();
  // Pull from cloud first
  await cloudPull(id);
  // Load this company's data into the shared variables
  couples      = ld(coKey('mt6_c'),    []);
  songs        = ld(coKey('mt6_s'),    []);
  insts        = ld(coKey('mt6_i'),    []);
  openSec      = ld(coKey('mt6_os'),   {});
  openYr       = ld(coKey('mt6_oy'),   {});
  songLib      = ld(coKey('mt6_lib'),  {});
  songHist     = ld(coKey('mt6_hist'), {});
  dashViewMode = localStorage.getItem(coKey('mt6_dashview')) || 'grid';
  normaliseInsts();
  // Migrate all clients: re-run ctlGet on every couple to fix ordering, labels, stale steps
  couples.forEach(function(co) { ctlGet(co.id); });
  _svLocal();
  cur = null;
  editorFilter = '';
  shooterFilter = '';
  // Show company dashboard first
  const co = companies.find(x=>x.id===id);
  if (co) {
    document.getElementById('coDashIcon').textContent = '🏢';
    document.getElementById('coDashName').textContent = 'Boardroom';
    const bcName = document.getElementById('bc_company_name');
    if (bcName) bcName.textContent = co.name || 'Dashboard';
  }
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('companyDashView').style.display=''; var _gh2=document.getElementById('globalHeader');if(_gh2)_gh2.style.display=''; setPageLabel('Boardroom');
  initYears();
  renderDashPanels('coDashPanels','coDashBanner');
}

function goToAllCouples() {
  // Editor: save current view before switching (for modal close navigation)
  if (_isEditor()) _editorPrevView = _getCurrentView();
  var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
  // Update All Clients hero with company info
  const co = companies.find(x=>x.id===activeCompany);
  const heroName = document.getElementById('allClientsHeroName');
  const heroIcon = document.getElementById('allClientsIcon');
  if (heroName) heroName.textContent = 'Client Lounge';
  if (heroIcon) heroIcon.textContent = '👥';
  document.getElementById('companyDashView').style.display = 'none';
  document.getElementById('mainApp').style.display=''; var _gh3=document.getElementById('globalHeader');if(_gh3)_gh3.style.display='';
  document.getElementById('dashView').style.display=''; setPageLabel('Client Lounge');
  document.getElementById('editorView').style.display = 'none';
  initYears();
  renderDashboard();
  renderEditorFilter();
  renderShooterFilter();
  _applyRoleVisibility();
  _saveSession();
}

function backToLogin() {
  var _er=document.getElementById('editingRoomView');if(_er)_er.style.display='none';var _tr=document.getElementById('theatreRoomView');if(_tr)_tr.style.display='none';
  activeCompany = null;
  _saveSession();
  cur = null;
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('companyDashView').style.display = 'none';
  document.getElementById('editorView').style.display = 'none';
  document.getElementById('dashView').style.display=''; setPageLabel('Client Lounge');
  document.getElementById('loginView').style.display=''; var _gh=document.getElementById('globalHeader');if(_gh)_gh.style.display='none'; setPageLabel('');
  renderCompanyGrid();
  _applyRoleVisibility();
}

function openNewCo() {
  if (!_isGlobalAdmin() && !_isEditorPlus()) return;
  document.getElementById('newCoName').value = '';
  document.getElementById('newCoIcon').value = '';
  document.getElementById('newCoOverlay').classList.add('open');
  setTimeout(() => document.getElementById('newCoName').focus(), 60);
}
function closeNewCo() {
  document.getElementById('newCoOverlay').classList.remove('open');
}
function saveNewCo() {
  if (!_isGlobalAdmin() && !_isEditorPlus()) return;
  const name = document.getElementById('newCoName').value.trim();
  const icon = document.getElementById('newCoIcon').value.trim() || '🎬';
  if (!name) { document.getElementById('newCoName').focus(); return; }
  const id = 'co_' + Date.now().toString(36);
  companies.push({ id, name, icon });
  localStorage.setItem('mt6_companies', JSON.stringify(companies));
  cloudSave('mt6_companies', companies);
  // If Editor+ created this company, assign ownership
  if (_isEditorPlus()) {
    if (!_currentUser.companies) _currentUser.companies = [];
    _currentUser.companies.push(id);
    var u = _appUsers.find(function(x){ return x.username === _currentUser.username; });
    if (u) { u.companies = _currentUser.companies; }
    _saveUsers();
  }
  closeNewCo();
  renderCompanyGrid();
  toast('Company created: ' + name);
}

function removeCompany(id) {
  var co = companies.find(function(c){ return c.id === id; });
  if (!co) return;
  // Permission check: global admin can delete any, editor+ only their own
  if (!_isGlobalAdmin()) {
    var owned = (_currentUser && _currentUser.companies) || [];
    if (owned.indexOf(id) === -1) { toast('You can only remove your own companies'); return; }
  }
  if (!confirm('Remove "' + co.name + '"?\n\nThis will delete the company and all its data. This cannot be undone.')) return;
  // Remove company from list
  companies = companies.filter(function(c){ return c.id !== id; });
  localStorage.setItem('mt6_companies', JSON.stringify(companies));
  cloudSave('mt6_companies', companies);
  // Clean up company data from localStorage
  ['mt6_c_','mt6_s_','mt6_i_','mt6_os_','mt6_oy_','mt6_lib_','mt6_hist_','mt6_dashview_'].forEach(function(prefix) {
    localStorage.removeItem(prefix + id);
  });
  // Remove from editor+ ownership if applicable
  if (_isEditorPlus() && _currentUser.companies) {
    _currentUser.companies = _currentUser.companies.filter(function(cid){ return cid !== id; });
    var u = _appUsers.find(function(x){ return x.username === _currentUser.username; });
    if (u) u.companies = _currentUser.companies;
    _saveUsers();
  }
  // If we were viewing this company, go back
  if (activeCompany === id) {
    activeCompany = null;
    _saveSession();
  }
  renderCompanyGrid();
  toast('Removed: ' + co.name);
}

// ── INIT ─────────────────────────────────────────────
initTheme();
renderCompanyGrid();

// ── Auto-restore session on refresh ──────────────────
(async function _autoRestoreSession() {
  var sess = _checkSession();
  if (!sess) return; // no saved session — show auth screen

  _historyNav = true; // suppress pushState during restore

  // User is valid — skip auth screen, show company picker
  _showApp();

  if (!sess.companyId) {
    // Set initial history state at company picker
    history.replaceState({ username: sess.username, companyId: null, coupleId: null, view: 'companies' }, '', '');
    _historyNav = false;
    return;
  }

  // Wait for cloud connectivity (up to 3s) then load company
  var waited = 0;
  while (!_cloudReady && waited < 3000) {
    await new Promise(function(r){ setTimeout(r, 200); });
    waited += 200;
  }

  // Load company data (works even without cloud — falls back to localStorage)
  try {
    var view = sess.view || 'boardroom';
    if (view === 'clientLounge') {
      await selectCompanyClients(sess.companyId);
    } else if (view === 'editingRoom') {
      await selectCompanyDash(sess.companyId);
      goToEditingRoom();
    } else if (view === 'theatreRoom') {
      await selectCompanyDash(sess.companyId);
      goToTheatreRoom();
    } else if (view === 'productionOffice' && sess.coupleId) {
      await selectCompanyClients(sess.companyId);
      selectCouple(sess.coupleId);
    } else {
      await selectCompanyDash(sess.companyId);
    }
  } catch(e) {
    console.warn('Session restore error:', e);
  }

  // Set initial history state at current view
  history.replaceState(JSON.parse(localStorage.getItem('mt6_session') || '{}'), '', '');
  _historyNav = false;
})();

// ── Auto-migrate to cloud if cloud is empty ─────────
async function _cloudAutoMigrate() {
  if (!_cloudReady) return;
  try {
    const data = await _dbSelect({ select: 'key', limit: '1' });
    if (!data || data.length === 0) {
      // Cloud is empty — push existing localStorage data up
      const coStr = localStorage.getItem('mt6_companies');
      if (coStr && JSON.parse(coStr).length > 0) {
        console.log('Cloud empty, migrating localStorage to cloud...');
        await cloudPushAll();
      }
    } else {
      // Cloud has data — pull companies list to stay in sync
      const coRows = await _dbSelect({ key: 'eq.mt6_companies', select: 'value' });
      if (coRows.length && coRows[0].value) {
        companies = coRows[0].value;
        localStorage.setItem('mt6_companies', JSON.stringify(companies));
        renderCompanyGrid();
      }
    }
  } catch (e) { console.warn('Cloud auto-migrate check failed:', e?.message || e); }
}

// ── BACKUP & RESTORE ─────────────────────────────────────

function openBackup() {
  var statusEl = document.getElementById('backupStatus');
  var overlay = document.getElementById('backupOverlay');
  var textOut = document.getElementById('backupTextOut');
  if (!overlay) { alert('Backup modal not found in DOM'); return; }
  statusEl.className = 'backup-status';
  statusEl.textContent = '';
  if (textOut) { textOut.value = ''; }
  var shareStatus = document.getElementById('shareStatus');
  if (shareStatus) { shareStatus.className = 'backup-status'; shareStatus.textContent = ''; }
  var scSearch = document.getElementById('shareClientSearch'); if (scSearch) scSearch.value = '';
  var scList = document.getElementById('shareClientList'); if (scList) scList.style.display = 'none';
  updateShareCount();
  overlay.classList.add('open');
}
function closeBackup() {
  document.getElementById('backupOverlay').classList.remove('open');
}

function generateBackupText() {
  try {
    var result = buildBackupData();
    var json = result.json;
    var ta = document.getElementById('backupTextOut');
    var st = document.getElementById('backupCopyStatus');
    if (!ta) { alert('Text area not found'); return; }
    ta.value = json;
    ta.removeAttribute('readonly');
    ta.style.background = 'var(--warm-white)';
    ta.style.color = 'var(--ink)';
    ta.focus();
    ta.setSelectionRange(0, ta.value.length);
    st.textContent = 'Data ready — click inside the box and press Ctrl+A then Ctrl+C to copy all.';
    st.style.color = 'var(--forest)';
  } catch(err) {
    alert('Error generating backup: ' + err.message);
  }
}

function restoreFromPaste() {
  const json = document.getElementById('backupTextIn').value.trim();
  const statusEl = document.getElementById('backupStatus');
  if (!json) {
    statusEl.textContent = '❌ Please paste your backup JSON first.';
    statusEl.className = 'backup-status err';
    return;
  }
  try {
    const file = new Blob([json], { type: 'application/json' });
    const fakeFile = new File([file], 'backup.json', { type: 'application/json' });
    importBackup(fakeFile);
  } catch(e) {
    statusEl.textContent = '❌ Invalid JSON: ' + e.message;
    statusEl.className = 'backup-status err';
  }
}

function buildBackupData() {
  const allCompanies = companies && companies.length ? companies : JSON.parse(localStorage.getItem('mt6_companies') || '[]');
  const backup = {
    version: 1,
    exportedAt: new Date().toISOString(),
    global: { theme: localStorage.getItem('mt6_theme') || 'light' },
    companies: allCompanies,
    companyData: {}
  };
  const dataKeys = ['mt6_c','mt6_s','mt6_i','mt6_os','mt6_oy','mt6_lib','mt6_hist','mt6_dashview','mt6_crew_photographers','mt6_crew_videographers','mt6_locations'];
  allCompanies.forEach(co => {
    backup.companyData[co.id] = {};
    dataKeys.forEach(k => {
      const val = localStorage.getItem(k + '_' + co.id);
      if (val !== null) {
        try { backup.companyData[co.id][k] = JSON.parse(val); }
        catch(e) { backup.companyData[co.id][k] = val; }
      }
    });
  });
  localStorage.setItem('mt6_companies', JSON.stringify(allCompanies));
  return { backup, json: JSON.stringify(backup, null, 2) };
}

function exportBackup() {
  const { json } = buildBackupData();
  const date = new Date().toISOString().slice(0,10);
  const filename = 'music-tracker-backup-' + date + '.json';

  // Try Blob URL first
  try {
    const blob = new Blob([json], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
    toast('✅ Backup downloading…');
    return;
  } catch(e) {}

  // Try data: URI
  try {
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(json);
    a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); }, 2000);
    toast('✅ Backup downloading…');
    return;
  } catch(e) {}

  // Fallback: show JSON in the modal for manual copy
  showBackupText(json, filename);
}

function showBackupText(json, filename) {
  const statusEl = document.getElementById('backupStatus');
  const existing = document.getElementById('backupTextArea');
  if (existing) existing.remove();
  statusEl.className = 'backup-status ok';
  statusEl.textContent = '📋 Copy everything below and save as: ' + filename;
  const ta = document.createElement('textarea');
  ta.id = 'backupTextArea';
  ta.value = json;
  ta.style.cssText = 'width:100%;height:160px;font-size:.6rem;margin-top:.5rem;border:1px solid var(--rule2);border-radius:6px;padding:.6rem;font-family:monospace;resize:vertical;box-sizing:border-box;';
  ta.readOnly = true;
  statusEl.after(ta);
  ta.focus(); ta.select();
  // Also try clipboard
  navigator.clipboard.writeText(json).then(function(){
    statusEl.textContent = '✅ Copied to clipboard! Paste into a new file and save as: ' + filename;
  }).catch(function(){ });
}


function renderShareClientList(filter) {
  var el = document.getElementById('shareClientList');
  if (!el) return;
  var q = (filter || '').toLowerCase().trim();
  var checked = new Set(Array.from(document.querySelectorAll('.share-client-cb:checked')).map(function(cb){ return cb.dataset.id; }));
  var filtered = q ? couples.filter(function(co){ return co.name.toLowerCase().includes(q) || (co.year||'').toString().includes(q); }) : couples;
  el.innerHTML = filtered.map(function(co) {
        return '<label class="scl-item">'
      + '<input type="checkbox" class="share-client-cb" data-id="'+co.id+'" style="accent-color:var(--gold);margin:0;flex-shrink:0;"'+(checked.has(co.id)?' checked':'')+' onchange="updateShareCount()"> '
      + '<span style="font-family:Cormorant Garamond,serif;font-size:.88rem;color:var(--ink);flex:1;">'+esc(co.name)+'</span>'
      + (co.year ? '<span style="color:var(--ink5);font-size:.56rem;">'+co.year+'</span>' : '')
      + '</label>';
  }).join('') || '<div style="font-size:.62rem;color:var(--ink5);font-style:italic;padding:.6rem .75rem;">'+(q?'No matches.':'No clients in this workspace.')+'</div>';
  updateShareCount();
}

function filterShareClients(val) {
  showShareDropdown();
  renderShareClientList(val);
}

function showShareDropdown() {
  var el = document.getElementById('shareClientList');
  if (el) { el.style.display = 'flex'; el.style.flexDirection = 'column'; }
  renderShareClientList(document.getElementById('shareClientSearch').value);
}

function hideShareDropdown() {
  setTimeout(function() {
    var el = document.getElementById('shareClientList');
    if (el) el.style.display = 'none';
  }, 200);
}

function updateShareCount() {
  var n = document.querySelectorAll('.share-client-cb:checked').length;
  var el = document.getElementById('shareSelectedCount');
  if (el) el.textContent = n ? n + ' selected' : '';
}

function selectAllShareClients(val) {
  document.querySelectorAll('.share-client-cb').forEach(function(cb){ cb.checked = val; });
  updateShareCount();
}

function exportSelectedClients() {
  var selected = Array.from(document.querySelectorAll('.share-client-cb:checked')).map(function(cb){ return cb.dataset.id; });
  var st = document.getElementById('shareStatus');
  if (!selected.length) {
    st.textContent = '❌ Please select at least one client.';
    st.className = 'backup-status err';
    return;
  }
  var dataKeys = ['mt6_c','mt6_s','mt6_i','mt6_os','mt6_oy','mt6_lib','mt6_hist','mt6_dashview','mt6_crew_photographers','mt6_crew_videographers','mt6_locations'];
  var payload = {
    type: 'shared_clients',
    version: 1,
    exportedAt: new Date().toISOString(),
    companyId: activeCompany,
    clients: []
  };
  selected.forEach(function(coId) {
    var co = couples.find(function(c){ return c.id === coId; });
    if (!co) return;
    var clientInsts = insts.filter(function(i){ return i.coupleId === coId; });
    payload.clients.push({ couple: co, insts: clientInsts });
  });
  var json = JSON.stringify(payload, null, 2);
  var date = new Date().toISOString().slice(0,10);
  var filename = 'shared-clients-' + date + '.json';
  try {
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
    st.textContent = '✅ Exported ' + payload.clients.length + ' client' + (payload.clients.length===1?'':'s') + ' — send the file to your colleague.';
    st.className = 'backup-status ok';
  } catch(e) {
    // Fallback: show JSON
    var ta = document.getElementById('shareImportText');
    if (ta) { ta.value = json; ta.focus(); ta.select(); }
    st.textContent = '📋 Copy the JSON above and send it to your colleague.';
    st.className = 'backup-status ok';
  }
}

function importSharedClientsFile(file) {
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var ta = document.getElementById('shareImportText');
    if (ta) ta.value = e.target.result;
    importSharedClients();
  };
  reader.readAsText(file);
}

// Holds pending import payload while conflict modal is shown
var _pendingImport = null;

function importSharedClients() {
  var json = document.getElementById('shareImportText').value.trim();
  var st = document.getElementById('shareStatus');
  if (!json) {
    st.textContent = '❌ Please paste the shared clients JSON first.';
    st.className = 'backup-status err';
    return;
  }
  try {
    var payload = JSON.parse(json);
    if (payload.type !== 'shared_clients' || !payload.clients) {
      throw new Error('This doesn\'t look like a shared clients file.');
    }
    var conflicts = [], newClients = [];
    var existingCoupleIds = new Set(couples.map(function(c){ return c.id; }));
    payload.clients.forEach(function(item) {
      if (existingCoupleIds.has(item.couple.id)) {
        conflicts.push(item);
      } else {
        newClients.push(item);
      }
    });
    if (conflicts.length === 0) {
      // No conflicts — import everything directly
      applySharedImport(newClients, []);
    } else {
      // Show conflict modal
      _pendingImport = { newClients: newClients, conflicts: conflicts };
      showConflictModal(conflicts);
    }
  } catch(e) {
    st.textContent = '❌ Error: ' + e.message;
    st.className = 'backup-status err';
  }
}

function showConflictModal(conflicts) {
  var el = document.getElementById('conflictModal');
  var list = document.getElementById('conflictList');
  list.innerHTML = conflicts.map(function(item, idx) {
    var mine = couples.find(function(c){ return c.id === item.couple.id; });
    var myInsts = insts.filter(function(i){ return i.coupleId === item.couple.id; });
    return '<div class="conflict-row" id="cr_'+idx+'">'
      + '<div class="conflict-name">'+esc(item.couple.name)+(item.couple.year?' <span style="font-size:.7rem;color:var(--ink5);">'+item.couple.year+'</span>':'')+'</div>'
      + '<div class="conflict-cols">'
      + '<div class="conflict-col">'
      + '<div class="conflict-col-title">📁 Mine</div>'
      + '<div class="conflict-detail">'+myInsts.length+' event'+(myInsts.length===1?'':'s')+'</div>'
      + '</div>'
      + '<div class="conflict-col">'
      + '<div class="conflict-col-title">📨 Incoming</div>'
      + '<div class="conflict-detail">'+item.insts.length+' event'+(item.insts.length===1?'':'s')+'</div>'
      + '</div>'
      + '</div>'
      + '<div class="conflict-btns">'
      + '<button class="conflict-btn keep" onclick="setConflictChoice('+idx+',\'keep\',this)">Keep Mine</button>'
      + '<button class="conflict-btn replace" onclick="setConflictChoice('+idx+',\'replace\',this)">Use Theirs</button>'
      + '<button class="conflict-btn both" onclick="setConflictChoice('+idx+',\'both\',this)">Keep Both</button>'
      + '</div>'
      + '<div class="conflict-chosen" id="cc_'+idx+'"></div>'
      + '</div>';
  }).join('');
  // Reset apply button
  document.getElementById('conflictApplyBtn').disabled = false;
  document.getElementById('conflictApplyBtn').textContent = 'Apply Choices';
  el.classList.add('open');
}

function setConflictChoice(idx, choice, btn) {
  // Highlight chosen button
  var row = document.getElementById('cr_'+idx);
  row.querySelectorAll('.conflict-btn').forEach(function(b){ b.classList.remove('selected'); });
  btn.classList.add('selected');
  var labels = { keep: '✓ Keeping mine', replace: '✓ Using theirs', both: '✓ Keeping both copies' };
  document.getElementById('cc_'+idx).textContent = labels[choice];
  row.dataset.choice = choice;
}

function applyConflictChoices() {
  if (!_pendingImport) return;
  var conflicts = _pendingImport.conflicts;
  var rows = document.querySelectorAll('.conflict-row');
  var resolved = [], unresolved = 0;
  rows.forEach(function(row, idx) {
    var choice = row.dataset.choice;
    if (!choice) { unresolved++; return; }
    resolved.push({ item: conflicts[idx], choice: choice });
  });
  if (unresolved > 0) {
    alert('Please choose an option for all ' + unresolved + ' remaining conflict' + (unresolved===1?'':'s') + '.');
    return;
  }
  applySharedImport(_pendingImport.newClients, resolved);
  closeConflictModal();
}

function applySharedImport(newClients, resolved) {
  var existingInstIds = new Set(insts.map(function(i){ return i.id; }));
  var added = 0, replaced = 0, duplicated = 0;

  // Add brand new clients
  newClients.forEach(function(item) {
    couples.push(item.couple);
    item.insts.forEach(function(inst) {
      if (!existingInstIds.has(inst.id)) { insts.push(inst); existingInstIds.add(inst.id); }
    });
    added++;
  });

  // Apply conflict resolutions
  resolved.forEach(function(r) {
    var item = r.item, choice = r.choice;
    if (choice === 'keep') {
      // Do nothing
    } else if (choice === 'replace') {
      // Remove existing couple + insts, add incoming
      couples = couples.filter(function(c){ return c.id !== item.couple.id; });
      insts = insts.filter(function(i){ return i.coupleId !== item.couple.id; });
      couples.push(item.couple);
      item.insts.forEach(function(inst) { insts.push(inst); });
      replaced++;
    } else if (choice === 'both') {
      // Duplicate incoming with new ID and "(imported)" label
      var newId = 'co_imp_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
      var dupCouple = Object.assign({}, item.couple, { id: newId, name: item.couple.name + ' (imported)' });
      couples.push(dupCouple);
      item.insts.forEach(function(inst) {
        var newInstId = 'i_imp_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
        insts.push(Object.assign({}, inst, { id: newInstId, coupleId: newId }));
      });
      duplicated++;
    }
  });

  sv();
  renderShareClientList();
  if (typeof renderDashboard === 'function') renderDashboard();

  var parts = [];
  if (added) parts.push(added + ' added');
  if (replaced) parts.push(replaced + ' replaced');
  if (duplicated) parts.push(duplicated + ' duplicated');
  var msg = parts.length ? '✅ ' + parts.join(', ') + '.' : '✅ No changes made.';
  var st = document.getElementById('shareStatus');
  if (st) { st.textContent = msg; st.className = 'backup-status ok'; }
  toast(msg);
  _pendingImport = null;
}

function closeConflictModal() {
  document.getElementById('conflictModal').classList.remove('open');
  _pendingImport = null;
}

function importBackup(file) {
  if (!file) return;
  const statusEl = document.getElementById('backupStatus');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.version || !backup.companies || !backup.companyData) {
        throw new Error('Invalid backup file format.');
      }

      // Restore global settings
      if (backup.global?.theme) localStorage.setItem('mt6_theme', backup.global.theme);

      // Merge companies list — add any that don't already exist
      const existing = JSON.parse(localStorage.getItem('mt6_companies') || '[]');
      const existingIds = new Set(existing.map(c => c.id));
      let added = 0;
      backup.companies.forEach(co => {
        if (!existingIds.has(co.id)) { existing.push(co); added++; }
      });
      localStorage.setItem('mt6_companies', JSON.stringify(existing));

      // Restore per-company data (only for companies in backup)
      const dataKeys = ['mt6_c','mt6_s','mt6_i','mt6_os','mt6_oy','mt6_lib','mt6_hist','mt6_dashview','mt6_crew_photographers','mt6_crew_videographers','mt6_locations'];
      let restoredCos = 0;
      Object.entries(backup.companyData).forEach(([coId, data]) => {
        dataKeys.forEach(k => {
          if (data[k] !== undefined) {
            var v = data[k];
            localStorage.setItem(k + '_' + coId, typeof v === 'string' ? v : JSON.stringify(v));
          }
        });
        restoredCos++;
      });

      // Refresh companies state
      companies = JSON.parse(localStorage.getItem('mt6_companies') || '[]');
      // Push restored data to cloud
      cloudPushAll();
      // If returning user already chose a layout, skip device picker
      if (_deviceLayout) {
        applyDeviceLayout(_deviceLayout);
        document.getElementById('loginDeviceStep').style.display = 'none';
        document.getElementById('loginCompanyStep').style.display = '';
        const icons = { desktop:'🖥 Desktop', tablet:'📱 iPad / Tablet', mobile:'📲 Mobile' };
        const badge = document.getElementById('loginDeviceBadge');
        if (badge) badge.textContent = (icons[_deviceLayout] || _deviceLayout) + ' mode';
        renderCompanyGrid();
      } else {
        renderCompanyGrid(); // pre-render grid in background
      }
      setTheme(['light','dark'].includes(backup.global?.theme) ? backup.global.theme : 'light');

      statusEl.textContent = `✅ Restored ${restoredCos} compan${restoredCos===1?'y':'ies'}${added>0?' ('+added+' new)':''} successfully!`;
      statusEl.className = 'backup-status ok';
      toast('✅ Backup restored!');
    } catch(err) {
      statusEl.textContent = '❌ Error: ' + err.message;
      statusEl.className = 'backup-status err';
    }
  };
  reader.readAsText(file);
}

// Drag & drop on backup-drop zone
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && _evModalOpen) closeEvModal();
});

document.addEventListener('DOMContentLoaded', () => {
  const drop = document.getElementById('backupDrop');
  if (!drop) return;
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('over'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('over'));
  drop.addEventListener('drop', e => {
    e.preventDefault(); drop.classList.remove('over');
    const file = e.dataTransfer?.files?.[0];
    if (file) importBackup(file);
  });
});


// ── Button drag-reorder ──────────────────────────────────────────────────────
var _bd = {};
function _attachBtnDrag() {
  document.querySelectorAll('.ev-btn-wrap').forEach(function(el) {
    el.addEventListener('dragstart', function(e) {
      _bd = { iid: el.dataset.iid, key: el.dataset.bid };
      el.classList.add('ev-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.stopPropagation();
    });
    el.addEventListener('dragend', function(e) {
      el.classList.remove('ev-dragging');
      document.querySelectorAll('.ev-btn-wrap').forEach(function(w){ w.classList.remove('ev-drag-over'); });
    });
    el.addEventListener('dragover', function(e) {
      e.preventDefault(); e.stopPropagation();
      if (el.dataset.iid !== _bd.iid || el.dataset.bid === _bd.key) return;
      document.querySelectorAll('.ev-btn-wrap').forEach(function(w){ w.classList.remove('ev-drag-over'); });
      el.classList.add('ev-drag-over');
    });
    el.addEventListener('dragleave', function(e) { el.classList.remove('ev-drag-over'); });
    el.addEventListener('drop', function(e) {
      e.preventDefault(); e.stopPropagation();
      el.classList.remove('ev-drag-over');
      if (!_bd.iid || el.dataset.iid !== _bd.iid) return;
      var toKey = el.dataset.bid, fromKey = _bd.key;
      if (toKey === fromKey) return;
      var inst = insts.find(function(x){ return x.id === _bd.iid; });
      if (!inst) return;
      var def = ['photoShot','videoShot','shootDone','photoEdit','videoEdit','editDone','footage','images','pause','upcoming'];
      var order = (inst.buttonOrder && inst.buttonOrder.length) ? inst.buttonOrder.slice() : def.slice();
      // Ensure all keys present
      def.forEach(function(k){ if (!order.includes(k)) order.push(k); });
      var fi = order.indexOf(fromKey), ti = order.indexOf(toKey);
      if (fi === -1 || ti === -1) return;
      order.splice(fi, 1); order.splice(ti, 0, fromKey);
      inst.buttonOrder = order;
      sv();
      renderSections();
      _bd = {};
    });
  });
}


// ── Panel drag-reorder ───────────────────────────────────────────────────────
var _pd = {};

function _attachPanelDrag() {
  document.querySelectorAll('.ev-panels-wrap').forEach(function(wrap) {
    var iid = wrap.dataset.iid;
    wrap.querySelectorAll('.ev-panel-draggable').forEach(function(panel) {
      panel.addEventListener('dragstart', function(e) {
        // Only start if drag began on the handle
        _pd = { iid: iid, key: panel.dataset.panel, wrap: wrap };
        panel.classList.add('ep-dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.stopPropagation();
      });
      panel.addEventListener('dragend', function(e) {
        panel.classList.remove('ep-dragging');
        wrap.querySelectorAll('.ev-panel-draggable').forEach(function(p){ p.classList.remove('ep-drag-over'); });
      });
      panel.addEventListener('dragover', function(e) {
        e.preventDefault(); e.stopPropagation();
        if (_pd.iid !== iid || panel.dataset.panel === _pd.key) return;
        wrap.querySelectorAll('.ev-panel-draggable').forEach(function(p){ p.classList.remove('ep-drag-over'); });
        panel.classList.add('ep-drag-over');
      });
      panel.addEventListener('dragleave', function(e) { panel.classList.remove('ep-drag-over'); });
      panel.addEventListener('drop', function(e) {
        e.preventDefault(); e.stopPropagation();
        panel.classList.remove('ep-drag-over');
        if (!_pd.iid || _pd.iid !== iid) return;
        var toKey = panel.dataset.panel, fromKey = _pd.key;
        if (toKey === fromKey) return;
        // Save open state
        var openPanels = {};
        wrap.querySelectorAll('.ev-panel-draggable').forEach(function(p){
          openPanels[p.dataset.panel] = p.classList.contains('open');
        });
        // Reorder DOM: move fromPanel before/after toPanel
        var fromPanel = wrap.querySelector('[data-panel="' + fromKey + '"]');
        var toPanel = wrap.querySelector('[data-panel="' + toKey + '"]');
        if (!fromPanel || !toPanel) return;
        // Determine insert position
        var allPanels = Array.from(wrap.querySelectorAll('.ev-panel-draggable'));
        var fi = allPanels.indexOf(fromPanel), ti = allPanels.indexOf(toPanel);
        if (fi < ti) {
          toPanel.after(fromPanel);
        } else {
          toPanel.before(fromPanel);
        }
        // Persist order
        var inst = insts.find(function(x){ return x.id === iid; });
        if (inst) {
          var newOrder = Array.from(wrap.querySelectorAll('.ev-panel-draggable')).map(function(p){ return p.dataset.panel; });
          inst.panelOrder = newOrder;
          sv();
        }
        _pd = {};
      });
    });
  });
}


// ── Client Journey drag-reorder ──────────────────────────────────────────────
var _ctlDrag = {};

function _attachCtlDrag() {
  var body = document.getElementById('ctlBody');
  if (!body) return;
  // Attach drag to each step within its own group (drag only within same group)
  body.querySelectorAll('.ctl-step-group').forEach(function(group) {
    group.querySelectorAll('.ctl-step[draggable]').forEach(function(step) {
      var fresh = step.cloneNode(true);
      step.parentNode.replaceChild(fresh, step);
    });
    group.querySelectorAll('.ctl-step[draggable]').forEach(function(step) {
      step.addEventListener('dragstart', function(e) {
        _ctlDrag = { id: step.dataset.stepid, group: group.id };
        step.classList.add('ctl-dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.stopPropagation();
      });
      step.addEventListener('dragend', function() {
        step.classList.remove('ctl-dragging');
        body.querySelectorAll('.ctl-step').forEach(function(s){ s.classList.remove('ctl-drag-over'); });
      });
      step.addEventListener('dragover', function(e) {
        e.preventDefault(); e.stopPropagation();
        if (step.dataset.stepid === _ctlDrag.id || group.id !== _ctlDrag.group) return;
        body.querySelectorAll('.ctl-step').forEach(function(s){ s.classList.remove('ctl-drag-over'); });
        step.classList.add('ctl-drag-over');
      });
      step.addEventListener('dragleave', function() { step.classList.remove('ctl-drag-over'); });
      step.addEventListener('drop', function(e) {
        e.preventDefault(); e.stopPropagation();
        step.classList.remove('ctl-drag-over');
        var toId = step.dataset.stepid, fromId = _ctlDrag.id;
        _ctlDrag = {};
        if (!fromId || toId === fromId) return;
        var fromEl = group.querySelector('[data-stepid="' + fromId + '"]');
        var toEl   = group.querySelector('[data-stepid="' + toId   + '"]');
        if (!fromEl || !toEl) return;
        var all = Array.from(group.querySelectorAll('.ctl-step'));
        var fi = all.indexOf(fromEl), ti = all.indexOf(toEl);
        if (fi < ti) toEl.after(fromEl); else toEl.before(fromEl);
        // Persist to co.timeline
        var co = couples.find(function(x){ return x.id === _ctlCoupleId; });
        if (co && co.timeline) {
          // Build new order from all groups
          var newOrder = Array.from(body.querySelectorAll('.ctl-step')).map(function(s){ return s.dataset.stepid; });
          co.timeline.sort(function(a, b){ return newOrder.indexOf(a.id) - newOrder.indexOf(b.id); });
          co.timelineUserOrdered = true;
          sv();
          renderCoupleTimeline();
        }
      });
    });
  });
}


// ── Button drag-reorder ──────────────────────────────────────────────────────
var _bd = {};
function _attachBtnDrag() {
  document.querySelectorAll('.ev-btn-wrap').forEach(function(el) {
    el.addEventListener('dragstart', function(e) {
      _bd = { iid: el.dataset.iid, key: el.dataset.bid };
      el.classList.add('ev-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.stopPropagation();
    });
    el.addEventListener('dragend', function(e) {
      el.classList.remove('ev-dragging');
      document.querySelectorAll('.ev-btn-wrap').forEach(function(w){ w.classList.remove('ev-drag-over'); });
    });
    el.addEventListener('dragover', function(e) {
      e.preventDefault(); e.stopPropagation();
      if (el.dataset.iid !== _bd.iid || el.dataset.bid === _bd.key) return;
      document.querySelectorAll('.ev-btn-wrap').forEach(function(w){ w.classList.remove('ev-drag-over'); });
      el.classList.add('ev-drag-over');
    });
    el.addEventListener('dragleave', function(e) { el.classList.remove('ev-drag-over'); });
    el.addEventListener('drop', function(e) {
      e.preventDefault(); e.stopPropagation();
      el.classList.remove('ev-drag-over');
      if (!_bd.iid || el.dataset.iid !== _bd.iid) return;
      var toKey = el.dataset.bid, fromKey = _bd.key;
      if (toKey === fromKey) return;
      var inst = insts.find(function(x){ return x.id === _bd.iid; });
      if (!inst) return;
      var def = ['photoShot','videoShot','shootDone','photoEdit','videoEdit','editDone','footage','images','pause','upcoming'];
      var order = (inst.buttonOrder && inst.buttonOrder.length) ? inst.buttonOrder.slice() : def.slice();
      // Ensure all keys present
      def.forEach(function(k){ if (!order.includes(k)) order.push(k); });
      var fi = order.indexOf(fromKey), ti = order.indexOf(toKey);
      if (fi === -1 || ti === -1) return;
      order.splice(fi, 1); order.splice(ti, 0, fromKey);
      inst.buttonOrder = order;
      sv();
      renderSections();
      _bd = {};
    });
  });
}

</script>

<!-- ── EDITOR ASSIGN MODAL ── -->
<div class="assign-overlay" id="assignOverlay" onclick="if(event.target===this)closeAssign()">
  <div class="assign-box">
    <div class="assign-title" id="assignTitle">Assign Event to Editor</div>
    <label class="assign-lbl">Editor</label>
    <input class="assign-inp" id="assignEditorInp" placeholder="Editor name…" oninput="renderAssignEventList()">
    <label class="assign-lbl">Event</label>
    <input class="assign-inp" id="assignSearchInp" placeholder="Search couple or event…" oninput="renderAssignEventList()" autocomplete="off" style="margin-bottom:.5rem;">
    <div class="assign-event-list" id="assignEventList"></div>
    <label class="assign-lbl">Status</label>
    <div class="assign-status-row">
      <button class="assign-status-btn new" id="asBtnNew" onclick="selectAssignStatus('new')">🆕 New Project</button>
      <button class="assign-status-btn changes" id="asBtnChanges" onclick="selectAssignStatus('changes')">✏️ Changes</button>
    </div>
    <div class="assign-btns">
      <button class="btn btn-outline btn-sm" onclick="closeAssign()">Cancel</button>
      <button class="btn btn-red" onclick="saveAssign()">Assign</button>
    </div>
  </div>
</div>


<!-- ── OVERVIEW DRILL-DOWN MODAL ── -->
<div class="ovdrill-overlay" id="ovDrillOverlay" onclick="if(event.target===this)closeOvDrill()">
  <div class="ovdrill-box">
    <div class="ovdrill-head">
      <div class="ovdrill-title" id="ovDrillTitle">Breakdown</div>
      <button class="ovdrill-close" onclick="closeOvDrill()">✕</button>
    </div>
    <div class="ovdrill-tabs" id="ovDrillTabs">
      <button class="ovdrill-tab active" id="ovTabPending" onclick="setOvTab('pending')">
        Pending <span class="tab-badge" id="ovBadgePending">0</span>
      </button>
      <button class="ovdrill-tab" id="ovTabDone" onclick="setOvTab('done')">
        Completed <span class="tab-badge" id="ovBadgeDone">0</span>
      </button>
    </div>
    <div class="ovdrill-body" id="ovDrillBody"></div>
  </div>
</div>


<!-- ── BACKUP / RESTORE MODAL ── -->
<div class="backup-overlay" id="backupOverlay" onclick="if(event.target===this)closeBackup()">
  <div class="backup-box">
    <div class="backup-title">💾 Backup &amp; Restore</div>
    <div class="backup-sub">Your data lives in this browser only. Back up regularly so you never lose it.</div>

    <div class="backup-section" id="cloudSyncSection" style="background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.06));border:1px solid rgba(59,130,246,.15);border-radius:10px;padding:.8rem;">
      <div class="backup-section-title">☁️ Cloud Sync</div>
      <p style="margin-bottom:.5rem;">Cloud sync is <strong style="color:#22c55e;">active</strong>. All changes auto-sync to Supabase so your team always has the latest data.</p>
      <div style="display:flex;gap:.5rem;">
        <button class="btn btn-outline btn-sm" style="flex:1;" onclick="cloudPushAll().then(()=>toast('All data pushed to cloud'))">⬆ Push All to Cloud</button>
        <button class="btn btn-outline btn-sm" style="flex:1;" onclick="cloudPull(activeCompany).then(()=>{_reloadActiveData();toast('Pulled latest from cloud')})">⬇ Pull from Cloud</button>
      </div>
      <div style="font-size:.55rem;color:var(--ink4);margin-top:.4rem;text-align:center;">Last save syncs automatically. Use these buttons only if something seems out of sync.</div>
    </div>

    <div class="backup-section">
      <div class="backup-section-title">Export — Save Your Data</div>
      <p>Click <strong>Generate Backup</strong> — your data will appear below. Select all the text, copy it, paste it into a new file named <code>backup.json</code>, and save it somewhere safe (Desktop, Google Drive, etc.).</p>
      <button class="btn btn-red" style="width:100%;margin-bottom:.6rem;" onclick="generateBackupText()">⬇ Generate Backup</button>
      <textarea id="backupTextOut" placeholder="Your backup data will appear here after clicking Generate…" style="width:100%;height:160px;font-size:.6rem;font-family:monospace;border:1px solid var(--rule2);border-radius:6px;padding:.65rem;resize:vertical;box-sizing:border-box;background:var(--parchment);color:var(--ink3);" readonly onclick="this.select()"></textarea>
      <div id="backupCopyStatus" style="font-size:.62rem;color:var(--forest);margin-top:.3rem;min-height:1em;"></div>
    </div>

    <div class="backup-section">
      <div class="backup-section-title">Import — Restore from Backup</div>
      <p>Paste your backup JSON below and click <strong>Restore</strong>, or choose a saved <code>.json</code> file.</p>
      <textarea id="backupTextIn" placeholder="Paste backup JSON here…" style="width:100%;height:120px;font-size:.6rem;font-family:monospace;border:1px solid var(--rule2);border-radius:6px;padding:.65rem;resize:vertical;box-sizing:border-box;margin-bottom:.5rem;"></textarea>
      <div style="display:flex;gap:.5rem;margin-bottom:.5rem;">
        <button class="btn btn-red" style="flex:1;" onclick="restoreFromPaste()">↩ Restore from Text</button>
        <label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;">
          📂 Choose File
          <input type="file" accept=".json" style="display:none;" onchange="importBackup(this.files[0])">
        </label>
      </div>
      <div id="backupDrop" class="backup-drop" style="display:none;">
        📂 Drag &amp; drop backup file here
        <input type="file" accept=".json" onchange="importBackup(this.files[0])">
      </div>
      <div class="backup-status" id="backupStatus"></div>
    </div>

    <div class="backup-section">
      <div class="backup-section-title">🔀 Share Clients</div>
      <p>Export specific clients to share with a colleague. They can import the file and it will <strong>add only new clients</strong> — nothing in their app gets overwritten.</p>
      <div style="position:relative;margin-bottom:.5rem;">
        <input id="shareClientSearch" type="text" placeholder="🔍 Search clients to add…" oninput="filterShareClients(this.value)" onfocus="showShareDropdown()" onblur="hideShareDropdown()" autocomplete="off"
          style="width:100%;box-sizing:border-box;padding:.4rem .7rem;font-family:Outfit,sans-serif;font-size:.65rem;border:1px solid var(--rule2);border-radius:8px;background:var(--parchment);color:var(--ink);outline:none;">
        <div id="shareClientList" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:100;background:var(--warm-white);border:1px solid var(--rule2);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-height:200px;overflow-y:auto;margin-top:.2rem;flex-direction:column;gap:0;"></div>
      </div>
      <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem;">
        <button class="btn btn-outline btn-sm" onclick="selectAllShareClients(true)">Select All</button>
        <button class="btn btn-outline btn-sm" onclick="selectAllShareClients(false)">Clear</button>
        <span id="shareSelectedCount" style="margin-left:auto;font-family:Outfit,sans-serif;font-size:.58rem;color:var(--ink4);"></span>
      </div>
      <button class="btn btn-red" style="width:100%;margin-bottom:.6rem;" onclick="exportSelectedClients()">⬇ Export Selected Clients</button>
      <div class="backup-section-title" style="margin-top:.8rem;">Import Shared Clients</div>
      <p>Paste or load a shared clients file. Clients that already exist (same ID) will be <strong>skipped</strong> — your data stays untouched.</p>
      <textarea id="shareImportText" placeholder="Paste shared clients JSON here…" style="width:100%;height:100px;font-size:.6rem;font-family:monospace;border:1px solid var(--rule2);border-radius:6px;padding:.65rem;resize:vertical;box-sizing:border-box;margin-bottom:.5rem;"></textarea>
      <div style="display:flex;gap:.5rem;margin-bottom:.5rem;">
        <button class="btn btn-red" style="flex:1;" onclick="importSharedClients()">↩ Import Clients</button>
        <label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;">
          📂 Choose File
          <input type="file" accept=".json" style="display:none;" onchange="importSharedClientsFile(this.files[0])">
        </label>
      </div>
      <div class="backup-status" id="shareStatus"></div>
    </div>

    <div class="backup-close-row">
      <button class="btn btn-outline btn-sm" onclick="closeBackup()">Close</button>
    </div>
  </div>
</div>


<!-- ── CONFLICT MODAL ── -->
<div class="backup-overlay" id="conflictModal" style="z-index:10001;">
  <div class="backup-box" style="max-width:560px;">
    <div class="backup-title">⚠️ Resolve Conflicts</div>
    <div class="backup-sub">These clients already exist in your app. Choose what to do with each one.</div>
    <div id="conflictList" style="display:flex;flex-direction:column;gap:.8rem;margin:1rem 0;max-height:55vh;overflow-y:auto;"></div>
    <div class="backup-close-row" style="display:flex;gap:.5rem;">
      <button class="btn btn-outline btn-sm" onclick="closeConflictModal()">Cancel</button>
      <button class="btn btn-red" id="conflictApplyBtn" onclick="applyConflictChoices()" style="flex:1;">Apply Choices</button>
    </div>
  </div>
</div>

<!-- ── CHANGES PROMPT MODAL ── -->
<div class="changes-prompt-overlay" id="changesPromptOverlay">
  <div class="changes-prompt-box">
    <div class="changes-prompt-icon">🔄</div>
    <div class="changes-prompt-title">Re-opening edit</div>
    <div class="changes-prompt-name" id="changesPromptName"></div>
    <div class="changes-prompt-sub">Why is this being re-opened?</div>
    <div class="changes-prompt-btns">
      <button class="btn-yes" onclick="confirmChanges(true)">Needs changes</button>
      <button class="btn-no" onclick="confirmChanges(false)">Mistake — undo</button>
    </div>
  </div>
</div>


<!-- ── CLIENT TIMELINE MODAL ── -->
<div class="ctl-overlay" id="ctlOverlay" onclick="if(event.target===this)closeTimeline()">
  <div class="ctl-box">
    <div class="ctl-head">
      <div class="ctl-head-left">
        <div class="ctl-title" id="ctlTitle">Client Journey</div>
        <div class="ctl-subtitle" id="ctlSubtitle">Booking to Delivery</div>
      </div>
      <button class="ctl-close" onclick="closeTimeline()">✕</button>
    </div>
    <div class="ctl-body" id="ctlBody"></div>
  </div>
</div>

<!-- ── EVENT MODAL OVERLAY ── -->
<div class="ev-modal-overlay" id="evModalOverlay" onclick="if(event.target===this)closeEvModal()">
  <div class="ev-modal-box" id="evModalBox" onclick="event.stopPropagation()">
    <div class="ev-modal-header" id="evModalHeader">
      <div class="ev-modal-title" id="evModalTitle"></div>
      <button class="ev-modal-close" onclick="closeEvModal()">✕</button>
    </div>
    <div class="ev-modal-body" id="evModalBody"></div>
  </div>
</div>

</body>
</html>
